# 不要修改该文件，会自动生成，详见 https://gitlab.alibaba-inc.com/node/ci

stages:
  - test

environments:
  NODE_ENV: "test"
{%- if environments %}
  {%- for key, value in environments %}
  {{key}}: "{{value}}"
  {%- endfor %}
{%- endif %}

beforeScript:
  - |
    export PATH=$PWD/node_modules/.bin:/root/.cli:$PATH
    echo $PATH
    time enclose install tnpm:tnpm
    tnpm -v
{%- if tengine %}
    yum install -y -b current t-alipay-tengine-1.5.3
{%- endif %}
{%- if obproxy %}
    /opt/taobao/install/obproxy/bin/obproxyd.sh -c start -e offline -n chair_test
{%- endif %}

{%- for item in versions %}
{{item.name}}-{{item.version}}:
  stage: test
  aciTags: DOCKER
  agent:
    docker:
      image: {{image}}
      resourceRequirements:
        cpu: {{resource.cpu}}
        memory: {{resource.memory}}
        ephemeral-storage: {{resource.storage}}
  script:
    - |
      export PATH=$PWD/node_modules/.bin:/root/.cli:$PATH
      {%- if environments and environments.MYSQL_DATABASE %}
      sh /home/admin/bin/start_mysql.sh
      {%- endif %}
      chown -R admin:admin ./
      time tnpm i --install-{{item.name}}={{item.version}} --no-cache --internal-oss-cache
      node -e "console.log('%j, %j', process.versions, process.execPath)"
      time tnpm run {{command}}
  coverage: '(?<=Statements\s{1,10}:\s{1,10})\d{1,10}.\d{1,10}'
  passrate: '(?<=PASS_RATE: )\d{1,10}.\d{1,10}'
  publisher:
    archiveArtifacts:
      artifacts: 'coverage/'
      allowEmptyArchive: true
    html:
      index: coverage/lcov-report/index.html
      displayName: 测试覆盖率
{%- else %}
test:
  stage: test
  aciTags: DOCKER
  agent:
    docker:
      image: {{image}}
      resourceRequirements:
        cpu: {{resource.cpu}}
        memory: {{resource.memory}}
        ephemeral-storage: {{resource.storage}}
  script:
    - |
      export PATH=$PWD/node_modules/.bin:/root/.cli:$PATH
      {%- if environments and environments.MYSQL_DATABASE %}
      sh /home/admin/bin/start_mysql.sh
      {%- endif %}
      time tnpm i --no-cache --internal-oss-cache
      node -e "console.log('%j, %j', process.versions, process.execPath)"
      time tnpm run {{command}}
  coverage: '(?<=Statements\s{1,10}:\s{1,10})\d{1,10}.\d{1,10}'
  passrate: '(?<=PASS_RATE: )\d{1,10}.\d{1,10}'
  publisher:
    archiveArtifacts:
      artifacts: 'coverage/'
      allowEmptyArchive: true
    html:
      index: coverage/lcov-report/index.html
      displayName: 测试覆盖率
{%- endfor %}
