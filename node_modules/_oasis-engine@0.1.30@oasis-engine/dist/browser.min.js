!function(e,t){"object"==typeof exports&&"undefined"!=typeof module?t(exports):"function"==typeof define&&define.amd?define(["exports"],t):t((e="undefined"!=typeof globalThis?globalThis:e||self).oasisEngine={})}(this,(function(e){"use strict";function t(e){return(t="function"==typeof Symbol&&"symbol"==typeof Symbol.iterator?function(e){return typeof e}:function(e){return e&&"function"==typeof Symbol&&e.constructor===Symbol&&e!==Symbol.prototype?"symbol":typeof e})(e)}function n(e,t){if(!(e instanceof t))throw new TypeError("Cannot call a class as a function")}function i(e,t){for(var n=0;n<t.length;n++){var i=t[n];i.enumerable=i.enumerable||!1,i.configurable=!0,"value"in i&&(i.writable=!0),Object.defineProperty(e,i.key,i)}}function r(e,t,n){return t&&i(e.prototype,t),n&&i(e,n),e}function a(e,t,n){return t in e?Object.defineProperty(e,t,{value:n,enumerable:!0,configurable:!0,writable:!0}):e[t]=n,e}function o(){return(o=Object.assign||function(e){for(var t=1;t<arguments.length;t++){var n=arguments[t];for(var i in n)Object.prototype.hasOwnProperty.call(n,i)&&(e[i]=n[i])}return e}).apply(this,arguments)}function s(e,t){var n=Object.keys(e);if(Object.getOwnPropertySymbols){var i=Object.getOwnPropertySymbols(e);t&&(i=i.filter((function(t){return Object.getOwnPropertyDescriptor(e,t).enumerable}))),n.push.apply(n,i)}return n}function u(e){for(var t=1;t<arguments.length;t++){var n=null!=arguments[t]?arguments[t]:{};t%2?s(Object(n),!0).forEach((function(t){a(e,t,n[t])})):Object.getOwnPropertyDescriptors?Object.defineProperties(e,Object.getOwnPropertyDescriptors(n)):s(Object(n)).forEach((function(t){Object.defineProperty(e,t,Object.getOwnPropertyDescriptor(n,t))}))}return e}function l(e,t){if("function"!=typeof t&&null!==t)throw new TypeError("Super expression must either be null or a function");e.prototype=Object.create(t&&t.prototype,{constructor:{value:e,writable:!0,configurable:!0}}),t&&h(e,t)}function c(e){return(c=Object.setPrototypeOf?Object.getPrototypeOf:function(e){return e.__proto__||Object.getPrototypeOf(e)})(e)}function h(e,t){return(h=Object.setPrototypeOf||function(e,t){return e.__proto__=t,e})(e,t)}function d(){if("undefined"==typeof Reflect||!Reflect.construct)return!1;if(Reflect.construct.sham)return!1;if("function"==typeof Proxy)return!0;try{return Date.prototype.toString.call(Reflect.construct(Date,[],(function(){}))),!0}catch(e){return!1}}function f(e,t,n){return(f=d()?Reflect.construct:function(e,t,n){var i=[null];i.push.apply(i,t);var r=new(Function.bind.apply(e,i));return n&&h(r,n.prototype),r}).apply(null,arguments)}function _(e){var t="function"==typeof Map?new Map:void 0;return(_=function(e){if(null===e||(n=e,-1===Function.toString.call(n).indexOf("[native code]")))return e;var n;if("function"!=typeof e)throw new TypeError("Super expression must either be null or a function");if(void 0!==t){if(t.has(e))return t.get(e);t.set(e,i)}function i(){return f(e,arguments,c(this).constructor)}return i.prototype=Object.create(e.prototype,{constructor:{value:i,enumerable:!1,writable:!0,configurable:!0}}),h(i,e)})(e)}function p(e){if(void 0===e)throw new ReferenceError("this hasn't been initialised - super() hasn't been called");return e}function v(e,t){return!t||"object"!=typeof t&&"function"!=typeof t?p(e):t}function m(e){var t=d();return function(){var n,i=c(e);if(t){var r=c(this).constructor;n=Reflect.construct(i,arguments,r)}else n=i.apply(this,arguments);return v(this,n)}}function g(e,t,n){return(g="undefined"!=typeof Reflect&&Reflect.get?Reflect.get:function(e,t,n){var i=function(e,t){for(;!Object.prototype.hasOwnProperty.call(e,t)&&null!==(e=c(e)););return e}(e,t);if(i){var r=Object.getOwnPropertyDescriptor(i,t);return r.get?r.get.call(n):r.value}})(e,t,n||e)}function y(e,t){return function(e){if(Array.isArray(e))return e}(e)||function(e,t){if("undefined"==typeof Symbol||!(Symbol.iterator in Object(e)))return;var n=[],i=!0,r=!1,a=void 0;try{for(var o,s=e[Symbol.iterator]();!(i=(o=s.next()).done)&&(n.push(o.value),!t||n.length!==t);i=!0);}catch(e){r=!0,a=e}finally{try{i||null==s.return||s.return()}finally{if(r)throw a}}return n}(e,t)||T(e,t)||function(){throw new TypeError("Invalid attempt to destructure non-iterable instance.\nIn order to be iterable, non-array objects must have a [Symbol.iterator]() method.")}()}function x(e){return function(e){if(Array.isArray(e))return A(e)}(e)||function(e){if("undefined"!=typeof Symbol&&Symbol.iterator in Object(e))return Array.from(e)}(e)||T(e)||function(){throw new TypeError("Invalid attempt to spread non-iterable instance.\nIn order to be iterable, non-array objects must have a [Symbol.iterator]() method.")}()}function T(e,t){if(e){if("string"==typeof e)return A(e,t);var n=Object.prototype.toString.call(e).slice(8,-1);return"Object"===n&&e.constructor&&(n=e.constructor.name),"Map"===n||"Set"===n?Array.from(e):"Arguments"===n||/^(?:Ui|I)nt(?:8|16|32)(?:Clamped)?Array$/.test(n)?A(e,t):void 0}}function A(e,t){(null==t||t>e.length)&&(t=e.length);for(var n=0,i=new Array(t);n<t;n++)i[n]=e[n];return i}function S(e,t){var n;if("undefined"==typeof Symbol||null==e[Symbol.iterator]){if(Array.isArray(e)||(n=T(e))||t&&e&&"number"==typeof e.length){n&&(e=n);var i=0,r=function(){};return{s:r,n:function(){return i>=e.length?{done:!0}:{done:!1,value:e[i++]}},e:function(e){throw e},f:r}}throw new TypeError("Invalid attempt to iterate non-iterable instance.\nIn order to be iterable, non-array objects must have a [Symbol.iterator]() method.")}var a,o=!0,s=!1;return{s:function(){n=e[Symbol.iterator]()},n:function(){var e=n.next();return o=e.done,e},e:function(e){s=!0,a=e},f:function(){try{o||null==n.return||n.return()}finally{if(s)throw a}}}}var E,C;function b(e,t){return e.x*t.x+e.y*t.y+e.z*t.z+e.w}(C=E||(E={}))[C.EXCLUDE=0]="EXCLUDE",C[C.INTERSECT=1]="INTERSECT",C[C.INCLUDE=2]="INCLUDE";var R=function(){function e(){n(this,e)}return r(e,null,[{key:"clamp",value:function(e,t,n){return Math.max(t,Math.min(n,e))}},{key:"equals",value:function(t,n){return Math.abs(t-n)<=e.zeroTolerance}},{key:"isPowerOf2",value:function(e){return 0==(e&e-1)}},{key:"radianToDegree",value:function(t){return t*e.radToDegreeFactor}},{key:"degreeToRadian",value:function(t){return t*e.degreeToRadFactor}}]),e}();R.zeroTolerance=1e-6,R.radToDegreeFactor=180/Math.PI,R.degreeToRadFactor=Math.PI/180;var w=function(){function e(){var t=arguments.length>0&&void 0!==arguments[0]?arguments[0]:0,i=arguments.length>1&&void 0!==arguments[1]?arguments[1]:0,r=arguments.length>2&&void 0!==arguments[2]?arguments[2]:0;n(this,e),this.x=t,this.y=i,this.z=r}return r(e,null,[{key:"add",value:function(e,t,n){n.x=e.x+t.x,n.y=e.y+t.y,n.z=e.z+t.z}},{key:"subtract",value:function(e,t,n){n.x=e.x-t.x,n.y=e.y-t.y,n.z=e.z-t.z}},{key:"multiply",value:function(e,t,n){n.x=e.x*t.x,n.y=e.y*t.y,n.z=e.z*t.z}},{key:"divide",value:function(e,t,n){n.x=e.x/t.x,n.y=e.y/t.y,n.z=e.z/t.z}},{key:"dot",value:function(e,t){return e.x*t.x+e.y*t.y+e.z*t.z}},{key:"cross",value:function(e,t,n){var i=e.x,r=e.y,a=e.z,o=t.x,s=t.y,u=t.z;n.x=r*u-a*s,n.y=a*o-i*u,n.z=i*s-r*o}},{key:"distance",value:function(e,t){var n=t.x-e.x,i=t.y-e.y,r=t.z-e.z;return Math.sqrt(n*n+i*i+r*r)}},{key:"distanceSquared",value:function(e,t){var n=t.x-e.x,i=t.y-e.y,r=t.z-e.z;return n*n+i*i+r*r}},{key:"equals",value:function(e,t){return R.equals(e.x,t.x)&&R.equals(e.y,t.y)&&R.equals(e.z,t.z)}},{key:"lerp",value:function(e,t,n,i){var r=e.x,a=e.y,o=e.z;i.x=r+(t.x-r)*n,i.y=a+(t.y-a)*n,i.z=o+(t.z-o)*n}},{key:"max",value:function(e,t,n){n.x=Math.max(e.x,t.x),n.y=Math.max(e.y,t.y),n.z=Math.max(e.z,t.z)}},{key:"min",value:function(e,t,n){n.x=Math.min(e.x,t.x),n.y=Math.min(e.y,t.y),n.z=Math.min(e.z,t.z)}},{key:"negate",value:function(e,t){t.x=-e.x,t.y=-e.y,t.z=-e.z}},{key:"normalize",value:function(e,t){var n=e.x,i=e.y,r=e.z,a=Math.sqrt(n*n+i*i+r*r);a>0&&(a=1/a,t.x=n*a,t.y=i*a,t.z=r*a)}},{key:"scale",value:function(e,t,n){n.x=e.x*t,n.y=e.y*t,n.z=e.z*t}},{key:"transformNormal",value:function(e,t,n){var i=e.x,r=e.y,a=e.z,o=t.elements;n.x=i*o[0]+r*o[4]+a*o[8],n.y=i*o[1]+r*o[5]+a*o[9],n.z=i*o[2]+r*o[6]+a*o[10]}},{key:"transformToVec3",value:function(e,t,n){var i=e.x,r=e.y,a=e.z,o=t.elements;n.x=i*o[0]+r*o[4]+a*o[8]+o[12],n.y=i*o[1]+r*o[5]+a*o[9]+o[13],n.z=i*o[2]+r*o[6]+a*o[10]+o[14]}},{key:"transformToVec4",value:function(e,t,n){var i=e.x,r=e.y,a=e.z,o=t.elements;n.x=i*o[0]+r*o[4]+a*o[8]+o[12],n.y=i*o[1]+r*o[5]+a*o[9]+o[13],n.z=i*o[2]+r*o[6]+a*o[10]+o[14],n.w=i*o[3]+r*o[7]+a*o[11]+o[15]}},{key:"transformCoordinate",value:function(e,t,n){var i=e.x,r=e.y,a=e.z,o=t.elements,s=i*o[3]+r*o[7]+a*o[11]+o[15];s=1/s,n.x=(i*o[0]+r*o[4]+a*o[8]+o[12])*s,n.y=(i*o[1]+r*o[5]+a*o[9]+o[13])*s,n.z=(i*o[2]+r*o[6]+a*o[10]+o[14])*s}},{key:"transformByQuat",value:function(e,t,n){var i=e.x,r=e.y,a=e.z,o=t.x,s=t.y,u=t.z,l=t.w,c=l*i+s*a-u*r,h=l*r+u*i-o*a,d=l*a+o*r-s*i,f=-o*i-s*r-u*a;n.x=c*l-f*o-h*u+d*s,n.y=h*l-f*s-d*o+c*u,n.z=d*l-f*u-c*s+h*o}}]),r(e,[{key:"setValue",value:function(e,t,n){return this.x=e,this.y=t,this.z=n,this}},{key:"setValueByArray",value:function(e){var t=arguments.length>1&&void 0!==arguments[1]?arguments[1]:0;return this.x=e[t],this.y=e[t+1],this.z=e[t+2],this}},{key:"add",value:function(e){return this.x+=e.x,this.y+=e.y,this.z+=e.z,this}},{key:"subtract",value:function(e){return this.x-=e.x,this.y-=e.y,this.z-=e.z,this}},{key:"multiply",value:function(e){return this.x*=e.x,this.y*=e.y,this.z*=e.z,this}},{key:"divide",value:function(e){return this.x/=e.x,this.y/=e.y,this.z/=e.z,this}},{key:"length",value:function(){var e=this.x,t=this.y,n=this.z;return Math.sqrt(e*e+t*t+n*n)}},{key:"lengthSquared",value:function(){var e=this.x,t=this.y,n=this.z;return e*e+t*t+n*n}},{key:"negate",value:function(){return this.x=-this.x,this.y=-this.y,this.z=-this.z,this}},{key:"normalize",value:function(){return e.normalize(this,this),this}},{key:"scale",value:function(e){return this.x*=e,this.y*=e,this.z*=e,this}},{key:"toArray",value:function(e){var t=arguments.length>1&&void 0!==arguments[1]?arguments[1]:0;e[t]=this.x,e[t+1]=this.y,e[t+2]=this.z}},{key:"clone",value:function(){return new e(this.x,this.y,this.z)}},{key:"cloneTo",value:function(e){return e.x=this.x,e.y=this.y,e.z=this.z,e}},{key:"transformNormal",value:function(t){return e.transformNormal(this,t,this),this}},{key:"transformToVec3",value:function(t){return e.transformToVec3(this,t,this),this}},{key:"transformCoordinate",value:function(t){return e.transformCoordinate(this,t,this),this}},{key:"transformByQuat",value:function(t){return e.transformByQuat(this,t,this),this}}]),e}();w._zero=new w(0,0,0),w._one=new w(1,1,1),w._tempVector3=new w;var M=function(){function e(t,i,r){n(this,e),this.center=new w,this.radius=0,this.centerWorld=new w,this.radiusWorld=0;var a=w.distance(t,i);this.radius=.5*a,w.add(t,i,this.center),this.center.scale(.5),this.updateByModelMatrix(r)}return r(e,[{key:"updateByModelMatrix",value:function(e){w.transformCoordinate(this.center,e,this.centerWorld),this.radiusWorld=this.radius*function(e){var t=e.elements,n=t[0]*t[0]+t[1]*t[1]+t[2]*t[2],i=t[4]*t[4]+t[5]*t[5]+t[6]*t[6],r=t[8]*t[8]+t[9]*t[9]+t[10]*t[10];return Math.sqrt(Math.max(n,i,r))}(e)}},{key:"intersectsFrustum",value:function(e){for(var t=0;t<6;t++){var n=b(e[t],this.centerWorld);if(n<-this.radiusWorld)return E.EXCLUDE;if(n<this.radiusWorld)return E.INTERSECT}return E.INCLUDE}},{key:"isInFrustum",value:function(e){for(var t=0;t<6;t++){if(b(e[t],this.centerWorld)<-this.radiusWorld)return!1}return!0}}]),e}(),L=function(){function e(t,i){n(this,e),this.min=new w,this.max=new w,this.update(t,i)}return r(e,[{key:"update",value:function(e,t){e.cloneTo(this.min),t.cloneTo(this.max)}},{key:"setFromCenterAndSize",value:function(e,t){var n=new w;w.scale(t,.5,n),w.subtract(e,n,this.min),w.add(e,n,this.max)}},{key:"intersectsFrustum",value:function(e){for(var t=this.min,n=this.max,i=new w,r=new w,a=0;a<6;a++){var o=e[a];i.x=o.x>0?t.x:n.x,r.x=o.x>0?n.x:t.x,i.y=o.y>0?t.y:n.y,r.y=o.y>0?n.y:t.y,i.z=o.z>0?t.z:n.z,r.z=o.z>0?n.z:t.z;var s=b(o,i),u=b(o,r);if(s<0&&u<0)return E.EXCLUDE;if(s<0||u<0)return E.INTERSECT}return E.INCLUDE}},{key:"isInFrustum",value:function(e){for(var t=this.min,n=this.max,i=new w,r=0;r<6;r++){var a=e[r];if(i.x=a.x>0?n.x:t.x,i.y=a.y>0?n.y:t.y,i.z=a.z>0?n.z:t.z,b(a,i)<0)return!1}return!0}},{key:"clone",value:function(){return new e(this.min,this.max)}},{key:"cloneTo",value:function(e){this.min.cloneTo(e.min),this.max.cloneTo(e.max)}}]),e}(),P=function(){function e(){var t=arguments.length>0&&void 0!==arguments[0]?arguments[0]:1,i=arguments.length>1&&void 0!==arguments[1]?arguments[1]:0,r=arguments.length>2&&void 0!==arguments[2]?arguments[2]:0,a=arguments.length>3&&void 0!==arguments[3]?arguments[3]:0,o=arguments.length>4&&void 0!==arguments[4]?arguments[4]:1,s=arguments.length>5&&void 0!==arguments[5]?arguments[5]:0,u=arguments.length>6&&void 0!==arguments[6]?arguments[6]:0,l=arguments.length>7&&void 0!==arguments[7]?arguments[7]:0,c=arguments.length>8&&void 0!==arguments[8]?arguments[8]:1;n(this,e),this.elements=new Float32Array(9);var h=this.elements;h[0]=t,h[1]=i,h[2]=r,h[3]=a,h[4]=o,h[5]=s,h[6]=u,h[7]=l,h[8]=c}return r(e,[{key:"setValue",value:function(e,t,n,i,r,a,o,s,u){var l=this.elements;return l[0]=e,l[1]=t,l[2]=n,l[3]=i,l[4]=r,l[5]=a,l[6]=o,l[7]=s,l[8]=u,this}},{key:"setValueByArray",value:function(e){for(var t=arguments.length>1&&void 0!==arguments[1]?arguments[1]:0,n=this.elements,i=0;i<12;i++)n[i]=e[i+t];return this}},{key:"setValueByMatrix",value:function(e){var t=e.elements,n=this.elements;return n[0]=t[0],n[1]=t[1],n[2]=t[2],n[3]=t[4],n[4]=t[5],n[5]=t[6],n[6]=t[8],n[7]=t[9],n[8]=t[10],this}},{key:"toArray",value:function(e){var t=arguments.length>1&&void 0!==arguments[1]?arguments[1]:0,n=this.elements;e[t]=n[0],e[t+1]=n[1],e[t+2]=n[2],e[t+3]=n[3],e[t+4]=n[4],e[t+5]=n[5],e[t+6]=n[6],e[t+7]=n[7],e[t+8]=n[8]}},{key:"clone",value:function(){var t=this.elements;return new e(t[0],t[1],t[2],t[3],t[4],t[5],t[6],t[7],t[8])}},{key:"cloneTo",value:function(e){var t=this.elements,n=e.elements;return n[0]=t[0],n[1]=t[1],n[2]=t[2],n[3]=t[3],n[4]=t[4],n[5]=t[5],n[6]=t[6],n[7]=t[7],n[8]=t[8],e}},{key:"add",value:function(t){return e.add(this,t,this),this}},{key:"subtract",value:function(t){return e.subtract(this,t,this),this}},{key:"multiply",value:function(t){return e.multiply(this,t,this),this}},{key:"determinant",value:function(){var e=this.elements,t=e[0],n=e[1],i=e[2],r=e[3],a=e[4],o=e[5],s=e[6],u=e[7],l=e[8];return t*(l*a-o*u)+n*(-l*r+o*s)+i*(u*r-a*s)}},{key:"identity",value:function(){var e=this.elements;return e[0]=1,e[1]=0,e[2]=0,e[3]=0,e[4]=1,e[5]=0,e[6]=0,e[7]=0,e[8]=1,this}},{key:"invert",value:function(){return e.invert(this,this),this}},{key:"rotate",value:function(t){return e.rotate(this,t,this),this}},{key:"scale",value:function(t){return e.scale(this,t,this),this}},{key:"translate",value:function(t){return e.translate(this,t,this),this}},{key:"transpose",value:function(){return e.transpose(this,this),this}}],[{key:"add",value:function(e,t,n){var i=e.elements,r=t.elements,a=n.elements;a[0]=i[0]+r[0],a[1]=i[1]+r[1],a[2]=i[2]+r[2],a[3]=i[3]+r[3],a[4]=i[4]+r[4],a[5]=i[5]+r[5],a[6]=i[6]+r[6],a[7]=i[7]+r[7],a[8]=i[8]+r[8]}},{key:"subtract",value:function(e,t,n){var i=e.elements,r=t.elements,a=n.elements;a[0]=i[0]-r[0],a[1]=i[1]-r[1],a[2]=i[2]-r[2],a[3]=i[3]-r[3],a[4]=i[4]-r[4],a[5]=i[5]-r[5],a[6]=i[6]-r[6],a[7]=i[7]-r[7],a[8]=i[8]-r[8]}},{key:"multiply",value:function(e,t,n){var i=e.elements,r=t.elements,a=n.elements,o=i[0],s=i[1],u=i[2],l=i[3],c=i[4],h=i[5],d=i[6],f=i[7],_=i[8],p=r[0],v=r[1],m=r[2],g=r[3],y=r[4],x=r[5],T=r[6],A=r[7],S=r[8];a[0]=o*p+l*v+d*m,a[1]=s*p+c*v+f*m,a[2]=u*p+h*v+_*m,a[3]=o*g+l*y+d*x,a[4]=s*g+c*y+f*x,a[5]=u*g+h*y+_*x,a[6]=o*T+l*A+d*S,a[7]=s*T+c*A+f*S,a[8]=u*T+h*A+_*S}},{key:"equals",value:function(e,t){var n=e.elements,i=t.elements;return R.equals(n[0],i[0])&&R.equals(n[1],i[1])&&R.equals(n[2],i[2])&&R.equals(n[3],i[3])&&R.equals(n[4],i[4])&&R.equals(n[5],i[5])&&R.equals(n[6],i[6])&&R.equals(n[7],i[7])&&R.equals(n[8],i[8])}},{key:"rotationQuaternion",value:function(e,t){var n=t.elements,i=e.x,r=e.y,a=e.z,o=e.w,s=i+i,u=r+r,l=a+a,c=i*s,h=r*s,d=r*u,f=a*s,_=a*u,p=a*l,v=o*s,m=o*u,g=o*l;n[0]=1-d-p,n[3]=h-g,n[6]=f+m,n[1]=h+g,n[4]=1-c-p,n[7]=_-v,n[2]=f-m,n[5]=_+v,n[8]=1-c-d}},{key:"scaling",value:function(e,t){var n=t.elements;n[0]=e.x,n[1]=0,n[2]=0,n[3]=0,n[4]=e.y,n[5]=0,n[6]=0,n[7]=0,n[8]=1}},{key:"translation",value:function(e,t){var n=t.elements;n[0]=1,n[1]=0,n[2]=0,n[3]=0,n[4]=1,n[5]=0,n[6]=e.x,n[7]=e.y,n[8]=1}},{key:"invert",value:function(e,t){var n=e.elements,i=t.elements,r=n[0],a=n[1],o=n[2],s=n[3],u=n[4],l=n[5],c=n[6],h=n[7],d=n[8],f=d*u-l*h,_=-d*s+l*c,p=h*s-u*c,v=r*f+a*_+o*p;v&&(v=1/v,i[0]=f*v,i[1]=(-d*a+o*h)*v,i[2]=(l*a-o*u)*v,i[3]=_*v,i[4]=(d*r-o*c)*v,i[5]=(-l*r+o*s)*v,i[6]=p*v,i[7]=(-h*r+a*c)*v,i[8]=(u*r-a*s)*v)}},{key:"normalMatrix",value:function(e,t){var n=e.elements,i=t.elements,r=n[0],a=n[1],o=n[2],s=n[3],u=n[4],l=n[5],c=n[6],h=n[7],d=n[8],f=n[9],_=n[10],p=n[11],v=n[12],m=n[13],g=n[14],y=n[15],x=r*l-a*u,T=r*c-o*u,A=r*h-s*u,S=a*c-o*l,E=a*h-s*l,C=o*h-s*c,b=d*m-f*v,R=d*g-_*v,w=d*y-p*v,M=f*g-_*m,L=f*y-p*m,P=_*y-p*g,O=x*P-T*L+A*M+S*w-E*R+C*b;if(!O)return null;O=1/O,i[0]=(l*P-c*L+h*M)*O,i[1]=(c*w-u*P-h*R)*O,i[2]=(u*L-l*w+h*b)*O,i[3]=(o*L-a*P-s*M)*O,i[4]=(r*P-o*w+s*R)*O,i[5]=(a*w-r*L-s*b)*O,i[6]=(m*C-g*E+y*S)*O,i[7]=(g*A-v*C-y*T)*O,i[8]=(v*E-m*A+y*x)*O}},{key:"rotate",value:function(e,t,n){var i=e.elements,r=n.elements,a=Math.sin(t),o=Math.cos(t),s=i[0],u=i[1],l=i[2],c=i[3],h=i[4],d=i[5],f=i[6],_=i[7],p=i[8];r[0]=o*s+a*c,r[1]=o*u+a*h,r[2]=o*l+a*d,r[3]=o*c-a*s,r[4]=o*h-a*u,r[5]=o*d-a*l,r[6]=f,r[7]=_,r[8]=p}},{key:"scale",value:function(e,t,n){var i=t.x,r=t.y,a=e.elements,o=n.elements;o[0]=i*a[0],o[1]=i*a[1],o[2]=i*a[2],o[3]=r*a[3],o[4]=r*a[4],o[5]=r*a[5],o[6]=a[6],o[7]=a[7],o[8]=a[8]}},{key:"translate",value:function(e,t,n){var i=t.x,r=t.y,a=e.elements,o=n.elements,s=a[0],u=a[1],l=a[2],c=a[3],h=a[4],d=a[5],f=a[6],_=a[7],p=a[8];o[0]=s,o[1]=u,o[2]=l,o[3]=c,o[4]=h,o[5]=d,o[6]=i*s+r*c+f,o[7]=i*u+r*h+_,o[8]=i*l+r*d+p}},{key:"transpose",value:function(e,t){var n=e.elements,i=t.elements;if(t===e){var r=n[1],a=n[2],o=n[5];i[1]=n[3],i[2]=n[6],i[3]=r,i[5]=n[7],i[6]=a,i[7]=o}else i[0]=n[0],i[1]=n[3],i[2]=n[6],i[3]=n[1],i[4]=n[4],i[5]=n[7],i[6]=n[2],i[7]=n[5],i[8]=n[8]}}]),e}(),O=function(){function e(){var t=arguments.length>0&&void 0!==arguments[0]?arguments[0]:0,i=arguments.length>1&&void 0!==arguments[1]?arguments[1]:0,r=arguments.length>2&&void 0!==arguments[2]?arguments[2]:0,a=arguments.length>3&&void 0!==arguments[3]?arguments[3]:1;n(this,e),this.x=t,this.y=i,this.z=r,this.w=a}return r(e,null,[{key:"add",value:function(e,t,n){n.x=e.x+t.x,n.y=e.y+t.y,n.z=e.z+t.z,n.w=e.w+t.w}},{key:"multiply",value:function(e,t,n){var i=e.x,r=e.y,a=e.z,o=e.w,s=t.x,u=t.y,l=t.z,c=t.w;n.x=i*c+o*s+r*l-a*u,n.y=r*c+o*u+a*s-i*l,n.z=a*c+o*l+i*u-r*s,n.w=o*c-i*s-r*u-a*l}},{key:"conjugate",value:function(e,t){t.x=-e.x,t.y=-e.y,t.z=-e.z,t.w=e.w}},{key:"dot",value:function(e,t){return e.x*t.x+e.y*t.y+e.z*t.z+e.w*t.w}},{key:"equals",value:function(e,t){return R.equals(e.x,t.x)&&R.equals(e.y,t.y)&&R.equals(e.z,t.z)&&R.equals(e.w,t.w)}},{key:"rotationAxisAngle",value:function(t,n,i){var r=e._tempVector3;w.normalize(t,r),n*=.5;var a=Math.sin(n);i.x=r.x*a,i.y=r.y*a,i.z=r.z*a,i.w=Math.cos(n)}},{key:"rotationEuler",value:function(t,n,i,r){e.rotationYawPitchRoll(n,t,i,r)}},{key:"rotationYawPitchRoll",value:function(e,t,n,i){var r=.5*n,a=.5*t,o=.5*e,s=Math.sin(r),u=Math.cos(r),l=Math.sin(a),c=Math.cos(a),h=Math.sin(o),d=Math.cos(o),f=d*c,_=h*l;i.x=d*l*u+h*c*s,i.y=h*c*u-d*l*s,i.z=f*s-_*u,i.w=f*u+_*s}},{key:"rotationMatrix3x3",value:function(e,t){var n,i,r=e.elements,a=r[0],o=r[1],s=r[2],u=r[3],l=r[4],c=r[5],h=r[6],d=r[7],f=r[8],_=a+l+f;_>0?(n=Math.sqrt(_+1),t.w=.5*n,n=.5/n,t.x=(c-d)*n,t.y=(h-s)*n,t.z=(o-u)*n):a>=l&&a>=f?(i=.5/(n=Math.sqrt(1+a-l-f)),t.x=.5*n,t.y=(o+u)*i,t.z=(s+h)*i,t.w=(c-d)*i):l>f?(i=.5/(n=Math.sqrt(1+l-a-f)),t.x=(u+o)*i,t.y=.5*n,t.z=(d+c)*i,t.w=(h-s)*i):(i=.5/(n=Math.sqrt(1+f-a-l)),t.x=(s+h)*i,t.y=(c+d)*i,t.z=.5*n,t.w=(o-u)*i)}},{key:"invert",value:function(e,t){var n=e.x,i=e.y,r=e.z,a=e.w,o=n*n+i*i+r*r+a*a;if(o>R.zeroTolerance){var s=1/o;t.x=-n*s,t.y=-i*s,t.z=-r*s,t.w=a*s}}},{key:"lerp",value:function(t,n,i,r){var a=1-i;e.dot(t,n)>=0?(r.x=t.x*a+n.x*i,r.y=t.y*a+n.y*i,r.z=t.z*a+n.z*i,r.w=t.w*a+n.w*i):(r.x=t.x*a-n.x*i,r.y=t.y*a-n.y*i,r.z=t.z*a-n.z*i,r.w=t.w*a-n.w*i),r.normalize()}},{key:"slerp",value:function(e,t,n,i){var r,a,o=e.x,s=e.y,u=e.z,l=e.w,c=t.x,h=t.y,d=t.z,f=t.w,_=o*c+s*h+u*d+l*f;if(_<0&&(_=-_,c=-c,h=-h,d=-d,f=-f),1-_>R.zeroTolerance){var p=Math.acos(_),v=Math.sin(p);r=Math.sin((1-n)*p)/v,a=Math.sin(n*p)/v}else r=1-n,a=n;i.x=r*o+a*c,i.y=r*s+a*h,i.z=r*u+a*d,i.w=r*l+a*f}},{key:"normalize",value:function(e,t){var n=e.x,i=e.y,r=e.z,a=e.w,o=Math.sqrt(n*n+i*i+r*r+a*a);o>R.zeroTolerance&&(o=1/o,t.x=n*o,t.y=i*o,t.z=r*o,t.w=a*o)}},{key:"rotationX",value:function(e,t){e*=.5;var n=Math.sin(e),i=Math.cos(e);t.x=n,t.y=0,t.z=0,t.w=i}},{key:"rotationY",value:function(e,t){e*=.5;var n=Math.sin(e),i=Math.cos(e);t.x=0,t.y=n,t.z=0,t.w=i}},{key:"rotationZ",value:function(e,t){e*=.5;var n=Math.sin(e),i=Math.cos(e);t.x=0,t.y=0,t.z=n,t.w=i}},{key:"rotateX",value:function(e,t,n){var i=e.x,r=e.y,a=e.z,o=e.w;t*=.5;var s=Math.sin(t),u=Math.cos(t);n.x=i*u+o*s,n.y=r*u+a*s,n.z=a*u-r*s,n.w=o*u-i*s}},{key:"rotateY",value:function(e,t,n){var i=e.x,r=e.y,a=e.z,o=e.w;t*=.5;var s=Math.sin(t),u=Math.cos(t);n.x=i*u-a*s,n.y=r*u+o*s,n.z=a*u+i*s,n.w=o*u-r*s}},{key:"rotateZ",value:function(e,t,n){var i=e.x,r=e.y,a=e.z,o=e.w;t*=.5;var s=Math.sin(t),u=Math.cos(t);n.x=i*u+r*s,n.y=r*u-i*s,n.z=a*u+o*s,n.w=o*u-a*s}},{key:"scale",value:function(e,t,n){n.x=e.x*t,n.y=e.y*t,n.z=e.z*t,n.w=e.w*t}}]),r(e,[{key:"setValue",value:function(e,t,n,i){return this.x=e,this.y=t,this.z=n,this.w=i,this}},{key:"setValueByArray",value:function(e){var t=arguments.length>1&&void 0!==arguments[1]?arguments[1]:0;return this.x=e[t],this.y=e[t+1],this.z=e[t+2],this.w=e[t+3],this}},{key:"conjugate",value:function(){return this.x*=-1,this.y*=-1,this.z*=-1,this}},{key:"getAxisAngle",value:function(e){var t=this.x,n=this.y,i=this.z,r=t*t+n*n+i*i;if(r<R.zeroTolerance)return e.x=1,e.y=0,e.z=0,0;var a=1/r;return e.x=this.x*a,e.y=this.y*a,e.z=this.z*a,2*Math.acos(this.w)}},{key:"identity",value:function(){return this.x=0,this.y=0,this.z=0,this.w=1,this}},{key:"length",value:function(){var e=this.x,t=this.y,n=this.z,i=this.w;return Math.sqrt(e*e+t*t+n*n+i*i)}},{key:"lengthSquared",value:function(){var e=this.x,t=this.y,n=this.z,i=this.w;return e*e+t*t+n*n+i*i}},{key:"normalize",value:function(){return e.normalize(this,this),this}},{key:"toEuler",value:function(e){this.toYawPitchRoll(e);var t=e.x;return e.x=e.y,e.y=t,e}},{key:"toYawPitchRoll",value:function(e){var t=this.x,n=this.y,i=this.z,r=this.w,a=t*t,o=n*n,s=i*i,u=t*n,l=i*r,c=i*t,h=n*r,d=n*i,f=t*r;return e.y=Math.asin(2*(f-d)),Math.cos(e.y)>R.zeroTolerance?(e.z=Math.atan2(2*(u+l),1-2*(s+a)),e.x=Math.atan2(2*(c+h),1-2*(o+a))):(e.z=Math.atan2(-2*(u-l),1-2*(o+s)),e.x=0),e}},{key:"toArray",value:function(e){var t=arguments.length>1&&void 0!==arguments[1]?arguments[1]:0;e[t]=this.x,e[t+1]=this.y,e[t+2]=this.z,e[t+3]=this.w}},{key:"clone",value:function(){return new e(this.x,this.y,this.z,this.w)}},{key:"cloneTo",value:function(e){return e.x=this.x,e.y=this.y,e.z=this.z,e.w=this.w,e}},{key:"rotateX",value:function(t){return e.rotateX(this,t,this),this}},{key:"rotateY",value:function(t){return e.rotateY(this,t,this),this}},{key:"rotateZ",value:function(t){return e.rotateZ(this,t,this),this}},{key:"rotationAxisAngle",value:function(t,n){return e.rotationAxisAngle(t,n,this),this}},{key:"multiply",value:function(t){return e.multiply(this,t,this),this}},{key:"invert",value:function(){return e.invert(this,this),this}},{key:"dot",value:function(t){return e.dot(this,t)}},{key:"lerp",value:function(t,n){return e.lerp(this,t,n,this),this}}]),e}();O._tempVector3=new w;var F=function(){function e(){var t=arguments.length>0&&void 0!==arguments[0]?arguments[0]:1,i=arguments.length>1&&void 0!==arguments[1]?arguments[1]:0,r=arguments.length>2&&void 0!==arguments[2]?arguments[2]:0,a=arguments.length>3&&void 0!==arguments[3]?arguments[3]:0,o=arguments.length>4&&void 0!==arguments[4]?arguments[4]:0,s=arguments.length>5&&void 0!==arguments[5]?arguments[5]:1,u=arguments.length>6&&void 0!==arguments[6]?arguments[6]:0,l=arguments.length>7&&void 0!==arguments[7]?arguments[7]:0,c=arguments.length>8&&void 0!==arguments[8]?arguments[8]:0,h=arguments.length>9&&void 0!==arguments[9]?arguments[9]:0,d=arguments.length>10&&void 0!==arguments[10]?arguments[10]:1,f=arguments.length>11&&void 0!==arguments[11]?arguments[11]:0,_=arguments.length>12&&void 0!==arguments[12]?arguments[12]:0,p=arguments.length>13&&void 0!==arguments[13]?arguments[13]:0,v=arguments.length>14&&void 0!==arguments[14]?arguments[14]:0,m=arguments.length>15&&void 0!==arguments[15]?arguments[15]:1;n(this,e),this.elements=new Float32Array(16);var g=this.elements;g[0]=t,g[1]=i,g[2]=r,g[3]=a,g[4]=o,g[5]=s,g[6]=u,g[7]=l,g[8]=c,g[9]=h,g[10]=d,g[11]=f,g[12]=_,g[13]=p,g[14]=v,g[15]=m}return r(e,[{key:"setValue",value:function(e,t,n,i,r,a,o,s,u,l,c,h,d,f,_,p){var v=this.elements;return v[0]=e,v[1]=t,v[2]=n,v[3]=i,v[4]=r,v[5]=a,v[6]=o,v[7]=s,v[8]=u,v[9]=l,v[10]=c,v[11]=h,v[12]=d,v[13]=f,v[14]=_,v[15]=p,this}},{key:"setValueByArray",value:function(e){for(var t=arguments.length>1&&void 0!==arguments[1]?arguments[1]:0,n=this.elements,i=0;i<16;i++)n[i]=e[i+t];return this}},{key:"toArray",value:function(e){var t=arguments.length>1&&void 0!==arguments[1]?arguments[1]:0,n=this.elements;e[t]=n[0],e[t+1]=n[1],e[t+2]=n[2],e[t+3]=n[3],e[t+4]=n[4],e[t+5]=n[5],e[t+6]=n[6],e[t+7]=n[7],e[t+8]=n[8],e[t+9]=n[9],e[t+10]=n[10],e[t+11]=n[11],e[t+12]=n[12],e[t+13]=n[13],e[t+14]=n[14],e[t+15]=n[15]}},{key:"clone",value:function(){var t=this.elements;return new e(t[0],t[1],t[2],t[3],t[4],t[5],t[6],t[7],t[8],t[9],t[10],t[11],t[12],t[13],t[14],t[15])}},{key:"cloneTo",value:function(e){var t=this.elements,n=e.elements;return n[0]=t[0],n[1]=t[1],n[2]=t[2],n[3]=t[3],n[4]=t[4],n[5]=t[5],n[6]=t[6],n[7]=t[7],n[8]=t[8],n[9]=t[9],n[10]=t[10],n[11]=t[11],n[12]=t[12],n[13]=t[13],n[14]=t[14],n[15]=t[15],e}},{key:"multiply",value:function(t){return e.multiply(this,t,this),this}},{key:"determinant",value:function(){var e=this.elements,t=e[0],n=e[1],i=e[2],r=e[3],a=e[4],o=e[5],s=e[6],u=e[7],l=e[8],c=e[9],h=e[10],d=e[11],f=e[12],_=e[13],p=e[14],v=e[15];return(t*o-n*a)*(h*v-d*p)-(t*s-i*a)*(c*v-d*_)+(t*u-r*a)*(c*p-h*_)+(n*s-i*o)*(l*v-d*f)-(n*u-r*o)*(l*p-h*f)+(i*u-r*s)*(l*_-c*f)}},{key:"decompose",value:function(t,n,i){var r=e._tempMat30,a=this.elements,o=r.elements,s=a[0],u=a[1],l=a[2],c=a[3],h=a[4],d=a[5],f=a[6],_=a[7],p=a[8],v=a[9],m=a[10],g=a[11];t.x=a[12],t.y=a[13],t.z=a[14];var y=Math.sign(s*u*l*c)<0?-1:1,x=Math.sign(h*d*f*_)<0?-1:1,T=Math.sign(p*v*m*g)<0?-1:1,A=y*Math.sqrt(s*s+u*u+l*l),S=x*Math.sqrt(h*h+d*d+f*f),E=T*Math.sqrt(p*p+v*v+m*m);if(i.x=A,i.y=S,i.z=E,Math.abs(A)<R.zeroTolerance||Math.abs(S)<R.zeroTolerance||Math.abs(E)<R.zeroTolerance)return n.identity(),!1;var C=1/A,b=1/S,w=1/E;return o[0]=s*C,o[1]=u*C,o[2]=l*C,o[3]=h*b,o[4]=d*b,o[5]=f*b,o[6]=p*w,o[7]=v*w,o[8]=m*w,O.rotationMatrix3x3(r,n),!0}},{key:"getRotation",value:function(e){var t=this.elements,n=t[0]+t[5]+t[10];if(n>R.zeroTolerance){var i=2*Math.sqrt(n+1);e.w=.25*i,e.x=(t[6]-t[9])/i,e.y=(t[8]-t[2])/i,e.z=(t[1]-t[4])/i}else if(t[0]>t[5]&&t[0]>t[10]){var r=2*Math.sqrt(1+t[0]-t[5]-t[10]);e.w=(t[6]-t[9])/r,e.x=.25*r,e.y=(t[1]+t[4])/r,e.z=(t[8]+t[2])/r}else if(t[5]>t[10]){var a=2*Math.sqrt(1+t[5]-t[0]-t[10]);e.w=(t[8]-t[2])/a,e.x=(t[1]+t[4])/a,e.y=.25*a,e.z=(t[6]+t[9])/a}else{var o=2*Math.sqrt(1+t[10]-t[0]-t[5]);e.w=(t[1]-t[4])/o,e.x=(t[8]+t[2])/o,e.y=(t[6]+t[9])/o,e.z=.25*o}return e}},{key:"getScaling",value:function(e){var t=this.elements,n=t[0],i=t[1],r=t[2],a=t[4],o=t[5],s=t[6],u=t[8],l=t[9],c=t[10];return e.x=Math.sqrt(n*n+i*i+r*r),e.y=Math.sqrt(a*a+o*o+s*s),e.z=Math.sqrt(u*u+l*l+c*c),e}},{key:"getTranslation",value:function(e){var t=this.elements;return e.x=t[12],e.y=t[13],e.z=t[14],e}},{key:"identity",value:function(){var e=this.elements;return e[0]=1,e[1]=0,e[2]=0,e[3]=0,e[4]=0,e[5]=1,e[6]=0,e[7]=0,e[8]=0,e[9]=0,e[10]=1,e[11]=0,e[12]=0,e[13]=0,e[14]=0,e[15]=1,this}},{key:"invert",value:function(){return e.invert(this,this),this}},{key:"rotateAxisAngle",value:function(t,n){return e.rotateAxisAngle(this,t,n,this),this}},{key:"scale",value:function(t){return e.scale(this,t,this),this}},{key:"translate",value:function(t){return e.translate(this,t,this),this}},{key:"transpose",value:function(){return e.transpose(this,this),this}}],[{key:"multiply",value:function(e,t,n){var i=e.elements,r=t.elements,a=n.elements,o=i[0],s=i[1],u=i[2],l=i[3],c=i[4],h=i[5],d=i[6],f=i[7],_=i[8],p=i[9],v=i[10],m=i[11],g=i[12],y=i[13],x=i[14],T=i[15],A=r[0],S=r[1],E=r[2],C=r[3],b=r[4],R=r[5],w=r[6],M=r[7],L=r[8],P=r[9],O=r[10],F=r[11],k=r[12],I=r[13],D=r[14],N=r[15];a[0]=o*A+c*S+_*E+g*C,a[1]=s*A+h*S+p*E+y*C,a[2]=u*A+d*S+v*E+x*C,a[3]=l*A+f*S+m*E+T*C,a[4]=o*b+c*R+_*w+g*M,a[5]=s*b+h*R+p*w+y*M,a[6]=u*b+d*R+v*w+x*M,a[7]=l*b+f*R+m*w+T*M,a[8]=o*L+c*P+_*O+g*F,a[9]=s*L+h*P+p*O+y*F,a[10]=u*L+d*P+v*O+x*F,a[11]=l*L+f*P+m*O+T*F,a[12]=o*k+c*I+_*D+g*N,a[13]=s*k+h*I+p*D+y*N,a[14]=u*k+d*I+v*D+x*N,a[15]=l*k+f*I+m*D+T*N}},{key:"equals",value:function(e,t){var n=e.elements,i=t.elements;return R.equals(n[0],i[0])&&R.equals(n[1],i[1])&&R.equals(n[2],i[2])&&R.equals(n[3],i[3])&&R.equals(n[4],i[4])&&R.equals(n[5],i[5])&&R.equals(n[6],i[6])&&R.equals(n[7],i[7])&&R.equals(n[8],i[8])&&R.equals(n[9],i[9])&&R.equals(n[10],i[10])&&R.equals(n[11],i[11])&&R.equals(n[12],i[12])&&R.equals(n[13],i[13])&&R.equals(n[14],i[14])&&R.equals(n[15],i[15])}},{key:"rotationQuaternion",value:function(e,t){var n=t.elements,i=e.x,r=e.y,a=e.z,o=e.w,s=i+i,u=r+r,l=a+a,c=i*s,h=r*s,d=r*u,f=a*s,_=a*u,p=a*l,v=o*s,m=o*u,g=o*l;n[0]=1-d-p,n[1]=h+g,n[2]=f-m,n[3]=0,n[4]=h-g,n[5]=1-c-p,n[6]=_+v,n[7]=0,n[8]=f+m,n[9]=_-v,n[10]=1-c-d,n[11]=0,n[12]=0,n[13]=0,n[14]=0,n[15]=1}},{key:"rotationAxisAngle",value:function(e,t,n){var i,r,a,o=n.elements,s=e.x,u=e.y,l=e.z,c=Math.sqrt(s*s+u*u+l*l);Math.abs(c)<R.zeroTolerance||(s*=c=1/c,u*=c,l*=c,i=Math.sin(t),a=1-(r=Math.cos(t)),o[0]=s*s*a+r,o[1]=u*s*a+l*i,o[2]=l*s*a-u*i,o[3]=0,o[4]=s*u*a-l*i,o[5]=u*u*a+r,o[6]=l*u*a+s*i,o[7]=0,o[8]=s*l*a+u*i,o[9]=u*l*a-s*i,o[10]=l*l*a+r,o[11]=0,o[12]=0,o[13]=0,o[14]=0,o[15]=1)}},{key:"rotationTranslation",value:function(t,n,i){e.rotationQuaternion(t,i);var r=i.elements;r[12]=n.x,r[13]=n.y,r[14]=n.z}},{key:"affineTransformation",value:function(e,t,n,i){var r=i.elements,a=t.x,o=t.y,s=t.z,u=t.w,l=a+a,c=o+o,h=s+s,d=a*l,f=a*c,_=a*h,p=o*c,v=o*h,m=s*h,g=u*l,y=u*c,x=u*h,T=e.x,A=e.y,S=e.z;r[0]=(1-(p+m))*T,r[1]=(f+x)*T,r[2]=(_-y)*T,r[3]=0,r[4]=(f-x)*A,r[5]=(1-(d+m))*A,r[6]=(v+g)*A,r[7]=0,r[8]=(_+y)*S,r[9]=(v-g)*S,r[10]=(1-(d+p))*S,r[11]=0,r[12]=n.x,r[13]=n.y,r[14]=n.z,r[15]=1}},{key:"scaling",value:function(e,t){var n=t.elements;n[0]=e.x,n[1]=0,n[2]=0,n[3]=0,n[4]=0,n[5]=e.y,n[6]=0,n[7]=0,n[8]=0,n[9]=0,n[10]=e.z,n[11]=0,n[12]=0,n[13]=0,n[14]=0,n[15]=1}},{key:"translation",value:function(e,t){var n=t.elements;n[0]=1,n[1]=0,n[2]=0,n[3]=0,n[4]=0,n[5]=1,n[6]=0,n[7]=0,n[8]=0,n[9]=0,n[10]=1,n[11]=0,n[12]=e.x,n[13]=e.y,n[14]=e.z,n[15]=1}},{key:"invert",value:function(e,t){var n=e.elements,i=t.elements,r=n[0],a=n[1],o=n[2],s=n[3],u=n[4],l=n[5],c=n[6],h=n[7],d=n[8],f=n[9],_=n[10],p=n[11],v=n[12],m=n[13],g=n[14],y=n[15],x=r*l-a*u,T=r*c-o*u,A=r*h-s*u,S=a*c-o*l,E=a*h-s*l,C=o*h-s*c,b=d*m-f*v,R=d*g-_*v,w=d*y-p*v,M=f*g-_*m,L=f*y-p*m,P=_*y-p*g,O=x*P-T*L+A*M+S*w-E*R+C*b;if(!O)return null;O=1/O,i[0]=(l*P-c*L+h*M)*O,i[1]=(o*L-a*P-s*M)*O,i[2]=(m*C-g*E+y*S)*O,i[3]=(_*E-f*C-p*S)*O,i[4]=(c*w-u*P-h*R)*O,i[5]=(r*P-o*w+s*R)*O,i[6]=(g*A-v*C-y*T)*O,i[7]=(d*C-_*A+p*T)*O,i[8]=(u*L-l*w+h*b)*O,i[9]=(a*w-r*L-s*b)*O,i[10]=(v*E-m*A+y*x)*O,i[11]=(f*A-d*E-p*x)*O,i[12]=(l*R-u*M-c*b)*O,i[13]=(r*M-a*R+o*b)*O,i[14]=(m*T-v*S-g*x)*O,i[15]=(d*S-f*T+_*x)*O}},{key:"lookAt",value:function(t,n,i,r){var a=r.elements,o=e._tempVec30,s=e._tempVec31,u=e._tempVec32;w.subtract(t,n,u),u.normalize(),w.cross(i,u,o),o.normalize(),w.cross(u,o,s),a[0]=o.x,a[1]=s.x,a[2]=u.x,a[3]=0,a[4]=o.y,a[5]=s.y,a[6]=u.y,a[7]=0,a[8]=o.z,a[9]=s.z,a[10]=u.z,a[11]=0,a[12]=-w.dot(o,t),a[13]=-w.dot(s,t),a[14]=-w.dot(u,t),a[15]=1}},{key:"ortho",value:function(e,t,n,i,r,a,o){var s=o.elements,u=1/(e-t),l=1/(n-i),c=1/(r-a);s[0]=-2*u,s[1]=0,s[2]=0,s[3]=0,s[4]=0,s[5]=-2*l,s[6]=0,s[7]=0,s[8]=0,s[9]=0,s[10]=2*c,s[11]=0,s[12]=(e+t)*u,s[13]=(i+n)*l,s[14]=(a+r)*c,s[15]=1}},{key:"perspective",value:function(e,t,n,i,r){var a=r.elements,o=1/Math.tan(e/2),s=1/(n-i);a[0]=o/t,a[1]=0,a[2]=0,a[3]=0,a[4]=0,a[5]=o,a[6]=0,a[7]=0,a[8]=0,a[9]=0,a[10]=(i+n)*s,a[11]=-1,a[12]=0,a[13]=0,a[14]=2*i*n*s,a[15]=0}},{key:"rotateAxisAngle",value:function(e,t,n,i){var r=t.x,a=t.y,o=t.z,s=Math.sqrt(r*r+a*a+o*o);if(!(Math.abs(s)<R.zeroTolerance)){var u,l,c,h=e.elements,d=i.elements;r*=s=1/s,a*=s,o*=s,u=Math.sin(n),c=1-(l=Math.cos(n));var f=h[0],_=h[1],p=h[2],v=h[3],m=h[4],g=h[5],y=h[6],x=h[7],T=h[8],A=h[9],S=h[10],E=h[11],C=r*r*c+l,b=a*r*c+o*u,w=o*r*c-a*u,M=r*a*c-o*u,L=a*a*c+l,P=o*a*c+r*u,O=r*o*c+a*u,F=a*o*c-r*u,k=o*o*c+l;d[0]=f*C+m*b+T*w,d[1]=_*C+g*b+A*w,d[2]=p*C+y*b+S*w,d[3]=v*C+x*b+E*w,d[4]=f*M+m*L+T*P,d[5]=_*M+g*L+A*P,d[6]=p*M+y*L+S*P,d[7]=v*M+x*L+E*P,d[8]=f*O+m*F+T*k,d[9]=_*O+g*F+A*k,d[10]=p*O+y*F+S*k,d[11]=v*O+x*F+E*k,e!==i&&(d[12]=h[12],d[13]=h[13],d[14]=h[14],d[15]=h[15])}}},{key:"scale",value:function(e,t,n){var i=e.elements,r=n.elements,a=t.x,o=t.y,s=t.z;r[0]=i[0]*a,r[1]=i[1]*a,r[2]=i[2]*a,r[3]=i[3]*a,r[4]=i[4]*o,r[5]=i[5]*o,r[6]=i[6]*o,r[7]=i[7]*o,r[8]=i[8]*s,r[9]=i[9]*s,r[10]=i[10]*s,r[11]=i[11]*s,r[12]=i[12],r[13]=i[13],r[14]=i[14],r[15]=i[15]}},{key:"translate",value:function(e,t,n){var i=e.elements,r=n.elements,a=t.x,o=t.y,s=t.z;if(e===n)r[12]=i[0]*a+i[4]*o+i[8]*s+i[12],r[13]=i[1]*a+i[5]*o+i[9]*s+i[13],r[14]=i[2]*a+i[6]*o+i[10]*s+i[14],r[15]=i[3]*a+i[7]*o+i[11]*s+i[15];else{var u=i[0],l=i[1],c=i[2],h=i[3],d=i[4],f=i[5],_=i[6],p=i[7],v=i[8],m=i[9],g=i[10],y=i[11];r[0]=u,r[1]=l,r[2]=c,r[3]=h,r[4]=d,r[5]=f,r[6]=_,r[7]=p,r[8]=v,r[9]=m,r[10]=g,r[11]=y,r[12]=u*a+d*o+v*s+i[12],r[13]=l*a+f*o+m*s+i[13],r[14]=c*a+_*o+g*s+i[14],r[15]=h*a+p*o+y*s+i[15]}}},{key:"transpose",value:function(e,t){var n=e.elements,i=t.elements;if(t===e){var r=n[1],a=n[2],o=n[3],s=n[6],u=n[7],l=n[11];i[1]=n[4],i[2]=n[8],i[3]=n[12],i[4]=r,i[6]=n[9],i[7]=n[13],i[8]=a,i[9]=s,i[11]=n[14],i[12]=o,i[13]=u,i[14]=l}else i[0]=n[0],i[1]=n[4],i[2]=n[8],i[3]=n[12],i[4]=n[1],i[5]=n[5],i[6]=n[9],i[7]=n[13],i[8]=n[2],i[9]=n[6],i[10]=n[10],i[11]=n[14],i[12]=n[3],i[13]=n[7],i[14]=n[11],i[15]=n[15]}}]),e}();F._tempVec30=new w,F._tempVec31=new w,F._tempVec32=new w,F._tempMat30=new P,F._tempMat40=new F,F._identity=new F(1,0,0,0,0,1,0,0,0,0,1,0,0,0,0,1);var k=function(){function e(t,i,r){n(this,e),this.min=new w,this.max=new w,this.corners=[],this.minWorld=new w,this.maxWorld=new w,this.cornersWorld=[],t.cloneTo(this.min),i.cloneTo(this.max),this.corners=this.getCornersFromMinMax(t,i),this.updateByModelMatrix(r)}return r(e,[{key:"getCornersFromMinMax",value:function(e,t){var n=e.x,i=e.y,r=e.z,a=t.x,o=t.y,s=t.z;return[new w(n,i,r),new w(a,o,s),new w(a,i,r),new w(n,o,r),new w(n,i,s),new w(a,o,r),new w(n,o,s),new w(a,i,s)]}},{key:"updateByModelMatrix",value:function(t){var n=this.minWorld,i=this.maxWorld;n.setValue(1/0,1/0,1/0),i.setValue(-1/0,-1/0,-1/0);for(var r=0;r<8;++r){var a=this.corners[r],o=e._tempVec3;w.transformCoordinate(a,t,o),w.min(n,o,n),w.max(i,o,i),this.cornersWorld[r]=new w,o.cloneTo(this.cornersWorld[r])}}},{key:"intersectsFrustum",value:function(e){for(var t=this.cornersWorld,n=0;n<6;n++){for(var i=e[n],r=!1,a=0;a<8;a++)if(b(i,t[a])>0)r=!0;else if(r)return E.INTERSECT;if(!r)return E.EXCLUDE}return E.INCLUDE}},{key:"isInFrustum",value:function(e){for(var t=this.cornersWorld,n=0;n<6;n++){for(var i=e[n],r=!1,a=0;a<8;a++)if(b(i,t[a])>0){r=!0;break}if(!r)return!1}return!0}}]),e}();k._tempVec3=new w;var I=function(){function e(t,i){n(this,e),this.origin=new w,this.direction=new w,t&&t.cloneTo(this.origin),i&&i.cloneTo(this.direction)}return r(e,[{key:"intersectPlane",value:function(e,t){var n=this.origin,i=w.dot(t,this.direction);if(Math.abs(i)>1e-6){var r=new w;w.subtract(e,n,r);var a=w.dot(r,t)/i;if(a>=0)return a}return!1}},{key:"getPoint",value:function(e){var t=new w;return w.scale(this.direction,e,t),t.add(this.origin)}},{key:"intersectSphere",value:function(e,t){var n=this.direction,i=new w;w.subtract(this.origin,e,i);var r=w.dot(n,n),a=2*w.dot(n,i),o=w.dot(i,i)-t*t,s=this._solveQuadratic(r,a,o);return!!s&&s[0]}},{key:"intersectAABB",value:function(e,t){var n=this.direction,i=this.origin,r=new w(1/n.x,1/n.y,1/n.z),a=[t,e],o=[n.x<0?1:0,n.y<0?1:0,n.z<0?1:0],s=(a[o[0]].x-i.x)*r.x,u=(a[1-o[0]].x-i.x)*r.x,l=(a[o[1]].y-i.y)*r.y,c=(a[1-o[1]].y-i.y)*r.y;if(s>c||l>u)return!1;l>s&&(s=l),c<u&&(u=c);var h=(a[o[2]].z-i.z)*r.z,d=(a[1-o[2]].z-i.z)*r.z;if(s>d||h>u)return!1;h>s&&(s=h),d<u&&(u=d);var f=s;return!(f<0&&(f=u)<0)&&f}},{key:"_solveQuadratic",value:function(e,t,n){var i=t*t-4*e*n;if(i<0)return!1;if(0==i){var r=-.5*t/e;return[r,r]}var a=Math.sqrt(i),o=t>0?-.5*(t+a):-.5*(t-a),s=o/e,u=n/o;return s<=u?[s,u]:[u,s]}}]),e}(),D=function e(){n(this,e),this.distance=Number.MAX_VALUE,this.collider=null,this.point=null},N=R.zeroTolerance,B=function(){function e(t,i,r){n(this,e),this.radius=void 0!==t?t:1,this.phi=void 0!==i?i:0,this.theta=void 0!==r?r:0}return r(e,[{key:"set",value:function(e,t,n){return this.radius=e,this.phi=t,this.theta=n,this}},{key:"makeSafe",value:function(){return this.phi=R.clamp(this.phi,N,Math.PI-N),this}},{key:"setFromVec3",value:function(e){return this.radius=e.length(),0===this.radius?(this.theta=0,this.phi=0):(this.theta=Math.atan2(e.x,e.z),this.phi=Math.acos(R.clamp(e.y/this.radius,-1,1))),this}},{key:"setToVec3",value:function(e){var t=Math.sin(this.phi)*this.radius;return e.x=t*Math.sin(this.theta),e.y=Math.cos(this.phi)*this.radius,e.z=t*Math.cos(this.theta),this}}]),e}(),z=function(){function e(){var t=arguments.length>0&&void 0!==arguments[0]?arguments[0]:0,i=arguments.length>1&&void 0!==arguments[1]?arguments[1]:0;n(this,e),this.x=t,this.y=i}return r(e,null,[{key:"add",value:function(e,t,n){n.x=e.x+t.x,n.y=e.y+t.y}},{key:"subtract",value:function(e,t,n){n.x=e.x-t.x,n.y=e.y-t.y}},{key:"multiply",value:function(e,t,n){n.x=e.x*t.x,n.y=e.y*t.y}},{key:"divide",value:function(e,t,n){n.x=e.x/t.x,n.y=e.y/t.y}},{key:"dot",value:function(e,t){return e.x*t.x+e.y*t.y}},{key:"distance",value:function(e,t){var n=t.x-e.x,i=t.y-e.y;return Math.sqrt(n*n+i*i)}},{key:"distanceSquared",value:function(e,t){var n=t.x-e.x,i=t.y-e.y;return n*n+i*i}},{key:"equals",value:function(e,t){return R.equals(e.x,t.x)&&R.equals(e.y,t.y)}},{key:"lerp",value:function(e,t,n,i){var r=e.x,a=e.y;i.x=r+(t.x-r)*n,i.y=a+(t.y-a)*n}},{key:"max",value:function(e,t,n){n.x=Math.max(e.x,t.x),n.y=Math.max(e.y,t.y)}},{key:"min",value:function(e,t,n){n.x=Math.min(e.x,t.x),n.y=Math.min(e.y,t.y)}},{key:"negate",value:function(e,t){t.x=-e.x,t.y=-e.y}},{key:"normalize",value:function(e,t){var n=e.x,i=e.y,r=Math.sqrt(n*n+i*i);r>R.zeroTolerance&&(r=1/r,t.x=n*r,t.y=i*r)}},{key:"scale",value:function(e,t,n){n.x=e.x*t,n.y=e.y*t}}]),r(e,[{key:"setValue",value:function(e,t){return this.x=e,this.y=t,this}},{key:"setValueByArray",value:function(e){var t=arguments.length>1&&void 0!==arguments[1]?arguments[1]:0;return this.x=e[t],this.y=e[t+1],this}},{key:"add",value:function(e){return this.x+=e.x,this.y+=e.y,this}},{key:"subtract",value:function(e){return this.x-=e.x,this.y-=e.y,this}},{key:"multiply",value:function(e){return this.x*=e.x,this.y*=e.y,this}},{key:"divide",value:function(e){return this.x/=e.x,this.y/=e.y,this}},{key:"length",value:function(){var e=this.x,t=this.y;return Math.sqrt(e*e+t*t)}},{key:"lengthSquared",value:function(){var e=this.x,t=this.y;return e*e+t*t}},{key:"negate",value:function(){return this.x=-this.x,this.y=-this.y,this}},{key:"normalize",value:function(){return e.normalize(this,this),this}},{key:"scale",value:function(e){return this.x*=e,this.y*=e,this}},{key:"toArray",value:function(e){var t=arguments.length>1&&void 0!==arguments[1]?arguments[1]:0;e[t]=this.x,e[t+1]=this.y}},{key:"clone",value:function(){return new e(this.x,this.y)}},{key:"cloneTo",value:function(e){return e.x=this.x,e.y=this.y,e}}]),e}();z._zero=new z(0,0),z._one=new z(1,1);var G,U=function(){function e(){var t=arguments.length>0&&void 0!==arguments[0]?arguments[0]:0,i=arguments.length>1&&void 0!==arguments[1]?arguments[1]:0,r=arguments.length>2&&void 0!==arguments[2]?arguments[2]:0,a=arguments.length>3&&void 0!==arguments[3]?arguments[3]:0;n(this,e),this.x=t,this.y=i,this.z=r,this.w=a}return r(e,null,[{key:"add",value:function(e,t,n){n.x=e.x+t.x,n.y=e.y+t.y,n.z=e.z+t.z,n.w=e.w+t.w}},{key:"subtract",value:function(e,t,n){n.x=e.x-t.x,n.y=e.y-t.y,n.z=e.z-t.z,n.w=e.w-t.w}},{key:"multiply",value:function(e,t,n){n.x=e.x*t.x,n.y=e.y*t.y,n.z=e.z*t.z,n.w=e.w*t.w}},{key:"divide",value:function(e,t,n){n.x=e.x/t.x,n.y=e.y/t.y,n.z=e.z/t.z,n.w=e.w/t.w}},{key:"dot",value:function(e,t){return e.x*t.x+e.y*t.y+e.z*t.z+e.w*t.w}},{key:"distance",value:function(e,t){var n=t.x-e.x,i=t.y-e.y,r=t.z-e.z,a=t.w-e.w;return Math.sqrt(n*n+i*i+r*r+a*a)}},{key:"distanceSquared",value:function(e,t){var n=t.x-e.x,i=t.y-e.y,r=t.z-e.z,a=t.w-e.w;return n*n+i*i+r*r+a*a}},{key:"equals",value:function(e,t){return R.equals(e.x,t.x)&&R.equals(e.y,t.y)&&R.equals(e.z,t.z)&&R.equals(e.w,t.w)}},{key:"lerp",value:function(e,t,n,i){var r=e.x,a=e.y,o=e.z,s=e.w;i.x=r+(t.x-r)*n,i.y=a+(t.y-a)*n,i.z=o+(t.z-o)*n,i.w=s+(t.w-s)*n}},{key:"max",value:function(e,t,n){n.x=Math.max(e.x,t.x),n.y=Math.max(e.y,t.y),n.z=Math.max(e.z,t.z),n.w=Math.max(e.w,t.w)}},{key:"min",value:function(e,t,n){n.x=Math.min(e.x,t.x),n.y=Math.min(e.y,t.y),n.z=Math.min(e.z,t.z),n.w=Math.min(e.w,t.w)}},{key:"negate",value:function(e,t){t.x=-e.x,t.y=-e.y,t.z=-e.z,t.w=-e.w}},{key:"normalize",value:function(e,t){var n=e.x,i=e.y,r=e.z,a=e.w,o=Math.sqrt(n*n+i*i+r*r+a*a);o>R.zeroTolerance&&(o=1/o,t.x=n*o,t.y=i*o,t.z=r*o,t.w=a*o)}},{key:"scale",value:function(e,t,n){n.x=e.x*t,n.y=e.y*t,n.z=e.z*t,n.w=e.w*t}},{key:"transform",value:function(e,t,n){var i=e.x,r=e.y,a=e.z,o=e.w,s=t.elements;n.x=i*s[0]+r*s[4]+a*s[8]+o*s[12],n.y=i*s[1]+r*s[5]+a*s[9]+o*s[13],n.z=i*s[2]+r*s[6]+a*s[10]+o*s[14],n.w=i*s[3]+r*s[7]+a*s[11]+o*s[15]}},{key:"transformByQuat",value:function(e,t,n){var i=e.x,r=e.y,a=e.z,o=e.w,s=t.x,u=t.y,l=t.z,c=t.w,h=c*i+u*a-l*r,d=c*r+l*i-s*a,f=c*a+s*r-u*i,_=-s*i-u*r-l*a;n.x=h*c-_*s-d*l+f*u,n.y=d*c-_*u-f*s+h*l,n.z=f*c-_*l-h*u+d*s,n.w=o}}]),r(e,[{key:"setValue",value:function(e,t,n,i){return this.x=e,this.y=t,this.z=n,this.w=i,this}},{key:"setValueByArray",value:function(e){var t=arguments.length>1&&void 0!==arguments[1]?arguments[1]:0;return this.x=e[t],this.y=e[t+1],this.z=e[t+2],this.w=e[t+3],this}},{key:"add",value:function(e){return this.x+=e.x,this.y+=e.y,this.z+=e.z,this.w+=e.w,this}},{key:"subtract",value:function(e){return this.x-=e.x,this.y-=e.y,this.z-=e.z,this.w-=e.w,this}},{key:"multiply",value:function(e){return this.x*=e.x,this.y*=e.y,this.z*=e.z,this.w*=e.w,this}},{key:"divide",value:function(e){return this.x/=e.x,this.y/=e.y,this.z/=e.z,this.w/=e.w,this}},{key:"length",value:function(){var e=this.x,t=this.y,n=this.z,i=this.w;return Math.sqrt(e*e+t*t+n*n+i*i)}},{key:"lengthSquared",value:function(){var e=this.x,t=this.y,n=this.z,i=this.w;return e*e+t*t+n*n+i*i}},{key:"negate",value:function(){return this.x=-this.x,this.y=-this.y,this.z=-this.z,this.w=-this.w,this}},{key:"normalize",value:function(){return e.normalize(this,this),this}},{key:"scale",value:function(e){return this.x*=e,this.y*=e,this.z*=e,this.w*=e,this}},{key:"toArray",value:function(e){var t=arguments.length>1&&void 0!==arguments[1]?arguments[1]:0;e[t]=this.x,e[t+1]=this.y,e[t+2]=this.z,e[t+3]=this.w}},{key:"clone",value:function(){return new e(this.x,this.y,this.z,this.w)}},{key:"cloneTo",value:function(e){return e.x=this.x,e.y=this.y,e.z=this.z,e.w=this.w,e}}]),e}();U._zero=new U(0,0,0,0),U._one=new U(1,1,1,1),(G=e.AssetPromiseStatus||(e.AssetPromiseStatus={}))[G.Success=0]="Success",G[G.Pending=1]="Pending",G[G.Failed=2]="Failed";var V=function(e){l(i,e);var t=m(i);function i(e){var r,a;n(this,i);var o=function(e){if(!(e<=r._progress)){r._progress=e;var t,n=S(r._listeners);try{for(n.s();!(t=n.n()).done;){(0,t.value)(e)}}catch(e){n.e(e)}finally{n.f()}}};return(r=t.call(this,(function(t,n){e((function(e){Promise.resolve().then((function(){o(1),r._status=0,t(e)}))}),a=function(e){Promise.resolve().then((function(){r._status=2,n(e)}))},(function(e){Promise.resolve().then((function(){o(e)}))}))})))._reject=a,r._listeners=new Set,r._progress=0,r._status=1,r}return r(i,[{key:"onProgress",value:function(e){return this._listeners.add(e),this}},{key:"cancel",value:function(){return 1!==this._status||this._reject("Promise Canceled"),this}},{key:"status",get:function(){return this._status}},{key:"progress",get:function(){return this._progress}}],[{key:"all",value:function(e){return new i((function(t,n,i){if(!Array.isArray(e))return t([e]);var r=0,a=e.length,o=new Array(a);e.forEach((function(e,s){Promise.resolve(e).then((function(e){o[s]=e,i((r+=1)/a),r==a&&t(o)})).catch((function(e){return n(e)}))}))}))}}]),i}(_(Promise)),H={isArray:"isArray"in Array?Array.isArray:function(e){return"[object Array]"===toString.call(e)},isArrayLike:function(e){return!!e&&"number"==typeof e.length&&"function"!=typeof e},clone:function(e){if("object"!==t(e)||null===e)return e;var n;if(H.isArrayLike(e)){n=e.slice();for(var i=0,r=e.length;i<r;i++)n[i]=H.clone(e[i])}else for(var a in n={},e)e.hasOwnProperty(a)&&(n[a]=H.clone(e[a]));return n},downloadBlob:function(e){var t=arguments.length>1&&void 0!==arguments[1]?arguments[1]:"";if(navigator&&navigator.msSaveBlob)navigator.msSaveBlob(e,t);else{var n=window.URL.createObjectURL(e),i=document.createElement("a");document.body.appendChild(i),i.style.display="none",i.href=n,i.download=t,i.addEventListener("click",(function(){i.parentElement&&i.parentElement.removeChild(i)})),i.click(),window.URL.revokeObjectURL(n)}}};function j(e,t){var n=e.indexOf(t);if(n<0)return!1;var i=e.length-1;if(n!==i){var r=e[i];e[n]=r}return e.length--,!0}function W(e){return Object.keys(e).map((function(t){return e[t]}))}var q=function(){function e(t){n(this,e),this.engine=t,this.retryCount=1,this.retryInterval=0,this.timeout=2e4,this._assetPool=Object.create(null),this._assetUrlPool=Object.create(null),this._refObjectPool=Object.create(null),this._loadingPromises={}}return r(e,[{key:"load",value:function(e){var t=this;if(!Array.isArray(e))return this._loadSingleItem(e);var n=e.map((function(e){return t._loadSingleItem(e)}));return V.all(n)}},{key:"cancelNotLoaded",value:function(e){var t=this;if(e)if("string"==typeof e){var n;null===(n=this._loadingPromises[e])||void 0===n||n.cancel()}else e.forEach((function(e){var n;null===(n=t._loadingPromises[e])||void 0===n||n.cancel()}));else W(this._loadingPromises).forEach((function(e){e.cancel()}))}},{key:"gc",value:function(){for(var e=W(this._refObjectPool),t=0,n=e.length;t<n;t++)e[t].isGCIgnored||e[t].destroy()}},{key:"getAssetPath",value:function(e){return this._assetPool[e]}},{key:"_addAsset",value:function(e,t){this._assetPool[t.instanceId]=e,this._assetUrlPool[e]=t}},{key:"_deleteAsset",value:function(e){var t=e.instanceId,n=this._assetPool[t];n&&(delete this._assetPool[t],delete this._assetUrlPool[n])}},{key:"_addRefObject",value:function(e,t){this._refObjectPool[e]=t}},{key:"_deleteRefObject",value:function(e){delete this._refObjectPool[e]}},{key:"_assignDefaultOptions",value:function(t){var n,i,r,a,o;if(t.type=null!==(n=t.type)&&void 0!==n?n:e._getTypeByUrl(t.url),void 0===t.type)throw"asset type should be specified: ".concat(t.url);return t.retryCount=null!==(i=t.retryCount)&&void 0!==i?i:this.retryCount,t.timeout=null!==(r=t.timeout)&&void 0!==r?r:this.timeout,t.retryInterval=null!==(a=t.retryInterval)&&void 0!==a?a:this.retryInterval,t.url=null!==(o=t.url)&&void 0!==o?o:t.urls.join(","),t}},{key:"_loadSingleItem",value:function(t){var n=this,i=this._assignDefaultOptions("string"==typeof t?{url:t}:t),r=i.url;if(this._assetUrlPool[r])return new V((function(e){e(n._assetUrlPool[r])}));if(this._loadingPromises[r])return this._loadingPromises[i.url];var a=e._loaders[i.type],o=a.load(i,this);return this._loadingPromises[r]=o,o.then((function(e){a.useCache&&n._addAsset(r,e),delete n._loadingPromises[r]})).catch((function(){})),o}}],[{key:"_addLoader",value:function(e,t,n){this._loaders[e]=t;for(var i=0,r=n.length;i<r;i++)this._extTypeMapping[n[i]]=e}},{key:"_getTypeByUrl",value:function(e){var t=e.split("?")[0];return this._extTypeMapping[t.substring(t.lastIndexOf(".")+1)]}}]),e}();function X(e,t){var n=!(arguments.length>2&&void 0!==arguments[2])||arguments[2];return function(i){var r=new i(n);q._addLoader(e,r,t)}}q._loaders={},q._extTypeMapping={};var K,Q,Y=function(){function e(t){var i=arguments.length>1&&void 0!==arguments[1]?arguments[1]:null,r=arguments.length>2&&void 0!==arguments[2]?arguments[2]:{},a=!(arguments.length>3&&void 0!==arguments[3])||arguments[3];n(this,e),this._timeStamp=(new Date).getTime(),this._target=i,this.data=r,this._currentTarget=null,this._bubbles=a,this._propagationStopped=!1,this._type=t}return r(e,[{key:"propagationStopped",get:function(){return this._propagationStopped}},{key:"target",get:function(){return this._target},set:function(e){this._target=e}},{key:"timeStamp",get:function(){return this._timeStamp}},{key:"currentTarget",get:function(){return this._currentTarget},set:function(e){this._currentTarget=e}},{key:"bubbles",get:function(){return this._bubbles}},{key:"type",get:function(){return this._type}}]),r(e,[{key:"stopPropagation",value:function(){this._propagationStopped=!0}}]),e}();function J(e,t){ee.registerCloneMode(e,t,K.Ignore)}function Z(e,t){ee.registerCloneMode(e,t,K.Shallow)}function $(e,t){ee.registerCloneMode(e,t,K.Deep)}(Q=K||(K={}))[Q.Ignore=0]="Ignore",Q[Q.Assignment=1]="Assignment",Q[Q.Shallow=2]="Shallow",Q[Q.Deep=3]="Deep";var ee=function(){function e(){n(this,e)}return r(e,null,[{key:"registerCloneMode",value:function(t,n,i){var r=e._subCloneModeMap.get(t.constructor);r||(r=Object.create(null),e._subCloneModeMap.set(t.constructor,r)),r[n]=i}},{key:"getCloneModeMode",value:function(t){var n=e._cloneModeMap.get(t);if(!n){n=Object.create(null),e._cloneModeMap.set(t,n);for(var i=e._obejctType,r=e._subCloneModeMap;t!==i;){var a=r.get(t);a&&o(n,a),t=Object.getPrototypeOf(t)}}return n}}]),e}();ee._subCloneModeMap=new Map,ee._cloneModeMap=new Map,ee._obejctType=Object.getPrototypeOf(Object);var te=Object.defineProperty,ne=Object.getOwnPropertyDescriptor,ie=function(e,t,n,i){for(var r,a=i>1?void 0:i?ne(t,n):t,o=e.length-1;o>=0;o--)(r=e[o])&&(a=(i?r(t,n,a):r(a))||a);return i&&a&&te(t,n,a),a},re=function e(t){n(this,e),this.instanceId=++e._instanceIdCounter,this._engine=t};re._instanceIdCounter=0,ie([J],re.prototype,"instanceId",2),ie([J],re.prototype,"_engine",2);var ae=Object.defineProperty,oe=Object.getOwnPropertyDescriptor,se=function(e){l(i,e);var t=m(i);function i(){var e;return n(this,i),(e=t.apply(this,arguments))._evts=Object.create(null),e._evtCount=0,e}return r(i,[{key:"hasEvent",value:function(e){return null!=this._evts[e]}},{key:"eventNames",value:function(){return 0===this._evtCount?[]:Object.keys(this._evts)}},{key:"listenerCount",value:function(e){var t=this._evts[e];return t?t.fn?1:t.length:0}},{key:"dispatch",value:function(e,t){if(!this._evts[e])return!1;var n=this._evts[e];if(n.fn)n.once&&this.removeEventListener(e,n.fn),n.fn(t);else for(var i=n.length,r=0;r<i;r++)n[r].once&&this.removeEventListener(e,n[r].fn),n[r].fn(t);return!0}},{key:"on",value:function(e,t){return this.addEventListener(e,t)}},{key:"once",value:function(e,t){return this.addEventListener(e,t,!0)}},{key:"addEventListener",value:function(e,t,n){var i={fn:t,once:n},r=this._evts;return r[e]?r[e].fn?r[e]=[r[e],i]:r[e].push(i):(r[e]=i,this._evtCount++),this}},{key:"off",value:function(e,t){if(!this._evts[e])return this;if(!t)return this._clearEvent(e),this;var n=this._evts[e];if(n.fn&&n.fn===t)this._clearEvent(e);else{var i=n.indexOf(t);if(i>-1){var r=n[n.length-1];n[i]=r,n.length--,1===n.length&&(this._evts[e]=n[0])}}return this}},{key:"removeEventListener",value:function(e,t){return this.off(e,t)}},{key:"removeAllEventListeners",value:function(e){e?this._evts[e]&&this._clearEvent(e):(this._evts=Object.create(null),this._evtCount=0)}},{key:"trigger",value:function(e){this.dispatch(e.type,e.data)}},{key:"_clearEvent",value:function(e){0==--this._evtCount?this._evts=Object.create(null):delete this._evts[e]}}]),i}(re);!function(e,t,n,i){for(var r,a=i>1?void 0:i?oe(t,n):t,o=e.length-1;o>=0;o--)(r=e[o])&&(a=(i?r(t,n,a):r(a))||a);i&&a&&ae(t,n,a)}([J],se.prototype,"_evts",2);var ue,le,ce,he,de,fe,_e,pe,ve,me,ge,ye,xe,Te,Ae,Se,Ee,Ce=function(e){},be=console.log.bind(console),Re=console.info.bind(console),we=console.warn.bind(console),Me=console.error.bind(console),Le={debug:Ce,info:Ce,warn:Ce,error:Ce,isEnabled:!1,enable:function(){this.debug=be,this.info=Re,this.warn=we,this.error=Me,this.isEnabled=!0},disable:function(){this.debug=Ce,this.info=Ce,this.warn=Ce,this.error=Ce,this.isEnabled=!1}},Pe=function(){function e(){n(this,e),this._clock=performance||Date,this._timeScale=1,this._deltaTime=1e-4;var t=this._clock.now();this._startTime=t,this._lastTickTime=t}return r(e,[{key:"reset",value:function(){this._lastTickTime=this._clock.now()}},{key:"tick",value:function(){var e=this.nowTime;this._deltaTime=(e-this._lastTickTime)*this._timeScale,this._lastTickTime=e}},{key:"nowTime",get:function(){return this._clock.now()}},{key:"deltaTime",get:function(){return this._deltaTime}},{key:"timeScale",get:function(){return this._timeScale},set:function(e){this._timeScale=e}},{key:"unscaledDeltaTime",get:function(){return this._deltaTime/this._timeScale}},{key:"timeSinceStartup",get:function(){return this.nowTime-this._startTime}}]),e}();(ue=e.InternalAssetType||(e.InternalAssetType={}))[ue.Scene=1]="Scene",ue[ue.Cache=2]="Cache",(le=e.ClearMode||(e.ClearMode={}))[le.DONT_CLEAR=0]="DONT_CLEAR",le[le.SOLID_COLOR=1]="SOLID_COLOR",le[le.DEPTH_ONLY=2]="DEPTH_ONLY",le[le.COLOR_ONLY=3]="COLOR_ONLY",le[le.STENCIL_ONLY=4]="STENCIL_ONLY",le[le.ALL_CLEAR=5]="ALL_CLEAR",(ce=e.MaterialType||(e.MaterialType={}))[ce.OPAQUE=1e3]="OPAQUE",ce[ce.TRANSPARENT=2e3]="TRANSPARENT",(he=e.RenderState||(e.RenderState={}))[he.BLEND=3042]="BLEND",he[he.CULL_FACE=2884]="CULL_FACE",he[he.DEPTH_TEST=2929]="DEPTH_TEST",he[he.ALPHA_TEST=3008]="ALPHA_TEST",he[he.POLYGON_OFFSET_FILL=32823]="POLYGON_OFFSET_FILL",he[he.SAMPLE_ALPHA_TO_COVERAGE=32926]="SAMPLE_ALPHA_TO_COVERAGE",he[he.SCISSOR_TEST=3089]="SCISSOR_TEST",(de=e.FrontFace||(e.FrontFace={}))[de.CW=2304]="CW",de[de.CCW=2305]="CCW",(fe=e.CullFace||(e.CullFace={}))[fe.FRONT=1028]="FRONT",fe[fe.BACK=1029]="BACK",fe[fe.FRONT_AND_BACK=1032]="FRONT_AND_BACK",(_e=e.Side||(e.Side={}))[_e.FRONT=0]="FRONT",_e[_e.BACK=1]="BACK",_e[_e.NONE=2]="NONE",_e[_e.DOUBLE=3]="DOUBLE",(pe=e.CompFunc||(e.CompFunc={}))[pe.NEVER=512]="NEVER",pe[pe.LESS=513]="LESS",pe[pe.EQUAL=514]="EQUAL",pe[pe.LEQUAL=515]="LEQUAL",pe[pe.GREATER=516]="GREATER",pe[pe.NOTEQUAL=517]="NOTEQUAL",pe[pe.GEQUAL=518]="GEQUAL",pe[pe.ALWAYS=519]="ALWAYS",(ve=e.TextureFilter||(e.TextureFilter={}))[ve.NEAREST=9728]="NEAREST",ve[ve.LINEAR=9729]="LINEAR",ve[ve.NEAREST_MIPMAP_NEAREST=9984]="NEAREST_MIPMAP_NEAREST",ve[ve.LINEAR_MIPMAP_NEAREST=9985]="LINEAR_MIPMAP_NEAREST",ve[ve.NEAREST_MIPMAP_LINEAR=9986]="NEAREST_MIPMAP_LINEAR",ve[ve.LINEAR_MIPMAP_LINEAR=9987]="LINEAR_MIPMAP_LINEAR",(me=e.DataType||(e.DataType={}))[me.FLOAT=5126]="FLOAT",me[me.FLOAT_VEC2=35664]="FLOAT_VEC2",me[me.FLOAT_VEC3=35665]="FLOAT_VEC3",me[me.FLOAT_VEC4=35666]="FLOAT_VEC4",me[me.INT=5124]="INT",me[me.INT_VEC2=35667]="INT_VEC2",me[me.INT_VEC3=35668]="INT_VEC3",me[me.INT_VEC4=35669]="INT_VEC4",me[me.BOOL=35670]="BOOL",me[me.BOOL_VEC2=35671]="BOOL_VEC2",me[me.BOOL_VEC3=35672]="BOOL_VEC3",me[me.BOOL_VEC4=35673]="BOOL_VEC4",me[me.FLOAT_MAT2=35674]="FLOAT_MAT2",me[me.FLOAT_MAT3=35675]="FLOAT_MAT3",me[me.FLOAT_MAT4=35676]="FLOAT_MAT4",me[me.FLOAT_ARRAY=35677]="FLOAT_ARRAY",me[me.FLOAT_VEC2_ARRAY=1e5]="FLOAT_VEC2_ARRAY",me[me.FLOAT_VEC3_ARRAY=100001]="FLOAT_VEC3_ARRAY",me[me.FLOAT_VEC4_ARRAY=100002]="FLOAT_VEC4_ARRAY",me[me.INT_ARRAY=100003]="INT_ARRAY",me[me.INT_VEC2_ARRAY=100004]="INT_VEC2_ARRAY",me[me.INT_VEC3_ARRAY=100005]="INT_VEC3_ARRAY",me[me.INT_VEC4_ARRAY=100006]="INT_VEC4_ARRAY",me[me.FLOAT_MAT2_ARRAY=100007]="FLOAT_MAT2_ARRAY",me[me.FLOAT_MAT3_ARRAY=100008]="FLOAT_MAT3_ARRAY",me[me.FLOAT_MAT4_ARRAY=100009]="FLOAT_MAT4_ARRAY",me[me.SAMPLER_2D_ARRAY=100010]="SAMPLER_2D_ARRAY",me[me.SAMPLER_CUBE_ARRAY=100011]="SAMPLER_CUBE_ARRAY",me[me.SAMPLER_2D=35678]="SAMPLER_2D",me[me.SAMPLER_CUBE=35680]="SAMPLER_CUBE",me[me.BYTE=5120]="BYTE",me[me.UNSIGNED_BYTE=5121]="UNSIGNED_BYTE",me[me.SHORT=5122]="SHORT",me[me.UNSIGNED_SHORT=5123]="UNSIGNED_SHORT",me[me.UNSIGNED_INT=5125]="UNSIGNED_INT",(ge=e.UniformSemantic||(e.UniformSemantic={}))[ge.LOCAL=1]="LOCAL",ge[ge.MODEL=2]="MODEL",ge[ge.VIEW=3]="VIEW",ge[ge.PROJECTION=4]="PROJECTION",ge[ge.MODELVIEW=5]="MODELVIEW",ge[ge.VIEWPROJECTION=21]="VIEWPROJECTION",ge[ge.MODELVIEWPROJECTION=6]="MODELVIEWPROJECTION",ge[ge.MODELINVERSE=7]="MODELINVERSE",ge[ge.VIEWINVERSE=8]="VIEWINVERSE",ge[ge.PROJECTIONINVERSE=9]="PROJECTIONINVERSE",ge[ge.MODELVIEWINVERSE=10]="MODELVIEWINVERSE",ge[ge.MODELVIEWPROJECTIONINVERSE=11]="MODELVIEWPROJECTIONINVERSE",ge[ge.MODELINVERSETRANSPOSE=12]="MODELINVERSETRANSPOSE",ge[ge.MODELVIEWINVERSETRANSPOSE=13]="MODELVIEWINVERSETRANSPOSE",ge[ge.VIEWPORT=14]="VIEWPORT",ge[ge.JOINTMATRIX=15]="JOINTMATRIX",ge[ge.MORPHWEIGHTS=16]="MORPHWEIGHTS",ge[ge.EYEPOS=17]="EYEPOS",ge[ge.TIME=18]="TIME",ge[ge.JOINTTEXTURE=19]="JOINTTEXTURE",ge[ge.JOINTCOUNT=20]="JOINTCOUNT",(ye=e.BlendFunc||(e.BlendFunc={}))[ye.ZERO=0]="ZERO",ye[ye.ONE=1]="ONE",ye[ye.SRC_COLOR=768]="SRC_COLOR",ye[ye.ONE_MINUS_SRC_COLOR=769]="ONE_MINUS_SRC_COLOR",ye[ye.SRC_ALPHA=770]="SRC_ALPHA",ye[ye.ONE_MINUS_SRC_ALPHA=771]="ONE_MINUS_SRC_ALPHA",ye[ye.DST_ALPHA=772]="DST_ALPHA",ye[ye.ONE_MINUS_DST_ALPHA=773]="ONE_MINUS_DST_ALPHA",ye[ye.DST_COLOR=774]="DST_COLOR",ye[ye.ONE_MINUS_DST_COLOR=775]="ONE_MINUS_DST_COLOR",ye[ye.SRC_ALPHA_SATURATE=776]="SRC_ALPHA_SATURATE",ye[ye.enumANT_COLOR=32769]="enumANT_COLOR",ye[ye.ONE_MINUS_enumANT_COLOR=32770]="ONE_MINUS_enumANT_COLOR",ye[ye.enumANT_ALPHA=32771]="enumANT_ALPHA",ye[ye.ONE_MINUS_enumANT_ALPHA=32772]="ONE_MINUS_enumANT_ALPHA",(xe=e.MaskList||(e.MaskList={}))[xe.MASK1=1]="MASK1",xe[xe.MASK2=2]="MASK2",xe[xe.MASK3=4]="MASK3",xe[xe.MASK4=8]="MASK4",xe[xe.MASK5=16]="MASK5",xe[xe.MASK6=32]="MASK6",xe[xe.MASK7=64]="MASK7",xe[xe.MASK8=128]="MASK8",xe[xe.MASK9=256]="MASK9",xe[xe.MASK10=512]="MASK10",xe[xe.MASK11=1024]="MASK11",xe[xe.MASK12=2048]="MASK12",xe[xe.MASK13=4096]="MASK13",xe[xe.MASK14=8192]="MASK14",xe[xe.MASK15=16384]="MASK15",xe[xe.MASK16=32768]="MASK16",xe[xe.MASK17=65536]="MASK17",xe[xe.MASK18=131072]="MASK18",xe[xe.MASK19=262144]="MASK19",xe[xe.MASK20=524288]="MASK20",xe[xe.EVERYTHING=268435455]="EVERYTHING",xe[xe.SHADOW=268435456]="SHADOW",xe[xe.SHADOW_MAP=536870912]="SHADOW_MAP",(Te=e.RefreshRate||(e.RefreshRate={}))[Te.ONCE=1]="ONCE",Te[Te.EVERYFRAME=2]="EVERYFRAME",(Ae=e.BoundingType||(e.BoundingType={}))[Ae.AABB=0]="AABB",Ae[Ae.OBB=1]="OBB",Ae[Ae.SPHERE=2]="SPHERE",(Se=e.GLCapabilityType||(e.GLCapabilityType={})).standardDerivatives="OES_standard_derivatives",Se.shaderTextureLod="EXT_shader_texture_lod",Se.elementIndexUint="OES_element_index_uint",Se.depthTexture="WEBGL_depth_texture",Se.drawBuffers="WEBGL_draw_buffers",Se.vertexArrayObject="OES_vertex_array_object",Se.instancedArrays="ANGLE_instanced_arrays",Se.multipleSample="multipleSampleOnlySupportedInWebGL2",Se.textureFloat="OES_texture_float",Se.textureFloatLinear="OES_texture_float_linear",Se.textureHalfFloat="OES_texture_half_float",Se.textureHalfFloatLinear="OES_texture_half_float_linear",Se.WEBGL_colorBufferFloat="WEBGL_color_buffer_float",Se.colorBufferFloat="EXT_color_buffer_float",Se.colorBufferHalfFloat="EXT_color_buffer_half_float",Se.textureFilterAnisotropic="EXT_texture_filter_anisotropic",Se.astc="WEBGL_compressed_texture_astc",Se.astc_webkit="WEBKIT_WEBGL_compressed_texture_astc",Se.etc="WEBGL_compressed_texture_etc",Se.etc_webkit="WEBKIT_WEBGL_compressed_texture_etc",Se.etc1="WEBGL_compressed_texture_etc1",Se.etc1_webkit="WEBKIT_WEBGL_compressed_texture_etc1",Se.pvrtc="WEBGL_compressed_texture_pvrtc",Se.pvrtc_webkit="WEBKIT_WEBGL_compressed_texture_pvrtc",Se.s3tc="WEBGL_compressed_texture_s3tc",Se.s3tc_webkit="WEBKIT_WEBGL_compressed_texture_s3tc",(Ee=e.OITMode||(e.OITMode={}))[Ee.WEIGHTED_AVERAGE=0]="WEIGHTED_AVERAGE",Ee[Ee.DEPTH_PEEL=1]="DEPTH_PEEL",Ee[Ee.DUAL_DEPTH_PEEL=2]="DUAL_DEPTH_PEEL";var Oe,Fe=function(){function e(){var t=arguments.length>0&&void 0!==arguments[0]?arguments[0]:0;n(this,e),this.length=0,this._elements=new Array(t)}return r(e,[{key:"add",value:function(e){this.length===this._elements.length?this._elements.push(e):this._elements[this.length]=e,this.length++}},{key:"delete",value:function(e){var t=this._elements.indexOf(e);this.deleteByIndex(t)}},{key:"deleteByIndex",value:function(e){var t=this._elements,n=null,i=this.length-1;return e!==i&&(n=t[i],t[e]=n),this.length--,n}},{key:"garbageCollection",value:function(){this._elements.length=this.length}}]),e}(),ke=function(){function e(){n(this,e),this._onStartScripts=new Fe,this._onUpdateScripts=new Fe,this._onLateUpdateScripts=new Fe,this._destoryComponents=[],this._onUpdateAnimations=new Fe,this._renderers=new Fe,this._onUpdateRenderers=new Fe,this._componentsContainerPool=[]}return r(e,[{key:"addRenderer",value:function(e){e._rendererIndex=this._renderers.length,this._renderers.add(e)}},{key:"removeRenderer",value:function(e){var t=this._renderers.deleteByIndex(e._rendererIndex);t&&(t._rendererIndex=e._rendererIndex),e._rendererIndex=-1}},{key:"addOnStartScript",value:function(e){e._onStartIndex=this._onStartScripts.length,this._onStartScripts.add(e)}},{key:"removeOnStartScript",value:function(e){var t=this._onStartScripts.deleteByIndex(e._onStartIndex);t&&(t._onStartIndex=e._onStartIndex),e._onStartIndex=-1}},{key:"addOnUpdateScript",value:function(e){e._onUpdateIndex=this._onUpdateScripts.length,this._onUpdateScripts.add(e)}},{key:"removeOnUpdateScript",value:function(e){var t=this._onUpdateScripts.deleteByIndex(e._onUpdateIndex);t&&(t._onUpdateIndex=e._onUpdateIndex),e._onUpdateIndex=-1}},{key:"addOnLateUpdateScript",value:function(e){e._onLateUpdateIndex=this._onLateUpdateScripts.length,this._onLateUpdateScripts.add(e)}},{key:"removeOnLateUpdateScript",value:function(e){var t=this._onLateUpdateScripts.deleteByIndex(e._onLateUpdateIndex);t&&(t._onLateUpdateIndex=e._onLateUpdateIndex),e._onLateUpdateIndex=-1}},{key:"addOnUpdateAnimations",value:function(e){e._onUpdateIndex=this._onUpdateAnimations.length,this._onUpdateAnimations.add(e)}},{key:"removeOnUpdateAnimations",value:function(e){var t=this._onUpdateAnimations.deleteByIndex(e._onUpdateIndex);t&&(t._onUpdateIndex=e._onUpdateIndex),e._onUpdateIndex=-1}},{key:"addOnUpdateRenderers",value:function(e){e._onUpdateIndex=this._onUpdateRenderers.length,this._onUpdateRenderers.add(e)}},{key:"removeOnUpdateRenderers",value:function(e){var t=this._onUpdateRenderers.deleteByIndex(e._onUpdateIndex);t&&(t._onUpdateIndex=e._onUpdateIndex),e._onUpdateIndex=-1}},{key:"addDestoryComponent",value:function(e){this._destoryComponents.push(e)}},{key:"callScriptOnStart",value:function(){var e=this._onStartScripts;if(e.length>0){for(var t=e._elements,n=0;n<e.length;n++){var i=t[n];i._started=!0,i._onStartIndex=-1,i.onStart()}e.length=0}}},{key:"callScriptOnUpdate",value:function(e){for(var t=this._onUpdateScripts._elements,n=this._onUpdateScripts.length-1;n>=0;--n){var i=t[n];i._started&&i.onUpdate(e)}}},{key:"callScriptOnLateUpdate",value:function(e){for(var t=this._onLateUpdateScripts._elements,n=this._onLateUpdateScripts.length-1;n>=0;--n){var i=t[n];i._started&&i.onLateUpdate(e)}}},{key:"callAnimationUpdate",value:function(e){for(var t=this._onUpdateAnimations._elements,n=this._onUpdateAnimations.length-1;n>=0;--n)t[n].update(e)}},{key:"callRendererOnUpdate",value:function(e){for(var t=this._onUpdateRenderers._elements,n=this._onUpdateRenderers.length-1;n>=0;--n)t[n].update(e)}},{key:"callRender",value:function(e){for(var t=this._renderers._elements,n=this._renderers.length-1;n>=0;--n)t[n]._render(e)}},{key:"callComponentDestory",value:function(){var e=this._destoryComponents,t=e.length;if(t>0){for(var n=t-1;n>=0;--n)e[n].onDestroy();e.length=0}}},{key:"callCameraOnBeginRender",value:function(e){for(var t=e.entity._components,n=t.length-1;n>=0;--n){var i=t[n];i.onBeginRender&&i.onBeginRender(e)}}},{key:"callCameraOnEndRender",value:function(e){for(var t=e.entity._components,n=t.length-1;n>=0;--n){var i=t[n];i.onBeginRender&&i.onEndRender(e)}}},{key:"getActiveChangedTempList",value:function(){return this._componentsContainerPool.length?this._componentsContainerPool.pop():[]}},{key:"putActiveChangedTempList",value:function(e){e.length=0,this._componentsContainerPool.push(e)}}]),e}(),Ie=function(){function e(){n(this,e)}return r(e,null,[{key:"cloneComponent",value:function(t,n){for(var i=ee.getCloneModeMode(t.constructor),r=Object.keys(t),a=0,s=r.length;a<s;a++){var u=r[a];switch(i[u]){case void 0:case K.Assignment:n[u]=t[u];break;case K.Shallow:var l=t[u];if(l instanceof Object){var c=n[u];null==c&&(c=n[u]=l.constructor()),o(c,l)}else n[u]=l;break;case K.Deep:var h=t[u];if(h instanceof Object){var d=n[u];null==d&&(d=n[u]=h.constructor()),e._cloneComponentProp(h,d)}else n[u]=h}}}},{key:"_cloneComponentProp",value:function(t,n){var i=t.constructor;if(i===Object)for(var r=Object.keys(t),a=0,o=r.length;a<o;a++){var s=r[a],u=t[s];if(u instanceof Object){var l=n[s];null==l&&(n[s]=l=u.constructor()),e._cloneComponentProp(u,l)}else n[s]=u}else if(i===Array){var c=t,h=n,d=c.length;h.length=d;for(var f=0;f<d;f++){var _=c[f];if(_ instanceof Object){var p=h[f];null==p&&(h[f]=p=_.constructor()),e._cloneComponentProp(_,p)}else h[f]=_}}else t.cloneTo(n)}}]),e}(),De=function(){function e(){n(this,e)}return r(e,null,[{key:"register",value:function(e,t){this._addDependency(e,t,this._dependenciesMap),this._addDependency(t,e,this._invDependenciesMap)}},{key:"_addCheck",value:function(t,n){var i=e._dependenciesMap.get(n);if(i)for(var r=0,a=i.length;r<a;r++)if(!t.getComponent(i[r]))throw"you should add ".concat(i[r]," before adding ").concat(n)}},{key:"_removeCheck",value:function(t,n){var i=e._invDependenciesMap.get(n);if(i)for(var r=0,a=i.length;r<a;r++)if(t.getComponent(i[r]))throw"you should remove ".concat(i[r]," before adding ").concat(n)}},{key:"_addDependency",value:function(e,t,n){var i=n.get(e);i||(i=[],n.set(e,i)),-1===i.indexOf(t)&&i.push(t)}}]),e}();function Ne(){for(var e=arguments.length,t=new Array(e),n=0;n<e;n++)t[n]=arguments[n];return function(e){t.forEach((function(t){return De.register(e,t)}))}}De._dependenciesMap=new Map,De._invDependenciesMap=new Map,(Oe=e.Layer||(e.Layer={}))[Oe.Layer0=1]="Layer0",Oe[Oe.Layer1=2]="Layer1",Oe[Oe.Layer2=4]="Layer2",Oe[Oe.Layer3=8]="Layer3",Oe[Oe.Layer4=16]="Layer4",Oe[Oe.Layer5=32]="Layer5",Oe[Oe.Layer6=64]="Layer6",Oe[Oe.Layer7=128]="Layer7",Oe[Oe.Layer8=256]="Layer8",Oe[Oe.Layer9=512]="Layer9",Oe[Oe.Layer10=1024]="Layer10",Oe[Oe.Layer11=2048]="Layer11",Oe[Oe.Layer12=4096]="Layer12",Oe[Oe.Layer13=8192]="Layer13",Oe[Oe.Layer14=16384]="Layer14",Oe[Oe.Layer15=32768]="Layer15",Oe[Oe.Layer16=65536]="Layer16",Oe[Oe.Layer17=131072]="Layer17",Oe[Oe.Layer18=262144]="Layer18",Oe[Oe.Layer19=524288]="Layer19",Oe[Oe.Layer20=1048576]="Layer20",Oe[Oe.Layer21=2097152]="Layer21",Oe[Oe.Layer22=4194304]="Layer22",Oe[Oe.Layer23=8388608]="Layer23",Oe[Oe.Layer24=16777216]="Layer24",Oe[Oe.Layer25=33554432]="Layer25",Oe[Oe.Layer26=67108864]="Layer26",Oe[Oe.Layer27=134217728]="Layer27",Oe[Oe.Layer28=268435456]="Layer28",Oe[Oe.Layer29=536870912]="Layer29",Oe[Oe.Layer30=1073741824]="Layer30",Oe[Oe.Layer31=2147483648]="Layer31",Oe[Oe.Everything=4294967295]="Everything",Oe[Oe.Nothing=0]="Nothing";var Be=Object.defineProperty,ze=Object.getOwnPropertyDescriptor,Ge=function(e,t,n,i){for(var r,a=i>1?void 0:i?ze(t,n):t,o=e.length-1;o>=0;o--)(r=e[o])&&(a=(i?r(t,n,a):r(a))||a);return i&&a&&Be(t,n,a),a},Ue=function(t){l(a,t);var i=m(a);function a(t){var r;return n(this,a),(r=i.call(this,t.engine))._destroyed=!1,r._enabled=!0,r._awaked=!1,r._renderPriority=0,r._cullDistanceSq=0,r._entity=t,r._renderPassFlag=e.MaskList.EVERYTHING,r._passMasks=[e.MaskList.EVERYTHING],r}return r(a,[{key:"destroy",value:function(){this._destroyed||(this._entity._removeComponent(this),this._entity.isActiveInHierarchy&&(this._enabled&&this._onDisable(),this._onInActive()),this._destroyed=!0,this._onDestroy())}},{key:"_onAwake",value:function(){}},{key:"_onEnable",value:function(){}},{key:"_onDisable",value:function(){}},{key:"_onDestroy",value:function(){}},{key:"_onActive",value:function(){}},{key:"_onInActive",value:function(){}},{key:"_setActive",value:function(e){e?(this._awaked||(this._awaked=!0,this._onAwake()),this._entity._isActiveInHierarchy&&(this._onActive(),this._enabled&&this._onEnable())):(this._enabled&&this._onDisable(),this._onInActive())}},{key:"setPassMasks",value:function(){for(var e=arguments.length,t=new Array(e),n=0;n<e;n++)t[n]=arguments[n];this._passMasks=t,this._renderPassFlag=t.reduce((function(e,t){return e|t}),0)}},{key:"addPassMasks",value:function(){for(var e=arguments.length,t=new Array(e),n=0;n<e;n++)t[n]=arguments[n];for(var i=0,r=t;i<r.length;i++){var a=r[i],o=this._passMasks.indexOf(a);o<0&&this._passMasks.push(a)}this.setPassMasks.apply(this,x(this._passMasks))}},{key:"removePassMasks",value:function(){for(var e=arguments.length,t=new Array(e),n=0;n<e;n++)t[n]=arguments[n];for(var i=0,r=t;i<r.length;i++){var a=r[i],o=this._passMasks.indexOf(a);o>-1&&this._passMasks.splice(o,1)}this.setPassMasks.apply(this,x(this._passMasks))}},{key:"enabled",get:function(){return this._enabled},set:function(e){e!==this._enabled&&(this._enabled=e,e?this._entity.isActiveInHierarchy&&this._onEnable():this._entity.isActiveInHierarchy&&this._onDisable())}},{key:"destroyed",get:function(){return this._destroyed}},{key:"entity",get:function(){return this._entity}},{key:"scene",get:function(){return this._entity.scene}},{key:"engine",get:function(){return this._entity.engine}},{key:"renderPriority",get:function(){return this._renderPriority},set:function(e){this._renderPriority=e}},{key:"cullDistanceSq",get:function(){return this._cullDistanceSq}},{key:"cullDistance",get:function(){return Math.sqrt(this._cullDistanceSq)},set:function(e){this._cullDistanceSq=e*e}},{key:"renderPassFlag",get:function(){return this._renderPassFlag},set:function(e){this._renderPassFlag=e}}]),a}(se);Ge([J],Ue.prototype,"_entity",2),Ge([J],Ue.prototype,"_destroyed",2),Ge([J],Ue.prototype,"_enabled",2),Ge([J],Ue.prototype,"_awaked",2);var Ve=function(){function e(){var t=arguments.length>0&&void 0!==arguments[0]?arguments[0]:[];n(this,e),this._flags=t,this.flag=!0}return r(e,[{key:"destroy",value:function(){j(this._flags,this),this._flags=null}}]),e}(),He=Object.defineProperty,je=Object.getOwnPropertyDescriptor,We=function(e,t,n,i){for(var r,a=i>1?void 0:i?je(t,n):t,o=e.length-1;o>=0;o--)(r=e[o])&&(a=(i?r(t,n,a):r(a))||a);return i&&a&&He(t,n,a),a},qe=function(e){l(i,e);var t=m(i);function i(){var e;return n(this,i),(e=t.apply(this,arguments))._position=new w,e._rotation=new w,e._rotationQuaternion=new O,e._scale=new w(1,1,1),e._worldPosition=new w,e._worldRotation=new w,e._worldRotationQuaternion=new O,e._lossyWorldScale=new w(1,1,1),e._localMatrix=new F,e._worldMatrix=new F,e._changeFlags=[],e._isParentDirty=!0,e._parentTransformCache=null,e._dirtyFlag=i._WM_WP_WE_WQ_WS_FLAGS,e}return r(i,[{key:"setPosition",value:function(e,t,n){this._position.setValue(e,t,n),this.position=this._position}},{key:"setRotation",value:function(e,t,n){this._rotation.setValue(e,t,n),this.rotation=this._rotation}},{key:"setRotationQuaternion",value:function(e,t,n,i){this._rotationQuaternion.setValue(e,t,n,i),this.rotationQuaternion=this._rotationQuaternion}},{key:"setScale",value:function(e,t,n){this._scale.setValue(e,t,n),this.scale=this._scale}},{key:"setWorldPosition",value:function(e,t,n){this._worldPosition.setValue(e,t,n),this.worldPosition=this._worldPosition}},{key:"setWorldRotation",value:function(e,t,n){this._worldRotation.setValue(e,t,n),this.worldRotation=this._worldRotation}},{key:"setWorldRotationQuaternion",value:function(e,t,n,i){this._worldRotationQuaternion.setValue(e,t,n,i),this.worldRotationQuaternion=this._worldRotationQuaternion}},{key:"getWorldForward",value:function(e){var t=this.worldMatrix.elements;return e.setValue(-t[8],-t[9],-t[10]),e.normalize()}},{key:"getWorldRight",value:function(e){var t=this.worldMatrix.elements;return e.setValue(t[0],t[1],t[2]),e.normalize()}},{key:"getWorldUp",value:function(e){var t=this.worldMatrix.elements;return e.setValue(t[4],t[5],t[6]),e.normalize()}},{key:"translate",value:function(e){var t=!(arguments.length>1&&void 0!==arguments[1])||arguments[1];if(t){var n=i._tempMat40;F.rotationQuaternion(this.rotationQuaternion,n),w.transformCoordinate(e,n,i._tempVec3),this.position=this._position.add(i._tempVec3)}else this.worldPosition=this._worldPosition.add(e)}},{key:"translateXYZ",value:function(e,t,n){var r=!(arguments.length>3&&void 0!==arguments[3])||arguments[3],a=i._tempVec3;a.setValue(e,t,n),this.translate(a,r)}},{key:"rotate",value:function(e){var t=!(arguments.length>1&&void 0!==arguments[1])||arguments[1];this.rotateXYZ(e.x,e.y,e.z,t)}},{key:"rotateXYZ",value:function(e,t,n){var r=!(arguments.length>3&&void 0!==arguments[3])||arguments[3],a=R.degreeToRadFactor,o=i._tempQuat0;O.rotationEuler(e*a,t*a,n*a,o),this._rotateByQuat(o,r)}},{key:"rotateByAxis",value:function(e,t){var n=!(arguments.length>2&&void 0!==arguments[2])||arguments[2],r=t*R.degreeToRadFactor;O.rotationAxisAngle(e,r,i._tempQuat0),this._rotateByQuat(i._tempQuat0,n)}},{key:"lookAt",value:function(e,t){var n,r=this.worldPosition,a=R.zeroTolerance;if(!(Math.abs(r.x-e.x)<a&&Math.abs(r.y-e.y)<a&&Math.abs(r.z-e.z)<a)){var o=i._tempMat43,s=this._worldRotationQuaternion;t=null!==(n=t)&&void 0!==n?n:i._tempVec3.setValue(0,1,0),F.lookAt(r,e,t,o),o.getRotation(s).invert(),this.worldRotationQuaternion=s}}},{key:"registerWorldChangeFlag",value:function(){var e=new Ve(this._changeFlags);return this._changeFlags.push(e),e}},{key:"_parentChange",value:function(){this._isParentDirty=!0,this._updateAllWorldFlag()}},{key:"_updateWorldPositionFlag",value:function(){if(!this._isContainDirtyFlags(i._WM_WP_FLAGS)){this._worldAssociatedChange(i._WM_WP_FLAGS);for(var e=this._entity._children,t=0,n=e.length;t<n;t++){var r;null===(r=e[t].transform)||void 0===r||r._updateWorldPositionFlag()}}}},{key:"_updateWorldRotationFlag",value:function(){if(!this._isContainDirtyFlags(i._WM_WE_WQ_FLAGS)){this._worldAssociatedChange(i._WM_WE_WQ_FLAGS);for(var e=this._entity._children,t=0,n=e.length;t<n;t++){var r;null===(r=e[t].transform)||void 0===r||r._updateWorldPositionAndRotationFlag()}}}},{key:"_updateWorldPositionAndRotationFlag",value:function(){if(!this._isContainDirtyFlags(i._WM_WP_WE_WQ_FLAGS)){this._worldAssociatedChange(i._WM_WP_WE_WQ_FLAGS);for(var e=this._entity._children,t=0,n=e.length;t<n;t++){var r;null===(r=e[t].transform)||void 0===r||r._updateWorldPositionAndRotationFlag()}}}},{key:"_updateWorldScaleFlag",value:function(){if(!this._isContainDirtyFlags(i._WM_WS_FLAGS)){this._worldAssociatedChange(i._WM_WS_FLAGS);for(var e=this._entity._children,t=0,n=e.length;t<n;t++){var r;null===(r=e[t].transform)||void 0===r||r._updateWorldPositionAndScaleFlag()}}}},{key:"_updateWorldPositionAndScaleFlag",value:function(){if(!this._isContainDirtyFlags(i._WM_WP_WS_FLAGS)){this._worldAssociatedChange(i._WM_WP_WS_FLAGS);for(var e=this._entity._children,t=0,n=e.length;t<n;t++){var r;null===(r=e[t].transform)||void 0===r||r._updateWorldPositionAndScaleFlag()}}}},{key:"_updateAllWorldFlag",value:function(){if(!this._isContainDirtyFlags(i._WM_WP_WE_WQ_WS_FLAGS)){this._worldAssociatedChange(i._WM_WP_WE_WQ_WS_FLAGS);for(var e=this._entity._children,t=0,n=e.length;t<n;t++){var r;null===(r=e[t].transform)||void 0===r||r._updateAllWorldFlag()}}}},{key:"_getParentTransform",value:function(){if(!this._isParentDirty)return this._parentTransformCache;for(var e=null,t=this._entity.parent;t;){var n=t.transform;if(n){e=n;break}t=t.parent}return this._parentTransformCache=e,this._isParentDirty=!1,e}},{key:"_getScaleMatrix",value:function(){var e=i._tempQuat0,t=i._tempMat30,n=i._tempMat31,r=i._tempMat32;return n.setValueByMatrix(this.worldMatrix),O.invert(this.worldRotationQuaternion,e),P.rotationQuaternion(e,t),P.multiply(t,n,r),r}},{key:"_isContainDirtyFlags",value:function(e){return(this._dirtyFlag&e)===e}},{key:"_isContainDirtyFlag",value:function(e){return 0!=(this._dirtyFlag&e)}},{key:"_setDirtyFlagTrue",value:function(e){this._dirtyFlag|=e}},{key:"_setDirtyFlagFalse",value:function(e){this._dirtyFlag&=~e}},{key:"_worldAssociatedChange",value:function(e){this._dirtyFlag|=e;for(var t=this._changeFlags.length-1;t>=0;t--)this._changeFlags[t].flag=!0}},{key:"_rotateByQuat",value:function(e,t){t?(O.multiply(this.rotationQuaternion,e,this._rotationQuaternion),this.rotationQuaternion=this._rotationQuaternion):(O.multiply(this.worldRotationQuaternion,e,this._worldRotationQuaternion),this.worldRotationQuaternion=this._worldRotationQuaternion)}},{key:"position",get:function(){return this._position},set:function(e){this._position!==e&&e.cloneTo(this._position),this._setDirtyFlagTrue(i._LOCAL_MATRIX_FLAG),this._updateWorldPositionFlag()}},{key:"worldPosition",get:function(){return this._isContainDirtyFlag(i._WORLD_POSITION_FLAG)&&(this._getParentTransform()?this.worldMatrix.getTranslation(this._worldPosition):this._position.cloneTo(this._worldPosition),this._setDirtyFlagFalse(i._WORLD_POSITION_FLAG)),this._worldPosition},set:function(e){this._worldPosition!==e&&e.cloneTo(this._worldPosition);var t=this._getParentTransform();t?(F.invert(t.worldMatrix,i._tempMat41),w.transformCoordinate(e,i._tempMat41,this._position)):e.cloneTo(this._position),this.position=this._position,this._setDirtyFlagFalse(i._WORLD_POSITION_FLAG)}},{key:"rotation",get:function(){return this._isContainDirtyFlag(i._LOCAL_EULER_FLAG)&&(this._rotationQuaternion.toEuler(this._rotation),this._rotation.scale(R.radToDegreeFactor),this._setDirtyFlagFalse(i._LOCAL_EULER_FLAG)),this._rotation},set:function(e){this._rotation!==e&&e.cloneTo(this._rotation),this._setDirtyFlagTrue(i._LOCAL_MATRIX_FLAG|i._LOCAL_QUAT_FLAG),this._setDirtyFlagFalse(i._LOCAL_EULER_FLAG),this._updateWorldRotationFlag()}},{key:"worldRotation",get:function(){return this._isContainDirtyFlag(i._WORLD_EULER_FLAG)&&(this.worldRotationQuaternion.toEuler(this._worldRotation),this._worldRotation.scale(R.radToDegreeFactor),this._setDirtyFlagFalse(i._WORLD_EULER_FLAG)),this._worldRotation},set:function(e){this._worldRotation!==e&&e.cloneTo(this._worldRotation),O.rotationEuler(R.degreeToRadian(e.x),R.degreeToRadian(e.y),R.degreeToRadian(e.z),this._worldRotationQuaternion),this.worldRotationQuaternion=this._worldRotationQuaternion,this._setDirtyFlagFalse(i._WORLD_EULER_FLAG)}},{key:"rotationQuaternion",get:function(){return this._isContainDirtyFlag(i._LOCAL_QUAT_FLAG)&&(O.rotationEuler(R.degreeToRadian(this._rotation.x),R.degreeToRadian(this._rotation.y),R.degreeToRadian(this._rotation.z),this._rotationQuaternion),this._setDirtyFlagFalse(i._LOCAL_QUAT_FLAG)),this._rotationQuaternion},set:function(e){this._rotationQuaternion!==e&&e.cloneTo(this._rotationQuaternion),this._setDirtyFlagTrue(i._LOCAL_MATRIX_FLAG|i._LOCAL_EULER_FLAG),this._setDirtyFlagFalse(i._LOCAL_QUAT_FLAG),this._updateWorldRotationFlag()}},{key:"worldRotationQuaternion",get:function(){if(this._isContainDirtyFlag(i._WORLD_QUAT_FLAG)){var e=this._getParentTransform();null!=e?O.multiply(e.worldRotationQuaternion,this.rotationQuaternion,this._worldRotationQuaternion):this.rotationQuaternion.cloneTo(this._worldRotationQuaternion),this._setDirtyFlagFalse(i._WORLD_QUAT_FLAG)}return this._worldRotationQuaternion},set:function(e){this._worldRotationQuaternion!==e&&e.cloneTo(this._worldRotationQuaternion);var t=this._getParentTransform();t?(O.invert(t.worldRotationQuaternion,i._tempQuat0),O.multiply(e,i._tempQuat0,this._rotationQuaternion)):e.cloneTo(this._rotationQuaternion),this.rotationQuaternion=this._rotationQuaternion,this._setDirtyFlagFalse(i._WORLD_QUAT_FLAG)}},{key:"scale",get:function(){return this._scale},set:function(e){this._scale!==e&&e.cloneTo(this._scale),this._setDirtyFlagTrue(i._LOCAL_MATRIX_FLAG),this._updateWorldScaleFlag()}},{key:"lossyWorldScale",get:function(){if(this._isContainDirtyFlag(i._WORLD_SCALE_FLAG)){if(this._getParentTransform()){var e=this._getScaleMatrix().elements;this._lossyWorldScale.setValue(e[0],e[4],e[8])}else this._scale.cloneTo(this._lossyWorldScale);this._setDirtyFlagFalse(i._WORLD_SCALE_FLAG)}return this._lossyWorldScale}},{key:"localMatrix",get:function(){return this._isContainDirtyFlag(i._LOCAL_MATRIX_FLAG)&&(F.affineTransformation(this._scale,this.rotationQuaternion,this._position,this._localMatrix),this._setDirtyFlagFalse(i._LOCAL_MATRIX_FLAG)),this._localMatrix},set:function(e){this._localMatrix!==e&&e.cloneTo(this._localMatrix),this._localMatrix.decompose(this._position,this._rotationQuaternion,this._scale),this._setDirtyFlagTrue(i._LOCAL_EULER_FLAG),this._setDirtyFlagFalse(i._LOCAL_MATRIX_FLAG),this._updateAllWorldFlag()}},{key:"worldMatrix",get:function(){if(this._isContainDirtyFlag(i._WORLD_MATRIX_FLAG)){var e=this._getParentTransform();e?F.multiply(e.worldMatrix,this.localMatrix,this._worldMatrix):this.localMatrix.cloneTo(this._worldMatrix),this._setDirtyFlagFalse(i._WORLD_MATRIX_FLAG)}return this._worldMatrix},set:function(e){this._worldMatrix!==e&&e.cloneTo(this._worldMatrix);var t=this._getParentTransform();t?(F.invert(t.worldMatrix,i._tempMat42),F.multiply(e,i._tempMat42,this._localMatrix)):e.cloneTo(this._localMatrix),this.localMatrix=this._localMatrix,this._setDirtyFlagFalse(i._WORLD_MATRIX_FLAG)}}]),i}(Ue);qe._tempQuat0=new O,qe._tempVec3=new w,qe._tempMat30=new P,qe._tempMat31=new P,qe._tempMat32=new P,qe._tempMat40=new F,qe._tempMat41=new F,qe._tempMat42=new F,qe._tempMat43=new F,qe._LOCAL_EULER_FLAG=1,qe._LOCAL_QUAT_FLAG=2,qe._WORLD_POSITION_FLAG=4,qe._WORLD_EULER_FLAG=8,qe._WORLD_QUAT_FLAG=16,qe._WORLD_SCALE_FLAG=32,qe._LOCAL_MATRIX_FLAG=64,qe._WORLD_MATRIX_FLAG=128,qe._WM_WP_FLAGS=132,qe._WM_WE_WQ_FLAGS=152,qe._WM_WP_WE_WQ_FLAGS=156,qe._WM_WS_FLAGS=160,qe._WM_WP_WS_FLAGS=164,qe._WM_WP_WE_WQ_WS_FLAGS=188,We([$],qe.prototype,"_position",2),We([$],qe.prototype,"_rotation",2),We([$],qe.prototype,"_rotationQuaternion",2),We([$],qe.prototype,"_scale",2),We([$],qe.prototype,"_worldPosition",2),We([$],qe.prototype,"_worldRotation",2),We([$],qe.prototype,"_worldRotationQuaternion",2),We([$],qe.prototype,"_lossyWorldScale",2),We([$],qe.prototype,"_localMatrix",2),We([$],qe.prototype,"_worldMatrix",2),We([J],qe.prototype,"_changeFlags",2),We([J],qe.prototype,"_isParentDirty",2),We([J],qe.prototype,"_parentTransformCache",2);var Xe=function(t){l(a,t);var i=m(a);function a(t,r){var o;return n(this,a),(o=i.call(this,t)).layer=e.Layer.Layer0,o._isActiveInHierarchy=!1,o._components=[],o._children=[],o._isRoot=!1,o._isActive=!0,o._parent=null,o._invModelMatrix=new F,a._entitys.add(p(o)),o.name=r,o.transform=o.addComponent(qe),o._inverseWorldMatFlag=o.transform.registerWorldChangeFlag(),o}return r(a,[{key:"addComponent",value:function(e){De._addCheck(this,e);var t=new e(this);return this._components.push(t),this._isActiveInHierarchy&&t._setActive(!0),t}},{key:"getComponent",value:function(e){for(var t=this._components.length-1;t>=0;t--){var n=this._components[t];if(n instanceof e)return n}}},{key:"getComponents",value:function(e,t){t.length=0;for(var n=this._components.length-1;n>=0;n--){var i=this._components[n];i instanceof e&&t.push(i)}return t}},{key:"getComponentsIncludeChildren",value:function(e,t){return t.length=0,this._getComponentsIncludeChildren(e,t),t}},{key:"addChild",value:function(e){e.parent=this}},{key:"removeChild",value:function(e){e.parent=null}},{key:"getChild",value:function(e){return this._children[e]}},{key:"findByName",value:function(e){var t=this._children,n=a._findChildByName(this,e);if(n)return n;for(var i=t.length-1;i>=0;i--){var r=t[i].findByName(e);if(r)return r}return null}},{key:"findByPath",value:function(e){for(var t=e.split("/"),n=this,i=0,r=t.length;i<r;++i){var o=t[i];if(o&&!(n=a._findChildByName(n,o)))return null}return n}},{key:"createChild",value:function(e){var t=new a(this.engine,e);return t.layer=this.layer,t.parent=this,t}},{key:"clearChildren",value:function(){for(var e=this._children,t=e.length-1;t>=0;t--){var n=e[t];n._parent=null,n._isActiveInHierarchy&&n._processInActive(),a._traverseSetOwnerScene(n,null)}e.length=0}},{key:"clone",value:function(){var e=new a(this._engine,this.name);e._isActive=this._isActive,e.transform.localMatrix=this.transform.localMatrix;for(var t=this._children,n=0,i=this._children.length;n<i;n++){var r=t[n];e.addChild(r.clone())}for(var o=this._components,s=0,u=o.length;s<u;s++){var l=o[s];if(!(l instanceof qe)){var c=e.addComponent(l.constructor);Ie.cloneComponent(l,c)}}return e}},{key:"destroy",value:function(){for(var e=this._components,t=e.length-1;t>=0;t--)e[t].destroy();this._components.length=0;for(var n=this._children,i=n.length-1;i>=0;i--)n[i].destroy();if(this._children.length=0,null!=this._parent){var r=this._parent._children;r.splice(r.indexOf(this),1)}this._parent=null,a._entitys.delete(this)}},{key:"_removeComponent",value:function(e){De._removeCheck(this,e.constructor);var t=this._components;t.splice(t.indexOf(e),1)}},{key:"_removeFromParent",value:function(){var e=this._parent;if(null!=e){var t=e._children;t.splice(t.indexOf(this),1),this._parent=null}return e}},{key:"_processActive",value:function(){if(this._activeChangedComponents)throw"Note: can't set the 'main inActive entity' active in hierarchy, if the operation is in main inActive entity or it's children script's onDisable Event.";this._activeChangedComponents=this._engine._componentsManager.getActiveChangedTempList(),this._setActiveInHierarchy(this._activeChangedComponents),this._setActiveComponents(!0)}},{key:"_processInActive",value:function(){if(this._activeChangedComponents)throw"Note: can't set the 'main active entity' inActive in hierarchy, if the operation is in main active entity or it's children script's onEnable Event.";this._activeChangedComponents=this._engine._componentsManager.getActiveChangedTempList(),this._setInActiveInHierarchy(this._activeChangedComponents),this._setActiveComponents(!1)}},{key:"_getComponentsIncludeChildren",value:function(e,t){for(var n=this._components.length-1;n>=0;n--){var i=this._components[n];i instanceof e&&t.push(i)}for(var r=this._children.length-1;r>=0;r--)this._children[r]._getComponentsIncludeChildren(e,t)}},{key:"_setActiveComponents",value:function(e){for(var t=this._activeChangedComponents,n=0,i=t.length;n<i;++n)t[n]._setActive(e);this._engine._componentsManager.putActiveChangedTempList(t),this._activeChangedComponents=null}},{key:"_setActiveInHierarchy",value:function(e){this._isActiveInHierarchy=!0;for(var t=this._components,n=t.length-1;n>=0;n--)e.push(t[n]);for(var i=this._children,r=i.length-1;r>=0;r--){var a=i[r];a.isActive&&a._setActiveInHierarchy(e)}}},{key:"_setInActiveInHierarchy",value:function(e){this._isActiveInHierarchy=!1;for(var t=this._components,n=t.length-1;n>=0;n--)e.push(t[n]);for(var i=this._children,r=i.length-1;r>=0;r--){var a=i[r];a.isActive&&a._setInActiveInHierarchy(e)}}},{key:"_setTransformDirty",value:function(){if(this.transform)this.transform._parentChange();else for(var e=0,t=this._children.length;e<t;e++)this._children[e]._setTransformDirty()}},{key:"getInvModelMatrix",value:function(){return this._inverseWorldMatFlag.flag&&(F.invert(this.transform.worldMatrix,this._invModelMatrix),this._inverseWorldMatFlag.flag=!1),this._invModelMatrix}},{key:"isActive",get:function(){return this._isActive},set:function(e){if(e!==this._isActive)if(this._isActive=e,e){var t=this._parent;(null!=t&&t._isActiveInHierarchy||this._isRoot&&this._scene._isActiveInEngine)&&this._processActive()}else this._isActiveInHierarchy&&this._processInActive()}},{key:"isActiveInHierarchy",get:function(){return this._isActiveInHierarchy}},{key:"parent",get:function(){return this._parent},set:function(e){if(e!==this._parent){var t=this._removeFromParent(),n=this._parent=e;if(n){n._children.push(this);var i=n._scene;this._scene!==i&&a._traverseSetOwnerScene(this,i),n._isActiveInHierarchy?!this._isActiveInHierarchy&&this._isActive&&this._processActive():this._isActiveInHierarchy&&this._processInActive()}else this._isActiveInHierarchy&&this._processInActive(),t&&a._traverseSetOwnerScene(this,null);this._setTransformDirty()}}},{key:"children",get:function(){return this._children}},{key:"childCount",get:function(){return this._children.length}},{key:"scene",get:function(){return this._scene}},{key:"engine",get:function(){return this._engine}},{key:"position",get:function(){return this.transform.position},set:function(e){this.transform.position=e}},{key:"worldPosition",get:function(){return this.transform.worldPosition},set:function(e){this.transform.worldPosition=e}},{key:"rotation",get:function(){return this.transform.rotationQuaternion},set:function(e){this.transform.rotationQuaternion=e}},{key:"scale",get:function(){return this.transform.scale},set:function(e){this.transform.scale=e}}],[{key:"findByName",value:function(e){for(var t=a._entitys,n=t._elements,i=t.length-1;i>=0;i--){var r=n[i];if(r.name===e)return r}return null}},{key:"findByPath",value:function(e,t){return e.findEntityByPath(t)}},{key:"_findChildByName",value:function(e,t){for(var n=e._children,i=n.length-1;i>=0;i--){var r=n[i];if(r.name===t)return r}return null}},{key:"_traverseSetOwnerScene",value:function(e,t){e._scene=t;for(var n=e._children,i=e.childCount-1;i>=0;i--)this._traverseSetOwnerScene(n[i],t)}}]),a}(se);Xe._entitys=new Fe;var Ke=function(){function e(){n(this,e),this._features=[],this._objects=[]}return r(e,[{key:"registerFeature",value:function(e){for(var t=this._features,n=0,i=t.length;n<i;n++)if(t[n]===e)return;t.push(e);for(var r=this._objects,a=0,o=r.length;a<o;a++)r[a].features.push(new e)}},{key:"addObject",value:function(e){e.features=[];for(var t=0,n=this._features.length;t<n;t++){var i;e.features.push(new this._features[t](null!==(i=e.engine)&&void 0!==i?i:e))}this._objects.push(e)}},{key:"callFeatureMethod",value:function(e,t,n){for(var i=e.features,r=i.length,a=0;a<r;a++){var o=i[a];o[t]&&o[t].apply(o,n)}}},{key:"findFeature",value:function(e,t){for(var n=e.features,i=n.length,r=0;r<i;r++){var a=n[r];if(a.constructor===t)return a}}}]),e}(),Qe=function(){function e(){n(this,e)}return r(e,[{key:"setValue",value:function(e,t,n,i){this.component=e,this.primitive=t,this.subPrimitive=n,this.material=i}}],[{key:"getFromPool",value:function(){var t=e._elementPoolIndex,n=e._elementPool;if(e._elementPoolIndex++,n.length===t){var i=new e;return n.push(i),i}return n[t]}},{key:"_restPool",value:function(){e._elementPoolIndex=0}}]),e}();Qe._elementPoolIndex=0,Qe._elementPool=[];var Ye=function(e){l(i,e);var t=m(i);function i(e,r){var a;return n(this,i),(a=t.call(this,e)).clipPlanes=[],a._activeCameras=[],a._isActiveInEngine=!1,a._destroyed=!1,a._rootEntities=[],a.features=[],a.name=r||"",i.sceneFeatureManager.addObject(p(a)),a}return r(i,[{key:"createRootEntity",value:function(e){var t=new Xe(this._engine,e);return this.addRootEntity(t),t}},{key:"addRootEntity",value:function(e){var t=e._isRoot;t||(e._isRoot=!0,e._removeFromParent());var n=e._scene;n!==this?(n&&t&&n._removeEntity(e),this._rootEntities.push(e),Xe._traverseSetOwnerScene(e,this)):t||this._rootEntities.push(e),this._isActiveInEngine?!e._isActiveInHierarchy&&e._isActive&&e._processActive():e._isActiveInHierarchy&&e._processInActive()}},{key:"removeRootEntity",value:function(e){e._isRoot&&e._scene==this&&(this._removeEntity(e),this._isActiveInEngine&&e._processInActive(),Xe._traverseSetOwnerScene(e,null))}},{key:"getRootEntity",value:function(){var e=arguments.length>0&&void 0!==arguments[0]?arguments[0]:0;return this._rootEntities[e]}},{key:"findEntityByName",value:function(e){for(var t=this._rootEntities,n=t.length-1;n>=0;n--){var i=t[n];if(i.name===e)return i}for(var r=t.length-1;r>=0;r--){var a=t[r].findByName(e);if(a)return a}return null}},{key:"findEntityByPath",value:function(e){for(var t=e.split("/").filter(Boolean),n=0,i=this.rootEntitiesCount;n<i;n++){var r=this.getRootEntity(n);if(r.name==t[0]){for(var a=1,o=t.length;a<o&&(r=Xe._findChildByName(r,t[a]));++a);return r}}return null}},{key:"destroy",value:function(){this._isActiveInEngine&&(this._engine.sceneManager.activeScene=null),i.sceneFeatureManager.callFeatureMethod(this,"destroy",[this]);for(var e=0,t=this.rootEntitiesCount;e<t;e++)this._rootEntities[e].destroy();this._rootEntities.length=0,this._activeCameras.length=0,i.sceneFeatureManager._objects=[],this._destroyed=!0}},{key:"attachRenderCamera",value:function(e){-1===this._activeCameras.indexOf(e)?this._activeCameras.push(e):Le.warn("Camera already attached.")}},{key:"detachRenderCamera",value:function(e){var t=this._activeCameras.indexOf(e);-1!==t&&this._activeCameras.splice(t,1)}},{key:"_processActive",value:function(e){this._isActiveInEngine=e;for(var t=this._rootEntities,n=t.length-1;n>=0;n--){var i=t[n];i._isActive&&(e?i._processActive():i._processInActive())}}},{key:"_removeEntity",value:function(e){var t=this._rootEntities;t.splice(t.indexOf(e),1)}},{key:"findFeature",value:function(e){return i.sceneFeatureManager.findFeature(this,e)}},{key:"raycast",value:function(e,t,n){}},{key:"engine",get:function(){return this._engine}},{key:"rootEntitiesCount",get:function(){return this._rootEntities.length}},{key:"rootEntities",get:function(){return this._rootEntities}},{key:"destroyed",get:function(){return this._destroyed}}],[{key:"registerFeature",value:function(e){i.sceneFeatureManager.registerFeature(e)}}]),i}(se);Ye.sceneFeatureManager=new Ke;var Je=function(){function e(t){n(this,e),this.engine=t}return r(e,[{key:"loadScene",value:function(e){var t=this,n=!(arguments.length>1&&void 0!==arguments[1])||arguments[1],i=this.engine.resourceManager.load(e);return i.then((function(e){var i=t._activeScene;t.activeScene=e,i&&n&&i.destroy()})),i}},{key:"mergeScenes",value:function(e,t){for(var n=e.rootEntities,i=0,r=n.length;i<r;i++)t.addRootEntity(n[i])}},{key:"activeScene",get:function(){return this._activeScene},set:function(e){var t=this._activeScene;t!==e&&(t&&t._processActive(!1),e&&e._processActive(!0),this._activeScene=e)}}]),e}(),Ze=new Ke,$e=function(e){l(i,e);var t=m(i);function i(e,r){var a;return n(this,i),(a=t.call(this,null))._componentsManager=new ke,a._resourceManager=new q(p(a)),a._sceneManager=new Je(p(a)),a._vSyncCount=1,a._targetFrameRate=60,a._time=new Pe,a._isPaused=!0,a._loopCounter=0,a._targetFrameInterval=1e3/60,a._animate=function(){a._vSyncCount?(a._requestId=requestAnimationFrame(a._animate),a._loopCounter++%a._vSyncCount==0&&(a.update(),a._loopCounter=1)):(a._timeoutId=window.setTimeout(a._animate,a._targetFrameInterval),a.update())},a.features=[],a._hardwareRenderer=r,a._hardwareRenderer.init(e,p(a)),a._canvas=e,Ze.addObject(p(a)),a._sceneManager.activeScene=new Ye(p(a),"DefaultScene"),a}return r(i,[{key:"createEntity",value:function(e){return new Xe(this,e)}},{key:"pause",value:function(){this._isPaused=!0,cancelAnimationFrame(this._requestId),clearTimeout(this._timeoutId)}},{key:"resume",value:function(){this._isPaused&&(this._isPaused=!1,this.time.reset(),requestAnimationFrame(this._animate))}},{key:"update",value:function(){var e=this._time,t=e.deltaTime;e.tick(),Qe._restPool(),Ze.callFeatureMethod(this,"preTick",[this,this._sceneManager._activeScene]),this._hardwareRenderer.beginFrame();var n=this._sceneManager._activeScene,i=this._componentsManager;n&&(i.callScriptOnStart(),i.callScriptOnUpdate(t),i.callAnimationUpdate(t),i.callScriptOnLateUpdate(t),this._render(n)),this._componentsManager.callComponentDestory(),this._hardwareRenderer.endFrame(),Ze.callFeatureMethod(this,"postTick",[this,this._sceneManager._activeScene])}},{key:"run",value:function(){Ze.callFeatureMethod(this,"preLoad",[this]),this.resume(),this.trigger(new Y("run",this))}},{key:"destroy",value:function(){this._sceneManager&&(this.trigger(new Y("shutdown",this)),Ze.callFeatureMethod(this,"shutdown",[this]),this.pause(),this._animate=null,this._sceneManager._activeScene.destroy(),this._sceneManager=null,this._resourceManager.gc(),this._resourceManager=null,this._canvas=null,this.features=[],this._time=null,Ze._objects=[])}},{key:"_render",value:function(e){var t=e._activeCameras,n=this._componentsManager,i=this.time.deltaTime;if(n.callRendererOnUpdate(i),t.length>0){t.sort((function(e,t){return e.priority-t.priority}));for(var r=0,a=t.length;r<a;r++){var o=t[r],s=o.entity;o.enabled&&s.isActiveInHierarchy&&(n.callCameraOnBeginRender(o),Ye.sceneFeatureManager.callFeatureMethod(e,"preRender",[this,o]),o.render(),Ye.sceneFeatureManager.callFeatureMethod(e,"postRender",[this,o]),n.callCameraOnEndRender(o))}}else Le.debug("NO active camera.")}},{key:"findFeature",value:function(e){return Ze.findFeature(this,e)}},{key:"canvas",get:function(){return this._canvas}},{key:"resourceManager",get:function(){return this._resourceManager}},{key:"sceneManager",get:function(){return this._sceneManager}},{key:"time",get:function(){return this._time}},{key:"isPaused",get:function(){return this._isPaused}},{key:"vSyncCount",get:function(){return this._vSyncCount},set:function(e){this._vSyncCount=Math.max(0,Math.floor(e))}},{key:"targetFrameRate",get:function(){return this._targetFrameRate},set:function(e){e=Math.max(1e-6,e),this._targetFrameRate=e,this._targetFrameInterval=1e3/e}},{key:"renderhardware",get:function(){return this._hardwareRenderer}}],[{key:"registerFeature",value:function(e){Ze.registerFeature(e)}}]),i}(se),et=function(){function e(){n(this,e)}return r(e,null,[{key:"devicePixelRatio",get:function(){return window.devicePixelRatio}}]),e}(),tt=function(){function e(){n(this,e)}return r(e,[{key:"preLoad",value:function(e){}},{key:"preTick",value:function(e,t){}},{key:"postTick",value:function(e,t){}},{key:"shutdown",value:function(e){}}]),e}(),nt=function(e){l(i,e);var t=m(i);function i(){return n(this,i),t.apply(this,arguments)}return i}(re),it=function e(){n(this,e)},rt=function(){function e(){n(this,e)}return r(e,[{key:"preUpdate",value:function(e){}},{key:"postUpdate",value:function(e){}},{key:"preRender",value:function(e,t){}},{key:"postRender",value:function(e,t){}},{key:"destroy",value:function(e){}}]),e}(),at=Object.defineProperty,ot=Object.getOwnPropertyDescriptor,st=function(e,t,n,i){for(var r,a=i>1?void 0:i?ot(t,n):t,o=e.length-1;o>=0;o--)(r=e[o])&&(a=(i?r(t,n,a):r(a))||a);return i&&a&&at(t,n,a),a},ut=function(e){l(i,e);var t=m(i);function i(){var e;return n(this,i),(e=t.apply(this,arguments))._started=!1,e._onStartIndex=-1,e._onUpdateIndex=-1,e._onLateUpdateIndex=-1,e._onPreRenderIndex=-1,e._onPostRenderIndex=-1,e}return r(i,[{key:"onAwake",value:function(){}},{key:"onEnable",value:function(){}},{key:"onStart",value:function(){}},{key:"onUpdate",value:function(e){}},{key:"onLateUpdate",value:function(e){}},{key:"onBeginRender",value:function(e){}},{key:"onEndRender",value:function(e){}},{key:"onDisable",value:function(){}},{key:"onDestroy",value:function(){}},{key:"_onAwake",value:function(){this.onAwake()}},{key:"_onEnable",value:function(){var e=this.engine._componentsManager,t=i.prototype;this._started||e.addOnStartScript(this),this.onUpdate!==t.onUpdate&&e.addOnUpdateScript(this),this.onLateUpdate!==t.onLateUpdate&&e.addOnLateUpdateScript(this),this.onEnable()}},{key:"_onDisable",value:function(){var e=this.engine._componentsManager;-1!==this._onStartIndex&&e.removeOnStartScript(this),-1!==this._onUpdateIndex&&e.removeOnUpdateScript(this),-1!==this._onLateUpdateIndex&&e.removeOnLateUpdateScript(this),this.onDisable()}},{key:"_onDestroy",value:function(){this.engine._componentsManager.addDestoryComponent(this)}}]),i}(Ue);st([J],ut.prototype,"_started",2),st([J],ut.prototype,"_onStartIndex",2),st([J],ut.prototype,"_onUpdateIndex",2),st([J],ut.prototype,"_onLateUpdateIndex",2),st([J],ut.prototype,"_onPreRenderIndex",2),st([J],ut.prototype,"_onPostRenderIndex",2);var lt=Object.defineProperty,ct=Object.getOwnPropertyDescriptor,ht=function(e,t,n,i){for(var r,a=i>1?void 0:i?ct(t,n):t,o=e.length-1;o>=0;o--)(r=e[o])&&(a=(i?r(t,n,a):r(a))||a);return i&&a&&lt(t,n,a),a},dt=function(e){l(i,e);var t=m(i);function i(e){var r;n(this,i),(r=t.call(this,e))._onUpdateIndex=-1,r._rendererIndex=-1,r._overrideUpdate=!1,r._bounds=new L(new w,new w);var a=i.prototype;return r._overrideUpdate=r.update!==a.update,r._transformChangeFlag=r.entity.transform.registerWorldChangeFlag(),r}return r(i,[{key:"destroy",value:function(){g(c(i.prototype),"destroy",this).call(this);var e=this._transformChangeFlag;e&&(e.destroy(),this._transformChangeFlag=null)}},{key:"update",value:function(e){}},{key:"_updateBounds",value:function(e){}},{key:"_onEnable",value:function(){var e=this.engine._componentsManager;this._overrideUpdate&&e.addOnUpdateRenderers(this),e.addRenderer(this)}},{key:"_onDisable",value:function(){var e=this.engine._componentsManager;this._overrideUpdate&&e.removeOnUpdateRenderers(this),e.removeRenderer(this)}},{key:"_render",value:function(e){var t=!1;if(this.cullDistanceSq>0){var n=w.distanceSquared(e._entity.transform.worldPosition,this.entity.transform.worldPosition);t=this.cullDistanceSq<n}t||this.render(e)}},{key:"bounds",get:function(){var e=this._transformChangeFlag;return e.flag&&(this._updateBounds(this._bounds),e.flag=!1),this._bounds}}]),i}(Ue);ht([J],dt.prototype,"_onUpdateIndex",2),ht([J],dt.prototype,"_rendererIndex",2),ht([J],dt.prototype,"_overrideUpdate",2),ht([J],dt.prototype,"_transformChangeFlag",2),ht([$],dt.prototype,"_bounds",2);var ft=0,_t=function(){function t(){var i=arguments.length>0&&void 0!==arguments[0]?arguments[0]:"RENDER_PASS".concat(ft++),r=arguments.length>1&&void 0!==arguments[1]?arguments[1]:0,a=arguments.length>2&&void 0!==arguments[2]?arguments[2]:null,o=arguments.length>3&&void 0!==arguments[3]?arguments[3]:null,s=arguments.length>4&&void 0!==arguments[4]?arguments[4]:null,u=arguments.length>5&&void 0!==arguments[5]?arguments[5]:new U(0,0,0,0);n(this,t),this.name=i,this.enabled=!0,this.priority=r,this.renderTarget=a,this.replaceMaterial=o,this.mask=s||e.MaskList.EVERYTHING,this.renderOverride=!1,this.clearMode=e.ClearMode.SOLID_COLOR,this._clearParam=u}return r(t,[{key:"render",value:function(e,t,n){}},{key:"preRender",value:function(e,t,n){}},{key:"postRender",value:function(e,t,n){}},{key:"clearParam",get:function(){return this._clearParam},set:function(e){this._clearParam=e}}]),t}(),pt=function(){function e(){n(this,e),this.viewProjectMatrix=new F}return r(e,null,[{key:"_getRenderContext",value:function(t){var n=e._renderContext;return n.camera=t,n.viewport=t.viewport,n.cameraPosition=t.entity.transform.worldPosition,n.inverseViewMatrix=t.inverseViewMatrix,n.inverseProjectionMatrix=t.inverseProjectionMatrix,n.viewMatrix=t.viewMatrix,n.projectionMatrix=t.projectionMatrix,F.multiply(n.projectionMatrix,n.viewMatrix,n.viewProjectMatrix),this._renderContext}}]),e}();pt._renderContext=new pt;var vt,mt,gt=function(){function e(){n(this,e),this._items=[]}return r(e,[{key:"clear",value:function(){this._items=[]}},{key:"pushPrimitive",value:function(e){this._items.push(e)}},{key:"sortByDistance",value:function(e){var t=this._items;t.length>1&&(this._items=t.sort((function(t,n){if(t.component.renderPriority===n.component.renderPriority){var i=t.component.entity.transform.worldPosition,r=n.component.entity.transform.worldPosition;return w.distanceSquared(r,e)-w.distanceSquared(i,e)}return t.component.renderPriority-n.component.renderPriority})))}},{key:"sortByTechnique",value:function(){var e=this._items;e.length>1&&(this._items=e.sort((function(e,t){if(e.component.renderPriority===t.component.renderPriority){var n=e.material.technique,i=t.material.technique;return n&&i?n.name.localeCompare(i.name):0}return e.component.renderPriority-t.component.renderPriority})))}},{key:"pushSprite",value:function(e,t,n,i,r,a,o){var s={component:e,positionQuad:t,uvRect:n,tintColor:i,texture:r,renderMode:a,camera:o};this._items.push(s)}},{key:"render",value:function(e,t,n){var i=e.scene.engine._hardwareRenderer,r=this._items;if(0!==r.length){this.updateMaxJointsNum(this._items,t);for(var a=pt._getRenderContext(e),o=e.cullingMask,s=0,u=r.length;s<u;s++){var l=r[s],c=l.component;if(o&c._entity.layer)if(c.renderPassFlag&n)if(this._isPrimitive(l)){var h,d,f=l;i.flushSprite();var _=t||f.material;null===(h=_.preRender)||void 0===h||h.call(_,f.component,f.primitive),_.prepareDrawing(a,f.component,f.primitive,f.material),i.drawPrimitive(f.primitive,f.subPrimitive,_),null===(d=_.postRender)||void 0===d||d.call(_,f.component,f.primitive)}else{var p=l;i.drawSprite(p.positionQuad,p.uvRect,p.tintColor,p.texture,p.renderMode,p.camera)}}i.flushSprite()}}},{key:"updateMaxJointsNum",value:function(e,t){for(var n=0,i=e.length;n<i;n++){var r=e[n],a=r.component,o=r.material,s=t||o;a.jointNodes&&(s.maxJointsNum=Math.max(s.maxJointsNum,a.jointNodes.length))}}},{key:"_isPrimitive",value:function(e){return!!e.primitive}},{key:"items",get:function(){return this._items}}]),e}(),yt=function(t){l(a,t);var i=m(a);function a(){var t,r=arguments.length>0&&void 0!==arguments[0]?arguments[0]:"SeparateSprite",o=arguments.length>1&&void 0!==arguments[1]?arguments[1]:10;return n(this,a),(t=i.call(this,r,o)).clearMode=e.ClearMode.DONT_CLEAR,t.renderOverride=!0,t._spriteItems=[],t}return r(a,[{key:"preRender",value:function(){this.enabled=this.isUsed}},{key:"render",value:function(e){var t=e.renderHardware;this._sortByDistance(e.eyePos);for(var n=this._spriteItems,i=0;i<n.length;i++){var r=n[i];t.drawSprite(r.positionQuad,r.uvRect,r.tintColor,r.texture,r.renderMode,r.camera)}n.length=0}},{key:"postRender",value:function(e){this.enabled&&e.renderHardware.flushSprite()}},{key:"_sortByDistance",value:function(e){this._spriteItems.length>1&&(this._spriteItems=this._spriteItems.sort((function(t,n){if(t.component.renderPriority===n.component.renderPriority){var i=t.component.node.worldPosition,r=n.component.node.worldPosition;return w.distanceSquared(r,e)-w.distanceSquared(i,e)}return t.component.renderPriority-n.component.renderPriority})))}},{key:"pushSprite",value:function(e,t,n,i,r,a,o){this._spriteItems.push({component:e,positionQuad:t,uvRect:n,tintColor:i,texture:r,renderMode:a,camera:o})}},{key:"isUsed",get:function(){return this._spriteItems.length>0}}]),a}(_t),xt=function(t){l(a,t);var i=m(a);function a(e){var t;return n(this,a),(t=i.call(this))._camera=e,t._opaqueQueue=new gt,t._transparentQueue=new gt,t._renderPassArray=[],t._defaultPass=new _t("default",0,null,null,0),t.addRenderPass(t._defaultPass),t}return r(a,[{key:"addRenderPass",value:function(e){var t=arguments.length>1&&void 0!==arguments[1]?arguments[1]:null,n=arguments.length>2&&void 0!==arguments[2]?arguments[2]:null,i=arguments.length>3&&void 0!==arguments[3]?arguments[3]:null,r=arguments.length>4&&void 0!==arguments[4]?arguments[4]:null,a=arguments.length>5&&void 0!==arguments[5]?arguments[5]:new U(0,0,0,0);if("string"==typeof e){var o=new _t(e,t,n,i,r,a);this._renderPassArray.push(o)}else e instanceof _t&&this._renderPassArray.push(e);this._renderPassArray.sort((function(e,t){return e.priority-t.priority}))}},{key:"removeRenderPass",value:function(e){var t;if("string"==typeof e?t=this.getRenderPass(e):e instanceof _t&&(t=e),t){var n=this._renderPassArray.indexOf(t);this._renderPassArray.splice(n,1)}}},{key:"getRenderPass",value:function(e){for(var t=0,n=this._renderPassArray.length;t<n;t++){var i=this._renderPassArray[t];if(i.name===e)return i}return null}},{key:"destroy",value:function(){}},{key:"render",value:function(){var t=this._camera,n=this._opaqueQueue,i=this._transparentQueue;n.clear(),i.clear(),t.engine._componentsManager.callRender(t),n.sortByTechnique(),i.sortByDistance(t.entity.transform.worldPosition),this._canvasDepthPass&&(this._canvasDepthPass.enabled=!1),this._separateSpritePass&&this._separateSpritePass.isUsed&&this._defaultPass.renderTarget&&(this._canvasDepthPass||(this._canvasDepthPass=new _t("CanvasDepthRenderPass",0,null,null,0),this._canvasDepthPass.clearMode=e.ClearMode.DONT_CLEAR,this.addRenderPass(this._canvasDepthPass)),this._canvasDepthPass.enabled=!0);for(var r=0,a=this._renderPassArray.length;r<a;r++)this._drawRenderPass(this._renderPassArray[r],t)}},{key:"_drawRenderPass",value:function(e,t){e.preRender(t,this.opaqueQueue,this.transparentQueue);var n=t.scene.engine._hardwareRenderer,i=t.renderTarget||e.renderTarget;n.activeRenderTarget(i,t),e.enabled&&(n.clearRenderTarget(e.clearMode,e.clearParam),e.renderOverride?e.render(t,this.opaqueQueue,this.transparentQueue):(this.opaqueQueue.render(t,e.replaceMaterial,e.mask),this.transparentQueue.render(t,e.replaceMaterial,e.mask))),n.blitRenderTarget(i),e.postRender(t,this.opaqueQueue,this.transparentQueue)}},{key:"pushPrimitive",value:function(t){t.material.renderType===e.MaterialType.TRANSPARENT?this._transparentQueue.pushPrimitive(t):this._opaqueQueue.pushPrimitive(t)}},{key:"pushSprite",value:function(e,t,n,i,r,a,o){if(e.separateDraw)return this._separateSpritePass||(this._separateSpritePass=new yt,this.addRenderPass(this._separateSpritePass)),void this._separateSpritePass.pushSprite(e,t,n,i,r,a,o);this._transparentQueue.pushSprite(e,t,n,i,r,a,o)}},{key:"defaultRenderPass",get:function(){return this._defaultPass}},{key:"opaqueQueue",get:function(){return this._opaqueQueue}},{key:"transparentQueue",get:function(){return this._transparentQueue}}]),a}(it),Tt=Object.defineProperty,At=Object.getOwnPropertyDescriptor,St=function(e,t,n,i){for(var r,a=i>1?void 0:i?At(t,n):t,o=e.length-1;o>=0;o--)(r=e[o])&&(a=(i?r(t,n,a):r(a))||a);return i&&a&&Tt(t,n,a),a},Et=function e(){n(this,e)};Et.tempMat4=new F,Et.tempVec4=new U,Et.tempVec3=new w,(mt=vt||(vt={}))[mt.DepthSky=0]="DepthSky",mt[mt.DepthColor=1]="DepthColor",mt[mt.Depth=2]="Depth",mt[mt.None=3]="None",e.Camera=function(t){l(a,t);var i=m(a);function a(t){var r;return n(this,a),(r=i.call(this,t)).priority=0,r.cullingMask=e.Layer.Everything,r._isOrthographic=!1,r._isProjMatSetting=!1,r._clearMode=e.ClearMode.SOLID_COLOR,r._nearClipPlane=.1,r._farClipPlane=100,r._fieldOfView=45,r._orthographicSize=10,r._isProjectionDirty=!0,r._isInvProjMatDirty=!0,r._customAspectRatio=void 0,r._renderTarget=null,r._projectionMatrix=new F,r._viewMatrix=new F,r._backgroundColor=new U,r._viewport=new U(0,0,1,1),r._inverseProjectionMatrix=new F,r._inverseViewMatrix=new F,r._lastAspectSize=new z(0,0),r._invViewProjMat=new F,r._transform=r.entity.transform,r._isViewMatrixDirty=r._transform.registerWorldChangeFlag(),r._isInvViewProjDirty=r._transform.registerWorldChangeFlag(),r._renderPipeline=new xt(p(r)),r.setClearMode(),r}return r(a,[{key:"resetProjectionMatrix",value:function(){this._isProjMatSetting=!1,this._projMatChange()}},{key:"resetAspectRatio",value:function(){this._customAspectRatio=void 0,this._projMatChange()}},{key:"worldToViewportPoint",value:function(e,t){F.multiply(this.projectionMatrix,this.viewMatrix,Et.tempMat4),Et.tempVec4.setValue(e.x,e.y,e.z,1),U.transform(Et.tempVec4,Et.tempMat4,Et.tempVec4);var n=Et.tempVec4.w,i=Et.tempVec4.x/n,r=Et.tempVec4.y/n,a=Et.tempVec4.z/n;return t.x=.5*(i+1),t.y=.5*(1-r),t.z=a,t.w=n,t}},{key:"viewportToWorldPoint",value:function(e,t){var n=this.invViewProjMat;return this._innerViewportToWorldPoint(e,n,t)}},{key:"viewportPointToRay",value:function(e,t){var n=Et.tempVec3;n.setValue(e.x,e.y,0);var i=this.viewportToWorldPoint(n,t.origin);n.z=1;var r=this._innerViewportToWorldPoint(n,this._invViewProjMat,n);return w.subtract(r,i,t.direction),t.direction.normalize(),t}},{key:"screenToViewportPoint",value:function(e,t){var n=this.engine.canvas,i=this.viewport;return t.x=(e.x/n.width-i.x)/i.z,t.y=(e.y/n.height-i.y)/i.w,t}},{key:"viewportToScreenPoint",value:function(e,t){var n=this.engine.canvas,i=this.viewport;return t.x=(i.x+e.x*i.z)*n.width,t.y=(i.y+e.y*i.w)*n.height,t}},{key:"worldToScreenPoint",value:function(e,t){return this.worldToViewportPoint(e,t),this.viewportToScreenPoint(t,t)}},{key:"screenToWorldPoint",value:function(e,t){return this.screenToViewportPoint(e,t),this.viewportToWorldPoint(t,t)}},{key:"render",value:function(e){this._renderPipeline.render()}},{key:"_onActive",value:function(){this.entity.scene.attachRenderCamera(this)}},{key:"_onInActive",value:function(){this.entity.scene.detachRenderCamera(this)}},{key:"_onDestroy",value:function(){var e;null===(e=this._renderPipeline)||void 0===e||e.destroy(),this._isInvViewProjDirty.destroy(),this._isViewMatrixDirty.destroy()}},{key:"_projMatChange",value:function(){this._isProjectionDirty=!0,this._isInvProjMatDirty=!0,this._isInvViewProjDirty.flag=!0}},{key:"_innerViewportToWorldPoint",value:function(e,t,n){var i=2*e.z-1,r=Et.tempVec4;r.setValue(2*e.x-1,1-2*e.y,i,1),U.transform(r,t,r);var a=1/r.w;return n.x=r.x*a,n.y=r.y*a,n.z=r.z*a,n}},{key:"setClearMode",value:function(){var t=arguments.length>0&&void 0!==arguments[0]?arguments[0]:e.ClearMode.SOLID_COLOR,n=arguments.length>1&&void 0!==arguments[1]?arguments[1]:new U(.25,.25,.25,1);this._clearMode=t,this._backgroundColor=n,this._renderPipeline.defaultRenderPass.clearParam=n,this._renderPipeline.defaultRenderPass.clearMode=t}},{key:"nearClipPlane",get:function(){return this._nearClipPlane},set:function(e){this._nearClipPlane=e,this._projMatChange()}},{key:"farClipPlane",get:function(){return this._farClipPlane},set:function(e){this._farClipPlane=e,this._projMatChange()}},{key:"fieldOfView",get:function(){return this._fieldOfView},set:function(e){this._fieldOfView=e,this._projMatChange()}},{key:"aspectRatio",get:function(){var e,t=this._entity.engine.canvas;return null!==(e=this._customAspectRatio)&&void 0!==e?e:t.width*this._viewport.z/(t.height*this._viewport.w)},set:function(e){this._customAspectRatio=e,this._projMatChange()}},{key:"viewport",get:function(){return this._viewport},set:function(e){e!==this._viewport&&e.cloneTo(this._viewport),this._projMatChange()}},{key:"isOrthographic",get:function(){return this._isOrthographic},set:function(e){this._isOrthographic=e,this._projMatChange()}},{key:"orthographicSize",get:function(){return this._orthographicSize},set:function(e){this._orthographicSize=e,this._projMatChange()}},{key:"clearFlags",get:function(){throw"not implemented"},set:function(e){throw"not implemented"}},{key:"backgroundColor",get:function(){return this._backgroundColor},set:function(e){this.setClearMode(this._clearMode,e)}},{key:"backgroundSky",get:function(){throw new Error("接口未实现")}},{key:"viewMatrix",get:function(){return this._isViewMatrixDirty.flag&&(this._isViewMatrixDirty.flag=!1,F.invert(this._transform.worldMatrix,this._viewMatrix)),this._viewMatrix}},{key:"projectionMatrix",set:function(e){this._projectionMatrix=e,this._isProjMatSetting=!0,this._projMatChange()},get:function(){var e=this._entity.engine.canvas;if((!this._isProjectionDirty||this._isProjMatSetting)&&this._lastAspectSize.x===e.width&&this._lastAspectSize.y===e.height)return this._projectionMatrix;this._isProjectionDirty=!1,this._lastAspectSize.x=e.width,this._lastAspectSize.y=e.height;var t=this.aspectRatio;if(this._isOrthographic){var n=this._orthographicSize*t,i=this._orthographicSize;F.ortho(-n,n,-i,i,this._nearClipPlane,this._farClipPlane,this._projectionMatrix)}else F.perspective(R.degreeToRadian(this._fieldOfView),t,this._nearClipPlane,this._farClipPlane,this._projectionMatrix);return this._projectionMatrix}},{key:"enableHDR",get:function(){return console.log("not implemention"),!1},set:function(e){console.log("not implemention")}},{key:"renderTarget",get:function(){return this._renderTarget},set:function(e){this._renderTarget=e}},{key:"invViewProjMat",get:function(){return this._isInvViewProjDirty.flag&&(this._isInvViewProjDirty.flag=!1,F.multiply(this.inverseViewMatrix,this.inverseProjectionMatrix,this._invViewProjMat)),this._invViewProjMat}},{key:"inverseProjectionMatrix",get:function(){return this._isInvProjMatDirty&&(this._isInvProjMatDirty=!1,F.invert(this.projectionMatrix,this._inverseProjectionMatrix)),this._inverseProjectionMatrix}},{key:"inverseViewMatrix",get:function(){return this._transform.worldMatrix.cloneTo(this._inverseViewMatrix),this._inverseViewMatrix}}]),a}(Ue),St([J],e.Camera.prototype,"_renderPipeline",2),St([J],e.Camera.prototype,"_transform",2),St([J],e.Camera.prototype,"_isViewMatrixDirty",2),St([J],e.Camera.prototype,"_isInvViewProjDirty",2),St([$],e.Camera.prototype,"_projectionMatrix",2),St([$],e.Camera.prototype,"_viewMatrix",2),St([$],e.Camera.prototype,"_backgroundColor",2),St([$],e.Camera.prototype,"_viewport",2),St([$],e.Camera.prototype,"_inverseProjectionMatrix",2),St([$],e.Camera.prototype,"_inverseViewMatrix",2),St([$],e.Camera.prototype,"_lastAspectSize",2),St([$],e.Camera.prototype,"_invViewProjMat",2),e.Camera=St([Ne(qe)],e.Camera);var Ct={json:"json",gltf:"json",mtl:"json",prefab:"json",txt:"text",bin:"arraybuffer",png:"image",webp:"image",jpg:"image"};function bt(e){var t=arguments.length>1&&void 0!==arguments[1]?arguments[1]:{};return new V((function(n,i,r){var a,o,s,u,l=null!==(a=t.retryCount)&&void 0!==a?a:4,c=null!==(o=t.retryInterval)&&void 0!==o?o:500;t.timeout=null!==(s=t.timeout)&&void 0!==s?s:15e3,t.type=null!==(u=t.type)&&void 0!==u?u:Mt(e);var h,d="image"===t.type?Rt:wt,f=new Pt((function(){return d(e,t).onProgress(r).then((function(e){n(e),f.stop()})).catch((function(e){return h=e}))}),l,c);f.start((function(){i(h)}))}))}function Rt(e,t){return new V((function(n,i){var r=t.timeout,a=new Image,o=function(){i(new Error("request ".concat(e," fail")))};a.onerror=o,a.onabort=o;var s,u=setTimeout((function(){i(new Error("request ".concat(e," timeout")))}),r);a.onload=(s=u,function(){requestAnimationFrame((function(){n(a)})),clearTimeout(s)}),a.crossOrigin="anonymous",a.src=e}))}function wt(e,t){return new V((function(n,i,r){var a,o=new XMLHttpRequest;o.timeout=t.timeout,t.method=null!==(a=t.method)&&void 0!==a?a:"get",o.onload=function(){var t;if(o.status<200||o.status>=300)i(new Error("request failed from: ".concat(e)));else{var r=null!==(t=o.response)&&void 0!==t?t:o.responseText;n(r)}},o.onerror=function(){i(new Error("request failed from: ".concat(e)))},o.ontimeout=function(){i(new Error("request timeout from: ".concat(e)))},o.onprogress=function(e){r(e.loaded/e.total)},o.open(t.method,e,!0),o.withCredentials="include"===t.credentials,o.responseType=t.type;var s=t.headers;s&&Object.keys(s).forEach((function(e){o.setRequestHeader(e,s[e])})),o.send(t.body)}))}function Mt(e){var t=e.substring(e.lastIndexOf(".")+1);return Ct[t]}var Lt,Pt=function(){function e(t,i,r){n(this,e),this.execFunc=t,this.totalCount=i,this.interval=r,this._timeoutId=-100,this._currentCount=0,this.exec=this.exec.bind(this)}return r(e,[{key:"start",value:function(e){this.done=e,this.exec()}},{key:"stop",value:function(){clearTimeout(this._timeoutId)}},{key:"exec",value:function(){var e=this;this._currentCount>=this.totalCount?this.done&&this.done():(this._currentCount++,this.execFunc(this._currentCount).then((function(){e._timeoutId=setTimeout(e.exec,e.interval)})))}}]),e}(),Ot=function e(t){n(this,e),this.useCache=t,this.request=bt};(Lt=e.AssetType||(e.AssetType={}))[Lt.Text=0]="Text",Lt[Lt.JSON=1]="JSON",Lt[Lt.Buffer=2]="Buffer",Lt[Lt.Texture2D=3]="Texture2D",Lt[Lt.TextureCube=4]="TextureCube",Lt[Lt.Material=5]="Material",Lt[Lt.Mesh=6]="Mesh",Lt[Lt.AnimationClip=7]="AnimationClip",Lt[Lt.Perfab=8]="Perfab",Lt[Lt.KTX=9]="KTX",Lt[Lt.KTXCube=10]="KTXCube";var Ft=function(e){l(i,e);var t=m(i);function i(e){var r;return n(this,i),(r=t.call(this,e)).isGCIgnored=!1,r._refCount=0,r._refChildren=[],r._refParent=null,r._destroyed=!1,e.resourceManager._addRefObject(r.instanceId,p(r)),r}return r(i,[{key:"destroy",value:function(){var e=arguments.length>0&&void 0!==arguments[0]&&arguments[0];if(this._destroyed)return!0;if(!e&&0!==this._refCount)return!1;var t=this._engine.resourceManager;return t&&(t._deleteAsset(this),t._deleteRefObject(this.instanceId)),this._refParent&&j(this._refParent._refChildren,this),this._engine=null,this._onDestroy(),this._destroyed=!0,!0}},{key:"_addToResourceManager",value:function(e){this._engine.resourceManager._addAsset(e,this)}},{key:"_addRefCount",value:function(e){this._refCount+=e;var t,n=S(this._refChildren);try{for(n.s();!(t=n.n()).done;){t.value._addRefCount(e)}}catch(e){n.e(e)}finally{n.f()}}},{key:"_addRefChild",value:function(e){this._refChildren.push(e),e._refParent=this,e._addRefCount(this._refCount)}},{key:"_removeRefChild",value:function(e){j(this._refChildren,e)&&(e._refParent=null,e._addRefCount(-this._refCount))}},{key:"refCount",get:function(){return this._refCount}},{key:"destroyed",get:function(){return this._destroyed}}]),i}(re),kt=new w(0,1,0),It=function(e){l(i,e);var t=m(i);function i(e){var r;return n(this,i),r=t.call(this,e),e.addEventListener("removedFromScene",r._onDisable.bind(p(r))),r}return r(i,null,[{key:"getUniformDefine",value:function(e){return{}}}]),r(i,[{key:"_onEnable",value:function(){this.scene.findFeature(Vt).attachRenderLight(this)}},{key:"_onDisable",value:function(){this.scene.findFeature(Vt).detachRenderLight(this)}},{key:"viewMatrix",get:function(){return this._viewMat||(this._viewMat=new F),F.invert(this.inverseViewMatrix,this._viewMat),this._viewMat}},{key:"inverseViewMatrix",get:function(){return this._modelMat||(this._modelMat=new F),F.rotateAxisAngle(this.entity.transform.worldMatrix,kt,Math.PI,this._modelMat),this._modelMat}}]),i}(Ue),Dt=function(t){l(o,t);var i=m(o);function o(e){var t;return n(this,o),(t=i.call(this,e)).color=new w(1,1,1),t.intensity=1,t._lightColor=new w,t}return r(o,null,[{key:"getUniformDefine",value:function(t){var n;return a(n={},t+".color",{name:t+".color",type:e.DataType.FLOAT_VEC3}),a(n,t+".lightColor",{name:t+".lightColor",type:e.DataType.FLOAT_VEC3}),a(n,t+".intensity",{name:t+".intensity",type:e.DataType.FLOAT}),n}}]),r(o,[{key:"bindMaterialValues",value:function(e,t){e.setValue(t+".color",this.color),e.setValue(t+".lightColor",this.lightColor),e.setValue(t+".intensity",this.intensity)}},{key:"lightColor",get:function(){return w.scale(this.color,this.intensity,this._lightColor),this._lightColor}}]),o}(It),Nt=function(t){l(a,t);var i=m(a);function a(e){var t;return n(this,a),(t=i.call(this,e))._forward=new w,t.color=new w(1,1,1),t.intensity=1,t._lightColor=new w,t._reverseDirection=new w,t}return r(a,[{key:"bindMaterialValues",value:function(e,t){e.setValue(t+".color",this.color),e.setValue(t+".lightColor",this.lightColor),e.setValue(t+".intensity",this.intensity),e.setValue(t+".direction",this.direction)}},{key:"direction",get:function(){return this.entity.transform.getWorldForward(this._forward),this._forward}},{key:"lightColor",get:function(){return w.scale(this.color,this.intensity,this._lightColor),this._lightColor}},{key:"reverseDirection",get:function(){return w.scale(this.direction,-1,this._reverseDirection),this._reverseDirection}}],[{key:"getUniformDefine",value:function(t){var n={};return n[t+".color"]={name:t+".color",type:e.DataType.FLOAT_VEC3},n[t+".lightColor"]={name:t+".lightColor",type:e.DataType.FLOAT_VEC3},n[t+".intensity"]={name:t+".intensity",type:e.DataType.FLOAT},n[t+".direction"]={name:t+".direction",type:e.DataType.FLOAT_VEC3},n}}]),a}(It),Bt=new P,zt=function(t){l(a,t);var i=m(a);function a(e){var t;return n(this,a),(t=i.call(this,e)).diffuse=new w(.3,.3,.3),t.specular=new w(.5,.5,.5),t.diffuseIntensity=1,t.specularIntensity=1,t}return r(a,null,[{key:"getUniformDefine",value:function(t){var n={};return n.u_env_diffuseSampler={name:"u_env_diffuseSampler",type:e.DataType.SAMPLER_CUBE},n.u_env_specularSampler={name:"u_env_specularSampler",type:e.DataType.SAMPLER_CUBE},n[t+".diffuse"]={name:t+".diffuse",type:e.DataType.FLOAT_VEC3},n[t+".specular"]={name:t+".specular",type:e.DataType.FLOAT_VEC3},n[t+".mipMapLevel"]={name:t+".mipMapLevel",type:e.DataType.FLOAT},n[t+".transformMatrix"]={name:t+".transformMatrix",type:e.DataType.FLOAT_MAT3},n[t+".diffuseIntensity"]={name:t+".diffuseIntensity",type:e.DataType.FLOAT},n[t+".specularIntensity"]={name:t+".specularIntensity",type:e.DataType.FLOAT},n}}]),r(a,[{key:"bindMaterialValues",value:function(e,t){e.setValue(t+".diffuseIntensity",this.diffuseIntensity),e.setValue(t+".specularIntensity",this.specularIntensity),this.useDiffuseMap?e.setValue("u_env_diffuseSampler",this.diffuseMap):e.setValue(t+".diffuse",this.diffuse),this.useSpecularMap?(e.setValue("u_env_specularSampler",this.specularMap),e.setValue(t+".mipMapLevel",this.specularMap.mipmapCount)):e.setValue(t+".specular",this.specular);var n=this.entity.transform.worldMatrix;Bt.setValueByMatrix(n),e.setValue(t+".transformMatrix",Bt)}},{key:"useDiffuseMap",get:function(){return!!this.diffuseMap}},{key:"useSpecularMap",get:function(){return!!this.specularMap}}]),a}(It),Gt=function(t){l(a,t);var i=m(a);function a(){var e;return n(this,a),(e=i.apply(this,arguments)).color=new w(1,1,1),e.intensity=1,e.distance=0,e.decay=0,e._lightColor=new w,e}return r(a,[{key:"bindMaterialValues",value:function(e,t){e.setValue(t+".position",this.position),e.setValue(t+".color",this.color),e.setValue(t+".lightColor",this.lightColor),e.setValue(t+".intensity",this.intensity),e.setValue(t+".distance",this.distance),e.setValue(t+".decay",this.decay)}},{key:"position",get:function(){return this.entity.worldPosition}},{key:"lightColor",get:function(){return w.scale(this.color,this.intensity,this._lightColor),this._lightColor}}],[{key:"getUniformDefine",value:function(t){var n={};return n[t+".position"]={name:t+".position",type:e.DataType.FLOAT_VEC3},n[t+".color"]={name:t+".color",type:e.DataType.FLOAT_VEC3},n[t+".lightColor"]={name:t+".lightColor",type:e.DataType.FLOAT_VEC3},n[t+".intensity"]={name:t+".intensity",type:e.DataType.FLOAT},n[t+".distance"]={name:t+".distance",type:e.DataType.FLOAT},n[t+".decay"]={name:t+".decay",type:e.DataType.FLOAT},n}}]),a}(It),Ut=function(t){l(a,t);var i=m(a);function a(e){var t;return n(this,a),(t=i.call(this,e))._forward=new w,t.color=new w(1,1,1),t.penumbra=0,t.distance=0,t.intensity=1,t.decay=0,t.angle=Math.PI/6,t._lightColor=new w,t._inverseDirection=new w,t}return r(a,[{key:"bindMaterialValues",value:function(e,t){e.setValue(t+".position",this.position),e.setValue(t+".direction",this.direction),e.setValue(t+".color",this.color),e.setValue(t+".lightColor",this.lightColor),e.setValue(t+".intensity",this.intensity),e.setValue(t+".distance",this.distance),e.setValue(t+".decay",this.decay),e.setValue(t+".angle",this.angle),e.setValue(t+".penumbra",this.penumbra),e.setValue(t+".coneCos",Math.cos(this.angle)),e.setValue(t+".penumbraCos",Math.cos(this.angle*(1-this.penumbra)))}},{key:"position",get:function(){return this.entity.worldPosition}},{key:"direction",get:function(){return this.entity.transform.getWorldForward(this._forward),this._forward}},{key:"reverseDirection",get:function(){return w.scale(this.direction,-1,this._inverseDirection),this._inverseDirection}},{key:"lightColor",get:function(){return w.scale(this.color,this.intensity,this._lightColor),this._lightColor}}],[{key:"getUniformDefine",value:function(t){var n={};return n[t+".position"]={name:t+".position",type:e.DataType.FLOAT_VEC3},n[t+".direction"]={name:t+".direction",type:e.DataType.FLOAT_VEC3},n[t+".color"]={name:t+".color",type:e.DataType.FLOAT_VEC3},n[t+".lightColor"]={name:t+".lightColor",type:e.DataType.FLOAT_VEC3},n[t+".intensity"]={name:t+".intensity",type:e.DataType.FLOAT},n[t+".distance"]={name:t+".distance",type:e.DataType.FLOAT},n[t+".decay"]={name:t+".decay",type:e.DataType.FLOAT},n[t+".angle"]={name:t+".angle",type:e.DataType.FLOAT},n[t+".penumbra"]={name:t+".penumbra",type:e.DataType.FLOAT},n[t+".coneCos"]={name:t+".coneCos",type:e.DataType.FLOAT},n[t+".penumbraCos"]={name:t+".penumbraCos",type:e.DataType.FLOAT},n}}]),a}(It);var Vt=function(e){l(i,e);var t=m(i);function i(){var e;return n(this,i),(e=t.call(this)).visibleLights=[],e}return r(i,[{key:"lightSortAmount",get:function(){for(var e=0,t=0,n=0,i=0,r=0,a=!1,o=!1,s=this.visibleLights,u=0,l=s.length;u<l;u++){var c=s[u];c instanceof Dt?e++:c instanceof Nt?t++:c instanceof Gt?n++:c instanceof Ut?i++:c instanceof zt&&(r++,a=c.useDiffuseMap,o=c.useSpecularMap)}return{ambientLightCount:e,directLightCount:t,pointLightCount:n,spotLightCount:i,envMapLightCount:r,useDiffuseEnv:a,useSpecularEnv:o}}}]),r(i,[{key:"attachRenderLight",value:function(e){-1==this.visibleLights.indexOf(e)?this.visibleLights.push(e):Le.warn("Light already attached.")}},{key:"detachRenderLight",value:function(e){var t=this.visibleLights.indexOf(e);-1!=t&&this.visibleLights.splice(t,1)}},{key:"bindMaterialValues",value:function(e){for(var t=0,n=0,i=0,r=this.visibleLights,a=0,o=r.length;a<o;a++){var s=r[a];s instanceof Dt?s.bindMaterialValues(e,"u_ambientLight"):s instanceof Nt?s.bindMaterialValues(e,"u_directLights[".concat(t++,"]")):s instanceof Gt?s.bindMaterialValues(e,"u_pointLights[".concat(n++,"]")):s instanceof Ut?s.bindMaterialValues(e,"u_spotLights[".concat(i++,"]")):s instanceof zt&&s.bindMaterialValues(e,"u_envMapLight")}}},{key:"getUniformDefine",value:function(){for(var e={},t=0,n=0,i=0,r=0,a=0,o=this.visibleLights,s=0,l=o.length;s<l;s++){var c=o[s];c instanceof Dt&&!t++?e=u(u({},e),Dt.getUniformDefine("u_ambientLight")):c instanceof Nt?e=u(u({},e),Nt.getUniformDefine("u_directLights[".concat(n++,"]"))):c instanceof Gt?e=u(u({},e),Gt.getUniformDefine("u_pointLights[".concat(i++,"]"))):c instanceof Ut?e=u(u({},e),Ut.getUniformDefine("u_spotLights[".concat(r++,"]"))):c instanceof zt&&!a++&&(e=u(u({},e),zt.getUniformDefine("u_envMapLight")))}return e}}]),i}(rt),Ht=function(e){l(i,e);var t=m(i);function i(){var e;return n(this,i),(e=t.call(this)).colliders=[],e}return r(i,[{key:"attachCollider",value:function(e){this.colliders.push(e)}},{key:"detachCollider",value:function(e){var t=this.colliders.indexOf(e);-1!=t&&this.colliders.splice(t,1)}}]),i}(rt),jt=function(t){l(a,t);var i=m(a);function a(t){var r;return n(this,a),(r=i.call(this,t)).tag=e.MaskList.EVERYTHING,r}return r(a,[{key:"_onEnable",value:function(){this.scene.findFeature(Ht).attachCollider(this)}},{key:"_onDisable",value:function(){this.scene.findFeature(Ht).detachCollider(this)}}]),a}(Ue),Wt=function(e){l(i,e);var t=m(i);function i(e){var r;return n(this,i),(r=t.call(this,e))._corners=[],r._cornerFlag=!1,r.boxMin=new w(-.5,-.5,-.5),r.boxMax=new w(.5,.5,.5),r}return r(i,[{key:"setBoxMinMax",value:function(e,t){this.boxMin=e,this.boxMax=t,this._cornerFlag=!0}},{key:"setBoxCenterSize",value:function(e,t){var n=i._tempVec3;w.scale(t,.5,n),w.add(e,n,this.boxMax),w.subtract(e,n,this.boxMin),this._cornerFlag=!0}},{key:"getCorners",value:function(){if(this._cornerFlag){var e=this.boxMin.x,t=this.boxMin.y,n=this.boxMin.z,i=this.boxMax.x-e,r=this.boxMax.y-t,a=this.boxMax.z-n;if(0===this._corners.length)for(var o=0;o<8;++o)this._corners.push(new w);this._corners[0].setValue(e+i,t+r,n+a),this._corners[1].setValue(e,t+r,n+a),this._corners[2].setValue(e,t,n+a),this._corners[3].setValue(e+i,t,n+a),this._corners[4].setValue(e+i,t+r,n),this._corners[5].setValue(e,t+r,n),this._corners[6].setValue(e,t,n),this._corners[7].setValue(e+i,t,n),this._cornerFlag=!1}return this._corners}}]),i}(jt);Wt._tempVec3=new w;var qt=function(e){l(i,e);var t=m(i);function i(e){var r;return n(this,i),(r=t.call(this,e)).center=new w,r.radius=1,r}return r(i,[{key:"raycast",value:function(e,t){}},{key:"setSphere",value:function(e,t){this.center=e,this.radius=t}}]),i}(jt),Xt=function(e){l(i,e);var t=m(i);function i(e){var r;return n(this,i),(r=t.call(this,e)).planePoint=new w,r.normal=new w(0,1,0),r}return r(i,[{key:"setPlane",value:function(e,t){this.planePoint=e,this.normal=t}}]),i}(jt);function Kt(e,t,n,i,r){var a=t.getPoint(n);w.transformCoordinate(a,e.entity.transform.worldMatrix,a),i.distance=w.distance(r,a),i.collider=e,i.point=a}function Qt(e,t){var n=e.entity.getInvModelMatrix(),i=new w;w.transformCoordinate(t.origin,n,i);var r,a,o,s,u,l,c,h=new w;return r=h,a=t.direction,o=n,s=a.x,u=a.y,l=a.z,c=o.elements,r.x=s*c[0]+u*c[4]+l*c[8],r.y=s*c[1]+u*c[5]+l*c[9],r.z=s*c[2]+u*c[6]+l*c[10],new I(i,h)}Ye.prototype.raycast=function(t,n){for(var i=arguments.length>2&&void 0!==arguments[2]?arguments[2]:e.MaskList.EVERYTHING,r=new I(t.origin,t.direction),a=this.findFeature(Ht),o=a.colliders,s=new D,u=0,l=o.length;u<l;u++){var c=o[u];if(c.entity.isActiveInHierarchy&&c.tag&i){var h=new D;c.raycast(r,h)&&h.distance<s.distance&&(s=h)}}return n&&s.collider&&s.point.cloneTo(n),s.collider},Wt.prototype.raycast=function(e,t){var n=Qt(this,e),i=n.intersectAABB(this.boxMax,this.boxMin);return!!i&&(Kt(this,n,i,t,e.origin),!0)},qt.prototype.raycast=function(e,t){var n=Qt(this,e),i=n.intersectSphere(this.center,this.radius);return!!i&&(Kt(this,n,i,t,e.origin),!0)},Xt.prototype.raycast=function(e,t){var n=Qt(this,e),i=n.intersectPlane(this.planePoint,this.normal);return!!i&&(Kt(this,n,i,t,e.origin),!0)};var Yt=function(e){l(i,e);var t=m(i);function i(e,r){var a;return n(this,i),(a=t.call(this,e)).primitives=[],a.groups=[],a.bounds=new L(new w,new w),a.name=r,a}return r(i,[{key:"updatePrimitiveWeightsIndices",value:function(e){}},{key:"destroy",value:function(){this.primitives=null}}]),i}(re),Jt=function(e){l(i,e);var t=m(i);function i(e){var r;return n(this,i),(r=t.call(this,null)).inverseBindMatrices=[],r.joints=[],r.skeleton="none",r}return i}(nt),Zt=Object.defineProperty,$t=Object.getOwnPropertyDescriptor,en=function(e,t,n,i){for(var r,a=i>1?void 0:i?$t(t,n):t,o=e.length-1;o>=0;o--)(r=e[o])&&(a=(i?r(t,n,a):r(a))||a);return i&&a&&Zt(t,n,a),a};function tn(e,t){for(var n=e.primitives,i=0,r=n.length;i<r;i++)n[i]._addRefCount(t)}var nn,rn,an,on,sn,un,ln=function(e){l(i,e);var t=m(i);function i(e){var r;return n(this,i),(r=t.call(this,e))._instanceMaterials=[],r._sharedMaterials=[],r._mesh=null,r}return r(i,[{key:"setSharedMaterial",value:function(e,t){this._sharedMaterials[e]&&this._sharedMaterials[e]._addRefCount(-1),t._addRefCount(1),this._sharedMaterials[e]=t}},{key:"setMaterial",value:function(e,t){this._instanceMaterials[e]&&this._instanceMaterials[e]._addRefCount(-1),t._addRefCount(1),this._instanceMaterials[e]=t}},{key:"getInstanceMaterial",value:function(e){return this._instanceMaterials[e]}},{key:"getSharedMaterial",value:function(e){return this._sharedMaterials[e]}},{key:"render",value:function(e){var t=this._mesh;if(t)for(var n=e._renderPipeline,i=t.primitives,r=t.groups,a=0,o=i.length;a<o;a++){var s=i[a],u=this._instanceMaterials[a]||this._sharedMaterials[a];if(u){var l=Qe.getFromPool();l.setValue(this,s,r[a],u),n.pushPrimitive(l)}else Le.error("Primitive has no material: "+s.name)}}},{key:"destroy",value:function(){g(c(i.prototype),"destroy",this).call(this),this._mesh=null,this._instanceMaterials=[],this._sharedMaterials=[];for(var e=0;e<this._instanceMaterials.length;e++)this._instanceMaterials[e]._addRefCount(-1);for(var t=0;t<this._sharedMaterials.length;t++)this._sharedMaterials[t]._addRefCount(-1);this._mesh&&tn(this._mesh,-1)}},{key:"_updateBounds",value:function(e){var t=this.mesh.bounds,n=this._entity.transform.worldMatrix;w.transformCoordinate(t.min,n,e.min),w.transformCoordinate(t.max,n,e.max)}},{key:"mesh",get:function(){return this._mesh},set:function(e){this._mesh&&tn(this._mesh,-1),tn(e,1),this._mesh=e,this._sharedMaterials=[],this._instanceMaterials=[]}}]),i}(dt);en([J],ln.prototype,"_instanceMaterials",2),en([Z],ln.prototype,"_sharedMaterials",2),(nn=e.TextureFilterMode||(e.TextureFilterMode={}))[nn.Point=0]="Point",nn[nn.Bilinear=1]="Bilinear",nn[nn.Trilinear=2]="Trilinear",(rn=e.TextureFormat||(e.TextureFormat={}))[rn.R8G8B8=0]="R8G8B8",rn[rn.R8G8B8A8=1]="R8G8B8A8",rn[rn.R4G4B4A4=2]="R4G4B4A4",rn[rn.R5G5B5A1=3]="R5G5B5A1",rn[rn.R5G6B5=4]="R5G6B5",rn[rn.Alpha8=5]="Alpha8",rn[rn.R32G32B32A32=6]="R32G32B32A32",rn[rn.DXT1=7]="DXT1",rn[rn.DXT5=8]="DXT5",rn[rn.ETC1_RGB=9]="ETC1_RGB",rn[rn.ETC2_RGB=10]="ETC2_RGB",rn[rn.ETC2_RGBA5=11]="ETC2_RGBA5",rn[rn.ETC2_RGBA8=12]="ETC2_RGBA8",rn[rn.PVRTC_RGB2=13]="PVRTC_RGB2",rn[rn.PVRTC_RGBA2=14]="PVRTC_RGBA2",rn[rn.PVRTC_RGB4=15]="PVRTC_RGB4",rn[rn.PVRTC_RGBA4=16]="PVRTC_RGBA4",rn[rn.ASTC_4x4=17]="ASTC_4x4",rn[rn.ASTC_5x5=18]="ASTC_5x5",rn[rn.ASTC_6x6=19]="ASTC_6x6",rn[rn.ASTC_8x8=20]="ASTC_8x8",rn[rn.ASTC_10x10=21]="ASTC_10x10",rn[rn.ASTC_12x12=22]="ASTC_12x12",(an=e.TextureWrapMode||(e.TextureWrapMode={}))[an.Clamp=0]="Clamp",an[an.Repeat=1]="Repeat",an[an.Mirror=2]="Mirror",(on=e.GLCompressedTextureInternalFormat||(e.GLCompressedTextureInternalFormat={}))[on.RGBA_ASTC_4X4_KHR=37808]="RGBA_ASTC_4X4_KHR",on[on.RGBA_ASTC_5X4_KHR=37809]="RGBA_ASTC_5X4_KHR",on[on.RGBA_ASTC_5X5_KHR=37810]="RGBA_ASTC_5X5_KHR",on[on.RGBA_ASTC_6X5_KHR=37811]="RGBA_ASTC_6X5_KHR",on[on.RGBA_ASTC_6X6_KHR=37812]="RGBA_ASTC_6X6_KHR",on[on.RGBA_ASTC_8X5_KHR=37813]="RGBA_ASTC_8X5_KHR",on[on.RGBA_ASTC_8X6_KHR=37814]="RGBA_ASTC_8X6_KHR",on[on.RGBA_ASTC_8X8_KHR=37815]="RGBA_ASTC_8X8_KHR",on[on.RGBA_ASTC_10X5_KHR=37816]="RGBA_ASTC_10X5_KHR",on[on.RGBA_ASTC_10X6_KHR=37817]="RGBA_ASTC_10X6_KHR",on[on.RGBA_ASTC_10X8_KHR=37818]="RGBA_ASTC_10X8_KHR",on[on.RGBA_ASTC_10X10_KHR=37819]="RGBA_ASTC_10X10_KHR",on[on.RGBA_ASTC_12X10_KHR=37820]="RGBA_ASTC_12X10_KHR",on[on.RGBA_ASTC_12X12_KHR=37821]="RGBA_ASTC_12X12_KHR",on[on.SRGB8_ALPHA8_ASTC_4X4_KHR=37840]="SRGB8_ALPHA8_ASTC_4X4_KHR",on[on.SRGB8_ALPHA8_ASTC_5X4_KHR=37841]="SRGB8_ALPHA8_ASTC_5X4_KHR",on[on.SRGB8_ALPHA8_ASTC_5X5_KHR=37842]="SRGB8_ALPHA8_ASTC_5X5_KHR",on[on.SRGB8_ALPHA8_ASTC_6X5_KHR=37843]="SRGB8_ALPHA8_ASTC_6X5_KHR",on[on.SRGB8_ALPHA8_ASTC_6X6_KHR=37844]="SRGB8_ALPHA8_ASTC_6X6_KHR",on[on.SRGB8_ALPHA8_ASTC_8X5_KHR=37845]="SRGB8_ALPHA8_ASTC_8X5_KHR",on[on.SRGB8_ALPHA8_ASTC_8X6_KHR=37846]="SRGB8_ALPHA8_ASTC_8X6_KHR",on[on.SRGB8_ALPHA8_ASTC_8X8_KHR=37847]="SRGB8_ALPHA8_ASTC_8X8_KHR",on[on.SRGB8_ALPHA8_ASTC_10X5_KHR=37848]="SRGB8_ALPHA8_ASTC_10X5_KHR",on[on.SRGB8_ALPHA8_ASTC_10X6_KHR=37849]="SRGB8_ALPHA8_ASTC_10X6_KHR",on[on.SRGB8_ALPHA8_ASTC_10X8_KHR=37850]="SRGB8_ALPHA8_ASTC_10X8_KHR",on[on.SRGB8_ALPHA8_ASTC_10X10_KHR=37851]="SRGB8_ALPHA8_ASTC_10X10_KHR",on[on.SRGB8_ALPHA8_ASTC_12X10_KHR=37852]="SRGB8_ALPHA8_ASTC_12X10_KHR",on[on.SRGB8_ALPHA8_ASTC_12X12_KHR=37853]="SRGB8_ALPHA8_ASTC_12X12_KHR",on[on.RGB_ETC1_WEBGL=36196]="RGB_ETC1_WEBGL",on[on.R11_EAC=37488]="R11_EAC",on[on.SIGNED_R11_EAC=37489]="SIGNED_R11_EAC",on[on.RG11_EAC=37490]="RG11_EAC",on[on.SIGNED_RG11_EAC=37491]="SIGNED_RG11_EAC",on[on.RGB8_ETC2=37492]="RGB8_ETC2",on[on.SRGB8_ETC2=37493]="SRGB8_ETC2",on[on.RGB8_PUNCHTHROUGH_ALPHA1_ETC2=37494]="RGB8_PUNCHTHROUGH_ALPHA1_ETC2",on[on.SRGB8_PUNCHTHROUGH_ALPHA1_ETC2=37495]="SRGB8_PUNCHTHROUGH_ALPHA1_ETC2",on[on.RGBA8_ETC2_EAC=37496]="RGBA8_ETC2_EAC",on[on.SRGB8_ALPHA8_ETC2_EAC=37497]="SRGB8_ALPHA8_ETC2_EAC",on[on.RGB_PVRTC_4BPPV1_IMG=35840]="RGB_PVRTC_4BPPV1_IMG",on[on.RGB_PVRTC_2BPPV1_IMG=35841]="RGB_PVRTC_2BPPV1_IMG",on[on.RGBA_PVRTC_4BPPV1_IMG=35842]="RGBA_PVRTC_4BPPV1_IMG",on[on.RGBA_PVRTC_2BPPV1_IMG=35843]="RGBA_PVRTC_2BPPV1_IMG",on[on.RGB_S3TC_DXT1_EXT=33776]="RGB_S3TC_DXT1_EXT",on[on.RGBA_S3TC_DXT1_EXT=33777]="RGBA_S3TC_DXT1_EXT",on[on.RGBA_S3TC_DXT3_EXT=33778]="RGBA_S3TC_DXT3_EXT",on[on.RGBA_S3TC_DXT5_EXT=33779]="RGBA_S3TC_DXT5_EXT",(sn=e.RenderBufferColorFormat||(e.RenderBufferColorFormat={}))[sn.R8G8B8=0]="R8G8B8",sn[sn.R8G8B8A8=1]="R8G8B8A8",sn[sn.R4G4B4A4=2]="R4G4B4A4",sn[sn.R5G5B5A1=3]="R5G5B5A1",sn[sn.R5G6B5=4]="R5G6B5",sn[sn.Alpha8=5]="Alpha8",sn[sn.R16G16B16A16=6]="R16G16B16A16",sn[sn.R32G32B32A32=7]="R32G32B32A32",(un=e.RenderBufferDepthFormat||(e.RenderBufferDepthFormat={}))[un.Depth=0]="Depth",un[un.DepthStencil=1]="DepthStencil",un[un.Stencil=2]="Stencil",un[un.Depth16=3]="Depth16",un[un.Depth24=4]="Depth24",un[un.Depth32=5]="Depth32",un[un.Depth24Stencil8=6]="Depth24Stencil8",un[un.Depth32Stencil8=7]="Depth32Stencil8";var cn=function(t){l(a,t);var i=m(a);function a(e){var t;return n(this,a),(t=i.call(this,e))._anisoLevel=1,t}return r(a,[{key:"generateMipmaps",value:function(){if(this._mipmap){var e=this._rhi.gl;this._bind(),e.generateMipmap(this._target),this._unbind()}}},{key:"_onDestroy",value:function(){this._rhi.gl.deleteTexture(this._glTexture),this._glTexture=null,this._formatDetail=null,this._rhi=null}},{key:"_bind",value:function(){this._rhi.gl.bindTexture(this._target,this._glTexture)}},{key:"_unbind",value:function(){this._rhi.gl.bindTexture(this._target,null)}},{key:"_getPixelBuffer",value:function(e,t,n,i,r,o){var s=this._rhi.gl,u=this._formatDetail,l=u.baseFormat,c=u.dataType;a._readFrameBuffer||(a._readFrameBuffer=s.createFramebuffer()),s.bindFramebuffer(s.FRAMEBUFFER,a._readFrameBuffer),null!=e?s.framebufferTexture2D(s.FRAMEBUFFER,s.COLOR_ATTACHMENT0,s.TEXTURE_CUBE_MAP_POSITIVE_X+e,this._glTexture,0):s.framebufferTexture2D(s.FRAMEBUFFER,s.COLOR_ATTACHMENT0,s.TEXTURE_2D,this._glTexture,0),s.readPixels(t,n,i,r,l,c,o),s.bindFramebuffer(s.FRAMEBUFFER,null)}},{key:"_initMipmap",value:function(e){var t=this._rhi.gl,n=this._rhi.isWebGL2,i=this._formatDetail,r=i.internalFormat,a=i.baseFormat,o=i.dataType;if(this._bind(),n)t.texStorage2D(this._target,this._mipmapCount,r,this._width,this._height);else if(a!==r&&(r=a),e)for(var s=0;s<this._mipmapCount;s++)for(var u=Math.max(1,this._width>>s),l=0;l<6;l++)t.texImage2D(t.TEXTURE_CUBE_MAP_POSITIVE_X+l,s,r,u,u,0,a,o,null);else for(var c=0;c<this._mipmapCount;c++){var h=Math.max(1,this._width>>c),d=Math.max(1,this._height>>c);t.texImage2D(this._target,c,r,h,d,0,a,o,null)}this._unbind()}},{key:"_getMaxMiplevel",value:function(e){return Math.floor(Math.log2(e))}},{key:"_getMipmapCount",value:function(){return this._mipmap?Math.floor(Math.log2(Math.max(this._width,this._height)))+1:1}},{key:"_setWrapMode",value:function(t,n){var i=this._rhi.gl;switch(this._rhi.isWebGL2||t===e.TextureWrapMode.Clamp||a._isPowerOf2(this._width)&&a._isPowerOf2(this._height)||(Le.warn("non-power-2 texture is not supported for REPEAT or MIRRORED_REPEAT in WebGL1,and has automatically downgraded to CLAMP_TO_EDGE"),t=e.TextureWrapMode.Clamp),t){case e.TextureWrapMode.Clamp:i.texParameteri(this._target,n,i.CLAMP_TO_EDGE);break;case e.TextureWrapMode.Repeat:i.texParameteri(this._target,n,i.REPEAT);break;case e.TextureWrapMode.Mirror:i.texParameteri(this._target,n,i.MIRRORED_REPEAT)}}},{key:"width",get:function(){return this._width}},{key:"height",get:function(){return this._height}},{key:"wrapModeU",get:function(){return this._wrapModeU},set:function(e){if(e!==this._wrapModeU){var t=this._rhi.gl;this._wrapModeU=e,this._bind(),this._setWrapMode(e,t.TEXTURE_WRAP_S),this._unbind()}}},{key:"wrapModeV",get:function(){return this._wrapModeV},set:function(e){if(e!==this._wrapModeV){var t=this._rhi.gl;this._wrapModeV=e,this._bind(),this._setWrapMode(e,t.TEXTURE_WRAP_T),this._unbind()}}},{key:"mipmapCount",get:function(){return this._mipmapCount}},{key:"filterMode",get:function(){return this._filterMode},set:function(t){if(t!==this._filterMode){var n=this._rhi.gl;switch(this._filterMode=t,this._bind(),t){case e.TextureFilterMode.Point:n.texParameteri(this._target,n.TEXTURE_MAG_FILTER,n.NEAREST),n.texParameteri(this._target,n.TEXTURE_MIN_FILTER,this._mipmap?n.NEAREST_MIPMAP_NEAREST:n.NEAREST);break;case e.TextureFilterMode.Bilinear:n.texParameteri(this._target,n.TEXTURE_MAG_FILTER,n.LINEAR),n.texParameteri(this._target,n.TEXTURE_MIN_FILTER,this._mipmap?n.LINEAR_MIPMAP_NEAREST:n.LINEAR);break;case e.TextureFilterMode.Trilinear:n.texParameteri(this._target,n.TEXTURE_MAG_FILTER,n.LINEAR),n.texParameteri(this._target,n.TEXTURE_MIN_FILTER,this._mipmap?n.LINEAR_MIPMAP_LINEAR:n.LINEAR)}this._unbind()}}},{key:"anisoLevel",get:function(){return this._anisoLevel},set:function(e){var t=this._rhi.capability.maxAnisoLevel;if(e>t&&(Le.warn("anisoLevel:".concat(e,", exceeds the limit and is automatically downgraded to:").concat(t)),e=t),e<1&&(Le.warn("anisoLevel:".concat(e,", must be greater than 0, and is automatically downgraded to 1")),e=1),e!==this._anisoLevel){var n=this._rhi.gl;this._anisoLevel=e,this._bind(),n.texParameterf(this._target,n.TEXTURE_MAX_ANISOTROPY_EXT,e),this._unbind()}}}],[{key:"_isPowerOf2",value:function(e){return 0==(e&e-1)}},{key:"_getFormatDetail",value:function(t,n,i){switch(t){case e.TextureFormat.R8G8B8:return{internalFormat:i?n.RGB8:n.RGB,baseFormat:n.RGB,dataType:n.UNSIGNED_BYTE,isCompressed:!1};case e.TextureFormat.R8G8B8A8:return{internalFormat:i?n.RGBA8:n.RGBA,baseFormat:n.RGBA,dataType:n.UNSIGNED_BYTE,isCompressed:!1};case e.TextureFormat.R4G4B4A4:return{internalFormat:i?n.RGBA4:n.RGBA,baseFormat:n.RGBA,dataType:n.UNSIGNED_SHORT_4_4_4_4,isCompressed:!1};case e.TextureFormat.R5G5B5A1:return{internalFormat:i?n.RGB5_A1:n.RGBA,baseFormat:n.RGBA,dataType:n.UNSIGNED_SHORT_5_5_5_1,isCompressed:!1};case e.TextureFormat.R5G6B5:return{internalFormat:i?n.RGB565:n.RGB,baseFormat:n.RGB,dataType:n.UNSIGNED_SHORT_5_6_5,isCompressed:!1};case e.TextureFormat.Alpha8:return{internalFormat:n.ALPHA,baseFormat:n.ALPHA,dataType:n.UNSIGNED_BYTE,isCompressed:!1};case e.TextureFormat.R32G32B32A32:return{internalFormat:n.RGBA32F,baseFormat:n.RGBA,dataType:n.FLOAT,isCompressed:!1};case e.TextureFormat.DXT1:return{internalFormat:e.GLCompressedTextureInternalFormat.RGB_S3TC_DXT1_EXT,isCompressed:!0};case e.TextureFormat.DXT5:return{internalFormat:e.GLCompressedTextureInternalFormat.RGBA_S3TC_DXT5_EXT,isCompressed:!0};case e.TextureFormat.ETC1_RGB:return{internalFormat:e.GLCompressedTextureInternalFormat.RGB_ETC1_WEBGL,isCompressed:!0};case e.TextureFormat.ETC2_RGB:return{internalFormat:e.GLCompressedTextureInternalFormat.RGB8_ETC2,isCompressed:!0};case e.TextureFormat.ETC2_RGBA5:return{internalFormat:e.GLCompressedTextureInternalFormat.RGB8_PUNCHTHROUGH_ALPHA1_ETC2,isCompressed:!0};case e.TextureFormat.ETC2_RGBA8:return{internalFormat:e.GLCompressedTextureInternalFormat.RGBA8_ETC2_EAC,isCompressed:!0};case e.TextureFormat.PVRTC_RGB2:return{internalFormat:e.GLCompressedTextureInternalFormat.RGB_PVRTC_2BPPV1_IMG,isCompressed:!0};case e.TextureFormat.PVRTC_RGBA2:return{internalFormat:e.GLCompressedTextureInternalFormat.RGBA_PVRTC_2BPPV1_IMG,isCompressed:!0};case e.TextureFormat.PVRTC_RGB4:return{internalFormat:e.GLCompressedTextureInternalFormat.RGB_PVRTC_4BPPV1_IMG,isCompressed:!0};case e.TextureFormat.PVRTC_RGBA4:return{internalFormat:e.GLCompressedTextureInternalFormat.RGBA_PVRTC_4BPPV1_IMG,isCompressed:!0};case e.TextureFormat.ASTC_4x4:return{internalFormat:e.GLCompressedTextureInternalFormat.RGBA_ASTC_4X4_KHR,isCompressed:!0};case e.TextureFormat.ASTC_5x5:return{internalFormat:e.GLCompressedTextureInternalFormat.RGBA_ASTC_5X5_KHR,isCompressed:!0};case e.TextureFormat.ASTC_6x6:return{internalFormat:e.GLCompressedTextureInternalFormat.RGBA_ASTC_6X6_KHR,isCompressed:!0};case e.TextureFormat.ASTC_8x8:return{internalFormat:e.GLCompressedTextureInternalFormat.RGBA_ASTC_8X8_KHR,isCompressed:!0};case e.TextureFormat.ASTC_10x10:return{internalFormat:e.GLCompressedTextureInternalFormat.RGBA_ASTC_10X10_KHR,isCompressed:!0};case e.TextureFormat.ASTC_12x12:return{internalFormat:e.GLCompressedTextureInternalFormat.RGBA_ASTC_12X12_KHR,isCompressed:!0};default:throw new Error("this TextureFormat is not supported in Oasis Engine: ".concat(t))}}},{key:"_getRenderBufferColorFormatDetail",value:function(t,n,i){switch(t){case e.RenderBufferColorFormat.R8G8B8:return{internalFormat:i?n.RGB8:n.RGB,baseFormat:n.RGB,dataType:n.UNSIGNED_BYTE,isCompressed:!1};case e.RenderBufferColorFormat.R8G8B8A8:return{internalFormat:i?n.RGBA8:n.RGBA,baseFormat:n.RGBA,dataType:n.UNSIGNED_BYTE,isCompressed:!1};case e.RenderBufferColorFormat.R4G4B4A4:return{internalFormat:i?n.RGBA4:n.RGBA,baseFormat:n.RGBA,dataType:n.UNSIGNED_SHORT_4_4_4_4,isCompressed:!1};case e.RenderBufferColorFormat.R5G5B5A1:return{internalFormat:i?n.RGB5_A1:n.RGBA,baseFormat:n.RGBA,dataType:n.UNSIGNED_SHORT_5_5_5_1,isCompressed:!1};case e.RenderBufferColorFormat.R5G6B5:return{internalFormat:i?n.RGB565:n.RGB,baseFormat:n.RGB,dataType:n.UNSIGNED_SHORT_5_6_5,isCompressed:!1};case e.RenderBufferColorFormat.Alpha8:return{internalFormat:n.ALPHA,baseFormat:n.ALPHA,dataType:n.UNSIGNED_BYTE,isCompressed:!1};case e.RenderBufferColorFormat.R16G16B16A16:return{internalFormat:n.RGBA16F,baseFormat:n.RGBA,dataType:n.HALF_FLOAT,isCompressed:!1};case e.RenderBufferColorFormat.R32G32B32A32:return{internalFormat:n.RGBA32F,baseFormat:n.RGBA,dataType:n.FLOAT,isCompressed:!1};default:throw new Error("this RenderBufferColorFormat is not supported in Oasis Engine: ".concat(t))}}},{key:"_getRenderBufferDepthFormatDetail",value:function(t,n,i){switch(t){case e.RenderBufferDepthFormat.Depth:return{internalFormat:i?n.DEPTH_COMPONENT32F:n.DEPTH_COMPONENT16,baseFormat:n.DEPTH_COMPONENT,dataType:i?n.FLOAT:n.UNSIGNED_INT,isCompressed:!1,attachment:n.DEPTH_ATTACHMENT};case e.RenderBufferDepthFormat.DepthStencil:return{internalFormat:i?n.DEPTH24_STENCIL8:n.DEPTH_STENCIL,baseFormat:n.DEPTH_STENCIL,dataType:n.UNSIGNED_INT_24_8,isCompressed:!1,attachment:n.DEPTH_STENCIL_ATTACHMENT};case e.RenderBufferDepthFormat.Stencil:return{internalFormat:n.STENCIL_INDEX8,baseFormat:n.STENCIL_ATTACHMENT,dataType:n.UNSIGNED_BYTE,isCompressed:!1,attachment:n.STENCIL_ATTACHMENT};case e.RenderBufferDepthFormat.Depth16:return{internalFormat:n.DEPTH_COMPONENT16,baseFormat:n.DEPTH_COMPONENT,dataType:n.UNSIGNED_INT,isCompressed:!1,attachment:n.DEPTH_ATTACHMENT};case e.RenderBufferDepthFormat.Depth24:return{internalFormat:n.DEPTH_COMPONENT24,baseFormat:n.DEPTH_COMPONENT,dataType:n.UNSIGNED_INT,isCompressed:!1,attachment:n.DEPTH_ATTACHMENT};case e.RenderBufferDepthFormat.Depth32:return{internalFormat:n.DEPTH_COMPONENT32F,baseFormat:n.DEPTH_COMPONENT,dataType:n.FLOAT,isCompressed:!1,attachment:n.DEPTH_ATTACHMENT};case e.RenderBufferDepthFormat.Depth24Stencil8:return{internalFormat:i?n.DEPTH24_STENCIL8:n.DEPTH_STENCIL,baseFormat:n.DEPTH_STENCIL,dataType:n.UNSIGNED_INT_24_8,isCompressed:!1,attachment:n.DEPTH_STENCIL_ATTACHMENT};case e.RenderBufferDepthFormat.Depth32Stencil8:return{internalFormat:n.DEPTH32F_STENCIL8,baseFormat:n.DEPTH_STENCIL,dataType:n.FLOAT_32_UNSIGNED_INT_24_8_REV,isCompressed:!1,attachment:n.DEPTH_STENCIL_ATTACHMENT};default:throw new Error("this RenderBufferDepthFormat is not supported in Oasis Engine: ".concat(t))}}},{key:"_supportTextureFormat",value:function(t,n){var i=!0;switch(t){case e.TextureFormat.R32G32B32A32:n.canIUse(e.GLCapabilityType.textureFloat)||(i=!1)}return i}},{key:"_supportRenderBufferColorFormat",value:function(t,n){var i=!0;switch(t){case e.RenderBufferColorFormat.R32G32B32A32:n.canIUse(e.GLCapabilityType.colorBufferFloat)&&n.canIUse(e.GLCapabilityType.textureFloat)||(i=!1);break;case e.RenderBufferColorFormat.R16G16B16A16:n.canIUse(e.GLCapabilityType.colorBufferHalfFloat)&&n.canIUse(e.GLCapabilityType.textureHalfFloat)||(i=!1)}return i}},{key:"_supportRenderBufferDepthFormat",value:function(t,n,i){var r=n.isWebGL2,a=!0;if(i&&!n.canIUse(e.GLCapabilityType.depthTexture))return!1;switch(t){case e.RenderBufferDepthFormat.Stencil:a=!1;break;case e.RenderBufferDepthFormat.Depth24:case e.RenderBufferDepthFormat.Depth32:case e.RenderBufferDepthFormat.Depth32Stencil8:r||(a=!1)}return a}}]),a}(Ft);cn._readFrameBuffer=null;var hn=function(t){l(a,t);var i=m(a);function a(t,r,o){var s,u=arguments.length>3&&void 0!==arguments[3]?arguments[3]:e.TextureFormat.R8G8B8A8,l=!(arguments.length>4&&void 0!==arguments[4])||arguments[4];n(this,a),(s=i.call(this,t))._compressedMipFilled=0;var c=t._hardwareRenderer,h=c.gl,d=c.isWebGL2;if(!cn._supportTextureFormat(u,c))throw new Error("Texture format is not supported:".concat(e.TextureFormat[u]));!l||d||cn._isPowerOf2(r)&&cn._isPowerOf2(o)||(Le.warn("non-power-2 texture is not supported for mipmap in WebGL1,and has automatically downgraded to non-mipmap"),l=!1);var f=cn._getFormatDetail(u,h,d);return s._glTexture=h.createTexture(),s._formatDetail=f,s._rhi=c,s._target=h.TEXTURE_2D,s._mipmap=l,s._width=r,s._height=o,s._format=u,s._mipmapCount=s._getMipmapCount(),f.isCompressed&&!d||s._initMipmap(!1),s.filterMode=e.TextureFilterMode.Bilinear,s.wrapModeU=s.wrapModeV=e.TextureWrapMode.Repeat,s}return r(a,[{key:"setPixelBuffer",value:function(e){var t=arguments.length>1&&void 0!==arguments[1]?arguments[1]:0,n=arguments.length>2?arguments[2]:void 0,i=arguments.length>3?arguments[3]:void 0,r=arguments.length>4?arguments[4]:void 0,a=arguments.length>5?arguments[5]:void 0,o=this._rhi.gl,s=this._rhi.isWebGL2,u=this._formatDetail,l=u.internalFormat,c=u.baseFormat,h=u.dataType,d=u.isCompressed,f=Math.max(1,this._width>>t),_=Math.max(1,this._height>>t);if(n=n||0,i=i||0,r=r||f-n,a=a||_-i,this._bind(),o.pixelStorei(o.UNPACK_FLIP_Y_WEBGL,0),o.pixelStorei(o.UNPACK_PREMULTIPLY_ALPHA_WEBGL,0),d){var p=1<<t;s||this._compressedMipFilled&p?o.compressedTexSubImage2D(this._target,t,n,i,r,a,l,e):(o.compressedTexImage2D(this._target,t,l,r,a,0,e),this._compressedMipFilled|=p)}else o.texSubImage2D(this._target,t,n,i,r,a,c,h,e);this._unbind()}},{key:"setImageSource",value:function(e){var t=arguments.length>1&&void 0!==arguments[1]?arguments[1]:0,n=arguments.length>2&&void 0!==arguments[2]&&arguments[2],i=arguments.length>3&&void 0!==arguments[3]&&arguments[3],r=arguments.length>4?arguments[4]:void 0,a=arguments.length>5?arguments[5]:void 0,o=this._rhi.gl,s=this._formatDetail,u=s.baseFormat,l=s.dataType;this._bind(),o.pixelStorei(o.UNPACK_FLIP_Y_WEBGL,+n),o.pixelStorei(o.UNPACK_PREMULTIPLY_ALPHA_WEBGL,+i),o.texSubImage2D(this._target,t,r||0,a||0,u,l,e),this._unbind()}},{key:"getPixelBuffer",value:function(e,t,n,i,r){if(this._formatDetail.isCompressed)throw new Error("Unable to read compressed texture");g(c(a.prototype),"_getPixelBuffer",this).call(this,null,e,t,n,i,r)}},{key:"format",get:function(){return this._format}}]),a}(cn),dn=Object.defineProperty,fn=Object.getOwnPropertyDescriptor,_n=function(e,t,n,i){for(var r,a=i>1?void 0:i?fn(t,n):t,o=e.length-1;o>=0;o--)(r=e[o])&&(a=(i?r(t,n,a):r(a))||a);return i&&a&&dn(t,n,a),a},pn=function(t){l(a,t);var i=m(a);function a(e){var t;return n(this,a),(t=i.call(this,e))._hasInitJoints=!1,t.weightsIndices=[],t._useJointTexture=!1,t._mat=new F,t._weights=null,t._skin=null,t}return r(a,[{key:"setWeights",value:function(e){if(this._weights=e,e){for(var t=e.length,n=0;n<t;n++)this.weightsIndices[n]=n;for(var i=this.weightsIndices,r=0;r<t-1;r++)for(var a=r+1;a<t;a++)if(e[a]>e[r]){var o=e[r];e[r]=e[a],e[a]=o,o=i[r],i[r]=i[a],i[a]=o}this.mesh.updatePrimitiveWeightsIndices(i)}}},{key:"_initJoints",value:function(){if(this._skin){for(var e=this._skin.joints,t=[],n=e.length-1;n>=0;n--)t[n]=this.findByNodeName(this.entity,e[n]);this.matrixPalette=new Float32Array(16*t.length),this.jointNodes=t;var i=this.entity.engine._hardwareRenderer;if(i){var r=i.renderStates.getParameter(i.gl.MAX_VERTEX_UNIFORM_VECTORS),a=Math.floor((r-20)/4);e.length>a&&i.canIUseMoreJoints&&(this._useJointTexture=!0)}}}},{key:"findByNodeName",value:function(e,t){if(!e)return null;var n=e.findByName(t);return n||this.findByNodeName(e.parent,t)}},{key:"_findParent",value:function(e,t){if(e){var n=e.parent;if(!n)return null;if(n.name===t)return n;var i=n.findByName(t);return i||this._findParent(n,t)}return null}},{key:"update",value:function(){if(this._hasInitJoints||(this._initJoints(),this._hasInitJoints=!0),this._skin){for(var e=this.jointNodes,t=this._skin.inverseBindMatrices,n=this.matrixPalette,i=this.entity.getInvModelMatrix(),r=this._mat,a=e.length-1;a>=0;a--)r.identity(),e[a]?F.multiply(e[a].transform.worldMatrix,t[a],r):t[a].cloneTo(r),F.multiply(i,r,r),n.set(r.elements,16*a);this._useJointTexture&&this.createJointTexture()}}},{key:"createJointTexture",value:function(){if(!this.jointTexture){var t=this.engine;if(!t._hardwareRenderer)return;this.jointTexture=new hn(t,4,this.jointNodes.length,e.TextureFormat.R32G32B32A32,!1),this.jointTexture.filterMode=e.TextureFilterMode.Point}this.jointTexture.setPixelBuffer(this.matrixPalette)}},{key:"skin",get:function(){return this._skin},set:function(e){this._skin=e}},{key:"weights",get:function(){return this._weights}}]),a}(ln);_n([J],pn.prototype,"matrixPalette",2),_n([J],pn.prototype,"jointNodes",2),_n([J],pn.prototype,"jointTexture",2),_n([J],pn.prototype,"_hasInitJoints",2),_n([J],pn.prototype,"_mat",2),_n([J],pn.prototype,"_weights",2),_n([J],pn.prototype,"weightsIndices",2),_n([J],pn.prototype,"_useJointTexture",2);var vn,mn,gn,yn=function(e){l(i,e);var t=m(i);function i(){var e;return n(this,i),(e=t.apply(this,arguments))._lods=[],e}return r(i,[{key:"addLod",value:function(e,t){t.enabled=!1,this._lods.push({distance:e,rendererAbility:t}),this._lods.sort((function(e,t){return t.distance-e.distance}))}},{key:"render",value:function(e){if(!(this._lods.length<=0)){for(var t=w.distance(e.eyePos,this.entity.worldPosition),n=this._lods,i=0,r=n.length-1;r>=0;r--){if(t<n[r].distance){i=r;break}}n[i].rendererAbility.render(e)}}}]),i}(dt),xn=function(t){l(a,t);var i=m(a);function a(t,r){var o;return n(this,a),(o=i.call(this,t)).name=r,o.renderType=e.MaterialType.OPAQUE,o.useFog=!0,o.maxJointsNum=0,o._technique=null,o._values={},o}return r(a,[{key:"clone",value:function(){var e=arguments.length>0&&void 0!==arguments[0]?arguments[0]:this.name,t=new this.constructor(e);for(var n in t.renderType=this.renderType,t.useFog=this.useFog,this._values)if(this._values.hasOwnProperty(n)){var i=this._values[n];i instanceof cn?t.setValue(n,i):t.setValue(n,H.clone(i))}return t}},{key:"setValue",value:function(e,t){var n=this.getValue(e),i=n instanceof cn,r=t instanceof cn;i&&this._removeRefChild(n),r&&this._addRefChild(t),this._generateTechnique&&i!==r&&(this._technique=null),null!=t?this._values[e]=t:this.delValue(e)}},{key:"delValue",value:function(e){delete this._values[e]}},{key:"getValue",value:function(e){return this._values[e]}},{key:"prepareDrawing",value:function(e,t,n,i){var r=e.camera,a=this._technique.uniforms;for(var o in a){var s=a[o];this._updateValueBySemantic(s,e,t)}var u=r.scene;u.hasFogFeature&&u.bindFogToMaterial(this),this._technique.compile(r,t,n,this)}},{key:"preCompile",value:function(e){}},{key:"postCompile",value:function(e){}},{key:"preRender",value:function(e,t){}},{key:"postRender",value:function(e,t){}},{key:"_updateValueBySemantic",value:function(t,n,i){var r,a=this._values;switch(t.semantic){case e.UniformSemantic.LOCAL:a[t.name]=i._entity.transform.localMatrix;break;case e.UniformSemantic.MODEL:a[t.name]=i._entity.transform.worldMatrix;break;case e.UniformSemantic.VIEW:a[t.name]=n.viewMatrix;break;case e.UniformSemantic.PROJECTION:a[t.name]=n.projectionMatrix;break;case e.UniformSemantic.MODELVIEW:var o=n.viewMatrix,s=i._entity.transform.worldMatrix,u=a[t.name];u||(u=new F),F.multiply(o,s,u),a[t.name]=u;break;case e.UniformSemantic.VIEWPROJECTION:var l=n.viewProjectMatrix;a[t.name]=l;break;case e.UniformSemantic.MODELVIEWPROJECTION:var c=n.viewProjectMatrix,h=i._entity.transform.worldMatrix,d=a[t.name];d||(d=new F),F.multiply(c,h,d),a[t.name]=d;break;case e.UniformSemantic.MODELINVERSE:a[t.name]=i.invModelMatrixs;break;case e.UniformSemantic.VIEWINVERSE:a[t.name]=n.inverseViewMatrix;break;case e.UniformSemantic.PROJECTIONINVERSE:a[t.name]=n.inverseProjectionMatrix;break;case e.UniformSemantic.MODELVIEWINVERSE:var f=n.viewMatrix,_=i._entity.transform.worldMatrix,p=a[t.name];p||(p=new F),F.multiply(f,_,p),F.invert(p,p),a[t.name]=p;break;case e.UniformSemantic.MODELVIEWPROJECTIONINVERSE:var v=n.viewProjectMatrix,m=i._entity.transform.worldMatrix,g=a[t.name];g||(g=new F),F.multiply(v,m,g),F.invert(g,g),a[t.name]=g;break;case e.UniformSemantic.MODELINVERSETRANSPOSE:var y=a[t.name];y||(y=new P),P.normalMatrix(i._entity.transform.worldMatrix,y),a[t.name]=y;break;case e.UniformSemantic.MODELVIEWINVERSETRANSPOSE:var x=a[t.name];x||(x=new F),F.multiply(n.viewMatrix,i._entity.transform.worldMatrix,x),F.invert(x,x),F.transpose(x,x),a[t.name]=x;break;case e.UniformSemantic.VIEWPORT:a[t.name]=n.viewport;break;case e.UniformSemantic.JOINTMATRIX:a[t.name]=i.matrixPalette;break;case e.UniformSemantic.JOINTTEXTURE:a[t.name]=i.jointTexture;break;case e.UniformSemantic.JOINTCOUNT:a[t.name]=null===(r=i.jointNodes)||void 0===r?void 0:r.length;break;case e.UniformSemantic.MORPHWEIGHTS:a[t.name]=i.weights;break;case e.UniformSemantic.EYEPOS:a[t.name]=n.cameraPosition;break;case e.UniformSemantic.TIME:a[t.name]=.001*i.engine.time.timeSinceStartup}}},{key:"_onDestroy",value:function(){if(this._technique){for(var e=W(this._values),t=0,n=e.length;t<n;t++){var i=e[t];i instanceof cn&&i._addRefCount(-1)}this._technique._finalize(),this._technique=null}}},{key:"transparent",get:function(){return this.renderType===e.MaterialType.TRANSPARENT},set:function(t){this.renderType=t?e.MaterialType.TRANSPARENT:e.MaterialType.OPAQUE}},{key:"technique",get:function(){return this._technique},set:function(e){this._technique=e,this._values={}}}]),a}(Ft),Tn=function(e){l(i,e);var t=m(i);function i(e,r){var a;return n(this,i),(a=t.call(this,e,r))._techniquePool={},a}return r(i,[{key:"prepareDrawing",value:function(e,t,n){var r=e.camera,a=this._requireTechnique(r,t,n);a&&(this._technique=a,g(c(i.prototype),"prepareDrawing",this).call(this,e,t,n))}},{key:"clearTechniques",value:function(){this._techniquePool={}}},{key:"_requireTechnique",value:function(e,t,n){var i=this._getTechniqueKey(e,t,n),r=this._techniquePool[i];return r||(r=this._generateTechnique(e,t,n),this._techniquePool[i]=r),r}},{key:"_generateTechnique",value:function(e,t,n){}},{key:"_getTechniqueKey",value:function(e,t,n){var i=null!=t.skin,r=i?t.skin.joints.length:0,a=i?"skin_":"static_";return i&&(a+="jont"+r),a}}]),i}(xn);(vn=e.BufferUsage||(e.BufferUsage={}))[vn.Static=0]="Static",vn[vn.Dynamic=1]="Dynamic",vn[vn.Stream=2]="Stream",(mn=e.VertexElementFormat||(e.VertexElementFormat={}))[mn.Float=0]="Float",mn[mn.Vector2=1]="Vector2",mn[mn.Vector3=2]="Vector3",mn[mn.Vector4=3]="Vector4",mn[mn.Byte4=4]="Byte4",mn[mn.UByte4=5]="UByte4",mn[mn.NormalizedByte4=6]="NormalizedByte4",mn[mn.NormalizedUByte4=7]="NormalizedUByte4",mn[mn.Short2=8]="Short2",mn[mn.UShort2=9]="UShort2",mn[mn.NormalizedShort2=10]="NormalizedShort2",mn[mn.NormalizedUShort2=11]="NormalizedUShort2",mn[mn.Short4=12]="Short4",mn[mn.UShort4=13]="UShort4",mn[mn.NormalizedShort4=14]="NormalizedShort4",mn[mn.NormalizedUShort4=15]="NormalizedUShort4",(gn=e.IndexFormat||(e.IndexFormat={}))[gn.UInt8=0]="UInt8",gn[gn.UInt16=1]="UInt16",gn[gn.UInt32=2]="UInt32";var An,Sn,En=function(){function t(){n(this,t)}return r(t,null,[{key:"_getGLBufferUsage",value:function(t,n){switch(n){case e.BufferUsage.Static:return t.STATIC_DRAW;case e.BufferUsage.Dynamic:return t.DYNAMIC_DRAW;case e.BufferUsage.Stream:return t.STREAM_DRAW}}},{key:"_getGLIndexType",value:function(t){switch(t){case e.IndexFormat.UInt8:return e.DataType.UNSIGNED_BYTE;case e.IndexFormat.UInt16:return e.DataType.UNSIGNED_SHORT;case e.IndexFormat.UInt32:return e.DataType.UNSIGNED_INT}}},{key:"_getElementInfo",value:function(t){var n,i;switch(t){case e.VertexElementFormat.Float:n=1,i=e.DataType.FLOAT;break;case e.VertexElementFormat.Vector2:n=2,i=e.DataType.FLOAT;break;case e.VertexElementFormat.Vector3:n=3,i=e.DataType.FLOAT;break;case e.VertexElementFormat.Vector4:n=4,i=e.DataType.FLOAT;break;case e.VertexElementFormat.Byte4:n=4,i=e.DataType.UNSIGNED_BYTE;break;case e.VertexElementFormat.Short2:n=2,i=e.DataType.SHORT;break;case e.VertexElementFormat.Short4:n=4,i=e.DataType.SHORT;break;case e.VertexElementFormat.UShort2:n=2,i=e.DataType.UNSIGNED_SHORT;break;case e.VertexElementFormat.UShort4:n=4,i=e.DataType.UNSIGNED_SHORT}return{size:n,type:i}}}]),t}();(An=e.BufferBindFlag||(e.BufferBindFlag={}))[An.VertexBuffer=0]="VertexBuffer",An[An.IndexBuffer=1]="IndexBuffer",(Sn=e.SetDataOptions||(e.SetDataOptions={}))[Sn.None=0]="None",Sn[Sn.Discard=1]="Discard";var Cn,bn=function(t){l(a,t);var i=m(a);function a(t,r,o){var s,u=arguments.length>3&&void 0!==arguments[3]?arguments[3]:e.BufferUsage.Static;n(this,a),(s=i.call(this,t))._engine=t,s._type=r,s._bufferUsage=u;var l=t._hardwareRenderer,c=l.gl,h=En._getGLBufferUsage(c,u),d=r===e.BufferBindFlag.VertexBuffer?c.ARRAY_BUFFER:c.ELEMENT_ARRAY_BUFFER;return s._nativeBuffer=c.createBuffer(),s._hardwareRenderer=l,s._glBufferUsage=h,s._glBindTarget=d,s.bind(),"number"==typeof o?(s._byteLength=o,c.bufferData(d,o,h)):(s._byteLength=o.byteLength,c.bufferData(d,o,h)),c.bindBuffer(d,null),s}return r(a,[{key:"engine",get:function(){return this._engine}},{key:"type",get:function(){return this._type}},{key:"byteLength",get:function(){return this._byteLength}},{key:"bufferUsage",get:function(){return this._bufferUsage}}]),r(a,[{key:"bind",value:function(){this._hardwareRenderer.gl.bindBuffer(this._glBindTarget,this._nativeBuffer)}},{key:"setData",value:function(t){var n=arguments.length>1&&void 0!==arguments[1]?arguments[1]:0,i=arguments.length>2&&void 0!==arguments[2]?arguments[2]:0,r=arguments.length>3?arguments[3]:void 0,a=arguments.length>4&&void 0!==arguments[4]?arguments[4]:e.SetDataOptions.None,o=this._hardwareRenderer.gl,s=this._hardwareRenderer.isWebGL2,u=this._glBindTarget;this.bind(),a===e.SetDataOptions.Discard&&o.bufferData(u,this._byteLength,this._glBufferUsage);var l=t.BYTES_PER_ELEMENT||1,c=r?l*r:t.byteLength;if(0!==i||c<t.byteLength){var h=void 0!==t.byteOffset;if(s&&h)o.bufferSubData(u,n,t,i,c/l);else{var d=new Uint8Array(h?t.buffer:t,i*l,c);o.bufferSubData(u,n,d)}}else o.bufferSubData(u,n,t);o.bindBuffer(u,null)}},{key:"getData",value:function(e){var t=arguments.length>1&&void 0!==arguments[1]?arguments[1]:0,n=arguments.length>2&&void 0!==arguments[2]?arguments[2]:0,i=arguments.length>3?arguments[3]:void 0,r=this._hardwareRenderer.isWebGL2;if(!r)throw"Buffer is write-only on WebGL1.0 platforms.";var a=this._hardwareRenderer.gl;this.bind(),a.getBufferSubData(this._glBindTarget,t,e,n,i)}},{key:"_onDestroy",value:function(){this._hardwareRenderer.gl.deleteBuffer(this._nativeBuffer),this._nativeBuffer=null,this._hardwareRenderer=null}},{key:"resize",value:function(e){this.bind(),this._hardwareRenderer.gl.bufferData(this._glBindTarget,e,this._glBufferUsage),this._byteLength=e}}]),a}(Ft);(Cn=e.PrimitiveTopology||(e.PrimitiveTopology={}))[Cn.Points=0]="Points",Cn[Cn.Lines=1]="Lines",Cn[Cn.LineLoop=2]="LineLoop",Cn[Cn.LineStrip=3]="LineStrip",Cn[Cn.Triangles=4]="Triangles",Cn[Cn.TriangleStrip=5]="TriangleStrip",Cn[Cn.TriangleFan=6]="TriangleFan";var Rn=function(){function e(t,i){n(this,e),this._buffer=t,this._format=i}return r(e,[{key:"buffer",get:function(){return this._buffer}},{key:"format",get:function(){return this._format}}]),e}(),wn=function(){function e(t,i){n(this,e),this._buffer=t,this._stride=i}return r(e,[{key:"buffer",get:function(){return this._buffer}},{key:"stride",get:function(){return this._stride}}]),e}(),Mn=function(e){l(i,e);var t=m(i);function i(e,r){var a;return n(this,i),(a=t.call(this,e)).instanceCount=0,a._vertexElementMap={},a._vertexBufferBindings=[],a._indexBufferBinding=null,a._vertexElements=[],a.targets=[],a.boundingBox=null,a.boundingSphere=null,a.isInFrustum=!0,a.name=r,a._platformPrimitive=a._engine._hardwareRenderer.createPlatformPrimitive(p(a)),a}return r(i,[{key:"setVertexBufferBinding",value:function(e){var t=arguments.length>1&&void 0!==arguments[1]?arguments[1]:0,n=arguments.length>2&&void 0!==arguments[2]?arguments[2]:0,i=e,r=void 0!==i.buffer;r||(i=new wn(e,t));var a=this._vertexBufferBindings;a.length<=n&&(a.length=n+1),this._setVertexBufferBinding(r?t:n,i)}},{key:"setVertexBufferBindings",value:function(e){var t=arguments.length>1&&void 0!==arguments[1]?arguments[1]:0,n=this._vertexBufferBindings,i=e,r=i.length,a=t+r;n.length<a&&(n.length=a);for(var o=0;o<r;o++)this._setVertexBufferBinding(t+o,i[o])}},{key:"setIndexBufferBinding",value:function(e,t){var n=e;void 0!==n.buffer||(n=new Rn(e,t)),this._indexBufferBinding=n,this._glIndexType=En._getGLIndexType(n.format)}},{key:"setVertexElements",value:function(e){this._clearVertexElements();for(var t=0,n=e.length;t<n;t++)this._addVertexElement(e[t])}},{key:"draw",value:function(e,t){this._platformPrimitive.draw(e,t)}},{key:"_onDestroy",value:function(){this._vertexBufferBindings=null,this._indexBufferBinding=null,this._vertexElements=null,this._vertexElementMap=null,this._platformPrimitive.destroy()}},{key:"_clearVertexElements",value:function(){this._vertexElements.length=0;var e=this._vertexElementMap;for(var t in e)delete e[t]}},{key:"_addVertexElement",value:function(e){this._vertexElementMap[e.semantic]=e,this._vertexElements.push(e)}},{key:"_setVertexBufferBinding",value:function(e,t){var n=this._vertexBufferBindings[e];n&&this._removeRefChild(n._buffer),this._addRefChild(t._buffer),this._vertexBufferBindings[e]=t}},{key:"vertexBufferBindings",get:function(){return this._vertexBufferBindings}},{key:"vertexElements",get:function(){return this._vertexElements}},{key:"indexBufferBinding",get:function(){return this._indexBufferBinding}}]),i}(Ft),Ln=function(){function e(t,i,r,a){var o=arguments.length>4&&void 0!==arguments[4]?arguments[4]:0;n(this,e),this.normalized=!1,this._semantic=t,this._offset=i,this._format=r,this._bindingIndex=a,this._glElementInfo=En._getElementInfo(this.format),this._instanceStepRate=Math.floor(o)}return r(e,[{key:"semantic",get:function(){return this._semantic}},{key:"offset",get:function(){return this._offset}},{key:"format",get:function(){return this._format}},{key:"bindingIndex",get:function(){return this._bindingIndex}},{key:"instanceStepRate",get:function(){return this._instanceStepRate}},{key:"elementInfo",get:function(){return this._glElementInfo}}]),e}(),Pn=function t(){var i=arguments.length>0&&void 0!==arguments[0]?arguments[0]:0,r=arguments.length>1&&void 0!==arguments[1]?arguments[1]:0,a=arguments.length>2&&void 0!==arguments[2]?arguments[2]:e.PrimitiveTopology.Triangles;n(this,t),this.start=i,this.count=r,this.topology=a},On=u({common:"#define PI 3.14159265359\n#define LOG2 1.442695\n\n#define saturate( a ) clamp( a, 0.0, 1.0 )\n#define whiteCompliment(a) ( 1.0 - saturate( a ) )\n\n// nosie common\n#include <noise_common>\n",common_vert:"attribute vec3 a_position;\n\n#ifdef O3_HAS_UV\n\nattribute vec2 a_uv;\n\n#endif\n\n#ifdef O3_HAS_NORMAL\n\nattribute vec3 a_normal;\n\n#endif\n\n#ifdef O3_HAS_TANGENT\n\nattribute vec4 a_tangent;\n\n#endif\n\n#ifdef O3_HAS_VERTEXCOLOR\n\nattribute vec4 a_color;\n\n#endif\n\n#if defined( O3_HAS_SKIN ) && ( defined( O3_JOINTS_NUM ) || defined( O3_USE_JOINT_TEXTURE ) )\n    attribute vec4 a_joint;\n    attribute vec4 a_weight;\n\n    #ifdef O3_USE_JOINT_TEXTURE\n        uniform sampler2D u_jointSampler;\n        uniform float u_jointCount;\n\n        mat4 getJointMatrix(sampler2D smp, float index)\n        {\n            float base = index / u_jointCount;\n            float hf = 0.5 / u_jointCount;\n            float v = base + hf;\n\n            vec4 m0 = texture2D(smp, vec2(0.125, v ));\n            vec4 m1 = texture2D(smp, vec2(0.375, v ));\n            vec4 m2 = texture2D(smp, vec2(0.625, v ));\n            vec4 m3 = texture2D(smp, vec2(0.875, v ));\n\n            return mat4(m0, m1, m2, m3);\n\n        }\n\n    #elif defined( O3_JOINTS_NUM )\n        uniform mat4 u_jointMatrix[ O3_JOINTS_NUM ];\n    #endif\n#endif\n\nuniform mat4 u_localMat;\nuniform mat4 u_modelMat;\nuniform mat4 u_viewMat;\nuniform mat4 u_projMat;\nuniform mat4 u_MVMat;\nuniform mat4 u_MVPMat;\nuniform mat3 u_normalMat;\nuniform vec3 u_cameraPos;\nuniform float u_time;\n",common_frag:"uniform O3_VERTEX_PRECISION mat4 u_localMat;\nuniform O3_VERTEX_PRECISION mat4 u_modelMat;\nuniform O3_VERTEX_PRECISION mat4 u_viewMat;\nuniform O3_VERTEX_PRECISION mat4 u_projMat;\nuniform O3_VERTEX_PRECISION mat4 u_MVMat;\nuniform O3_VERTEX_PRECISION mat4 u_MVPMat;\nuniform O3_VERTEX_PRECISION mat3 u_normalMat;\nuniform O3_VERTEX_PRECISION vec3 u_cameraPos;\nuniform O3_VERTEX_PRECISION float u_time;\n",color_share:"#ifdef O3_HAS_VERTEXCOLOR\n\nvarying vec4 v_color;\n\n#endif\n",normal_share:"#ifdef O3_HAS_NORMAL\n\n    #if defined( O3_HAS_TANGENT ) && defined( O3_HAS_NORMALMAP )\n\n    varying mat3 v_TBN;\n\n    #else\n\n    varying vec3 v_normal;\n\n    #endif\n\n#endif\n",uv_share:"varying vec2 v_uv;\n",worldpos_share:"#if defined( O3_NEED_WORLDPOS ) || defined( O3_HAS_ENVMAP ) || defined( O3_HAS_LIGHTMAP ) || defined(O3_CLIPPLANE_NUM)\n\nvarying vec3 v_pos;\n\n#endif\n",shadow_share:"#ifdef O3_GENERATE_SHADOW_MAP\n\nuniform mat4 u_viewMatFromLight;\nuniform mat4 u_projMatFromLight;\n\n#endif\n\n#ifdef O3_SHADOW_MAP_COUNT\n\nuniform mat4 u_viewMatFromLight[O3_SHADOW_MAP_COUNT];\nuniform mat4 u_projMatFromLight[O3_SHADOW_MAP_COUNT];\nvarying vec4 v_PositionFromLight[O3_SHADOW_MAP_COUNT];\n\n#endif\n",fog_share:"#ifdef O3_HAS_FOG\n\nvarying vec3 v_fogDepth;\n\nuniform O3_VERTEX_PRECISION vec3 u_fogColor;\n\n    #ifdef O3_FOG_EXP2\n\n        uniform O3_VERTEX_PRECISION float u_fogDensity;\n\n    #else\n\n        uniform O3_VERTEX_PRECISION float u_fogNear;\n        uniform O3_VERTEX_PRECISION float u_fogFar;\n\n    #endif\n\n#endif\n",begin_normal_vert:"    #ifdef O3_HAS_NORMAL\n\n    vec3 normal = vec3( a_normal );\n\n        #if defined( O3_HAS_TANGENT ) && defined( O3_HAS_NORMALMAP )\n\n        vec4 tangent = vec4( a_tangent );\n\n        #endif\n\n    #endif\n",begin_position_vert:"    vec4 position = vec4( a_position , 1.0 );\n",morph_target_vert:"#ifdef O3_HAS_MORPH\n\n    uniform float u_morphWeights[ O3_MORPH_NUM ];\n\n    #ifdef O3_MORPH_POSITION\n\n    attribute vec3 a_position0;\n\n    #endif\n\n    #ifdef O3_MORPH_NORMAL\n\n    attribute vec3 a_normal0;\n\n    #endif\n\n    #ifdef O3_MORPH_TANGENT\n\n    attribute vec3 a_tangent0;\n\n    #endif\n\n    #if O3_MORPH_NUM > 1\n\n        #ifdef O3_MORPH_POSITION\n\n        attribute vec3 a_position1;\n\n        #endif\n\n        #ifdef O3_MORPH_NORMAL\n\n        attribute vec3 a_normal1;\n\n        #endif\n\n        #ifdef O3_MORPH_TANGENT\n\n        attribute vec3 a_tangent1;\n\n        #endif\n\n    #endif\n\n    #if O3_MORPH_NUM > 2\n\n        #ifdef O3_MORPH_POSITION\n\n        attribute vec3 a_position2;\n\n        #endif\n\n        #ifdef O3_MORPH_NORMAL\n\n        attribute vec3 a_normal2;\n\n        #endif\n\n        #ifdef O3_MORPH_TANGENT\n\n        attribute vec3 a_tangent2;\n\n        #endif\n\n    #endif\n\n    #if O3_MORPH_NUM > 3\n\n        #ifdef O3_MORPH_POSITION\n\n        attribute vec3 a_position3;\n\n        #endif\n\n        #ifdef O3_MORPH_NORMAL\n\n        attribute vec3 a_normal3;\n\n        #endif\n\n        #ifdef O3_MORPH_TANGENT\n\n        attribute vec3 a_tangent3;\n\n        #endif\n\n    #endif\n\n    #if O3_MORPH_NUM > 4\n\n        #ifdef O3_MORPH_POSITION\n\n        attribute vec3 a_position4;\n\n        #endif\n\n        #ifdef O3_MORPH_NORMAL\n\n        attribute vec3 a_normal4;\n\n        #endif\n\n        #ifdef O3_MORPH_TANGENT\n\n        attribute vec3 a_tangent4;\n\n        #endif\n\n    #endif\n\n    #if O3_MORPH_NUM > 5\n\n        #ifdef O3_MORPH_POSITION\n\n        attribute vec3 a_position5;\n\n        #endif\n\n        #ifdef O3_MORPH_NORMAL\n\n        attribute vec3 a_normal5;\n\n        #endif\n\n        #ifdef O3_MORPH_TANGENT\n\n        attribute vec3 a_tangent5;\n\n        #endif\n\n    #endif\n\n    #if O3_MORPH_NUM > 6\n\n        #ifdef O3_MORPH_POSITION\n\n        attribute vec3 a_position6;\n\n        #endif\n\n        #ifdef O3_MORPH_NORMAL\n\n        attribute vec3 a_normal6;\n\n        #endif\n\n        #ifdef O3_MORPH_TANGENT\n\n        attribute vec3 a_tangent6;\n\n        #endif\n\n    #endif\n\n    #if O3_MORPH_NUM > 7\n\n        #ifdef O3_MORPH_POSITION\n\n        attribute vec3 a_position7;\n\n        #endif\n\n        #ifdef O3_MORPH_NORMAL\n\n        attribute vec3 a_normal7;\n\n        #endif\n\n        #ifdef O3_MORPH_TANGENT\n\n        attribute vec3 a_tangent7;\n\n        #endif\n\n    #endif\n\n#endif\n",position_vert:"    #ifndef O3_GENERATE_SHADOW_MAP\n\n    gl_Position = u_MVPMat * position;\n\n    #endif\n",color_vert:"    #ifdef O3_HAS_VERTEXCOLOR\n\n    v_color = a_color;\n\n    #endif\n",normal_vert:"    #ifdef O3_HAS_NORMAL\n\n        #if defined( O3_HAS_TANGENT ) && defined( O3_HAS_NORMALMAP )\n\n        vec3 normalW = normalize( u_normalMat * normal.xyz );\n        vec3 tangentW = normalize( u_normalMat * tangent.xyz );\n        vec3 bitangentW = cross( normalW, tangentW ) * tangent.w;\n        v_TBN = mat3( tangentW, bitangentW, normalW );\n\n        #else\n\n        v_normal = normalize( u_normalMat * normal );\n\n        #endif\n\n    #endif\n",skinning_vert:"#if defined( O3_HAS_SKIN ) && ( defined( O3_JOINTS_NUM ) || defined( O3_USE_JOINT_TEXTURE ) )\n\n        #ifdef O3_USE_JOINT_TEXTURE\n            mat4 skinMatrix =\n                a_weight.x * getJointMatrix(u_jointSampler, a_joint.x ) +\n                a_weight.y * getJointMatrix(u_jointSampler, a_joint.y ) +\n                a_weight.z * getJointMatrix(u_jointSampler, a_joint.z ) +\n                a_weight.w * getJointMatrix(u_jointSampler, a_joint.w );\n\n        #elif defined( O3_JOINTS_NUM )\n            mat4 skinMatrix =\n                a_weight.x * u_jointMatrix[ int( a_joint.x ) ] +\n                a_weight.y * u_jointMatrix[ int( a_joint.y ) ] +\n                a_weight.z * u_jointMatrix[ int( a_joint.z ) ] +\n                a_weight.w * u_jointMatrix[ int( a_joint.w ) ];\n        #endif\n\n        position = skinMatrix * position;\n\n        #ifdef O3_HAS_NORMAL\n            normal = vec4( skinMatrix * vec4( normal, 0.0 ) ).xyz;\n            #if defined( O3_HAS_TANGENT ) && defined( O3_HAS_NORMALMAP )\n                tangent.xyz = vec4( skinMatrix * vec4( tangent.xyz, 0.0 ) ).xyz;\n            #endif\n\n        #endif\n\n#endif\n",uv_vert:"    #ifdef O3_HAS_UV\n\n    v_uv = a_uv;\n\n    #else\n\n    // may need this calculate normal\n    v_uv = vec2( 0., 0. );\n\n    #endif\n",worldpos_vert:"    #if defined( O3_NEED_WORLDPOS ) || defined( O3_HAS_ENVMAP ) || defined( O3_HAS_LIGHTMAP ) || defined(O3_CLIPPLANE_NUM)\n\n    vec4 temp_pos = u_modelMat * position;\n    v_pos = temp_pos.xyz / temp_pos.w;\n\n    #endif\n",shadow_vert:"    #ifdef O3_GENERATE_SHADOW_MAP\n\n    gl_Position = u_projMatFromLight * u_viewMatFromLight * u_modelMat * position;\n\n    #endif\n\n    #ifdef O3_SHADOW_MAP_COUNT\n\n    for (int i = 0; i < O3_SHADOW_MAP_COUNT; i++) {\n\n        v_PositionFromLight[i] = u_projMatFromLight[i] * u_viewMatFromLight[i] * u_modelMat * vec4( a_position, 1.0 );\n\n    }\n\n    #endif\n",morph_vert:"    #ifdef O3_HAS_MORPH\n\n        #if defined( O3_MORPH_POSITION )\n\n        position.xyz += u_morphWeights[ 0 ] * a_position0;\n\n            #if O3_MORPH_NUM > 1\n\n            position.xyz += u_morphWeights[ 1 ] * a_position1;\n\n            #endif\n\n            #if O3_MORPH_NUM > 2\n\n            position.xyz += u_morphWeights[ 2 ] * a_position2;\n\n            #endif\n\n            #if O3_MORPH_NUM > 3\n\n            position.xyz += u_morphWeights[ 3 ] * a_position3;\n\n            #endif\n\n            #if O3_MORPH_NUM > 4\n\n            position.xyz += u_morphWeights[ 4 ] * a_position4;\n\n            #endif\n\n            #if O3_MORPH_NUM > 5\n\n            position.xyz += u_morphWeights[ 5 ] * a_position5;\n\n            #endif\n\n            #if O3_MORPH_NUM > 6\n\n            position.xyz += u_morphWeights[ 6 ] * a_position6;\n\n            #endif\n\n            #if O3_MORPH_NUM > 7\n\n            position.xyz += u_morphWeights[ 7 ] * a_position7;\n\n            #endif\n\n        #endif\n\n        #if defined( O3_HAS_NORMAL ) && defined( O3_MORPH_NORMAL )\n\n        normal.xyz += u_morphWeights[ 0 ] * a_normal0;\n\n            #if O3_MORPH_NUM > 1\n\n            normal.xyz += u_morphWeights[ 1 ] * a_normal1;\n\n            #endif\n\n            #if O3_MORPH_NUM > 2\n\n            normal.xyz += u_morphWeights[ 2 ] * a_normal2;\n\n            #endif\n\n            #if O3_MORPH_NUM > 3\n\n            normal.xyz += u_morphWeights[ 3 ] * a_normal3;\n\n            #endif\n\n            #if O3_MORPH_NUM > 4\n\n            normal.xyz += u_morphWeights[ 4 ] * a_normal4;\n\n            #endif\n\n            #if O3_MORPH_NUM > 5\n\n            normal.xyz += u_morphWeights[ 5 ] * a_normal5;\n\n            #endif\n\n            #if O3_MORPH_NUM > 6\n\n            normal.xyz += u_morphWeights[ 6 ] * a_normal6;\n\n            #endif\n\n            #if O3_MORPH_NUM > 7\n\n            normal.xyz += u_morphWeights[ 7 ] * a_normal7;\n\n            #endif\n\n        #endif\n\n        #if defined( O3_HAS_TANGENT ) && defined( O3_MORPH_TANGENT ) && defined( O3_HAS_NORMALMAP )\n\n        tangent.xyz += u_morphWeights[ 0 ] * a_tangent0;\n\n            #if O3_MORPH_NUM > 1\n\n            tangent.xyz += u_morphWeights[ 1 ] * a_tangent1;\n\n            #endif\n\n            #if O3_MORPH_NUM > 2\n\n            tangent.xyz += u_morphWeights[ 2 ] * a_tangent2;\n\n            #endif\n\n            #if O3_MORPH_NUM > 3\n\n            tangent.xyz += u_morphWeights[ 3 ] * a_tangent3;\n\n            #endif\n\n            #if O3_MORPH_NUM > 4\n\n            tangent.xyz += u_morphWeights[ 4 ] * a_tangent4;\n\n            #endif\n\n            #if O3_MORPH_NUM > 5\n\n            tangent.xyz += u_morphWeights[ 5 ] * a_tangent5;\n\n            #endif\n\n            #if O3_MORPH_NUM > 6\n\n            tangent.xyz += u_morphWeights[ 6 ] * a_tangent6;\n\n            #endif\n\n            #if O3_MORPH_NUM > 7\n\n            tangent.xyz += u_morphWeights[ 7 ] * a_tangent7;\n\n            #endif\n\n        #endif\n\n    #endif\n",fog_vert:"    #ifdef O3_HAS_FOG\n\n    v_fogDepth = ( u_MVMat * position ).xyz;\n\n    #endif\n",ambient_light_frag:"#ifdef O3_HAS_AMBIENT_LIGHT\n\nstruct AmbientLight {\n    vec3 color;\n    vec3 lightColor;\n    float intensity;\n};\nuniform AmbientLight u_ambientLight;\n\n#endif\n",direct_light_frag:"#ifdef O3_DIRECT_LIGHT_COUNT\n\nstruct DirectLight {\n    vec3 color;\n    vec3 lightColor;\n    float intensity;\n    vec3 direction;\n};\nuniform DirectLight u_directLights[ O3_DIRECT_LIGHT_COUNT ];\n\n#endif\n",point_light_frag:"#ifdef O3_POINT_LIGHT_COUNT\n\nstruct PointLight {\n    vec3 color;\n    vec3 lightColor;\n    vec3 position;\n    float intensity;\n    float distance;\n    float decay;\n};\nuniform PointLight u_pointLights[ O3_POINT_LIGHT_COUNT ];\n\n#endif\n",spot_light_frag:"#ifdef O3_SPOT_LIGHT_COUNT\n\nstruct SpotLight {\n    vec3 color;\n    vec3 lightColor;\n    vec3 position;\n    vec3 direction;\n    float intensity;\n    float distance;\n    float decay;\n    float angle;\n    float penumbra;\n    float coneCos;\n    float penumbraCos;\n};\nuniform SpotLight u_spotLights[ O3_SPOT_LIGHT_COUNT ];\n\n#endif\n",mobile_material_frag:"uniform float u_shininess;\n\n#ifdef O3_EMISSION_TEXTURE\n\nuniform sampler2D u_emission;\n\n#else\n\nuniform vec4 u_emission;\n\n#endif\n\n#ifdef O3_AMBIENT_TEXTURE\n\nuniform sampler2D u_ambient;\n\n#else\n\nuniform vec4 u_ambient;\n\n#endif\n\n#ifdef O3_DIFFUSE_TEXTURE\n\nuniform sampler2D u_diffuse;\n\n#else\n\nuniform vec4 u_diffuse;\n\n#endif\n\n#ifdef O3_SPECULAR_TEXTURE\n\nuniform sampler2D u_specular;\n\n#else\n\nuniform vec4 u_specular;\n\n#endif\n",fog_frag:"    #ifdef O3_HAS_FOG\n\n    float fogDepth = length( v_fogDepth );\n\n        #ifdef O3_FOG_EXP2\n\n            float fogFactor = whiteCompliment( exp2( - u_fogDensity * u_fogDensity * fogDepth * fogDepth * LOG2 ) );\n\n        #else\n\n            float fogFactor = smoothstep( u_fogNear, u_fogFar, fogDepth );\n\n        #endif\n\n\tgl_FragColor.rgb = mix( gl_FragColor.rgb, u_fogColor, fogFactor );\n\n    #endif\n",begin_mobile_frag:"    #ifdef O3_EMISSION_TEXTURE\n\n    vec4 emission = texture2D(u_emission, v_uv);\n\n    #else\n\n    vec4 emission = u_emission;\n\n    #endif\n\n    vec4 ambient = vec4(0);\n    #ifdef O3_HAS_AMBIENT_LIGHT\n        #ifdef O3_AMBIENT_TEXTURE\n            ambient = texture2D(u_ambient, v_uv) * vec4(u_ambientLight.lightColor, 1.0);\n         #else\n            ambient = u_ambient * vec4(u_ambientLight.lightColor, 1.0);\n         #endif\n    #endif\n\n    #ifdef O3_DIFFUSE_TEXTURE\n\n    vec4 diffuse = texture2D(u_diffuse, v_uv);\n\n    #else\n\n    vec4 diffuse = u_diffuse;\n\n    #endif\n\n    #ifdef O3_SPECULAR_TEXTURE\n\n    vec4 specular = texture2D(u_specular, v_uv);\n\n    #else\n\n    vec4 specular = u_specular;\n\n    #endif\n",begin_normal_frag:"    #ifdef O3_HAS_NORMAL\n\n        #if defined( O3_HAS_TANGENT ) && defined( O3_HAS_NORMALMAP )\n\n        vec3 N = normalize( v_TBN[ 2 ] );\n\n        #else\n\n        vec3 N = normalize( v_normal );\n\n        #endif\n\n    #endif\n",begin_viewdir_frag:"    #if defined( O3_NEED_WORLDPOS ) || defined( O3_HAS_ENVMAP ) || defined( O3_HAS_LIGHTMAP )\n\n    vec3 V =  normalize( u_cameraPos - v_pos );\n\n    #endif\n",mobile_blinnphong_frag:"    #ifdef O3_HAS_NORMAL\n         N *= float( gl_FrontFacing ) * 2.0 - 1.0;\n    #else\n         vec3 N = vec3(0, 0, 1);\n    #endif\n\n\n    vec3 lightDiffuse = vec3( 0.0, 0.0, 0.0 );\n    vec3 lightSpecular = vec3( 0.0, 0.0, 0.0 );\n\n    #ifdef O3_DIRECT_LIGHT_COUNT\n\n    for( int i = 0; i < O3_DIRECT_LIGHT_COUNT; i++ ) {\n        DirectLight lgt = u_directLights[ i ];\n\n        float d = max(dot(N, -lgt.direction), 0.0)*lgt.intensity;\n        lightDiffuse += lgt.color*d;\n\n        vec3 halfDir = normalize( V - lgt.direction );\n        float s = pow( clamp( dot( N, halfDir ), 0.0, 1.0 ), u_shininess ) * lgt.intensity;\n        lightSpecular += lgt.color * s;\n    }\n\n    #endif\n\n    #ifdef O3_POINT_LIGHT_COUNT\n\n    for( int i = 0; i < O3_POINT_LIGHT_COUNT; i++ ) {\n        PointLight lgt = u_pointLights[ i ];\n        vec3 direction = v_pos - lgt.position;\n        float dist = length( direction );\n        direction /= dist;\n        float decay = pow( max( 0.0, 1.0-dist/lgt.distance ), 2.0 );\n\n        float d =  max( dot( N, -direction ), 0.0 )*lgt.intensity*decay;\n        lightDiffuse += lgt.color*d;\n\n        vec3 halfDir = normalize( V - direction );\n        float s = pow( clamp( dot( N, halfDir ), 0.0, 1.0 ), u_shininess ) * lgt.intensity * decay;\n        lightSpecular += lgt.color * s;\n\n    }\n\n    #endif\n\n    #ifdef O3_SPOT_LIGHT_COUNT\n\n    for( int i = 0; i < O3_SPOT_LIGHT_COUNT; i++) {\n        SpotLight lgt = u_spotLights[ i ];\n        vec3 direction = v_pos - lgt.position;\n        float angle = acos( dot( normalize( direction ), normalize( lgt.direction ) ) );\n        float dist = length( direction );\n        direction /= dist;\n        float decay = pow( max( 0.0, 1.0 - dist / lgt.distance ), 2.0 );\n\n        float hasLight = step( angle, lgt.angle );\n        float hasPenumbra = step( lgt.angle, angle ) * step( angle, lgt.angle * ( 1.0 + lgt.penumbra ) );\n        float penumbra = hasPenumbra * ( 1.0 - ( angle - lgt.angle ) / ( lgt.angle * lgt.penumbra ) );\n        float d = max( dot( N, -direction ), 0.0 ) * lgt.intensity * decay * ( penumbra + hasLight );\n        lightDiffuse += lgt.color * d;\n\n        vec3 halfDir = normalize( V - direction );\n        float s = pow( clamp( dot( N, halfDir ), 0.0, 1.0 ), u_shininess ) * lgt.intensity * decay * ( penumbra + hasLight );\n        lightSpecular += lgt.color * s;\n\n    }\n\n    #endif\n\n    diffuse *= vec4( lightDiffuse, 1.0 );\n    specular *= vec4( lightSpecular, 1.0 );\n",mobile_lambert_frag:"    vec3 totalLight = vec3(0.0, 0.0, 0.0);\n    #ifdef O3_DIRECT_LIGHT_COUNT\n    for( int i = 0; i < O3_DIRECT_LIGHT_COUNT; i++ ){\n        vec3 lightColor = u_directLights[ i ].color * u_directLights[ i ].intensity;\n        lightColor *= max( dot( N, -u_directLights[ i ].direction ), 0.0 );\n\n        totalLight += lightColor;\n    }\n    #endif\n    diffuse *= vec4( totalLight, 1.0 );\n",noise_common:"// Modulo 289 without a division (only multiplications)\nvec4 mod289( vec4 x ) {\n\n    return x - floor( x * ( 1.0 / 289.0 ) ) * 289.0;\n\n}\n\nvec3 mod289( vec3 x ) {\n\n    return x - floor( x * ( 1.0 / 289.0 ) ) * 289.0;\n\n}\n\nvec2 mod289( vec2 x ) {\n\n    return x - floor( x * ( 1.0 / 289.0 ) ) * 289.0;\n\n}\n\nfloat mod289( float x ) {\n\n    return x - floor( x * ( 1.0 / 289.0 ) ) * 289.0;\n\n}\n\n// Modulo 7 without a division\nvec4 mod7( vec4 x ) {\n\n    return x - floor( x * ( 1.0 / 7.0 ) ) * 7.0;\n\n}\n\nvec3 mod7( vec3 x ) {\n\n    return x - floor( x * ( 1.0 / 7.0 ) ) * 7.0;\n\n}\n\n// Permutation polynomial: (34x^2 + x) mod 289\nvec4 permute( vec4 x ) {\n\n    return mod289( ( 34.0 * x + 1.0 ) * x);\n\n}\n\nvec3 permute( vec3 x ) {\n\n    return mod289( ( 34.0 * x + 1.0 ) * x );\n\n}\n\nfloat permute( float x ) {\n\n  return mod289( ( ( x * 34.0 ) + 1.0 ) * x );\n\n}\n\nvec4 taylorInvSqrt( vec4 r ) {\n\n    return 1.79284291400159 - 0.85373472095314 * r;\n\n}\n\nfloat taylorInvSqrt( float r ) {\n\n    return 1.79284291400159 - 0.85373472095314 * r;\n\n}\n\nvec4 fade( vec4 t ) {\n\n    return t * t * t * ( t * ( t * 6.0 - 15.0 ) + 10.0 );\n\n}\n\nvec3 fade( vec3 t ) {\n\n    return t * t * t * ( t * ( t * 6.0 - 15.0 ) + 10.0 );\n\n}\n\nvec2 fade( vec2 t ) {\n\n    return t * t * t * ( t * ( t * 6.0 - 15.0 ) + 10.0 );\n\n}\n\n#define K 0.142857142857 // 1/7\n#define Ko 0.428571428571 // 1/2-K/2\n#define K2 0.020408163265306 // 1/(7*7)\n#define Kd2 0.0714285714285 // K/2\n#define Kz 0.166666666667 // 1/6\n#define Kzo 0.416666666667 // 1/2-1/6*2\n#define jitter 1.0 // smaller jitter gives more regular pattern\n#define jitter1 0.8 // smaller jitter gives less errors in F1 F2\n",noise_cellular_2D:'\n// Cellular noise ("Worley noise") in 2D in GLSL.\n// Copyright (c) Stefan Gustavson 2011-04-19. All rights reserved.\n// This code is released under the conditions of the MIT license.\n// See LICENSE file for details.\n// https://github.com/stegu/webgl-noise\n\n// Cellular noise, returning F1 and F2 in a vec2.\n// Standard 3x3 search window for good F1 and F2 values\nvec2 cellular( vec2 P ) {\n\n\tvec2 Pi = mod289( floor( P ) );\n \tvec2 Pf = fract( P );\n\tvec3 oi = vec3( -1.0, 0.0, 1.0);\n\tvec3 of = vec3( -0.5, 0.5, 1.5);\n\tvec3 px = permute( Pi.x + oi );\n\tvec3 p = permute( px.x + Pi.y + oi ); // p11, p12, p13\n\tvec3 ox = fract( p * K ) - Ko;\n\tvec3 oy = mod7( floor( p * K ) ) * K - Ko;\n\tvec3 dx = Pf.x + 0.5 + jitter * ox;\n\tvec3 dy = Pf.y - of + jitter * oy;\n\tvec3 d1 = dx * dx + dy * dy; // d11, d12 and d13, squared\n\tp = permute( px.y + Pi.y + oi ); // p21, p22, p23\n\tox = fract( p * K ) - Ko;\n\toy = mod7( floor( p * K ) ) * K - Ko;\n\tdx = Pf.x - 0.5 + jitter * ox;\n\tdy = Pf.y - of + jitter * oy;\n\tvec3 d2 = dx * dx + dy * dy; // d21, d22 and d23, squared\n\tp = permute( px.z + Pi.y + oi ); // p31, p32, p33\n\tox = fract( p * K ) - Ko;\n\toy = mod7( floor( p * K ) ) * K - Ko;\n\tdx = Pf.x - 1.5 + jitter * ox;\n\tdy = Pf.y - of + jitter * oy;\n\tvec3 d3 = dx * dx + dy * dy; // d31, d32 and d33, squared\n\t// Sort out the two smallest distances (F1, F2)\n\tvec3 d1a = min( d1, d2 );\n\td2 = max( d1, d2 ); // Swap to keep candidates for F2\n\td2 = min( d2, d3 ); // neither F1 nor F2 are now in d3\n\td1 = min( d1a, d2 ); // F1 is now in d1\n\td2 = max( d1a, d2 ); // Swap to keep candidates for F2\n\td1.xy = ( d1.x < d1.y ) ? d1.xy : d1.yx; // Swap if smaller\n\td1.xz = ( d1.x < d1.z ) ? d1.xz : d1.zx; // F1 is in d1.x\n\td1.yz = min( d1.yz, d2.yz ); // F2 is now not in d2.yz\n\td1.y = min( d1.y, d1.z ); // nor in  d1.z\n\td1.y = min( d1.y, d2.x ); // F2 is in d1.y, we\'re done.\n\treturn sqrt( d1.xy );\n\n}\n',noise_cellular_2x2:'\n// Cellular noise ("Worley noise") in 2D in GLSL.\n// Copyright (c) Stefan Gustavson 2011-04-19. All rights reserved.\n// This code is released under the conditions of the MIT license.\n// See LICENSE file for details.\n// https://github.com/stegu/webgl-noise\n\n// Cellular noise, returning F1 and F2 in a vec2.\n// Speeded up by using 2x2 search window instead of 3x3,\n// at the expense of some strong pattern artifacts.\n// F2 is often wrong and has sharp discontinuities.\n// If you need a smooth F2, use the slower 3x3 version.\n// F1 is sometimes wrong, too, but OK for most purposes.\nvec2 cellular2x2( vec2 P ) {\n\n\tvec2 Pi = mod289( floor( P ) );\n \tvec2 Pf = fract( P );\n\tvec4 Pfx = Pf.x + vec4( -0.5, -1.5, -0.5, -1.5 );\n\tvec4 Pfy = Pf.y + vec4( -0.5, -0.5, -1.5, -1.5 );\n\tvec4 p = permute( Pi.x + vec4( 0.0, 1.0, 0.0, 1.0 ) );\n\tp = permute( p + Pi.y + vec4( 0.0, 0.0, 1.0, 1.0 ) );\n\tvec4 ox = mod7( p ) * K + Kd2;\n\tvec4 oy = mod7( floor( p * K ) ) * K + Kd2;\n\tvec4 dx = Pfx + jitter1 * ox;\n\tvec4 dy = Pfy + jitter1 * oy;\n\tvec4 d = dx * dx + dy * dy; // d11, d12, d21 and d22, squared\n\n\t// Do it right and find both F1 and F2\n\td.xy = ( d.x < d.y ) ? d.xy : d.yx; // Swap if smaller\n\td.xz = ( d.x < d.z ) ? d.xz : d.zx;\n\td.xw = ( d.x < d.w ) ? d.xw : d.wx;\n\td.y = min( d.y, d.z );\n\td.y = min( d.y, d.w );\n\treturn sqrt( d.xy );\n\n}\n',noise_cellular_2x2x2:'\n// Cellular noise ("Worley noise") in 3D in GLSL.\n// Copyright (c) Stefan Gustavson 2011-04-19. All rights reserved.\n// This code is released under the conditions of the MIT license.\n// See LICENSE file for details.\n// https://github.com/stegu/webgl-noise\n\n// Cellular noise, returning F1 and F2 in a vec2.\n// Speeded up by using 2x2x2 search window instead of 3x3x3,\n// at the expense of some pattern artifacts.\n// F2 is often wrong and has sharp discontinuities.\n// If you need a good F2, use the slower 3x3x3 version.\nvec2 cellular2x2x2(vec3 P) {\n\n\tvec3 Pi = mod289( floor( P ) );\n \tvec3 Pf = fract( P );\n\tvec4 Pfx = Pf.x + vec4( 0.0, -1.0, 0.0, -1.0 );\n\tvec4 Pfy = Pf.y + vec4( 0.0, 0.0, -1.0, -1.0 );\n\tvec4 p = permute( Pi.x + vec4( 0.0, 1.0, 0.0, 1.0 ) );\n\tp = permute( p + Pi.y + vec4( 0.0, 0.0, 1.0, 1.0 ) );\n\tvec4 p1 = permute( p + Pi.z ); // z+0\n\tvec4 p2 = permute( p + Pi.z + vec4( 1.0 ) ); // z+1\n\tvec4 ox1 = fract( p1 * K ) - Ko;\n\tvec4 oy1 = mod7( floor( p1 * K ) ) * K - Ko;\n\tvec4 oz1 = floor( p1 * K2 ) * Kz - Kzo; // p1 < 289 guaranteed\n\tvec4 ox2 = fract( p2 * K ) - Ko;\n\tvec4 oy2 = mod7( floor( p2 * K ) ) * K - Ko;\n\tvec4 oz2 = floor( p2 * K2 ) * Kz - Kzo;\n\tvec4 dx1 = Pfx + jitter1 * ox1;\n\tvec4 dy1 = Pfy + jitter1 * oy1;\n\tvec4 dz1 = Pf.z + jitter1 * oz1;\n\tvec4 dx2 = Pfx + jitter1 * ox2;\n\tvec4 dy2 = Pfy + jitter1 * oy2;\n\tvec4 dz2 = Pf.z - 1.0 + jitter1 * oz2;\n\tvec4 d1 = dx1 * dx1 + dy1 * dy1 + dz1 * dz1; // z+0\n\tvec4 d2 = dx2 * dx2 + dy2 * dy2 + dz2 * dz2; // z+1\n\n\t// Do it right and sort out both F1 and F2\n\tvec4 d = min( d1, d2 ); // F1 is now in d\n\td2 = max( d1, d2 ); // Make sure we keep all candidates for F2\n\td.xy = ( d.x < d.y ) ? d.xy : d.yx; // Swap smallest to d.x\n\td.xz = ( d.x < d.z ) ? d.xz : d.zx;\n\td.xw = ( d.x < d.w ) ? d.xw : d.wx; // F1 is now in d.x\n\td.yzw = min( d.yzw, d2.yzw ); // F2 now not in d2.yzw\n\td.y = min( d.y, d.z ); // nor in d.z\n\td.y = min( d.y, d.w ); // nor in d.w\n\td.y = min( d.y, d2.x ); // F2 is now in d.y\n\treturn sqrt( d.xy ); // F1 and F2\n\n}\n',noise_cellular_3D:'\n// Cellular noise ("Worley noise") in 3D in GLSL.\n// Copyright (c) Stefan Gustavson 2011-04-19. All rights reserved.\n// This code is released under the conditions of the MIT license.\n// See LICENSE file for details.\n// https://github.com/stegu/webgl-noise\n\n// Cellular noise, returning F1 and F2 in a vec2.\n// 3x3x3 search region for good F2 everywhere, but a lot\n// slower than the 2x2x2 version.\n// The code below is a bit scary even to its author,\n// but it has at least half decent performance on a\n// modern GPU. In any case, it beats any software\n// implementation of Worley noise hands down.\n\nvec2 cellular( vec3 P ) {\n\n\tvec3 Pi = mod289( floor( P ) );\n \tvec3 Pf = fract( P ) - 0.5;\n\n\tvec3 Pfx = Pf.x + vec3( 1.0, 0.0, -1.0 );\n\tvec3 Pfy = Pf.y + vec3( 1.0, 0.0, -1.0 );\n\tvec3 Pfz = Pf.z + vec3( 1.0, 0.0, -1.0 );\n\n\tvec3 p = permute( Pi.x + vec3( -1.0, 0.0, 1.0 ) );\n\tvec3 p1 = permute( p + Pi.y - 1.0 );\n\tvec3 p2 = permute( p + Pi.y );\n\tvec3 p3 = permute( p + Pi.y + 1.0 );\n\n\tvec3 p11 = permute( p1 + Pi.z - 1.0 );\n\tvec3 p12 = permute( p1 + Pi.z );\n\tvec3 p13 = permute( p1 + Pi.z + 1.0 );\n\n\tvec3 p21 = permute( p2 + Pi.z - 1.0 );\n\tvec3 p22 = permute( p2 + Pi.z );\n\tvec3 p23 = permute( p2 + Pi.z + 1.0 );\n\n\tvec3 p31 = permute( p3 + Pi.z - 1.0 );\n\tvec3 p32 = permute( p3 + Pi.z );\n\tvec3 p33 = permute( p3 + Pi.z + 1.0 );\n\n\tvec3 ox11 = fract( p11 * K ) - Ko;\n\tvec3 oy11 = mod7( floor( p11 * K ) ) * K - Ko;\n\tvec3 oz11 = floor( p11 * K2 ) * Kz - Kzo; // p11 < 289 guaranteed\n\n\tvec3 ox12 = fract( p12 * K ) - Ko;\n\tvec3 oy12 = mod7( floor( p12 * K ) ) * K - Ko;\n\tvec3 oz12 = floor( p12 * K2 ) * Kz - Kzo;\n\n\tvec3 ox13 = fract( p13 * K ) - Ko;\n\tvec3 oy13 = mod7( floor( p13 * K ) ) * K - Ko;\n\tvec3 oz13 = floor( p13 * K2 ) * Kz - Kzo;\n\n\tvec3 ox21 = fract( p21 * K ) - Ko;\n\tvec3 oy21 = mod7( floor( p21 * K ) ) * K - Ko;\n\tvec3 oz21 = floor( p21 * K2 ) * Kz - Kzo;\n\n\tvec3 ox22 = fract( p22 * K ) - Ko;\n\tvec3 oy22 = mod7( floor( p22 * K ) ) * K - Ko;\n\tvec3 oz22 = floor( p22 * K2 ) * Kz - Kzo;\n\n\tvec3 ox23 = fract( p23 * K ) - Ko;\n\tvec3 oy23 = mod7( floor( p23 * K ) ) * K - Ko;\n\tvec3 oz23 = floor( p23 * K2 ) * Kz - Kzo;\n\n\tvec3 ox31 = fract( p31 * K ) - Ko;\n\tvec3 oy31 = mod7( floor( p31 * K ) ) * K - Ko;\n\tvec3 oz31 = floor( p31 * K2 ) * Kz - Kzo;\n\n\tvec3 ox32 = fract( p32 * K ) - Ko;\n\tvec3 oy32 = mod7( floor( p32 * K ) ) * K - Ko;\n\tvec3 oz32 = floor( p32 * K2 ) * Kz - Kzo;\n\n\tvec3 ox33 = fract( p33 * K ) - Ko;\n\tvec3 oy33 = mod7( floor( p33 * K ) ) * K - Ko;\n\tvec3 oz33 = floor( p33 * K2 ) * Kz - Kzo;\n\n\tvec3 dx11 = Pfx + jitter * ox11;\n\tvec3 dy11 = Pfy.x + jitter * oy11;\n\tvec3 dz11 = Pfz.x + jitter * oz11;\n\n\tvec3 dx12 = Pfx + jitter * ox12;\n\tvec3 dy12 = Pfy.x + jitter * oy12;\n\tvec3 dz12 = Pfz.y + jitter * oz12;\n\n\tvec3 dx13 = Pfx + jitter * ox13;\n\tvec3 dy13 = Pfy.x + jitter * oy13;\n\tvec3 dz13 = Pfz.z + jitter * oz13;\n\n\tvec3 dx21 = Pfx + jitter * ox21;\n\tvec3 dy21 = Pfy.y + jitter * oy21;\n\tvec3 dz21 = Pfz.x + jitter * oz21;\n\n\tvec3 dx22 = Pfx + jitter * ox22;\n\tvec3 dy22 = Pfy.y + jitter * oy22;\n\tvec3 dz22 = Pfz.y + jitter * oz22;\n\n\tvec3 dx23 = Pfx + jitter * ox23;\n\tvec3 dy23 = Pfy.y + jitter * oy23;\n\tvec3 dz23 = Pfz.z + jitter * oz23;\n\n\tvec3 dx31 = Pfx + jitter * ox31;\n\tvec3 dy31 = Pfy.z + jitter * oy31;\n\tvec3 dz31 = Pfz.x + jitter * oz31;\n\n\tvec3 dx32 = Pfx + jitter * ox32;\n\tvec3 dy32 = Pfy.z + jitter * oy32;\n\tvec3 dz32 = Pfz.y + jitter * oz32;\n\n\tvec3 dx33 = Pfx + jitter * ox33;\n\tvec3 dy33 = Pfy.z + jitter * oy33;\n\tvec3 dz33 = Pfz.z + jitter * oz33;\n\n\tvec3 d11 = dx11 * dx11 + dy11 * dy11 + dz11 * dz11;\n\tvec3 d12 = dx12 * dx12 + dy12 * dy12 + dz12 * dz12;\n\tvec3 d13 = dx13 * dx13 + dy13 * dy13 + dz13 * dz13;\n\tvec3 d21 = dx21 * dx21 + dy21 * dy21 + dz21 * dz21;\n\tvec3 d22 = dx22 * dx22 + dy22 * dy22 + dz22 * dz22;\n\tvec3 d23 = dx23 * dx23 + dy23 * dy23 + dz23 * dz23;\n\tvec3 d31 = dx31 * dx31 + dy31 * dy31 + dz31 * dz31;\n\tvec3 d32 = dx32 * dx32 + dy32 * dy32 + dz32 * dz32;\n\tvec3 d33 = dx33 * dx33 + dy33 * dy33 + dz33 * dz33;\n\n\t// Do it right and sort out both F1 and F2\n\tvec3 d1a = min( d11, d12 );\n\td12 = max( d11, d12 );\n\td11 = min( d1a, d13 ); // Smallest now not in d12 or d13\n\td13 = max( d1a, d13 );\n\td12 = min( d12, d13 ); // 2nd smallest now not in d13\n\tvec3 d2a = min( d21, d22 );\n\td22 = max( d21, d22 );\n\td21 = min( d2a, d23 ); // Smallest now not in d22 or d23\n\td23 = max( d2a, d23 );\n\td22 = min( d22, d23 ); // 2nd smallest now not in d23\n\tvec3 d3a = min( d31, d32 );\n\td32 = max( d31, d32 );\n\td31 = min( d3a, d33 ); // Smallest now not in d32 or d33\n\td33 = max( d3a, d33 );\n\td32 = min( d32, d33 ); // 2nd smallest now not in d33\n\tvec3 da = min( d11, d21 );\n\td21 = max( d11, d21 );\n\td11 = min( da, d31 ); // Smallest now in d11\n\td31 = max( da, d31 ); // 2nd smallest now not in d31\n\td11.xy = ( d11.x < d11.y ) ? d11.xy : d11.yx;\n\td11.xz = ( d11.x < d11.z ) ? d11.xz : d11.zx; // d11.x now smallest\n\td12 = min( d12, d21 ); // 2nd smallest now not in d21\n\td12 = min( d12, d22 ); // nor in d22\n\td12 = min( d12, d31 ); // nor in d31\n\td12 = min( d12, d32 ); // nor in d32\n\td11.yz = min( d11.yz, d12.xy ); // nor in d12.yz\n\td11.y = min( d11.y, d12.z ); // Only two more to go\n\td11.y = min( d11.y, d11.z ); // Done! (Phew! )\n\treturn sqrt( d11.xy ); // F1, F2\n\n}\n',noise_cellular:"#include <noise_cellular_2D>\n#include <noise_cellular_3D>\n#include <noise_cellular_2x2>\n#include <noise_cellular_2x2x2>\n",noise_perlin_2D:'//\n// GLSL textureless classic 2D noise "cnoise",\n// with an RSL-style periodic variant "pnoise".\n// Author:  Stefan Gustavson (stefan.gustavson@liu.se)\n// Version: 2011-08-22\n//\n// Many thanks to Ian McEwan of Ashima Arts for the\n// ideas for permutation and gradient selection.\n//\n// Copyright (c) 2011 Stefan Gustavson. All rights reserved.\n// Distributed under the MIT license. See LICENSE file.\n// https://github.com/stegu/webgl-noise\n//\n\n// Classic Perlin noise\nfloat perlin( vec2 P ) {\n\n    vec4 Pi = floor(P.xyxy) + vec4(0.0, 0.0, 1.0, 1.0);\n    vec4 Pf = fract(P.xyxy) - vec4(0.0, 0.0, 1.0, 1.0);\n    Pi = mod289(Pi); // To avoid truncation effects in permutation\n    vec4 ix = Pi.xzxz;\n    vec4 iy = Pi.yyww;\n    vec4 fx = Pf.xzxz;\n    vec4 fy = Pf.yyww;\n\n    vec4 i = permute(permute(ix) + iy);\n\n    vec4 gx = fract(i * (1.0 / 41.0)) * 2.0 - 1.0 ;\n    vec4 gy = abs(gx) - 0.5 ;\n    vec4 tx = floor(gx + 0.5);\n    gx = gx - tx;\n\n    vec2 g00 = vec2(gx.x,gy.x);\n    vec2 g10 = vec2(gx.y,gy.y);\n    vec2 g01 = vec2(gx.z,gy.z);\n    vec2 g11 = vec2(gx.w,gy.w);\n\n    vec4 norm = taylorInvSqrt(vec4(dot(g00, g00), dot(g01, g01), dot(g10, g10), dot(g11, g11)));\n    g00 *= norm.x;\n    g01 *= norm.y;\n    g10 *= norm.z;\n    g11 *= norm.w;\n\n    float n00 = dot(g00, vec2(fx.x, fy.x));\n    float n10 = dot(g10, vec2(fx.y, fy.y));\n    float n01 = dot(g01, vec2(fx.z, fy.z));\n    float n11 = dot(g11, vec2(fx.w, fy.w));\n\n    vec2 fade_xy = fade(Pf.xy);\n    vec2 n_x = mix(vec2(n00, n01), vec2(n10, n11), fade_xy.x);\n    float n_xy = mix(n_x.x, n_x.y, fade_xy.y);\n    return 2.3 * n_xy;\n\n}\n\n// Classic Perlin noise, periodic variant\nfloat perlin( vec2 P, vec2 rep ) {\n\n    vec4 Pi = floor(P.xyxy) + vec4(0.0, 0.0, 1.0, 1.0);\n    vec4 Pf = fract(P.xyxy) - vec4(0.0, 0.0, 1.0, 1.0);\n    Pi = mod(Pi, rep.xyxy); // To create noise with explicit period\n    Pi = mod289(Pi);        // To avoid truncation effects in permutation\n    vec4 ix = Pi.xzxz;\n    vec4 iy = Pi.yyww;\n    vec4 fx = Pf.xzxz;\n    vec4 fy = Pf.yyww;\n\n    vec4 i = permute(permute(ix) + iy);\n\n    vec4 gx = fract(i * (1.0 / 41.0)) * 2.0 - 1.0 ;\n    vec4 gy = abs(gx) - 0.5 ;\n    vec4 tx = floor(gx + 0.5);\n    gx = gx - tx;\n\n    vec2 g00 = vec2(gx.x,gy.x);\n    vec2 g10 = vec2(gx.y,gy.y);\n    vec2 g01 = vec2(gx.z,gy.z);\n    vec2 g11 = vec2(gx.w,gy.w);\n\n    vec4 norm = taylorInvSqrt(vec4(dot(g00, g00), dot(g01, g01), dot(g10, g10), dot(g11, g11)));\n    g00 *= norm.x;\n    g01 *= norm.y;\n    g10 *= norm.z;\n    g11 *= norm.w;\n\n    float n00 = dot(g00, vec2(fx.x, fy.x));\n    float n10 = dot(g10, vec2(fx.y, fy.y));\n    float n01 = dot(g01, vec2(fx.z, fy.z));\n    float n11 = dot(g11, vec2(fx.w, fy.w));\n\n    vec2 fade_xy = fade(Pf.xy);\n    vec2 n_x = mix(vec2(n00, n01), vec2(n10, n11), fade_xy.x);\n    float n_xy = mix(n_x.x, n_x.y, fade_xy.y);\n    return 2.3 * n_xy;\n\n}\n',noise_perlin_3D:'//\n// GLSL textureless classic 3D noise "cnoise",\n// with an RSL-style periodic variant "pnoise".\n// Author:  Stefan Gustavson (stefan.gustavson@liu.se)\n// Version: 2011-10-11\n//\n// Many thanks to Ian McEwan of Ashima Arts for the\n// ideas for permutation and gradient selection.\n//\n// Copyright (c) 2011 Stefan Gustavson. All rights reserved.\n// Distributed under the MIT license. See LICENSE file.\n// https://github.com/stegu/webgl-noise\n//\n\n// Classic Perlin noise\nfloat perlin( vec3 P ) {\n\n    vec3 Pi0 = floor(P); // Integer part for indexing\n    vec3 Pi1 = Pi0 + vec3(1.0); // Integer part + 1\n    Pi0 = mod289(Pi0);\n    Pi1 = mod289(Pi1);\n    vec3 Pf0 = fract(P); // Fractional part for interpolation\n    vec3 Pf1 = Pf0 - vec3(1.0); // Fractional part - 1.0\n    vec4 ix = vec4(Pi0.x, Pi1.x, Pi0.x, Pi1.x);\n    vec4 iy = vec4(Pi0.yy, Pi1.yy);\n    vec4 iz0 = Pi0.zzzz;\n    vec4 iz1 = Pi1.zzzz;\n\n    vec4 ixy = permute(permute(ix) + iy);\n    vec4 ixy0 = permute(ixy + iz0);\n    vec4 ixy1 = permute(ixy + iz1);\n\n    vec4 gx0 = ixy0 * (1.0 / 7.0);\n    vec4 gy0 = fract(floor(gx0) * (1.0 / 7.0)) - 0.5;\n    gx0 = fract(gx0);\n    vec4 gz0 = vec4(0.5) - abs(gx0) - abs(gy0);\n    vec4 sz0 = step(gz0, vec4(0.0));\n    gx0 -= sz0 * (step(0.0, gx0) - 0.5);\n    gy0 -= sz0 * (step(0.0, gy0) - 0.5);\n\n    vec4 gx1 = ixy1 * (1.0 / 7.0);\n    vec4 gy1 = fract(floor(gx1) * (1.0 / 7.0)) - 0.5;\n    gx1 = fract(gx1);\n    vec4 gz1 = vec4(0.5) - abs(gx1) - abs(gy1);\n    vec4 sz1 = step(gz1, vec4(0.0));\n    gx1 -= sz1 * (step(0.0, gx1) - 0.5);\n    gy1 -= sz1 * (step(0.0, gy1) - 0.5);\n\n    vec3 g000 = vec3(gx0.x,gy0.x,gz0.x);\n    vec3 g100 = vec3(gx0.y,gy0.y,gz0.y);\n    vec3 g010 = vec3(gx0.z,gy0.z,gz0.z);\n    vec3 g110 = vec3(gx0.w,gy0.w,gz0.w);\n    vec3 g001 = vec3(gx1.x,gy1.x,gz1.x);\n    vec3 g101 = vec3(gx1.y,gy1.y,gz1.y);\n    vec3 g011 = vec3(gx1.z,gy1.z,gz1.z);\n    vec3 g111 = vec3(gx1.w,gy1.w,gz1.w);\n\n    vec4 norm0 = taylorInvSqrt(vec4(dot(g000, g000), dot(g010, g010), dot(g100, g100), dot(g110, g110)));\n    g000 *= norm0.x;\n    g010 *= norm0.y;\n    g100 *= norm0.z;\n    g110 *= norm0.w;\n    vec4 norm1 = taylorInvSqrt(vec4(dot(g001, g001), dot(g011, g011), dot(g101, g101), dot(g111, g111)));\n    g001 *= norm1.x;\n    g011 *= norm1.y;\n    g101 *= norm1.z;\n    g111 *= norm1.w;\n\n    float n000 = dot(g000, Pf0);\n    float n100 = dot(g100, vec3(Pf1.x, Pf0.yz));\n    float n010 = dot(g010, vec3(Pf0.x, Pf1.y, Pf0.z));\n    float n110 = dot(g110, vec3(Pf1.xy, Pf0.z));\n    float n001 = dot(g001, vec3(Pf0.xy, Pf1.z));\n    float n101 = dot(g101, vec3(Pf1.x, Pf0.y, Pf1.z));\n    float n011 = dot(g011, vec3(Pf0.x, Pf1.yz));\n    float n111 = dot(g111, Pf1);\n\n    vec3 fade_xyz = fade(Pf0);\n    vec4 n_z = mix(vec4(n000, n100, n010, n110), vec4(n001, n101, n011, n111), fade_xyz.z);\n    vec2 n_yz = mix(n_z.xy, n_z.zw, fade_xyz.y);\n    float n_xyz = mix(n_yz.x, n_yz.y, fade_xyz.x);\n    return 2.2 * n_xyz;\n\n}\n\n// Classic Perlin noise, periodic variant\nfloat perlin( vec3 P, vec3 rep ) {\n\n    vec3 Pi0 = mod(floor(P), rep); // Integer part, modulo period\n    vec3 Pi1 = mod(Pi0 + vec3(1.0), rep); // Integer part + 1, mod period\n    Pi0 = mod289(Pi0);\n    Pi1 = mod289(Pi1);\n    vec3 Pf0 = fract(P); // Fractional part for interpolation\n    vec3 Pf1 = Pf0 - vec3(1.0); // Fractional part - 1.0\n    vec4 ix = vec4(Pi0.x, Pi1.x, Pi0.x, Pi1.x);\n    vec4 iy = vec4(Pi0.yy, Pi1.yy);\n    vec4 iz0 = Pi0.zzzz;\n    vec4 iz1 = Pi1.zzzz;\n\n    vec4 ixy = permute(permute(ix) + iy);\n    vec4 ixy0 = permute(ixy + iz0);\n    vec4 ixy1 = permute(ixy + iz1);\n\n    vec4 gx0 = ixy0 * (1.0 / 7.0);\n    vec4 gy0 = fract(floor(gx0) * (1.0 / 7.0)) - 0.5;\n    gx0 = fract(gx0);\n    vec4 gz0 = vec4(0.5) - abs(gx0) - abs(gy0);\n    vec4 sz0 = step(gz0, vec4(0.0));\n    gx0 -= sz0 * (step(0.0, gx0) - 0.5);\n    gy0 -= sz0 * (step(0.0, gy0) - 0.5);\n\n    vec4 gx1 = ixy1 * (1.0 / 7.0);\n    vec4 gy1 = fract(floor(gx1) * (1.0 / 7.0)) - 0.5;\n    gx1 = fract(gx1);\n    vec4 gz1 = vec4(0.5) - abs(gx1) - abs(gy1);\n    vec4 sz1 = step(gz1, vec4(0.0));\n    gx1 -= sz1 * (step(0.0, gx1) - 0.5);\n    gy1 -= sz1 * (step(0.0, gy1) - 0.5);\n\n    vec3 g000 = vec3(gx0.x,gy0.x,gz0.x);\n    vec3 g100 = vec3(gx0.y,gy0.y,gz0.y);\n    vec3 g010 = vec3(gx0.z,gy0.z,gz0.z);\n    vec3 g110 = vec3(gx0.w,gy0.w,gz0.w);\n    vec3 g001 = vec3(gx1.x,gy1.x,gz1.x);\n    vec3 g101 = vec3(gx1.y,gy1.y,gz1.y);\n    vec3 g011 = vec3(gx1.z,gy1.z,gz1.z);\n    vec3 g111 = vec3(gx1.w,gy1.w,gz1.w);\n\n    vec4 norm0 = taylorInvSqrt(vec4(dot(g000, g000), dot(g010, g010), dot(g100, g100), dot(g110, g110)));\n    g000 *= norm0.x;\n    g010 *= norm0.y;\n    g100 *= norm0.z;\n    g110 *= norm0.w;\n    vec4 norm1 = taylorInvSqrt(vec4(dot(g001, g001), dot(g011, g011), dot(g101, g101), dot(g111, g111)));\n    g001 *= norm1.x;\n    g011 *= norm1.y;\n    g101 *= norm1.z;\n    g111 *= norm1.w;\n\n    float n000 = dot(g000, Pf0);\n    float n100 = dot(g100, vec3(Pf1.x, Pf0.yz));\n    float n010 = dot(g010, vec3(Pf0.x, Pf1.y, Pf0.z));\n    float n110 = dot(g110, vec3(Pf1.xy, Pf0.z));\n    float n001 = dot(g001, vec3(Pf0.xy, Pf1.z));\n    float n101 = dot(g101, vec3(Pf1.x, Pf0.y, Pf1.z));\n    float n011 = dot(g011, vec3(Pf0.x, Pf1.yz));\n    float n111 = dot(g111, Pf1);\n\n    vec3 fade_xyz = fade(Pf0);\n    vec4 n_z = mix(vec4(n000, n100, n010, n110), vec4(n001, n101, n011, n111), fade_xyz.z);\n    vec2 n_yz = mix(n_z.xy, n_z.zw, fade_xyz.y);\n    float n_xyz = mix(n_yz.x, n_yz.y, fade_xyz.x);\n    return 2.2 * n_xyz;\n\n}\n',noise_perlin_4D:'//\n// GLSL textureless classic 4D noise "cnoise",\n// with an RSL-style periodic variant "pnoise".\n// Author:  Stefan Gustavson (stefan.gustavson@liu.se)\n// Version: 2011-08-22\n//\n// Many thanks to Ian McEwan of Ashima Arts for the\n// ideas for permutation and gradient selection.\n//\n// Copyright (c) 2011 Stefan Gustavson. All rights reserved.\n// Distributed under the MIT license. See LICENSE file.\n// https://github.com/stegu/webgl-noise\n//\n\n// Classic Perlin noise\nfloat perlin( vec4 P ) {\n\n    vec4 Pi0 = floor(P); // Integer part for indexing\n    vec4 Pi1 = Pi0 + 1.0; // Integer part + 1\n    Pi0 = mod289(Pi0);\n    Pi1 = mod289(Pi1);\n    vec4 Pf0 = fract(P); // Fractional part for interpolation\n    vec4 Pf1 = Pf0 - 1.0; // Fractional part - 1.0\n    vec4 ix = vec4(Pi0.x, Pi1.x, Pi0.x, Pi1.x);\n    vec4 iy = vec4(Pi0.yy, Pi1.yy);\n    vec4 iz0 = vec4(Pi0.zzzz);\n    vec4 iz1 = vec4(Pi1.zzzz);\n    vec4 iw0 = vec4(Pi0.wwww);\n    vec4 iw1 = vec4(Pi1.wwww);\n\n    vec4 ixy = permute(permute(ix) + iy);\n    vec4 ixy0 = permute(ixy + iz0);\n    vec4 ixy1 = permute(ixy + iz1);\n    vec4 ixy00 = permute(ixy0 + iw0);\n    vec4 ixy01 = permute(ixy0 + iw1);\n    vec4 ixy10 = permute(ixy1 + iw0);\n    vec4 ixy11 = permute(ixy1 + iw1);\n\n    vec4 gx00 = ixy00 * (1.0 / 7.0);\n    vec4 gy00 = floor(gx00) * (1.0 / 7.0);\n    vec4 gz00 = floor(gy00) * (1.0 / 6.0);\n    gx00 = fract(gx00) - 0.5;\n    gy00 = fract(gy00) - 0.5;\n    gz00 = fract(gz00) - 0.5;\n    vec4 gw00 = vec4(0.75) - abs(gx00) - abs(gy00) - abs(gz00);\n    vec4 sw00 = step(gw00, vec4(0.0));\n    gx00 -= sw00 * (step(0.0, gx00) - 0.5);\n    gy00 -= sw00 * (step(0.0, gy00) - 0.5);\n\n    vec4 gx01 = ixy01 * (1.0 / 7.0);\n    vec4 gy01 = floor(gx01) * (1.0 / 7.0);\n    vec4 gz01 = floor(gy01) * (1.0 / 6.0);\n    gx01 = fract(gx01) - 0.5;\n    gy01 = fract(gy01) - 0.5;\n    gz01 = fract(gz01) - 0.5;\n    vec4 gw01 = vec4(0.75) - abs(gx01) - abs(gy01) - abs(gz01);\n    vec4 sw01 = step(gw01, vec4(0.0));\n    gx01 -= sw01 * (step(0.0, gx01) - 0.5);\n    gy01 -= sw01 * (step(0.0, gy01) - 0.5);\n\n    vec4 gx10 = ixy10 * (1.0 / 7.0);\n    vec4 gy10 = floor(gx10) * (1.0 / 7.0);\n    vec4 gz10 = floor(gy10) * (1.0 / 6.0);\n    gx10 = fract(gx10) - 0.5;\n    gy10 = fract(gy10) - 0.5;\n    gz10 = fract(gz10) - 0.5;\n    vec4 gw10 = vec4(0.75) - abs(gx10) - abs(gy10) - abs(gz10);\n    vec4 sw10 = step(gw10, vec4(0.0));\n    gx10 -= sw10 * (step(0.0, gx10) - 0.5);\n    gy10 -= sw10 * (step(0.0, gy10) - 0.5);\n\n    vec4 gx11 = ixy11 * (1.0 / 7.0);\n    vec4 gy11 = floor(gx11) * (1.0 / 7.0);\n    vec4 gz11 = floor(gy11) * (1.0 / 6.0);\n    gx11 = fract(gx11) - 0.5;\n    gy11 = fract(gy11) - 0.5;\n    gz11 = fract(gz11) - 0.5;\n    vec4 gw11 = vec4(0.75) - abs(gx11) - abs(gy11) - abs(gz11);\n    vec4 sw11 = step(gw11, vec4(0.0));\n    gx11 -= sw11 * (step(0.0, gx11) - 0.5);\n    gy11 -= sw11 * (step(0.0, gy11) - 0.5);\n\n    vec4 g0000 = vec4(gx00.x,gy00.x,gz00.x,gw00.x);\n    vec4 g1000 = vec4(gx00.y,gy00.y,gz00.y,gw00.y);\n    vec4 g0100 = vec4(gx00.z,gy00.z,gz00.z,gw00.z);\n    vec4 g1100 = vec4(gx00.w,gy00.w,gz00.w,gw00.w);\n    vec4 g0010 = vec4(gx10.x,gy10.x,gz10.x,gw10.x);\n    vec4 g1010 = vec4(gx10.y,gy10.y,gz10.y,gw10.y);\n    vec4 g0110 = vec4(gx10.z,gy10.z,gz10.z,gw10.z);\n    vec4 g1110 = vec4(gx10.w,gy10.w,gz10.w,gw10.w);\n    vec4 g0001 = vec4(gx01.x,gy01.x,gz01.x,gw01.x);\n    vec4 g1001 = vec4(gx01.y,gy01.y,gz01.y,gw01.y);\n    vec4 g0101 = vec4(gx01.z,gy01.z,gz01.z,gw01.z);\n    vec4 g1101 = vec4(gx01.w,gy01.w,gz01.w,gw01.w);\n    vec4 g0011 = vec4(gx11.x,gy11.x,gz11.x,gw11.x);\n    vec4 g1011 = vec4(gx11.y,gy11.y,gz11.y,gw11.y);\n    vec4 g0111 = vec4(gx11.z,gy11.z,gz11.z,gw11.z);\n    vec4 g1111 = vec4(gx11.w,gy11.w,gz11.w,gw11.w);\n\n    vec4 norm00 = taylorInvSqrt(vec4(dot(g0000, g0000), dot(g0100, g0100), dot(g1000, g1000), dot(g1100, g1100)));\n    g0000 *= norm00.x;\n    g0100 *= norm00.y;\n    g1000 *= norm00.z;\n    g1100 *= norm00.w;\n\n    vec4 norm01 = taylorInvSqrt(vec4(dot(g0001, g0001), dot(g0101, g0101), dot(g1001, g1001), dot(g1101, g1101)));\n    g0001 *= norm01.x;\n    g0101 *= norm01.y;\n    g1001 *= norm01.z;\n    g1101 *= norm01.w;\n\n    vec4 norm10 = taylorInvSqrt(vec4(dot(g0010, g0010), dot(g0110, g0110), dot(g1010, g1010), dot(g1110, g1110)));\n    g0010 *= norm10.x;\n    g0110 *= norm10.y;\n    g1010 *= norm10.z;\n    g1110 *= norm10.w;\n\n    vec4 norm11 = taylorInvSqrt(vec4(dot(g0011, g0011), dot(g0111, g0111), dot(g1011, g1011), dot(g1111, g1111)));\n    g0011 *= norm11.x;\n    g0111 *= norm11.y;\n    g1011 *= norm11.z;\n    g1111 *= norm11.w;\n\n    float n0000 = dot(g0000, Pf0);\n    float n1000 = dot(g1000, vec4(Pf1.x, Pf0.yzw));\n    float n0100 = dot(g0100, vec4(Pf0.x, Pf1.y, Pf0.zw));\n    float n1100 = dot(g1100, vec4(Pf1.xy, Pf0.zw));\n    float n0010 = dot(g0010, vec4(Pf0.xy, Pf1.z, Pf0.w));\n    float n1010 = dot(g1010, vec4(Pf1.x, Pf0.y, Pf1.z, Pf0.w));\n    float n0110 = dot(g0110, vec4(Pf0.x, Pf1.yz, Pf0.w));\n    float n1110 = dot(g1110, vec4(Pf1.xyz, Pf0.w));\n    float n0001 = dot(g0001, vec4(Pf0.xyz, Pf1.w));\n    float n1001 = dot(g1001, vec4(Pf1.x, Pf0.yz, Pf1.w));\n    float n0101 = dot(g0101, vec4(Pf0.x, Pf1.y, Pf0.z, Pf1.w));\n    float n1101 = dot(g1101, vec4(Pf1.xy, Pf0.z, Pf1.w));\n    float n0011 = dot(g0011, vec4(Pf0.xy, Pf1.zw));\n    float n1011 = dot(g1011, vec4(Pf1.x, Pf0.y, Pf1.zw));\n    float n0111 = dot(g0111, vec4(Pf0.x, Pf1.yzw));\n    float n1111 = dot(g1111, Pf1);\n\n    vec4 fade_xyzw = fade(Pf0);\n    vec4 n_0w = mix(vec4(n0000, n1000, n0100, n1100), vec4(n0001, n1001, n0101, n1101), fade_xyzw.w);\n    vec4 n_1w = mix(vec4(n0010, n1010, n0110, n1110), vec4(n0011, n1011, n0111, n1111), fade_xyzw.w);\n    vec4 n_zw = mix(n_0w, n_1w, fade_xyzw.z);\n    vec2 n_yzw = mix(n_zw.xy, n_zw.zw, fade_xyzw.y);\n    float n_xyzw = mix(n_yzw.x, n_yzw.y, fade_xyzw.x);\n    return 2.2 * n_xyzw;\n\n}\n\n// Classic Perlin noise, periodic version\nfloat perlin( vec4 P, vec4 rep ) {\n\n    vec4 Pi0 = mod(floor(P), rep); // Integer part modulo rep\n    vec4 Pi1 = mod(Pi0 + 1.0, rep); // Integer part + 1 mod rep\n    Pi0 = mod289(Pi0);\n    Pi1 = mod289(Pi1);\n    vec4 Pf0 = fract(P); // Fractional part for interpolation\n    vec4 Pf1 = Pf0 - 1.0; // Fractional part - 1.0\n    vec4 ix = vec4(Pi0.x, Pi1.x, Pi0.x, Pi1.x);\n    vec4 iy = vec4(Pi0.yy, Pi1.yy);\n    vec4 iz0 = vec4(Pi0.zzzz);\n    vec4 iz1 = vec4(Pi1.zzzz);\n    vec4 iw0 = vec4(Pi0.wwww);\n    vec4 iw1 = vec4(Pi1.wwww);\n\n    vec4 ixy = permute(permute(ix) + iy);\n    vec4 ixy0 = permute(ixy + iz0);\n    vec4 ixy1 = permute(ixy + iz1);\n    vec4 ixy00 = permute(ixy0 + iw0);\n    vec4 ixy01 = permute(ixy0 + iw1);\n    vec4 ixy10 = permute(ixy1 + iw0);\n    vec4 ixy11 = permute(ixy1 + iw1);\n\n    vec4 gx00 = ixy00 * (1.0 / 7.0);\n    vec4 gy00 = floor(gx00) * (1.0 / 7.0);\n    vec4 gz00 = floor(gy00) * (1.0 / 6.0);\n    gx00 = fract(gx00) - 0.5;\n    gy00 = fract(gy00) - 0.5;\n    gz00 = fract(gz00) - 0.5;\n    vec4 gw00 = vec4(0.75) - abs(gx00) - abs(gy00) - abs(gz00);\n    vec4 sw00 = step(gw00, vec4(0.0));\n    gx00 -= sw00 * (step(0.0, gx00) - 0.5);\n    gy00 -= sw00 * (step(0.0, gy00) - 0.5);\n\n    vec4 gx01 = ixy01 * (1.0 / 7.0);\n    vec4 gy01 = floor(gx01) * (1.0 / 7.0);\n    vec4 gz01 = floor(gy01) * (1.0 / 6.0);\n    gx01 = fract(gx01) - 0.5;\n    gy01 = fract(gy01) - 0.5;\n    gz01 = fract(gz01) - 0.5;\n    vec4 gw01 = vec4(0.75) - abs(gx01) - abs(gy01) - abs(gz01);\n    vec4 sw01 = step(gw01, vec4(0.0));\n    gx01 -= sw01 * (step(0.0, gx01) - 0.5);\n    gy01 -= sw01 * (step(0.0, gy01) - 0.5);\n\n    vec4 gx10 = ixy10 * (1.0 / 7.0);\n    vec4 gy10 = floor(gx10) * (1.0 / 7.0);\n    vec4 gz10 = floor(gy10) * (1.0 / 6.0);\n    gx10 = fract(gx10) - 0.5;\n    gy10 = fract(gy10) - 0.5;\n    gz10 = fract(gz10) - 0.5;\n    vec4 gw10 = vec4(0.75) - abs(gx10) - abs(gy10) - abs(gz10);\n    vec4 sw10 = step(gw10, vec4(0.0));\n    gx10 -= sw10 * (step(0.0, gx10) - 0.5);\n    gy10 -= sw10 * (step(0.0, gy10) - 0.5);\n\n    vec4 gx11 = ixy11 * (1.0 / 7.0);\n    vec4 gy11 = floor(gx11) * (1.0 / 7.0);\n    vec4 gz11 = floor(gy11) * (1.0 / 6.0);\n    gx11 = fract(gx11) - 0.5;\n    gy11 = fract(gy11) - 0.5;\n    gz11 = fract(gz11) - 0.5;\n    vec4 gw11 = vec4(0.75) - abs(gx11) - abs(gy11) - abs(gz11);\n    vec4 sw11 = step(gw11, vec4(0.0));\n    gx11 -= sw11 * (step(0.0, gx11) - 0.5);\n    gy11 -= sw11 * (step(0.0, gy11) - 0.5);\n\n    vec4 g0000 = vec4(gx00.x,gy00.x,gz00.x,gw00.x);\n    vec4 g1000 = vec4(gx00.y,gy00.y,gz00.y,gw00.y);\n    vec4 g0100 = vec4(gx00.z,gy00.z,gz00.z,gw00.z);\n    vec4 g1100 = vec4(gx00.w,gy00.w,gz00.w,gw00.w);\n    vec4 g0010 = vec4(gx10.x,gy10.x,gz10.x,gw10.x);\n    vec4 g1010 = vec4(gx10.y,gy10.y,gz10.y,gw10.y);\n    vec4 g0110 = vec4(gx10.z,gy10.z,gz10.z,gw10.z);\n    vec4 g1110 = vec4(gx10.w,gy10.w,gz10.w,gw10.w);\n    vec4 g0001 = vec4(gx01.x,gy01.x,gz01.x,gw01.x);\n    vec4 g1001 = vec4(gx01.y,gy01.y,gz01.y,gw01.y);\n    vec4 g0101 = vec4(gx01.z,gy01.z,gz01.z,gw01.z);\n    vec4 g1101 = vec4(gx01.w,gy01.w,gz01.w,gw01.w);\n    vec4 g0011 = vec4(gx11.x,gy11.x,gz11.x,gw11.x);\n    vec4 g1011 = vec4(gx11.y,gy11.y,gz11.y,gw11.y);\n    vec4 g0111 = vec4(gx11.z,gy11.z,gz11.z,gw11.z);\n    vec4 g1111 = vec4(gx11.w,gy11.w,gz11.w,gw11.w);\n\n    vec4 norm00 = taylorInvSqrt(vec4(dot(g0000, g0000), dot(g0100, g0100), dot(g1000, g1000), dot(g1100, g1100)));\n    g0000 *= norm00.x;\n    g0100 *= norm00.y;\n    g1000 *= norm00.z;\n    g1100 *= norm00.w;\n\n    vec4 norm01 = taylorInvSqrt(vec4(dot(g0001, g0001), dot(g0101, g0101), dot(g1001, g1001), dot(g1101, g1101)));\n    g0001 *= norm01.x;\n    g0101 *= norm01.y;\n    g1001 *= norm01.z;\n    g1101 *= norm01.w;\n\n    vec4 norm10 = taylorInvSqrt(vec4(dot(g0010, g0010), dot(g0110, g0110), dot(g1010, g1010), dot(g1110, g1110)));\n    g0010 *= norm10.x;\n    g0110 *= norm10.y;\n    g1010 *= norm10.z;\n    g1110 *= norm10.w;\n\n    vec4 norm11 = taylorInvSqrt(vec4(dot(g0011, g0011), dot(g0111, g0111), dot(g1011, g1011), dot(g1111, g1111)));\n    g0011 *= norm11.x;\n    g0111 *= norm11.y;\n    g1011 *= norm11.z;\n    g1111 *= norm11.w;\n\n    float n0000 = dot(g0000, Pf0);\n    float n1000 = dot(g1000, vec4(Pf1.x, Pf0.yzw));\n    float n0100 = dot(g0100, vec4(Pf0.x, Pf1.y, Pf0.zw));\n    float n1100 = dot(g1100, vec4(Pf1.xy, Pf0.zw));\n    float n0010 = dot(g0010, vec4(Pf0.xy, Pf1.z, Pf0.w));\n    float n1010 = dot(g1010, vec4(Pf1.x, Pf0.y, Pf1.z, Pf0.w));\n    float n0110 = dot(g0110, vec4(Pf0.x, Pf1.yz, Pf0.w));\n    float n1110 = dot(g1110, vec4(Pf1.xyz, Pf0.w));\n    float n0001 = dot(g0001, vec4(Pf0.xyz, Pf1.w));\n    float n1001 = dot(g1001, vec4(Pf1.x, Pf0.yz, Pf1.w));\n    float n0101 = dot(g0101, vec4(Pf0.x, Pf1.y, Pf0.z, Pf1.w));\n    float n1101 = dot(g1101, vec4(Pf1.xy, Pf0.z, Pf1.w));\n    float n0011 = dot(g0011, vec4(Pf0.xy, Pf1.zw));\n    float n1011 = dot(g1011, vec4(Pf1.x, Pf0.y, Pf1.zw));\n    float n0111 = dot(g0111, vec4(Pf0.x, Pf1.yzw));\n    float n1111 = dot(g1111, Pf1);\n\n    vec4 fade_xyzw = fade(Pf0);\n    vec4 n_0w = mix(vec4(n0000, n1000, n0100, n1100), vec4(n0001, n1001, n0101, n1101), fade_xyzw.w);\n    vec4 n_1w = mix(vec4(n0010, n1010, n0110, n1110), vec4(n0011, n1011, n0111, n1111), fade_xyzw.w);\n    vec4 n_zw = mix(n_0w, n_1w, fade_xyzw.z);\n    vec2 n_yzw = mix(n_zw.xy, n_zw.zw, fade_xyzw.y);\n    float n_xyzw = mix(n_yzw.x, n_yzw.y, fade_xyzw.x);\n    return 2.2 * n_xyzw;\n\n}\n',noise_perlin:"#include <noise_perlin_2D>\n#include <noise_perlin_3D>\n#include <noise_perlin_4D>\n",noise_psrd_2D:'// Periodic (tiling) 2-D simplex noise (hexagonal lattice gradient noise)\n// with rotating gradients and analytic derivatives.\n// Variants also without the derivative (no "d" in the name), without\n// the tiling property (no "p" in the name) and without the rotating\n// gradients (no "r" in the name).\n//\n// This is (yet) another variation on simplex noise. It\'s similar to the\n// version presented by Ken Perlin, but the grid is axis-aligned and\n// slightly stretched in the y direction to permit rectangular tiling.\n//\n// The noise can be made to tile seamlessly to any integer period in x and\n// any even integer period in y. Odd periods may be specified for y, but\n// then the actual tiling period will be twice that number.\n//\n// The rotating gradients give the appearance of a swirling motion, and can\n// serve a similar purpose for animation as motion along z in 3-D noise.\n// The rotating gradients in conjunction with the analytic derivatives\n// can make "flow noise" effects as presented by Perlin and Neyret.\n//\n// vec3 {p}s{r}dnoise(vec2 pos {, vec2 per} {, float rot})\n// "pos" is the input (x,y) coordinate\n// "per" is the x and y period, where per.x is a positive integer\n//    and per.y is a positive even integer\n// "rot" is the angle to rotate the gradients (any float value,\n//    where 0.0 is no rotation and 1.0 is one full turn)\n// The first component of the 3-element return vector is the noise value.\n// The second and third components are the x and y partial derivatives.\n//\n// float {p}s{r}noise(vec2 pos {, vec2 per} {, float rot})\n// "pos" is the input (x,y) coordinate\n// "per" is the x and y period, where per.x is a positive integer\n//    and per.y is a positive even integer\n// "rot" is the angle to rotate the gradients (any float value,\n//    where 0.0 is no rotation and 1.0 is one full turn)\n// The return value is the noise value.\n// Partial derivatives are not computed, making these functions faster.\n//\n// Author: Stefan Gustavson (stefan.gustavson@gmail.com)\n// Version 2016-05-10.\n//\n// Many thanks to Ian McEwan of Ashima Arts for the\n// idea of using a permutation polynomial.\n//\n// Copyright (c) 2016 Stefan Gustavson. All rights reserved.\n// Distributed under the MIT license. See LICENSE file.\n// https://github.com/stegu/webgl-noise\n//\n\n// Hashed 2-D gradients with an extra rotation.\n// (The constant 0.0243902439 is 1/41)\nvec2 rgrad2( vec2 p, float rot ) {\n\n    // For more isotropic gradients, sin/cos can be used instead.\n    float u = permute( permute( p.x ) + p.y ) * 0.0243902439 + rot; // Rotate by shift\n    u = fract( u ) * 6.28318530718; // 2*pi\n    return vec2( cos( u ), sin( u ));\n\n}\n\n//\n// 2-D tiling simplex noise with rotating gradients and analytical derivative.\n// The first component of the 3-element return vector is the noise value,\n// and the second and third components are the x and y partial derivatives.\n//\nvec3 psrdnoise(vec2 pos, vec2 per, float rot) {\n  // Hack: offset y slightly to hide some rare artifacts\n  pos.y += 0.01;\n  // Skew to hexagonal grid\n  vec2 uv = vec2(pos.x + pos.y*0.5, pos.y);\n\n  vec2 i0 = floor(uv);\n  vec2 f0 = fract(uv);\n  // Traversal order\n  vec2 i1 = (f0.x > f0.y) ? vec2(1.0, 0.0) : vec2(0.0, 1.0);\n\n  // Unskewed grid points in (x,y) space\n  vec2 p0 = vec2(i0.x - i0.y * 0.5, i0.y);\n  vec2 p1 = vec2(p0.x + i1.x - i1.y * 0.5, p0.y + i1.y);\n  vec2 p2 = vec2(p0.x + 0.5, p0.y + 1.0);\n\n  // Integer grid point indices in (u,v) space\n  i1 = i0 + i1;\n  vec2 i2 = i0 + vec2(1.0, 1.0);\n\n  // Vectors in unskewed (x,y) coordinates from\n  // each of the simplex corners to the evaluation point\n  vec2 d0 = pos - p0;\n  vec2 d1 = pos - p1;\n  vec2 d2 = pos - p2;\n\n  // Wrap i0, i1 and i2 to the desired period before gradient hashing:\n  // wrap points in (x,y), map to (u,v)\n  vec3 xw = mod(vec3(p0.x, p1.x, p2.x), per.x);\n  vec3 yw = mod(vec3(p0.y, p1.y, p2.y), per.y);\n  vec3 iuw = xw + 0.5 * yw;\n  vec3 ivw = yw;\n\n  // Create gradients from indices\n  vec2 g0 = rgrad2(vec2(iuw.x, ivw.x), rot);\n  vec2 g1 = rgrad2(vec2(iuw.y, ivw.y), rot);\n  vec2 g2 = rgrad2(vec2(iuw.z, ivw.z), rot);\n\n  // Gradients dot vectors to corresponding corners\n  // (The derivatives of this are simply the gradients)\n  vec3 w = vec3(dot(g0, d0), dot(g1, d1), dot(g2, d2));\n\n  // Radial weights from corners\n  // 0.8 is the square of 2/sqrt(5), the distance from\n  // a grid point to the nearest simplex boundary\n  vec3 t = 0.8 - vec3(dot(d0, d0), dot(d1, d1), dot(d2, d2));\n\n  // Partial derivatives for analytical gradient computation\n  vec3 dtdx = -2.0 * vec3(d0.x, d1.x, d2.x);\n  vec3 dtdy = -2.0 * vec3(d0.y, d1.y, d2.y);\n\n  // Set influence of each surflet to zero outside radius sqrt(0.8)\n  if (t.x < 0.0) {\n    dtdx.x = 0.0;\n    dtdy.x = 0.0;\n\tt.x = 0.0;\n  }\n  if (t.y < 0.0) {\n    dtdx.y = 0.0;\n    dtdy.y = 0.0;\n\tt.y = 0.0;\n  }\n  if (t.z < 0.0) {\n    dtdx.z = 0.0;\n    dtdy.z = 0.0;\n\tt.z = 0.0;\n  }\n\n  // Fourth power of t (and third power for derivative)\n  vec3 t2 = t * t;\n  vec3 t4 = t2 * t2;\n  vec3 t3 = t2 * t;\n\n  // Final noise value is:\n  // sum of ((radial weights) times (gradient dot vector from corner))\n  float n = dot(t4, w);\n\n  // Final analytical derivative (gradient of a sum of scalar products)\n  vec2 dt0 = vec2(dtdx.x, dtdy.x) * 4.0 * t3.x;\n  vec2 dn0 = t4.x * g0 + dt0 * w.x;\n  vec2 dt1 = vec2(dtdx.y, dtdy.y) * 4.0 * t3.y;\n  vec2 dn1 = t4.y * g1 + dt1 * w.y;\n  vec2 dt2 = vec2(dtdx.z, dtdy.z) * 4.0 * t3.z;\n  vec2 dn2 = t4.z * g2 + dt2 * w.z;\n\n  return 11.0*vec3(n, dn0 + dn1 + dn2);\n}\n\n//\n// 2-D tiling simplex noise with fixed gradients\n// and analytical derivative.\n// This function is implemented as a wrapper to "psrdnoise",\n// at the minimal cost of three extra additions.\n//\nvec3 psdnoise(vec2 pos, vec2 per) {\n  return psrdnoise(pos, per, 0.0);\n}\n\n//\n// 2-D tiling simplex noise with rotating gradients,\n// but without the analytical derivative.\n//\nfloat psrnoise(vec2 pos, vec2 per, float rot) {\n  // Offset y slightly to hide some rare artifacts\n  pos.y += 0.001;\n  // Skew to hexagonal grid\n  vec2 uv = vec2(pos.x + pos.y*0.5, pos.y);\n\n  vec2 i0 = floor(uv);\n  vec2 f0 = fract(uv);\n  // Traversal order\n  vec2 i1 = (f0.x > f0.y) ? vec2(1.0, 0.0) : vec2(0.0, 1.0);\n\n  // Unskewed grid points in (x,y) space\n  vec2 p0 = vec2(i0.x - i0.y * 0.5, i0.y);\n  vec2 p1 = vec2(p0.x + i1.x - i1.y * 0.5, p0.y + i1.y);\n  vec2 p2 = vec2(p0.x + 0.5, p0.y + 1.0);\n\n  // Integer grid point indices in (u,v) space\n  i1 = i0 + i1;\n  vec2 i2 = i0 + vec2(1.0, 1.0);\n\n  // Vectors in unskewed (x,y) coordinates from\n  // each of the simplex corners to the evaluation point\n  vec2 d0 = pos - p0;\n  vec2 d1 = pos - p1;\n  vec2 d2 = pos - p2;\n\n  // Wrap i0, i1 and i2 to the desired period before gradient hashing:\n  // wrap points in (x,y), map to (u,v)\n  vec3 xw = mod(vec3(p0.x, p1.x, p2.x), per.x);\n  vec3 yw = mod(vec3(p0.y, p1.y, p2.y), per.y);\n  vec3 iuw = xw + 0.5 * yw;\n  vec3 ivw = yw;\n\n  // Create gradients from indices\n  vec2 g0 = rgrad2(vec2(iuw.x, ivw.x), rot);\n  vec2 g1 = rgrad2(vec2(iuw.y, ivw.y), rot);\n  vec2 g2 = rgrad2(vec2(iuw.z, ivw.z), rot);\n\n  // Gradients dot vectors to corresponding corners\n  // (The derivatives of this are simply the gradients)\n  vec3 w = vec3(dot(g0, d0), dot(g1, d1), dot(g2, d2));\n\n  // Radial weights from corners\n  // 0.8 is the square of 2/sqrt(5), the distance from\n  // a grid point to the nearest simplex boundary\n  vec3 t = 0.8 - vec3(dot(d0, d0), dot(d1, d1), dot(d2, d2));\n\n  // Set influence of each surflet to zero outside radius sqrt(0.8)\n  t = max(t, 0.0);\n\n  // Fourth power of t\n  vec3 t2 = t * t;\n  vec3 t4 = t2 * t2;\n\n  // Final noise value is:\n  // sum of ((radial weights) times (gradient dot vector from corner))\n  float n = dot(t4, w);\n\n  // Rescale to cover the range [-1,1] reasonably well\n  return 11.0*n;\n}\n\n//\n// 2-D tiling simplex noise with fixed gradients,\n// without the analytical derivative.\n// This function is implemented as a wrapper to "psrnoise",\n// at the minimal cost of three extra additions.\n//\nfloat psnoise(vec2 pos, vec2 per) {\n  return psrnoise(pos, per, 0.0);\n}\n\n//\n// 2-D non-tiling simplex noise with rotating gradients and analytical derivative.\n// The first component of the 3-element return vector is the noise value,\n// and the second and third components are the x and y partial derivatives.\n//\nvec3 srdnoise(vec2 pos, float rot) {\n  // Offset y slightly to hide some rare artifacts\n  pos.y += 0.001;\n  // Skew to hexagonal grid\n  vec2 uv = vec2(pos.x + pos.y*0.5, pos.y);\n\n  vec2 i0 = floor(uv);\n  vec2 f0 = fract(uv);\n  // Traversal order\n  vec2 i1 = (f0.x > f0.y) ? vec2(1.0, 0.0) : vec2(0.0, 1.0);\n\n  // Unskewed grid points in (x,y) space\n  vec2 p0 = vec2(i0.x - i0.y * 0.5, i0.y);\n  vec2 p1 = vec2(p0.x + i1.x - i1.y * 0.5, p0.y + i1.y);\n  vec2 p2 = vec2(p0.x + 0.5, p0.y + 1.0);\n\n  // Integer grid point indices in (u,v) space\n  i1 = i0 + i1;\n  vec2 i2 = i0 + vec2(1.0, 1.0);\n\n  // Vectors in unskewed (x,y) coordinates from\n  // each of the simplex corners to the evaluation point\n  vec2 d0 = pos - p0;\n  vec2 d1 = pos - p1;\n  vec2 d2 = pos - p2;\n\n  vec3 x = vec3(p0.x, p1.x, p2.x);\n  vec3 y = vec3(p0.y, p1.y, p2.y);\n  vec3 iuw = x + 0.5 * y;\n  vec3 ivw = y;\n\n  // Avoid precision issues in permutation\n  iuw = mod289(iuw);\n  ivw = mod289(ivw);\n\n  // Create gradients from indices\n  vec2 g0 = rgrad2(vec2(iuw.x, ivw.x), rot);\n  vec2 g1 = rgrad2(vec2(iuw.y, ivw.y), rot);\n  vec2 g2 = rgrad2(vec2(iuw.z, ivw.z), rot);\n\n  // Gradients dot vectors to corresponding corners\n  // (The derivatives of this are simply the gradients)\n  vec3 w = vec3(dot(g0, d0), dot(g1, d1), dot(g2, d2));\n\n  // Radial weights from corners\n  // 0.8 is the square of 2/sqrt(5), the distance from\n  // a grid point to the nearest simplex boundary\n  vec3 t = 0.8 - vec3(dot(d0, d0), dot(d1, d1), dot(d2, d2));\n\n  // Partial derivatives for analytical gradient computation\n  vec3 dtdx = -2.0 * vec3(d0.x, d1.x, d2.x);\n  vec3 dtdy = -2.0 * vec3(d0.y, d1.y, d2.y);\n\n  // Set influence of each surflet to zero outside radius sqrt(0.8)\n  if (t.x < 0.0) {\n    dtdx.x = 0.0;\n    dtdy.x = 0.0;\n\tt.x = 0.0;\n  }\n  if (t.y < 0.0) {\n    dtdx.y = 0.0;\n    dtdy.y = 0.0;\n\tt.y = 0.0;\n  }\n  if (t.z < 0.0) {\n    dtdx.z = 0.0;\n    dtdy.z = 0.0;\n\tt.z = 0.0;\n  }\n\n  // Fourth power of t (and third power for derivative)\n  vec3 t2 = t * t;\n  vec3 t4 = t2 * t2;\n  vec3 t3 = t2 * t;\n\n  // Final noise value is:\n  // sum of ((radial weights) times (gradient dot vector from corner))\n  float n = dot(t4, w);\n\n  // Final analytical derivative (gradient of a sum of scalar products)\n  vec2 dt0 = vec2(dtdx.x, dtdy.x) * 4.0 * t3.x;\n  vec2 dn0 = t4.x * g0 + dt0 * w.x;\n  vec2 dt1 = vec2(dtdx.y, dtdy.y) * 4.0 * t3.y;\n  vec2 dn1 = t4.y * g1 + dt1 * w.y;\n  vec2 dt2 = vec2(dtdx.z, dtdy.z) * 4.0 * t3.z;\n  vec2 dn2 = t4.z * g2 + dt2 * w.z;\n\n  return 11.0*vec3(n, dn0 + dn1 + dn2);\n}\n\n//\n// 2-D non-tiling simplex noise with fixed gradients and analytical derivative.\n// This function is implemented as a wrapper to "srdnoise",\n// at the minimal cost of three extra additions.\n//\nvec3 sdnoise(vec2 pos) {\n  return srdnoise(pos, 0.0);\n}\n\n//\n// 2-D non-tiling simplex noise with rotating gradients,\n// without the analytical derivative.\n//\nfloat srnoise(vec2 pos, float rot) {\n  // Offset y slightly to hide some rare artifacts\n  pos.y += 0.001;\n  // Skew to hexagonal grid\n  vec2 uv = vec2(pos.x + pos.y*0.5, pos.y);\n\n  vec2 i0 = floor(uv);\n  vec2 f0 = fract(uv);\n  // Traversal order\n  vec2 i1 = (f0.x > f0.y) ? vec2(1.0, 0.0) : vec2(0.0, 1.0);\n\n  // Unskewed grid points in (x,y) space\n  vec2 p0 = vec2(i0.x - i0.y * 0.5, i0.y);\n  vec2 p1 = vec2(p0.x + i1.x - i1.y * 0.5, p0.y + i1.y);\n  vec2 p2 = vec2(p0.x + 0.5, p0.y + 1.0);\n\n  // Integer grid point indices in (u,v) space\n  i1 = i0 + i1;\n  vec2 i2 = i0 + vec2(1.0, 1.0);\n\n  // Vectors in unskewed (x,y) coordinates from\n  // each of the simplex corners to the evaluation point\n  vec2 d0 = pos - p0;\n  vec2 d1 = pos - p1;\n  vec2 d2 = pos - p2;\n\n  // Wrap i0, i1 and i2 to the desired period before gradient hashing:\n  // wrap points in (x,y), map to (u,v)\n  vec3 x = vec3(p0.x, p1.x, p2.x);\n  vec3 y = vec3(p0.y, p1.y, p2.y);\n  vec3 iuw = x + 0.5 * y;\n  vec3 ivw = y;\n\n  // Avoid precision issues in permutation\n  iuw = mod289(iuw);\n  ivw = mod289(ivw);\n\n  // Create gradients from indices\n  vec2 g0 = rgrad2(vec2(iuw.x, ivw.x), rot);\n  vec2 g1 = rgrad2(vec2(iuw.y, ivw.y), rot);\n  vec2 g2 = rgrad2(vec2(iuw.z, ivw.z), rot);\n\n  // Gradients dot vectors to corresponding corners\n  // (The derivatives of this are simply the gradients)\n  vec3 w = vec3(dot(g0, d0), dot(g1, d1), dot(g2, d2));\n\n  // Radial weights from corners\n  // 0.8 is the square of 2/sqrt(5), the distance from\n  // a grid point to the nearest simplex boundary\n  vec3 t = 0.8 - vec3(dot(d0, d0), dot(d1, d1), dot(d2, d2));\n\n  // Set influence of each surflet to zero outside radius sqrt(0.8)\n  t = max(t, 0.0);\n\n  // Fourth power of t\n  vec3 t2 = t * t;\n  vec3 t4 = t2 * t2;\n\n  // Final noise value is:\n  // sum of ((radial weights) times (gradient dot vector from corner))\n  float n = dot(t4, w);\n\n  // Rescale to cover the range [-1,1] reasonably well\n  return 11.0*n;\n}\n\n//\n// 2-D non-tiling simplex noise with fixed gradients,\n// without the analytical derivative.\n// This function is implemented as a wrapper to "srnoise",\n// at the minimal cost of three extra additions.\n// Note: if this kind of noise is all you want, there are faster\n// GLSL implementations of non-tiling simplex noise out there.\n// This one is included mainly for completeness and compatibility\n// with the other functions in the file.\n//\nfloat snoise(vec2 pos) {\n  return srnoise(pos, 0.0);\n}\n',noise_simplex_2D:"//\n// Description : Array and textureless GLSL 2D simplex noise function.\n//      Author : Ian McEwan, Ashima Arts.\n//  Maintainer : stegu\n//     Lastmod : 20110822 (ijm)\n//     License : Copyright (C) 2011 Ashima Arts. All rights reserved.\n//               Distributed under the MIT License. See LICENSE file.\n//               https://github.com/ashima/webgl-noise\n//               https://github.com/stegu/webgl-noise\n//\n\nfloat simplex( vec2 v ) {\n\n    const vec4 C = vec4( 0.211324865405187,  // (3.0-sqrt(3.0))/6.0\n                        0.366025403784439,  // 0.5*(sqrt(3.0)-1.0)\n                        -0.577350269189626,  // -1.0 + 2.0 * C.x\n                        0.024390243902439 ); // 1.0 / 41.0\n    // First corner\n    vec2 i  = floor( v + dot( v, C.yy ) );\n    vec2 x0 = v - i + dot( i, C.xx );\n\n    // Other corners\n    vec2 i1;\n    //i1.x = step( x0.y, x0.x ); // x0.x > x0.y ? 1.0 : 0.0\n    //i1.y = 1.0 - i1.x;\n    i1 = ( x0.x > x0.y ) ? vec2( 1.0, 0.0 ) : vec2( 0.0, 1.0 );\n    // x0 = x0 - 0.0 + 0.0 * C.xx ;\n    // x1 = x0 - i1 + 1.0 * C.xx ;\n    // x2 = x0 - 1.0 + 2.0 * C.xx ;\n    vec4 x12 = x0.xyxy + C.xxzz;\n    x12.xy -= i1;\n\n    // Permutations\n    i = mod289( i ); // Avoid truncation effects in permutation\n    vec3 p = permute( permute( i.y + vec3( 0.0, i1.y, 1.0 ) )\n        + i.x + vec3( 0.0, i1.x, 1.0 ) );\n\n    vec3 m = max( 0.5 - vec3( dot( x0, x0 ), dot( x12.xy, x12.xy ), dot( x12.zw, x12.zw ) ), 0.0 );\n    m = m*m ;\n    m = m*m ;\n\n    // Gradients: 41 points uniformly over a line, mapped onto a diamond.\n    // The ring size 17*17 = 289 is close to a multiple of 41 (41*7 = 287)\n\n    vec3 x = 2.0 * fract( p * C.www ) - 1.0;\n    vec3 h = abs( x ) - 0.5;\n    vec3 ox = floor( x + 0.5 );\n    vec3 a0 = x - ox;\n\n    // Normalise gradients implicitly by scaling m\n    // Approximation of: m *= inversesqrt( a0*a0 + h*h );\n    m *= 1.79284291400159 - 0.85373472095314 * ( a0 * a0 + h * h );\n\n    // Compute final noise value at P\n    vec3 g;\n    g.x  = a0.x * x0.x + h.x * x0.y;\n    g.yz = a0.yz * x12.xz + h.yz * x12.yw;\n    return 130.0 * dot( m, g );\n\n}\n",noise_simplex_3D_grad:"//\n// Description : Array and textureless GLSL 2D/3D/4D simplex\n//               noise functions.\n//      Author : Ian McEwan, Ashima Arts.\n//  Maintainer : stegu\n//     Lastmod : 20150104 (JcBernack)\n//     License : Copyright (C) 2011 Ashima Arts. All rights reserved.\n//               Distributed under the MIT License. See LICENSE file.\n//               https://github.com/ashima/webgl-noise\n//               https://github.com/stegu/webgl-noise\n//\n\nfloat simplex( vec3 v, out vec3 gradient ) {\n\n    const vec2  C = vec2( 1.0 / 6.0, 1.0 / 3.0 );\n    const vec4  D = vec4( 0.0, 0.5, 1.0, 2.0 );\n\n    // First corner\n    vec3 i  = floor( v + dot( v, C.yyy ) );\n    vec3 x0 = v - i + dot( i, C.xxx ) ;\n\n    // Other corners\n    vec3 g = step( x0.yzx, x0.xyz );\n    vec3 l = 1.0 - g;\n    vec3 i1 = min( g.xyz, l.zxy );\n    vec3 i2 = max( g.xyz, l.zxy );\n\n    vec3 x1 = x0 - i1 + C.xxx;\n    vec3 x2 = x0 - i2 + C.yyy; // 2.0*C.x = 1/3 = C.y\n    vec3 x3 = x0 - D.yyy;      // -1.0+3.0*C.x = -0.5 = -D.y\n\n    // Permutations\n    i = mod289( i );\n    vec4 p = permute( permute( permute(\n                i.z + vec4( 0.0, i1.z, i2.z, 1.0 ) )\n            + i.y + vec4( 0.0, i1.y, i2.y, 1.0 ) )\n            + i.x + vec4( 0.0, i1.x, i2.x, 1.0 ) );\n\n    // Gradients: 7x7 points over a square, mapped onto an octahedron.\n    // The ring size 17*17 = 289 is close to a multiple of 49 (49*6 = 294)\n    float n_ = 0.142857142857; // 1.0/7.0\n    vec3 ns = n_ * D.wyz - D.xzx;\n\n    vec4 j = p - 49.0 * floor(p * ns.z * ns.z);  //  mod(p,7*7)\n\n    vec4 x_ = floor(j * ns.z);\n    vec4 y_ = floor(j - 7.0 * x_ );    // mod(j,N)\n\n    vec4 x = x_ * ns.x + ns.yyyy;\n    vec4 y = y_ * ns.x + ns.yyyy;\n    vec4 h = 1.0 - abs( x ) - abs( y );\n\n    vec4 b0 = vec4( x.xy, y.xy );\n    vec4 b1 = vec4( x.zw, y.zw );\n\n    vec4 s0 = floor( b0 ) * 2.0 + 1.0;\n    vec4 s1 = floor( b1 ) * 2.0 + 1.0;\n    vec4 sh = - step( h, vec4( 0.0 ) );\n\n    vec4 a0 = b0.xzyw + s0.xzyw * sh.xxyy ;\n    vec4 a1 = b1.xzyw + s1.xzyw * sh.zzww ;\n\n    vec3 p0 = vec3( a0.xy, h.x );\n    vec3 p1 = vec3( a0.zw, h.y );\n    vec3 p2 = vec3( a1.xy, h.z );\n    vec3 p3 = vec3( a1.zw, h.w );\n\n    //Normalise gradients\n    vec4 norm = taylorInvSqrt( vec4( dot( p0, p0 ), dot( p1, p1 ), dot( p2, p2 ), dot( p3, p3 ) ) );\n    p0 *= norm.x;\n    p1 *= norm.y;\n    p2 *= norm.z;\n    p3 *= norm.w;\n\n    // Mix final noise value\n    vec4 m = max( 0.6 - vec4( dot( x0, x0 ), dot( x1, x1 ), dot( x2, x2 ), dot( x3, x3 ) ), 0.0 );\n    vec4 m2 = m * m;\n    vec4 m4 = m2 * m2;\n    vec4 pdotx = vec4( dot( p0, x0 ), dot( p1, x1 ), dot( p2, x2 ), dot( p3, x3 ) );\n\n    // Determine noise gradient\n    vec4 temp = m2 * m * pdotx;\n    gradient = - 8.0 * ( temp.x * x0 + temp.y * x1 + temp.z * x2 + temp.w * x3 );\n    gradient += m4.x * p0 + m4.y * p1 + m4.z * p2 + m4.w * p3;\n    gradient *= 42.0;\n\n    return 42.0 * dot( m4, pdotx );\n\n}\n",noise_simplex_3D:"//\n// Description : Array and textureless GLSL 2D/3D/4D simplex\n//               noise functions.\n//      Author : Ian McEwan, Ashima Arts.\n//  Maintainer : stegu\n//     Lastmod : 20110822 (ijm)\n//     License : Copyright (C) 2011 Ashima Arts. All rights reserved.\n//               Distributed under the MIT License. See LICENSE file.\n//               https://github.com/ashima/webgl-noise\n//               https://github.com/stegu/webgl-noise\n//\n\nfloat simplex( vec3 v ) {\n\n    const vec2 C = vec2( 1.0 / 6.0, 1.0 / 3.0 );\n    const vec4 D = vec4( 0.0, 0.5, 1.0, 2.0 );\n\n    // First corner\n    vec3 i  = floor( v + dot( v, C.yyy ) );\n    vec3 x0 = v - i + dot( i, C.xxx );\n\n    // Other corners\n    vec3 g = step( x0.yzx, x0.xyz );\n    vec3 l = 1.0 - g;\n    vec3 i1 = min( g.xyz, l.zxy );\n    vec3 i2 = max( g.xyz, l.zxy );\n\n    vec3 x1 = x0 - i1 + C.xxx;\n    vec3 x2 = x0 - i2 + C.yyy; // 2.0*C.x = 1/3 = C.y\n    vec3 x3 = x0 - D.yyy;      // -1.0+3.0*C.x = -0.5 = -D.y\n\n    // Permutations\n    i = mod289( i );\n    vec4 p = permute( permute( permute(\n                i.z + vec4(0.0, i1.z, i2.z, 1.0 ))\n            + i.y + vec4(0.0, i1.y, i2.y, 1.0 ))\n            + i.x + vec4(0.0, i1.x, i2.x, 1.0 ));\n\n    // Gradients: 7x7 points over a square, mapped onto an octahedron.\n    // The ring size 17*17 = 289 is close to a multiple of 49 (49*6 = 294)\n    float n_ = 0.142857142857; // 1.0/7.0\n    vec3 ns = n_ * D.wyz - D.xzx;\n\n    vec4 j = p - 49.0 * floor( p * ns.z * ns.z );  //  mod(p,7*7)\n\n    vec4 x_ = floor(j * ns.z);\n    vec4 y_ = floor(j - 7.0 * x_ );    // mod(j,N)\n\n    vec4 x = x_ *ns.x + ns.yyyy;\n    vec4 y = y_ *ns.x + ns.yyyy;\n    vec4 h = 1.0 - abs( x ) - abs( y );\n\n    vec4 b0 = vec4( x.xy, y.xy );\n    vec4 b1 = vec4( x.zw, y.zw );\n\n    vec4 s0 = floor( b0 ) * 2.0 + 1.0;\n    vec4 s1 = floor( b1 ) * 2.0 + 1.0;\n    vec4 sh = - step( h, vec4( 0.0 ) );\n\n    vec4 a0 = b0.xzyw + s0.xzyw * sh.xxyy ;\n    vec4 a1 = b1.xzyw + s1.xzyw * sh.zzww ;\n\n    vec3 p0 = vec3( a0.xy, h.x );\n    vec3 p1 = vec3( a0.zw, h.y );\n    vec3 p2 = vec3( a1.xy, h.z );\n    vec3 p3 = vec3( a1.zw, h.w );\n\n    //Normalise gradients\n    vec4 norm = taylorInvSqrt( vec4( dot( p0, p0 ), dot( p1, p1 ), dot( p2, p2 ), dot( p3, p3 ) ) );\n    p0 *= norm.x;\n    p1 *= norm.y;\n    p2 *= norm.z;\n    p3 *= norm.w;\n\n    // Mix final noise value\n    vec4 m = max( 0.6 - vec4( dot( x0, x0 ), dot( x1, x1 ), dot( x2, x2 ), dot( x3, x3 ) ), 0.0 );\n    m = m * m;\n    return 42.0 * dot( m*m, vec4( dot( p0, x0 ), dot( p1, x1 ),\n                                dot( p2, x2 ), dot( p3, x3 ) ) );\n\n}\n",noise_simplex_4D:"//\n// Description : Array and textureless GLSL 2D/3D/4D simplex\n//               noise functions.\n//      Author : Ian McEwan, Ashima Arts.\n//  Maintainer : stegu\n//     Lastmod : 20110822 (ijm)\n//     License : Copyright (C) 2011 Ashima Arts. All rights reserved.\n//               Distributed under the MIT License. See LICENSE file.\n//               https://github.com/ashima/webgl-noise\n//               https://github.com/stegu/webgl-noise\n//\n\nvec4 grad4( float j, vec4 ip ) {\n\n    const vec4 ones = vec4( 1.0, 1.0, 1.0, -1.0 );\n    vec4 p, s;\n\n    p.xyz = floor( fract( vec3( j ) * ip.xyz ) * 7.0 ) * ip.z - 1.0;\n    p.w = 1.5 - dot( abs( p.xyz ), ones.xyz );\n    s = vec4( lessThan( p, vec4( 0.0 ) ) );\n    p.xyz = p.xyz + ( s.xyz * 2.0 - 1.0 ) * s.www;\n\n    return p;\n\n}\n\n// (sqrt(5) - 1)/4 = F4, used once below\n#define F4 0.309016994374947451\n\nfloat simplex(vec4 v) {\n\n    const vec4 C = vec4( 0.138196601125011,  // (5 - sqrt(5))/20  G4\n                        0.276393202250021,  // 2 * G4\n                        0.414589803375032,  // 3 * G4\n                        -0.447213595499958); // -1 + 4 * G4\n\n    // First corner\n    vec4 i  = floor( v + dot( v, vec4( F4 ) ) );\n    vec4 x0 = v - i + dot( i, C.xxxx );\n\n    // Other corners\n\n    // Rank sorting originally contributed by Bill Licea-Kane, AMD (formerly ATI)\n    vec4 i0;\n    vec3 isX = step( x0.yzw, x0.xxx );\n    vec3 isYZ = step( x0.zww, x0.yyz );\n    i0.x = isX.x + isX.y + isX.z;\n    i0.yzw = 1.0 - isX;\n    i0.y += isYZ.x + isYZ.y;\n    i0.zw += 1.0 - isYZ.xy;\n    i0.z += isYZ.z;\n    i0.w += 1.0 - isYZ.z;\n\n    vec4 i3 = clamp( i0, 0.0, 1.0 );\n    vec4 i2 = clamp( i0 - 1.0, 0.0, 1.0 );\n    vec4 i1 = clamp( i0 - 2.0, 0.0, 1.0 );\n\n    vec4 x1 = x0 - i1 + C.xxxx;\n    vec4 x2 = x0 - i2 + C.yyyy;\n    vec4 x3 = x0 - i3 + C.zzzz;\n    vec4 x4 = x0 + C.wwww;\n\n    // Permutations\n    i = mod289( i );\n    float j0 = permute( permute( permute( permute( i.w ) + i.z ) + i.y ) + i.x );\n    vec4 j1 = permute( permute( permute( permute (\n                i.w + vec4(i1.w, i2.w, i3.w, 1.0 ))\n            + i.z + vec4(i1.z, i2.z, i3.z, 1.0 ))\n            + i.y + vec4(i1.y, i2.y, i3.y, 1.0 ))\n            + i.x + vec4(i1.x, i2.x, i3.x, 1.0 ));\n\n    // Gradients: 7x7x6 points over a cube, mapped onto a 4-cross polytope\n    // 7*7*6 = 294, which is close to the ring size 17*17 = 289.\n    vec4 ip = vec4( 1.0 / 294.0, 1.0 / 49.0, 1.0 / 7.0, 0.0 );\n\n    vec4 p0 = grad4(j0,   ip);\n    vec4 p1 = grad4(j1.x, ip);\n    vec4 p2 = grad4(j1.y, ip);\n    vec4 p3 = grad4(j1.z, ip);\n    vec4 p4 = grad4(j1.w, ip);\n\n    // Normalise gradients\n    vec4 norm = taylorInvSqrt( vec4( dot( p0, p0 ), dot( p1, p1 ), dot( p2, p2 ), dot( p3, p3 ) ) );\n    p0 *= norm.x;\n    p1 *= norm.y;\n    p2 *= norm.z;\n    p3 *= norm.w;\n    p4 *= taylorInvSqrt( dot( p4, p4 ) );\n\n    // Mix contributions from the five corners\n    vec3 m0 = max( 0.6 - vec3( dot( x0, x0 ), dot( x1, x1 ), dot( x2, x2 ) ), 0.0 );\n    vec2 m1 = max( 0.6 - vec2( dot( x3, x3 ), dot( x4, x4 ) ), 0.0 );\n    m0 = m0 * m0;\n    m1 = m1 * m1;\n    return 49.0 * ( dot(m0*m0, vec3( dot( p0, x0 ), dot( p1, x1 ), dot( p2, x2 )))\n                + dot(m1*m1, vec2( dot( p3, x3 ), dot( p4, x4 ) ) ) ) ;\n\n}\n",noise_simplex:"#include <noise_simplex_2D>\n#include <noise_simplex_3D>\n#include <noise_simplex_3D_grad>\n#include <noise_simplex_4D>\n",perturbation_share:"#ifdef HAS_PERTURBATIONMAP\n  uniform sampler2D u_perturbationSampler;\n  uniform float u_perturbationUOffset;\n  uniform float u_perturbationVOffset;\n#endif\n",perturbation_frag:"#ifdef HAS_PERTURBATIONMAP\n  vec2 getScreenUv(){\n    return gl_FragCoord.xy / u_resolution;\n  }\n\n  vec4 screenColor = texture2D(u_perturbationSampler, getScreenUv() + normalize(u_viewMat * vec4(normal, 1.)).xy * vec2(u_perturbationUOffset, u_perturbationVOffset));\n  gl_FragColor = mix(screenColor, gl_FragColor, gl_FragColor.a);\n\n#endif\n",refraction_share:"#ifdef HAS_REFRACTIONMAP\n\n    uniform sampler2D u_refractionSampler;\n    uniform mat4 u_PTMMatrix;\n    uniform float u_refractionDepth;\n\n#endif\n",refraction_frag:"#ifdef HAS_REFRACTIONMAP\n  vec4 refractionColor = vec4(0.);\n  vec3 refractDir = normalize(refract(-geometry.viewDir, geometry.normal, u_refractionRatio));\n  vec3 newPos = v_pos + refractDir * u_refractionDepth;\n  vec4 projectionPos = u_PTMMatrix * u_projMat * u_viewMat * vec4(newPos, 1.0);\n  vec2 projectionUv = projectionPos.xy / projectionPos.w;\n  refractionColor = texture2D(u_refractionSampler, projectionUv);\n  gl_FragColor = mix(refractionColor, gl_FragColor, gl_FragColor.a);\n\n#endif\n",clipPlane_vert_define:"#ifdef O3_CLIPPLANE_NUM\n    uniform vec4 u_clipPlanes[O3_CLIPPLANE_NUM];\n    varying float v_clipDistances[O3_CLIPPLANE_NUM];\n#endif\n",clipPlane_vert:"#ifdef O3_CLIPPLANE_NUM\n    for(int i = 0; i < O3_CLIPPLANE_NUM; i++){\n        v_clipDistances[i] = dot(vec4(v_pos,1.0), u_clipPlanes[i]);\n    }\n#endif\n",clipPlane_frag_define:"#ifdef O3_CLIPPLANE_NUM\n    varying float v_clipDistances[O3_CLIPPLANE_NUM];\n#endif\n",clipPlane_frag:"#ifdef O3_CLIPPLANE_NUM\n    for(int i = 0; i < O3_CLIPPLANE_NUM; i++){\n        if(v_clipDistances[i] < 0.0){\n            discard;\n        }\n    }\n#endif\n",gamma_frag:"#ifdef GAMMA\n    float gamma = 2.2;\n    gl_FragColor.rgb = pow(gl_FragColor.rgb, vec3(1.0 / gamma));\n#endif\n",oit_frag:"#if defined(ALPHA_BLEND) && defined(OIT_ENABLE)\n    if(gl_FragCoord.z > texture2D(u_depthSampler, gl_FragCoord.xy / u_resolution).r){\n        discard;\n    }\n    vec4 oitColor = gl_FragColor;\n\n    // Bavoil and Myers’ Method\n    gl_FragData[0]= vec4(oitColor.rgb * oitColor.a, oitColor.a);\n    gl_FragData[1]= vec4(1)/ 255.0; // 兼容非浮点输出\n\n\n    // Depth Weights Improve Occlusion\n//    float w = weight(gl_FragCoord.z, oitColor.a);\n//    gl_FragData[0] = vec4(oitColor.rgb * oitColor.a * w, oitColor.a);\n//    gl_FragData[1].r =oitColor.a * w;\n#endif\n",oit_frag_define:"#if defined(ALPHA_BLEND) && defined(OIT_ENABLE)\n\n    uniform sampler2D u_depthSampler;\n\n    float weight(float z, float a) {\n        return a * clamp(3e3 * pow(1.0 - z, 3.0), 1e-2, 3e3);\n//          return pow(z,-5.0);\n    }\n#endif\n"},{pbr_common_frag_define:"#ifndef EPSILON\n#define EPSILON 1e-6\n#endif\n\n#ifndef RECIPROCAL_PI\n    #define RECIPROCAL_PI 0.31830988618\n#endif\n\n\n#define MAXIMUM_SPECULAR_COEFFICIENT 0.16\n#define DEFAULT_SPECULAR_COEFFICIENT 0.04\n\n#define RE_Direct\t\t\t\tRE_Direct_Physical\n#define RE_IndirectDiffuse\t\tRE_IndirectDiffuse_Physical\n#define RE_IndirectSpecular\t\tRE_IndirectSpecular_Physical\n\n#define Material_BlinnShininessExponent( material )   GGXRoughnessToBlinnExponent( material.specularRoughness )\n",pbr_util_frag_define:"vec4 SRGBtoLINEAR(vec4 srgbIn)\n{\n    #ifdef MANUAL_SRGB\n\n        #ifdef SRGB_FAST_APPROXIMATION\n\n            vec3 linOut = pow(srgbIn.xyz, vec3(2.2));\n        #else\n\n         vec3 bLess = step(vec3(0.04045), srgbIn.xyz);\n         vec3 linOut = mix(srgbIn.xyz/vec3(12.92), pow((srgbIn.xyz+vec3(0.055))/vec3(1.055), vec3(2.4)), bLess);\n\n        #endif\n\n    return vec4(linOut, srgbIn.w);;\n\n    #else\n\n    return srgbIn;\n\n    #endif\n}\n\nfloat pow2( const in float x ) {\n    return x * x;\n}\n\nvec3 inverseTransformDirection( in vec3 dir, in mat4 matrix ) {\n    return normalize( ( vec4( dir, 0.0 ) * matrix ).xyz );\n}\n\n// todo: enhance\nfloat punctualLightIntensityToIrradianceFactor( const in float lightDistance, const in float cutoffDistance, const in float decayExponent ) {\n\n    if( decayExponent > 0.0 ) {\n\n        #if defined ( PHYSICALLY_CORRECT_LIGHTS )\n\n        // based upon Frostbite 3 Moving to Physically-based Rendering\n        // page 32, equation 26: E[window1]\n        // https://seblagarde.files.wordpress.com/2015/07/course_notes_moving_frostbite_to_pbr_v32.pdf\n        // this is intended to be used on spot and point lights who are represented as luminous intensity\n        // but who must be converted to luminous irradiance for surface lighting calculation\n        float distanceFalloff = 1.0 / max( pow( lightDistance, decayExponent ), 0.01 );\n        float maxDistanceCutoffFactor = pow2( saturate( 1.0 - pow4( lightDistance / cutoffDistance ) ) );\n        return distanceFalloff * maxDistanceCutoffFactor;\n\n        #else\n\n        return pow( saturate( -lightDistance / cutoffDistance + 1.0 ), decayExponent );\n\n        #endif\n\n    }\n\n    return 1.0;\n\n}\n\nvec3 BRDF_Diffuse_Lambert( const in vec3 diffuseColor ) {\n\n\treturn RECIPROCAL_PI * diffuseColor;\n\n}\n\n// source: http://simonstechblog.blogspot.ca/2011/12/microfacet-brdf.html\nfloat GGXRoughnessToBlinnExponent( const in float ggxRoughness ) {\n    return ( 2.0 / pow2( ggxRoughness + 0.0001 ) - 2.0 );\n}\n\n\nfloat computeSpecularOcclusion( const in float dotNV, const in float ambientOcclusion, const in float roughness ) {\n\n    return saturate( pow( dotNV + ambientOcclusion, exp2( - 16.0 * roughness - 1.0 ) ) - 1.0 + ambientOcclusion );\n\n}\n\n// 亮度值\nfloat getLuminance(vec3 color)\n{\n    return dot(color, vec3(0.2126, 0.7152, 0.0722));\n}\n",pbr_envmap_light_frag_define:"#ifdef O3_HAS_ENVMAP_LIGHT\n\nstruct EnvMapLight {\n    vec3 diffuse;\n    vec3 specular;\n    float mipMapLevel;\n    float diffuseIntensity;\n    float specularIntensity;\n    mat3 transformMatrix;\n};\n\n\nuniform EnvMapLight u_envMapLight;\n\n#ifdef O3_USE_DIFFUSE_ENV\n    uniform samplerCube u_env_diffuseSampler;\n#endif\n\n#ifdef O3_USE_SPECULAR_ENV\n    uniform samplerCube u_env_specularSampler;\n#endif\n\n#endif\n",pbr_base_frag_define:"#ifdef ALPHA_MASK\nuniform float u_alphaCutoff;\n#endif\n\nuniform vec4 u_baseColorFactor;\nuniform vec2 u_metallicRoughnessValue;\nuniform vec3 u_specularFactor;\nuniform float u_glossinessFactor;\n\nuniform float u_envMapIntensity;\nuniform float u_refractionRatio;\n\nuniform vec2 u_resolution;\n\n// todo: delete\nuniform float u_normalScale;\nuniform float u_occlusionStrength;\n\n",pbr_texture_frag_define:"#ifdef HAS_BASECOLORMAP\n\nuniform sampler2D u_baseColorSampler;\n\n#endif\n\n#ifdef O3_HAS_NORMALMAP\n\nuniform sampler2D u_normalSampler;\n\n#endif\n\n#ifdef HAS_EMISSIVEMAP\n\nuniform sampler2D u_emissiveSampler;\nuniform vec3 u_emissiveFactor;\n\n#endif\n\n#ifdef HAS_METALMAP\n\nuniform sampler2D u_metallicSampler;\n\n#endif\n\n#ifdef HAS_ROUGHNESSMAP\n\nuniform sampler2D u_roughnessSampler;\n\n#endif\n\n#ifdef HAS_METALROUGHNESSMAP\n\nuniform sampler2D u_metallicRoughnessSampler;\n\n#endif\n\n\n#ifdef HAS_SPECULARGLOSSINESSMAP\n\nuniform sampler2D u_specularGlossinessSampler;\n\n#endif\n\n#ifdef HAS_OCCLUSIONMAP\n\nuniform sampler2D u_occlusionSampler;\n\n#endif\n\n#ifdef HAS_OPACITYMAP\n\nuniform sampler2D u_opacitySampler;\n\n#endif\n\n#ifdef HAS_REFLECTIONMAP\n\nuniform samplerCube u_reflectionSampler;\n\n#endif\n",pbr_runtime_frag_define:"struct IncidentLight {\n    vec3 color;\n    vec3 direction;\n    bool visible;\n};\nstruct ReflectedLight {\n    vec3 directDiffuse;\n    vec3 directSpecular;\n    vec3 indirectDiffuse;\n    vec3 indirectSpecular;\n};\nstruct GeometricContext {\n    vec3 position;\n    vec3 normal;\n    vec3 viewDir;\n};\nstruct PhysicalMaterial {\n    vec3    diffuseColor;\n    float   specularRoughness;\n    vec3    specularColor;\n};\n",pbr_normal_frag_define:"vec3 getNormal()\n{\n  #ifdef O3_HAS_NORMALMAP\n    #ifndef O3_HAS_TANGENT\n        #ifdef HAS_DERIVATIVES\n            vec3 pos_dx = dFdx(v_pos);\n            vec3 pos_dy = dFdy(v_pos);\n            vec3 tex_dx = dFdx(vec3(v_uv, 0.0));\n            vec3 tex_dy = dFdy(vec3(v_uv, 0.0));\n            vec3 t = (tex_dy.t * pos_dx - tex_dx.t * pos_dy) / (tex_dx.s * tex_dy.t - tex_dy.s * tex_dx.t);\n            #ifdef O3_HAS_NORMAL\n                vec3 ng = normalize(v_normal);\n            #else\n                vec3 ng = normalize( cross(pos_dx, pos_dy) );\n            #endif\n            t = normalize(t - ng * dot(ng, t));\n            vec3 b = normalize(cross(ng, t));\n            mat3 tbn = mat3(t, b, ng);\n        #else\n            #ifdef O3_HAS_NORMAL\n                vec3 ng = normalize(v_normal);\n            #else\n                vec3 ng = vec3(0.0, 0.0, 1.0);\n            #endif\n            mat3 tbn = mat3(vec3(0.0), vec3(0.0), ng);\n        #endif\n    #else\n        mat3 tbn = v_TBN;\n    #endif\n        vec3 n = texture2D(u_normalSampler, v_uv ).rgb;\n        n = normalize(tbn * ((2.0 * n - 1.0) * vec3(u_normalScale, u_normalScale, 1.0)));\n  #else\n    #ifdef O3_HAS_NORMAL\n        vec3 n = normalize(v_normal);\n    #elif defined(HAS_DERIVATIVES)\n        vec3 pos_dx = dFdx(v_pos);\n        vec3 pos_dy = dFdy(v_pos);\n        vec3 n = normalize( cross(pos_dx, pos_dy) );\n    #else\n        vec3 n= vec3(0.0,0.0,1.0);\n    #endif\n  #endif\n\n  n *= float( gl_FrontFacing ) * 2.0 - 1.0;\n\n  return n;\n}\n",pbr_brdf_cook_torrance_frag_define:"vec3 F_Schlick( const in vec3 specularColor, const in float dotLH ) {\n\n\t// Original approximation by Christophe Schlick '94\n\t// float fresnel = pow( 1.0 - dotLH, 5.0 );\n\n\t// Optimized variant (presented by Epic at SIGGRAPH '13)\n\t// https://cdn2.unrealengine.com/Resources/files/2013SiggraphPresentationsNotes-26915738.pdf\n\tfloat fresnel = exp2( ( -5.55473 * dotLH - 6.98316 ) * dotLH );\n\n\treturn ( 1.0 - specularColor ) * fresnel + specularColor;\n\n} // validated\n\n// Moving Frostbite to Physically Based Rendering 3.0 - page 12, listing 2\n// https://seblagarde.files.wordpress.com/2015/07/course_notes_moving_frostbite_to_pbr_v32.pdf\nfloat G_GGX_SmithCorrelated( const in float alpha, const in float dotNL, const in float dotNV ) {\n\n\tfloat a2 = pow2( alpha );\n\n\t// dotNL and dotNV are explicitly swapped. This is not a mistake.\n\tfloat gv = dotNL * sqrt( a2 + ( 1.0 - a2 ) * pow2( dotNV ) );\n\tfloat gl = dotNV * sqrt( a2 + ( 1.0 - a2 ) * pow2( dotNL ) );\n\n\treturn 0.5 / max( gv + gl, EPSILON );\n\n}\n\n// Microfacet Models for Refraction through Rough Surfaces - equation (33)\n// http://graphicrants.blogspot.com/2013/08/specular-brdf-reference.html\n// alpha is \"roughness squared\" in Disney’s reparameterization\nfloat D_GGX( const in float alpha, const in float dotNH ) {\n\n\tfloat a2 = pow2( alpha );\n\n\tfloat denom = pow2( dotNH ) * ( a2 - 1.0 ) + 1.0; // avoid alpha = 0 with dotNH = 1\n\n\treturn RECIPROCAL_PI * a2 / pow2( denom );\n\n}\n\n// GGX Distribution, Schlick Fresnel, GGX-Smith Visibility\nvec3 BRDF_Specular_GGX( const in IncidentLight incidentLight, const in GeometricContext geometry, const in vec3 specularColor, const in float roughness ) {\n\n\tfloat alpha = pow2( roughness ); // UE4's roughness\n\n\tvec3 halfDir = normalize( incidentLight.direction + geometry.viewDir );\n\n\tfloat dotNL = saturate( dot( geometry.normal, incidentLight.direction ) );\n\tfloat dotNV = saturate( dot( geometry.normal, geometry.viewDir ) );\n\tfloat dotNH = saturate( dot( geometry.normal, halfDir ) );\n\tfloat dotLH = saturate( dot( incidentLight.direction, halfDir ) );\n\n\tvec3 F = F_Schlick( specularColor, dotLH );\n\n\tfloat G = G_GGX_SmithCorrelated( alpha, dotNL, dotNV );\n\n\tfloat D = D_GGX( alpha, dotNH );\n\n\treturn F * ( G * D );\n\n} // validated\n",pbr_direct_irradiance_frag_define:"void RE_Direct_Physical( const in IncidentLight directLight, const in GeometricContext geometry, const in PhysicalMaterial material, inout ReflectedLight reflectedLight ) {\n\n    float dotNL = saturate( dot( geometry.normal, directLight.direction ) );\n\n    vec3 irradiance = dotNL * directLight.color;\n\n    #ifndef PHYSICALLY_CORRECT_LIGHTS\n\n        irradiance *= PI; // punctual light\n\n    #endif\n\n\n\n    reflectedLight.directSpecular += irradiance * BRDF_Specular_GGX( directLight, geometry, material.specularColor, material.specularRoughness );\n\n    reflectedLight.directDiffuse += irradiance * BRDF_Diffuse_Lambert( material.diffuseColor );\n\n}\n\n\n\n#ifdef O3_DIRECT_LIGHT_COUNT\n\n    void getDirectionalDirectLightIrradiance( const in DirectLight directionalLight, const in GeometricContext geometry, out IncidentLight directLight ) {\n        directLight.color = directionalLight.lightColor;\n        directLight.direction = -directionalLight.direction;\n        directLight.visible = true;\n    }\n\n#endif\n\n#ifdef O3_POINT_LIGHT_COUNT\n\n\t// directLight is an out parameter as having it as a return value caused compiler errors on some devices\n\tvoid getPointDirectLightIrradiance( const in PointLight pointLight, const in GeometricContext geometry, out IncidentLight directLight ) {\n\n\t\tvec3 lVector = pointLight.position - geometry.position;\n\t\tdirectLight.direction = normalize( lVector );\n\n\t\tfloat lightDistance = length( lVector );\n\n\t\tdirectLight.color = pointLight.lightColor;\n\t\tdirectLight.color *= punctualLightIntensityToIrradianceFactor( lightDistance, pointLight.distance, pointLight.decay );\n\t\tdirectLight.visible = ( directLight.color != vec3( 0.0 ) );\n\n\t}\n\n#endif\n\n#ifdef O3_SPOT_LIGHT_COUNT\n\n\t// directLight is an out parameter as having it as a return value caused compiler errors on some devices\n\tvoid getSpotDirectLightIrradiance( const in SpotLight spotLight, const in GeometricContext geometry, out IncidentLight directLight  ) {\n\n\t\tvec3 lVector = spotLight.position - geometry.position;\n\t\tdirectLight.direction = normalize( lVector );\n\n\t\tfloat lightDistance = length( lVector );\n\t\tfloat angleCos = dot( directLight.direction, spotLight.direction );\n\n\t\tif ( angleCos > spotLight.coneCos ) {\n\n\t\t\tfloat spotEffect = smoothstep( spotLight.coneCos, spotLight.penumbraCos, angleCos );\n\n\t\t\tdirectLight.color = spotLight.lightColor;\n\t\t\tdirectLight.color *= spotEffect * punctualLightIntensityToIrradianceFactor( lightDistance, spotLight.distance, spotLight.decay );\n\t\t\tdirectLight.visible = true;\n\n\t\t} else {\n\n\t\t\tdirectLight.color = vec3( 0.0 );\n\t\t\tdirectLight.visible = false;\n\n\t\t}\n\t}\n\n\n#endif\n",pbr_ibl_specular_frag_define:"// ref: https://www.unrealengine.com/blog/physically-based-shading-on-mobile - environmentBRDF for GGX on mobile\nvec3 BRDF_Specular_GGX_Environment( const in GeometricContext geometry, const in vec3 specularColor, const in float roughness ) {\n\n    float dotNV = saturate( dot( geometry.normal, geometry.viewDir ) );\n\n    const vec4 c0 = vec4( - 1, - 0.0275, - 0.572, 0.022 );\n\n    const vec4 c1 = vec4( 1, 0.0425, 1.04, - 0.04 );\n\n    vec4 r = roughness * c0 + c1;\n\n    float a004 = min( r.x * r.x, exp2( - 9.28 * dotNV ) ) * r.x + r.y;\n\n    vec2 AB = vec2( -1.04, 1.04 ) * a004 + r.zw;\n\n    return specularColor * AB.x + AB.y;\n\n} // validated\n\n\n// taken from here: http://casual-effects.blogspot.ca/2011/08/plausible-environment-lighting-in-two.html\nfloat getSpecularMIPLevel( const in float blinnShininessExponent, const in int maxMIPLevel ) {\n\n    //float envMapWidth = pow( 2.0, maxMIPLevelScalar );\n    //float desiredMIPLevel = log2( envMapWidth * sqrt( 3.0 ) ) - 0.5 * log2( pow2( blinnShininessExponent ) + 1.0 );\n\n    float maxMIPLevelScalar = float( maxMIPLevel );\n    float desiredMIPLevel = maxMIPLevelScalar + 0.79248 - 0.5 * log2( pow2( blinnShininessExponent ) + 1.0 );\n\n    // clamp to allowable LOD ranges.\n    return clamp( desiredMIPLevel, 0.0, maxMIPLevelScalar );\n\n}\n\n#ifdef O3_HAS_ENVMAP_LIGHT\n\nvec3 getLightProbeIndirectRadiance( /*const in SpecularLightProbe specularLightProbe,*/ const in GeometricContext geometry, const in float blinnShininessExponent, const in int maxMIPLevel ) {\n\n    #if !defined(O3_USE_SPECULAR_ENV) && !defined(HAS_REFLECTIONMAP)\n\n        return u_envMapLight.specular * u_envMapLight.specularIntensity * u_envMapIntensity;\n\n    #else\n\n    #ifdef ENVMAPMODE_REFRACT\n\n        vec3 reflectVec = refract( -geometry.viewDir, geometry.normal, u_refractionRatio );\n\n    #else\n\n        vec3 reflectVec = reflect( -geometry.viewDir, geometry.normal );\n\n    #endif\n//        reflectVec = inverseTransformDirection( reflectVec, u_viewMat );\n\n        reflectVec =  u_envMapLight.transformMatrix * reflectVec;\n\n        float specularMIPLevel = getSpecularMIPLevel( blinnShininessExponent, maxMIPLevel );\n\n        #ifdef HAS_TEX_LOD\n            #ifdef HAS_REFLECTIONMAP\n                 vec4 envMapColor = textureCubeLodEXT( u_reflectionSampler, reflectVec, specularMIPLevel );\n            #else\n                vec4 envMapColor = textureCubeLodEXT( u_env_specularSampler, reflectVec, specularMIPLevel );\n            #endif\n\n        #else\n            #ifdef HAS_REFLECTIONMAP\n                 vec4 envMapColor = textureCube( u_reflectionSampler, reflectVec, specularMIPLevel );\n            #else\n                 vec4 envMapColor = textureCube( u_env_specularSampler, reflectVec, specularMIPLevel );\n            #endif\n        #endif\n\n        envMapColor.rgb = SRGBtoLINEAR( envMapColor * u_envMapLight.specularIntensity * u_envMapIntensity).rgb;\n\n        return envMapColor.rgb;\n\n    #endif\n\n}\n#endif\n\nvoid RE_IndirectSpecular_Physical( const in vec3 radiance, const in GeometricContext geometry, const in PhysicalMaterial material, inout ReflectedLight reflectedLight ) {\n\n    float dotNV = saturate( dot( geometry.normal, geometry.viewDir ) );\n    float dotNL = dotNV;\n\n\treflectedLight.indirectSpecular += radiance * BRDF_Specular_GGX_Environment( geometry, material.specularColor, material.specularRoughness );\n\n}\n",pbr_ibl_diffuse_frag_define:"void RE_IndirectDiffuse_Physical( const in vec3 irradiance, const in GeometricContext geometry, const in PhysicalMaterial material, inout ReflectedLight reflectedLight ) {\n\n    reflectedLight.indirectDiffuse += irradiance * BRDF_Diffuse_Lambert( material.diffuseColor );\n\n}\n\n#ifdef O3_HAS_AMBIENT_LIGHT\n\nvec3 getAmbientLightIrradiance( const in vec3 ambientLightColor ) {\n\n    vec3 irradiance = ambientLightColor;\n\n    #ifndef PHYSICALLY_CORRECT_LIGHTS\n\n        irradiance *= PI;\n\n    #endif\n\n    return irradiance;\n\n}\n\n#endif\n",pbr_begin_frag:"    vec3 normal = getNormal();\n    vec4 diffuseColor = u_baseColorFactor;\n    vec3 totalEmissiveRadiance = vec3(0.0);\n    float metalnessFactor = u_metallicRoughnessValue.r;\n    float roughnessFactor = u_metallicRoughnessValue.g;\n    vec3 specularFactor = u_specularFactor;\n    float glossinessFactor = u_glossinessFactor;\n\n    ReflectedLight reflectedLight = ReflectedLight( vec3( 0.0 ), vec3( 0.0 ), vec3( 0.0 ), vec3( 0.0 ) );\n    PhysicalMaterial material;\n    GeometricContext geometry;\n    IncidentLight directLight;\n\n    #ifdef HAS_BASECOLORMAP\n\n        vec4 baseMapColor = texture2D( u_baseColorSampler, v_uv );\n        baseMapColor = SRGBtoLINEAR( baseMapColor );\n        diffuseColor *= baseMapColor;\n\n    #endif\n\n    #ifdef O3_HAS_VERTEXCOLOR\n\n        diffuseColor.rgb *= v_color.rgb;\n\n        #ifdef O3_HAS_VERTEXALPHA\n\n            diffuseColor.a *= v_color.a;\n\n        #endif\n\n    #endif\n\n    #ifdef ALPHA_MASK\n\n        if( diffuseColor.a < u_alphaCutoff ) {\n            discard;\n        }\n\n    #endif\n\n\n    #if defined(ALPHA_BLEND) && defined(HAS_OPACITYMAP)\n\n        #ifdef GETOPACITYFROMRGB\n            diffuseColor.a *= getLuminance(texture2D( u_opacitySampler, v_uv ).rgb);\n        #else\n            diffuseColor.a *= texture2D( u_opacitySampler, v_uv ).a;\n        #endif\n\n    #endif\n\n    #ifdef UNLIT\n\n        gl_FragColor = vec4( diffuseColor.rgb, diffuseColor.a );\n\n    #else\n\n\n\n        #ifdef HAS_METALROUGHNESSMAP\n\n            vec4 metalRoughMapColor = texture2D( u_metallicRoughnessSampler, v_uv );\n            metalnessFactor *= metalRoughMapColor.b;\n            roughnessFactor *= metalRoughMapColor.g;\n\n        #else\n            #ifdef HAS_METALMAP\n\n            vec4 metalMapColor = texture2D( u_metallicSampler, v_uv );\n            metalnessFactor *= metalMapColor.b;\n\n            #endif\n\n            #ifdef HAS_ROUGHNESSMAP\n\n            vec4 roughMapColor = texture2D( u_roughnessSampler, v_uv );\n            roughnessFactor *= roughMapColor.g;\n\n            #endif\n        #endif\n\n        #ifdef HAS_SPECULARGLOSSINESSMAP\n\n            vec4 specularGlossinessColor = texture2D(u_specularGlossinessSampler, v_uv );\n            specularFactor *= specularGlossinessColor.rgb;\n            glossinessFactor *= specularGlossinessColor.a;\n\n        #endif\n\n\n        #ifdef IS_METALLIC_WORKFLOW\n            material.diffuseColor = diffuseColor.rgb * ( 1.0 - metalnessFactor );\n            material.specularRoughness = clamp( roughnessFactor, 0.04, 1.0 );\n//          material.specularColor = mix( vec3( DEFAULT_SPECULAR_COEFFICIENT ), diffuseColor.rgb, metalnessFactor );\n            material.specularColor = mix( vec3( MAXIMUM_SPECULAR_COEFFICIENT /* pow2( reflectivity )*/ ), diffuseColor.rgb, metalnessFactor );\n        #else\n            float specularStrength = max( max( specularFactor.r, specularFactor.g ), specularFactor.b );\n            material.diffuseColor = diffuseColor.rgb * ( 1.0 - specularStrength );\n            material.specularRoughness = clamp( 1.0 - glossinessFactor, 0.04, 1.0 );\n            material.specularColor = specularFactor;\n        #endif\n\n        geometry.position = v_pos;\n        geometry.normal = normal;\n        geometry.viewDir = normalize( u_cameraPos - v_pos );\n",pbr_direct_irradiance_frag:"        #if defined( O3_DIRECT_LIGHT_COUNT ) && defined( RE_Direct )\n\n            DirectLight directionalLight;\n\n            for ( int i = 0; i < O3_DIRECT_LIGHT_COUNT; i ++ ) {\n\n                directionalLight = u_directLights[ i ];\n\n                getDirectionalDirectLightIrradiance( directionalLight, geometry, directLight );\n\n                RE_Direct( directLight, geometry, material, reflectedLight );\n\n            }\n\n        #endif\n\n        #if defined( O3_POINT_LIGHT_COUNT ) && defined( RE_Direct )\n\n            PointLight pointLight;\n\n            for ( int i = 0; i < O3_POINT_LIGHT_COUNT; i ++ ) {\n\n                pointLight = u_pointLights[ i ];\n\n                getPointDirectLightIrradiance( pointLight, geometry, directLight );\n\n                RE_Direct( directLight, geometry, material, reflectedLight );\n\n            }\n\n        #endif\n\n        #if defined( O3_SPOT_LIGHT_COUNT ) && defined( RE_Direct )\n\n            SpotLight spotLight;\n\n            for ( int i = 0; i < O3_SPOT_LIGHT_COUNT; i ++ ) {\n\n                spotLight = u_spotLights[ i ];\n\n                getSpotDirectLightIrradiance( spotLight, geometry, directLight );\n\n                RE_Direct( directLight, geometry, material, reflectedLight );\n\n            }\n\n        #endif\n",pbr_ibl_diffuse_frag:"#if defined(RE_IndirectDiffuse)\n\n    vec3 irradiance = vec3(0);\n\n    #if defined(O3_HAS_AMBIENT_LIGHT)\n        irradiance += getAmbientLightIrradiance(u_ambientLight.lightColor);\n    #endif\n\n    #if defined(O3_HAS_ENVMAP_LIGHT)\n\n        #ifdef O3_USE_DIFFUSE_ENV\n            vec3 lightMapIrradiance = textureCube(u_env_diffuseSampler, geometry.normal).rgb * u_envMapLight.diffuseIntensity;\n        #else\n            vec3 lightMapIrradiance = u_envMapLight.diffuse * u_envMapLight.diffuseIntensity;\n        #endif\n\n        #ifndef PHYSICALLY_CORRECT_LIGHTS\n            lightMapIrradiance *= PI;\n        #endif\n\n        irradiance += lightMapIrradiance;\n\n    #endif\n\n    RE_IndirectDiffuse( irradiance, geometry, material, reflectedLight );\n\n#endif\n\n\n",pbr_ibl_specular_frag:"#if defined( RE_IndirectSpecular )\n\n    vec3 radiance = vec3( 0.0 );\n\n#endif\n\n\n\n#if defined( O3_HAS_ENVMAP_LIGHT ) && defined( RE_IndirectSpecular )\n\n    radiance += getLightProbeIndirectRadiance( geometry, Material_BlinnShininessExponent( material ), int(u_envMapLight.mipMapLevel) );\n\n#endif\n\n\n#if defined( RE_IndirectSpecular )\n\n    RE_IndirectSpecular( radiance, geometry, material, reflectedLight );\n\n#endif\n",pbr_end_frag:"#ifdef HAS_OCCLUSIONMAP\n\n    float ambientOcclusion = (texture2D(u_occlusionSampler, v_uv).r - 1.0) * u_occlusionStrength + 1.0;\n    reflectedLight.indirectDiffuse *= ambientOcclusion;\n\n    #if defined(O3_USE_SPECULAR_ENV)\n\n        float dotNV = saturate(dot(geometry.normal, geometry.viewDir));\n        reflectedLight.indirectSpecular *= computeSpecularOcclusion(dotNV, ambientOcclusion, material.specularRoughness);\n\n    #endif\n\n#endif\n\n#ifdef HAS_EMISSIVEMAP\n\n    vec4 emissiveMapColor = texture2D(u_emissiveSampler, v_uv);\n    emissiveMapColor = SRGBtoLINEAR(emissiveMapColor);\n    totalEmissiveRadiance += u_emissiveFactor * emissiveMapColor.rgb;\n\n#endif\n\nvec3 outgoingLight = reflectedLight.directDiffuse + reflectedLight.indirectDiffuse + reflectedLight.directSpecular + reflectedLight.indirectSpecular + totalEmissiveRadiance;\ngl_FragColor = vec4(outgoingLight, diffuseColor.a);\n\n#endif\n"});var Fn,kn=function(){function e(){n(this,e)}return r(e,null,[{key:"parseVersion",value:function(){var e=arguments.length>0&&void 0!==arguments[0]?arguments[0]:"100";return"#version ".concat(e,"\n")}},{key:"parsePrecision",value:function(e,t,n){var i="mediump";return"\n        #ifdef GL_FRAGMENT_PRECISION_HIGH\n          precision ".concat(n?e:t," float;\n          precision ").concat(n?e:t," int;\n\n          #define O3_VERTEX_PRECISION ").concat(e,"\n          #define O3_FRAGMENT_PRECISION ").concat(t,"\n        #else\n          precision ").concat(i," float;\n          precision ").concat(i," int;\n\n          #define O3_VERTEX_PRECISION ").concat(i,"\n          #define O3_FRAGMENT_PRECISION ").concat(i,"\n        #endif\n      ")}},{key:"parseShaderName",value:function(e){return"#define O3_SHADER_NAME ".concat(e,"\n")}},{key:"parseAttributeMacros",value:function(e){return"#define O3_ATTRIBUTE_MACROS_START\n"+e.map((function(e){return"#define ".concat(e,"\n")})).join("")+"#define O3_ATTRIBUTE_MACROS_END\n"}},{key:"parseCustomMacros",value:function(e){return"#define O3_CUSTOM_MACROS_START\n"+e.map((function(e){return"#define ".concat(e,"\n")})).join("")+"#define O3_CUSTOM_MACROS_END\n"}},{key:"parseShader",value:function(t){return e.parseIncludes(t)}},{key:"parseIncludes",value:function(t){return t.replace(/^[ \t]*#include +<([\w\d.]+)>/gm,(function(t,n){var i=On[n];return void 0===i?(Le.error('Shader slice "'.concat(t.trim(),'" not founded.')),""):e.parseIncludes(i)}))}},{key:"InjectShaderSlices",value:function(e){o(On,e)}},{key:"parseExtension",value:function(e){return"#define O3_EXTENSION_START\n"+e.map((function(e){return"#extension ".concat(e," : enable\n")})).join("")+"#define O3_EXTENSION_END\n"}},{key:"convertTo300",value:function(e,t){if(e.includes("#version 300 es"))return e;if(e=(e=(e=(e=(e=e.replace(/#version 100/,"#version 300 es")).replace(/\battribute\b/g,"in")).replace(/\bvarying\b/g,t?"in":"out")).replace(/\btexture(2D|Cube)\s*\(/g,"texture(")).replace(/\btexture(2D|Cube)LodEXT\s*\(/g,"textureLod("),t)if(/\bgl_FragData\[.+?\]/g.test(e)){var n=(e=e.replace(/\bgl_FragColor\b/g,"gl_FragData[0]")).match(/\bgl_FragData\[.+?\]/g);e=this.replaceMRTShader(e,n)}else e=(e=e.replace(/void\s+?main\s*\(/g,"out vec4 glFragColor;\nvoid main(")).replace(/\bgl_FragColor\b/g,"glFragColor");return e}},{key:"getMaxDrawBuffers",value:function(e){for(var t=new Set,n=e.match(/\bgl_FragData\[.+?\]/g)||[],i=0;i<n.length;i++){var r=n[i].match(/\bgl_FragData\[(.+?)\]/);t.add(r[1])}return t.size}},{key:"compatible",value:function(e){return/\bgl_FragData\[.+?\]/g.test(e)&&(e=e.replace(/\bgl_FragColor\b/g,"gl_FragData[0]")),e}},{key:"replaceMRTShader",value:function(e,t){for(var n="",i=new Set,r=0;r<t.length;r++){var a=t[r].match(/\bgl_FragData\[(.+?)\]/);i.add(a[1])}return i.forEach((function(e){n+="layout(location=".concat(e,") out vec4 fragOutColor").concat(e,";\n")})),n+="void main(",e=(e=e.replace(/\bgl_FragData\[(.+?)\]/g,"fragOutColor$1")).replace(/void\s+?main\s*\(/g,n)}}]),e}(),In=function(t){l(a,t);var i=m(a);function a(e){var t;return n(this,a),(t=i.call(this,null)).name=e,t.isValid=!1,t._uniforms=a.commonUniforms,t._attributes=a.commonAttributes,t.states=null,t.vertexShader="",t.fragmentShader="",t.version="100",t.autoConvert=!0,t.vertexPrecision="highp",t.fragmentPrecision="mediump",t.customMacros=[],t.shaderExtension100=["GL_EXT_shader_texture_lod","GL_OES_standard_derivatives","GL_EXT_draw_buffers"],t.shaderExtension300=[],t._needCompile=!0,t}return r(a,[{key:"compile",value:function(e,t,n,i){if(this.parseFog(e),this._needCompile){var r,a,o=e.engine._hardwareRenderer,s=null==o?void 0:o.isWebGL2;null===(r=i.preCompile)||void 0===r||r.call(i,this);var u=this.getAttributeDefines(e,t,n,i);if(this._recreateHeader&&(this.attributes=this.attributes,this.uniforms=this.uniforms),this._vsHeader&&!this._recreateHeader||(this._vsHeader=kn.parseVersion(this.version)+kn.parseShaderName((this.name||"VOID").toUpperCase()+"_VERT")+"\n"+kn.parsePrecision(this.vertexPrecision,this.fragmentPrecision,!0)+"\n"+kn.parseAttributeMacros(u)+"\n"+kn.parseCustomMacros(this.customMacros)+"\n"),this._vsCode||(this._vsCode=kn.parseShader(this.vertexShader)),this.vertexShader=this._vsHeader+this._vsCode,this._fsHeader&&!this._recreateHeader||(this._fsHeader=kn.parseVersion(this.version)+kn.parseShaderName((this.name||"VOID").toUpperCase()+"_FRAG")+"\n"+kn.parseExtension(s?this.shaderExtension300:this.shaderExtension100)+kn.parsePrecision(this.vertexPrecision,this.fragmentPrecision)+"\n"+kn.parseAttributeMacros(u)+"\n"+kn.parseCustomMacros(this.customMacros)+"\n"),this._fsCode||(this._fsCode=kn.parseShader(this.fragmentShader)),this.fragmentShader=this._fsHeader+this._fsCode,this.autoConvert&&s&&"300 es"!==this.version){var l=o.capability.maxDrawBuffers;kn.getMaxDrawBuffers(this.fragmentShader)<=l&&(this.vertexShader=kn.convertTo300(this.vertexShader),this.fragmentShader=kn.convertTo300(this.fragmentShader,!0))}else s||"300es"===this.version||(this.fragmentShader=kn.compatible(this.fragmentShader));this._needCompile=!1,this._recreateHeader=!1,null===(a=i.postCompile)||void 0===a||a.call(i,this)}}},{key:"getAttributeDefines",value:function(t,n,i,r){var a=t.scene.engine._hardwareRenderer,o=a.gl,s=[];if(!i)return s;var u,l=Object.keys(i._vertexElementMap);if((l.indexOf("TEXCOORD_0")>-1&&s.push("O3_HAS_UV"),l.indexOf("NORMAL")>-1&&s.push("O3_HAS_NORMAL"),l.indexOf("TANGENT")>-1&&s.push("O3_HAS_TANGENT"),l.indexOf("JOINTS_0")>-1)&&(s.push("O3_HAS_SKIN"),null!==(u=n.jointNodes)&&void 0!==u&&u.length)){var c=a.renderStates.getParameter(o.MAX_VERTEX_UNIFORM_VECTORS),h=Math.floor((c-20)/4),d=n.jointNodes.length;d>h?a.canIUseMoreJoints?s.push("O3_USE_JOINT_TEXTURE"):Le.error("component's joints count(".concat(d,") greater than device's MAX_VERTEX_UNIFORM_VECTORS number ").concat(c,", suggest joint count less than ").concat(h,"."),n):r.maxJointsNum>0&&s.push("O3_JOINTS_NUM ".concat(r.maxJointsNum))}l.indexOf("COLOR_0")>-1&&(s.push("O3_HAS_VERTEXCOLOR"),i._vertexElementMap.COLOR_0.format===e.VertexElementFormat.Vector4&&s.push("O3_HAS_VERTEXALPHA"));var f=t.scene;return f.hasFogFeature&&s.push.apply(s,x(f.getFogMacro())),s}},{key:"parseFog",value:function(e){var t=e.scene;if(t.hasFogFeature){var n=t.getFogMacro();this._fogMacro!==n&&(this._needCompile=!0,this._recreateHeader=!0,this._fogMacro=n)}}},{key:"createMorphConfig",value:function(t,n){for(var i=Object.keys(t._vertexElementMap),r={},a=0;a<n;a++)i.indexOf("POSITION_".concat(a))>-1&&(r["a_position".concat(a)]={name:"a_position".concat(a),semantic:"POSITION_".concat(a),type:e.DataType.FLOAT_VEC3}),i.indexOf("NORMAL_".concat(a))>-1&&(r["a_normal".concat(a)]={name:"a_normal".concat(a),semantic:"NORMAL_".concat(a),type:e.DataType.FLOAT_VEC3}),i.indexOf("TANGENT_".concat(a))>-1&&(r["a_tangent".concat(a)]={name:"a_tangent".concat(a),semantic:"TANGENT_".concat(a),type:e.DataType.FLOAT_VEC3});return r}},{key:"_finalize",value:function(){this._glTechnique&&(this._glTechnique.finalize(!0),this._glTechnique=null)}},{key:"attributes",get:function(){return this._attributes},set:function(e){this._attributes=o({},a.commonAttributes,e)}},{key:"uniforms",get:function(){return this._uniforms},set:function(e){this._uniforms=o({},a.commonUniforms,e)}}]),a}(nt);In.commonAttributes={a_position:{name:"a_position",semantic:"POSITION",type:e.DataType.FLOAT_VEC3},a_uv:{name:"a_uv",semantic:"TEXCOORD_0",type:e.DataType.FLOAT_VEC2},a_normal:{name:"a_noraml",semantic:"NORMAL",type:e.DataType.FLOAT_VEC3},a_tangent:{name:"a_tangent",semantic:"TANGENT",type:e.DataType.FLOAT_VEC4},a_color:{name:"a_color",semantic:"COLOR_0",type:e.DataType.FLOAT_VEC4},a_joint:{name:"a_joint",semantic:"JOINTS_0",type:e.DataType.FLOAT_VEC4},a_weight:{name:"a_weight",semantic:"WEIGHTS_0",type:e.DataType.FLOAT_VEC4}},In.commonUniforms={u_localMat:{name:"u_localMat",semantic:e.UniformSemantic.LOCAL,type:e.DataType.FLOAT_MAT4},u_modelMat:{name:"u_modelMat",semantic:e.UniformSemantic.MODEL,type:e.DataType.FLOAT_MAT4},u_viewMat:{name:"u_viewMat",semantic:e.UniformSemantic.VIEW,type:e.DataType.FLOAT_MAT4},u_projMat:{name:"u_projMat",semantic:e.UniformSemantic.PROJECTION,type:e.DataType.FLOAT_MAT4},u_MVMat:{name:"u_MVMat",semantic:e.UniformSemantic.MODELVIEW,type:e.DataType.FLOAT_MAT4},u_MVPMat:{name:"u_MVPMat",semantic:e.UniformSemantic.MODELVIEWPROJECTION,type:e.DataType.FLOAT_MAT4},u_normalMat:{name:"u_normalMat",semantic:e.UniformSemantic.MODELINVERSETRANSPOSE,type:e.DataType.FLOAT_MAT3},u_cameraPos:{name:"u_cameraPos",type:e.DataType.FLOAT_VEC3,semantic:e.UniformSemantic.EYEPOS},u_time:{name:"u_time",type:e.DataType.FLOAT,semantic:e.UniformSemantic.TIME},u_jointMatrix:{name:"u_jointMatrix",semantic:e.UniformSemantic.JOINTMATRIX,type:e.DataType.FLOAT_MAT4_ARRAY},u_jointSampler:{name:"u_jointSampler",semantic:e.UniformSemantic.JOINTTEXTURE,type:e.DataType.SAMPLER_2D},u_jointCount:{name:"u_jointCount",semantic:e.UniformSemantic.JOINTCOUNT,type:e.DataType.FLOAT},u_fogColor:{name:"u_fogColor",type:e.DataType.FLOAT_VEC3},u_fogDensity:{name:"u_fogDensity",type:e.DataType.FLOAT},u_fogNear:{name:"u_fogNear",type:e.DataType.FLOAT},u_fogFar:{name:"u_fogFar",type:e.DataType.FLOAT}},(Fn=e.TextureCubeFace||(e.TextureCubeFace={}))[Fn.PositiveX=0]="PositiveX",Fn[Fn.NegativeX=1]="NegativeX",Fn[Fn.PositiveY=2]="PositiveY",Fn[Fn.NegativeY=3]="NegativeY",Fn[Fn.PositiveZ=4]="PositiveZ",Fn[Fn.NegativeZ=5]="NegativeZ";var Dn,Nn,Bn,zn,Gn,Un=function(t){l(a,t);var i=m(a);function a(t,r){var o,s=arguments.length>2&&void 0!==arguments[2]?arguments[2]:e.TextureFormat.R8G8B8A8,u=!(arguments.length>3&&void 0!==arguments[3])||arguments[3];n(this,a),(o=i.call(this,t))._compressedFaceFilled=[0,0,0,0,0,0];var l=t._hardwareRenderer,c=l.gl,h=l.isWebGL2;if(!cn._supportTextureFormat(s,l))throw new Error("Texture format is not supported:".concat(e.TextureFormat[s]));!u||h||cn._isPowerOf2(r)||(Le.warn("non-power-2 texture is not supported for mipmap in WebGL1,and has automatically downgraded to non-mipmap"),u=!1);var d=cn._getFormatDetail(s,c,h);return o._glTexture=c.createTexture(),o._formatDetail=d,o._rhi=l,o._target=c.TEXTURE_CUBE_MAP,o._mipmap=u,o._width=r,o._height=r,o._format=s,o._mipmapCount=o._getMipmapCount(),d.isCompressed&&!h||o._initMipmap(!0),o.filterMode=e.TextureFilterMode.Bilinear,o.wrapModeU=o.wrapModeV=e.TextureWrapMode.Clamp,o}return r(a,[{key:"setPixelBuffer",value:function(e,t){var n=arguments.length>2&&void 0!==arguments[2]?arguments[2]:0,i=arguments.length>3?arguments[3]:void 0,r=arguments.length>4?arguments[4]:void 0,a=arguments.length>5?arguments[5]:void 0,o=arguments.length>6?arguments[6]:void 0,s=this._rhi.gl,u=this._rhi.isWebGL2,l=this._formatDetail,c=l.internalFormat,h=l.baseFormat,d=l.dataType,f=l.isCompressed,_=Math.max(1,this._width>>n);if(i=i||0,r=r||0,a=a||_-i,o=o||_-r,this._bind(),s.pixelStorei(s.UNPACK_FLIP_Y_WEBGL,0),s.pixelStorei(s.UNPACK_PREMULTIPLY_ALPHA_WEBGL,0),f){var p=1<<n;u||this._compressedFaceFilled[e]&p?s.compressedTexSubImage2D(s.TEXTURE_CUBE_MAP_POSITIVE_X+e,n,i,r,a,o,c,t):(s.compressedTexImage2D(s.TEXTURE_CUBE_MAP_POSITIVE_X+e,n,c,a,o,0,t),this._compressedFaceFilled[e]|=p)}else s.texSubImage2D(s.TEXTURE_CUBE_MAP_POSITIVE_X+e,n,i,r,a,o,h,d,t);this._unbind()}},{key:"setImageSource",value:function(e,t){var n=arguments.length>2&&void 0!==arguments[2]?arguments[2]:0,i=arguments.length>3&&void 0!==arguments[3]&&arguments[3],r=arguments.length>4&&void 0!==arguments[4]&&arguments[4],a=arguments.length>5?arguments[5]:void 0,o=arguments.length>6?arguments[6]:void 0,s=this._rhi.gl,u=this._formatDetail,l=u.baseFormat,c=u.dataType;this._bind(),s.pixelStorei(s.UNPACK_FLIP_Y_WEBGL,+i),s.pixelStorei(s.UNPACK_PREMULTIPLY_ALPHA_WEBGL,+r),s.texSubImage2D(s.TEXTURE_CUBE_MAP_POSITIVE_X+e,n,a||0,o||0,l,c,t),this._unbind()}},{key:"getPixelBuffer",value:function(e,t,n,i,r,o){if(this._formatDetail.isCompressed)throw new Error("Unable to read compressed texture");g(c(a.prototype),"_getPixelBuffer",this).call(this,e,t,n,i,r,o)}},{key:"format",get:function(){return this._format}}]),a}(cn),Vn=function(t){l(a,t);var i=m(a);function a(t,r,o){var s,u=arguments.length>3&&void 0!==arguments[3]?arguments[3]:e.RenderBufferDepthFormat.Depth,l=arguments.length>4&&void 0!==arguments[4]&&arguments[4],c=arguments.length>5&&void 0!==arguments[5]&&arguments[5];n(this,a),(s=i.call(this,t))._isCube=!1,s._autoMipmap=!1;var h=t._hardwareRenderer,d=h.gl,f=h.isWebGL2;if(!cn._supportRenderBufferDepthFormat(u,h,!0))throw new Error("RenderBufferDepthFormat is not supported:".concat(e.RenderBufferDepthFormat[u]));if(c&&r!==o)throw new Error("The cube texture must have the same width and height");return!l||f||cn._isPowerOf2(r)&&cn._isPowerOf2(o)||(Le.warn("non-power-2 texture is not supported for mipmap in WebGL1,and has automatically downgraded to non-mipmap"),l=!1),s._glTexture=d.createTexture(),s._formatDetail=cn._getRenderBufferDepthFormatDetail(u,d,f),s._isCube=c,s._rhi=h,s._target=c?d.TEXTURE_CUBE_MAP:d.TEXTURE_2D,s._mipmap=l,s._width=r,s._height=o,s._format=u,s._mipmapCount=s._getMipmapCount(),s._initMipmap(c),s.filterMode=e.TextureFilterMode.Bilinear,s.wrapModeU=s.wrapModeV=e.TextureWrapMode.Clamp,s}return r(a,[{key:"format",get:function(){return this._format}},{key:"autoGenerateMipmaps",get:function(){return this._autoMipmap},set:function(e){this._autoMipmap=e}}]),a}(cn),Hn=function(t){l(a,t);var i=m(a);function a(t,r,o,s){var u,l=arguments.length>4&&void 0!==arguments[4]?arguments[4]:e.RenderBufferDepthFormat.Depth,c=arguments.length>5&&void 0!==arguments[5]?arguments[5]:1;n(this,a),(u=i.call(this,t))._MSAAColorRenderBuffers=[];var h=t._hardwareRenderer,d=h.gl;if(!(l instanceof Vn||cn._supportRenderBufferDepthFormat(l,h,!1)))throw new Error("RenderBufferDepthFormat is not supported:".concat(e.RenderBufferDepthFormat[l]));if((null==s?void 0:s.length)>1&&!h.canIUse(e.GLCapabilityType.drawBuffers))throw new Error("MRT is not supported");if(u._colorTextures=s?s instanceof Array?s.slice():[s]:[],u._colorTextures.some((function(e){return e.width!==r||e.height!==o})))throw new Error("RenderColorTexture's size must as same as RenderTarget");if(l instanceof Vn&&(l.width!==r||l.height!==o))throw new Error("RenderDepthTexture's size must as same as RenderTarget");if(u._colorTextures.length>1&&u._colorTextures.some((function(e){return e._isCube})))throw new Error("MRT+Cube+[,MSAA] is not supported");var f=h.capability.maxAntiAliasing;return c>f&&(Le.warn("MSAA antiAliasing exceeds the limit and is automatically downgraded to:".concat(f)),c=f),u._rhi=h,u._width=r,u._height=o,u._frameBuffer=d.createFramebuffer(),u._antiAliasing=c,l instanceof Vn&&(u._depthTexture=l),u._bindMainFBO(l),c>1&&(u._MSAAFrameBuffer=d.createFramebuffer(),u._bindMSAAFBO(l)),u}return r(a,[{key:"getColorTexture",value:function(){var e=arguments.length>0&&void 0!==arguments[0]?arguments[0]:0;return this._colorTextures[e]}},{key:"destroy",value:function(){var e=this._rhi.gl;e.deleteFramebuffer(this._frameBuffer),this._depthRenderBuffer&&e.deleteRenderbuffer(this._depthRenderBuffer),this._MSAAFrameBuffer&&e.deleteFramebuffer(this._MSAAFrameBuffer),this._MSAADepthRenderBuffer&&e.deleteRenderbuffer(this._MSAADepthRenderBuffer);for(var t=0;t<this._colorTextures.length;t++)this._colorTextures[t].destroy();for(var n=0;n<this._MSAAColorRenderBuffers.length;n++)e.deleteRenderbuffer(this._MSAAColorRenderBuffers[n]);this._depthTexture&&this._depthTexture.destroy(),this._frameBuffer=null,this._colorTextures.length=0,this._depthTexture=null,this._depthRenderBuffer=null,this._MSAAFrameBuffer=null,this._MSAAColorRenderBuffers.length=0,this._MSAADepthRenderBuffer=null}},{key:"_activeRenderTarget",value:function(){var e=this._rhi.gl;this._MSAAFrameBuffer?e.bindFramebuffer(e.FRAMEBUFFER,this._MSAAFrameBuffer):e.bindFramebuffer(e.FRAMEBUFFER,this._frameBuffer)}},{key:"_setRenderTargetFace",value:function(e){var t=this._rhi.gl,n=this._colorTextures[0],i=this._depthTexture;t.bindFramebuffer(t.FRAMEBUFFER,this._frameBuffer),null!=n&&n._isCube&&t.framebufferTexture2D(t.FRAMEBUFFER,t.COLOR_ATTACHMENT0,t.TEXTURE_CUBE_MAP_POSITIVE_X+e,n._glTexture,0),null!=i&&i._isCube&&t.framebufferTexture2D(t.FRAMEBUFFER,i._formatDetail.attachment,t.TEXTURE_CUBE_MAP_POSITIVE_X+e,i._glTexture,0),this._activeRenderTarget()}},{key:"_blitRenderTarget",value:function(){var e=this._rhi.gl,t=e.COLOR_BUFFER_BIT|(this._depthTexture?e.DEPTH_BUFFER_BIT:0),n=this._colorTextures.length;e.bindFramebuffer(e.READ_FRAMEBUFFER,this._MSAAFrameBuffer),e.bindFramebuffer(e.DRAW_FRAMEBUFFER,this._frameBuffer);for(var i=0;i<n;i++){var r=e.COLOR_ATTACHMENT0+i;this._blitDrawBuffers[i]=r,e.readBuffer(r),e.drawBuffers(this._blitDrawBuffers),e.blitFramebuffer(0,0,this._width,this._height,0,0,this._width,this._height,t,e.NEAREST),this._blitDrawBuffers[i]=e.NONE}e.bindFramebuffer(e.FRAMEBUFFER,null)}},{key:"_bindMainFBO",value:function(e){var t=this._rhi.gl,n=this._rhi.isWebGL2,i=this._colorTextures.length,r=new Array(i);t.bindFramebuffer(t.FRAMEBUFFER,this._frameBuffer);for(var a=0;a<i;a++){var o=this._colorTextures[a],s=t.COLOR_ATTACHMENT0+a;r[a]=s,o._isCube||t.framebufferTexture2D(t.FRAMEBUFFER,s,t.TEXTURE_2D,o._glTexture,0)}if(i>1&&t.drawBuffers(r),this._oriDrawBuffers=r,null!==e)if(e instanceof Vn)e._isCube||t.framebufferTexture2D(t.FRAMEBUFFER,e._formatDetail.attachment,t.TEXTURE_2D,e._glTexture,0);else if(this._antiAliasing<=1){var u=cn._getRenderBufferDepthFormatDetail(e,t,n),l=u.internalFormat,c=u.attachment,h=t.createRenderbuffer();this._depthRenderBuffer=h,t.bindRenderbuffer(t.RENDERBUFFER,h),t.renderbufferStorage(t.RENDERBUFFER,l,this._width,this._height),t.framebufferRenderbuffer(t.FRAMEBUFFER,c,t.RENDERBUFFER,h)}t.bindFramebuffer(t.FRAMEBUFFER,null),t.bindRenderbuffer(t.RENDERBUFFER,null)}},{key:"_bindMSAAFBO",value:function(e){var t=this._rhi.gl,n=this._rhi.isWebGL2,i=t.createRenderbuffer(),r=this._colorTextures.length;this._blitDrawBuffers=new Array(r),this._MSAADepthRenderBuffer=i,t.bindFramebuffer(t.FRAMEBUFFER,this._MSAAFrameBuffer);for(var a=0;a<r;a++){var o=t.createRenderbuffer();this._MSAAColorRenderBuffers[a]=o,this._blitDrawBuffers[a]=t.NONE,t.bindRenderbuffer(t.RENDERBUFFER,o),t.renderbufferStorageMultisample(t.RENDERBUFFER,this._antiAliasing,this._colorTextures[a]._formatDetail.internalFormat,this._width,this._height),t.framebufferRenderbuffer(t.FRAMEBUFFER,t.COLOR_ATTACHMENT0+a,t.RENDERBUFFER,o)}if(t.drawBuffers(this._oriDrawBuffers),null!==e){var s=e instanceof Vn?e._formatDetail:cn._getRenderBufferDepthFormatDetail(e,t,n),u=s.internalFormat,l=s.attachment;t.bindRenderbuffer(t.RENDERBUFFER,i),t.renderbufferStorageMultisample(t.RENDERBUFFER,this._antiAliasing,u,this._width,this._height),t.framebufferRenderbuffer(t.FRAMEBUFFER,l,t.RENDERBUFFER,i)}this._checkFrameBuffer(),t.bindFramebuffer(t.FRAMEBUFFER,null),t.bindRenderbuffer(t.RENDERBUFFER,null)}},{key:"_checkFrameBuffer",value:function(){var e=this._rhi.gl,t=this._rhi.isWebGL2,n=e.checkFramebufferStatus(e.FRAMEBUFFER);switch(n){case e.FRAMEBUFFER_INCOMPLETE_ATTACHMENT:throw new Error("The attachment types are mismatched or not all framebuffer attachment points are framebuffer attachment complete");case e.FRAMEBUFFER_INCOMPLETE_MISSING_ATTACHMENT:throw new Error("There is no attachment");case e.FRAMEBUFFER_INCOMPLETE_DIMENSIONS:throw new Error(" Height and width of the attachment are not the same.");case e.FRAMEBUFFER_UNSUPPORTED:throw new Error("The format of the attachment is not supported or if depth and stencil attachments are not the same renderbuffer")}if(t&&n===e.FRAMEBUFFER_INCOMPLETE_MULTISAMPLE)throw new Error("The values of gl.RENDERBUFFER_SAMPLES are different among attached renderbuffers, or are non-zero if the attached images are a mix of renderbuffers and textures.")}},{key:"width",get:function(){return this._width}},{key:"height",get:function(){return this._height}},{key:"colorTextureCount",get:function(){return this._colorTextures.length}},{key:"depthTexture",get:function(){return this._depthTexture}},{key:"antiAliasing",get:function(){return this._antiAliasing}}]),a}(re),jn=function(t){l(a,t);var i=m(a);function a(t,r,o){var s,u=arguments.length>3&&void 0!==arguments[3]?arguments[3]:e.RenderBufferColorFormat.R8G8B8A8,l=arguments.length>4&&void 0!==arguments[4]&&arguments[4],c=arguments.length>5&&void 0!==arguments[5]&&arguments[5];n(this,a),(s=i.call(this,t))._isCube=!1,s._autoMipmap=!1;var h=t._hardwareRenderer,d=h.gl,f=h.isWebGL2;if(!cn._supportRenderBufferColorFormat(u,h))throw new Error("RenderBufferColorFormat is not supported:".concat(e.RenderBufferColorFormat[u]));if(c&&r!==o)throw new Error("The cube texture must have the same width and height");return!l||f||cn._isPowerOf2(r)&&cn._isPowerOf2(o)||(Le.warn("non-power-2 texture is not supported for mipmap in WebGL1,and has automatically downgraded to non-mipmap"),l=!1),s._glTexture=d.createTexture(),s._formatDetail=cn._getRenderBufferColorFormatDetail(u,d,f),s._isCube=c,s._rhi=h,s._target=c?d.TEXTURE_CUBE_MAP:d.TEXTURE_2D,s._mipmap=l,s._width=r,s._height=o,s._format=u,s._mipmapCount=s._getMipmapCount(),s._initMipmap(c),s.filterMode=e.TextureFilterMode.Bilinear,s.wrapModeU=s.wrapModeV=e.TextureWrapMode.Clamp,s}return r(a,[{key:"getPixelBuffer",value:function(e,t,n,i,r,o){g(c(a.prototype),"_getPixelBuffer",this).call(this,e,t,n,i,r,o)}},{key:"format",get:function(){return this._format}},{key:"autoGenerateMipmaps",get:function(){return this._autoMipmap},set:function(e){this._autoMipmap=e}}]),a}(cn),Wn=function(e){l(i,e);var t=m(i);function i(e){var r;return n(this,i),(r=t.call(this,e))._worldSize=[],r._rotationAngle=0,r.renderMode="2D",r.tintColor=new U(1,1,1,1),r._worldSizeFactor=100,r.setTexture(void 0),r.setRect(void 0),r.setAnchor(void 0),r.setUvRect(),r.setWorldSize(),r._positionQuad={leftTop:new w,leftBottom:new w,rightTop:new w,rightBottom:new w},r}return r(i,[{key:"setTexture",value:function(e){e&&e.asset&&(e=e.asset),this._texture=e}},{key:"setRect",value:function(e){var t,n,i,r;try{e&&JSON.parse(e)}catch(e){Le.warn("Rect is not valid JSON format")}this._rect=e||{x:0,y:0,width:null!==(t=null===(n=this._texture)||void 0===n?void 0:n.width)&&void 0!==t?t:0,height:null!==(i=null===(r=this._texture)||void 0===r?void 0:r.height)&&void 0!==i?i:0}}},{key:"setAnchor",value:function(e){this._anchor=e||[.5,.5]}},{key:"setWorldSize",value:function(){var e=this._worldSizeFactor;this._worldSize=[this._rect.width/e,this._rect.height/e]}},{key:"setUvRect",value:function(){var e,t;this._texture?(e=this._texture.width,t=this._texture.height):(e=this._rect.width,t=this._rect.height),this._uvRect={u:this._rect.x/e,v:this._rect.y/t,width:this._rect.width/e,height:this._rect.height/t}}},{key:"render",value:function(e){this._updatePositionQuad(e),this._transformByMatrix(),e._renderPipeline.pushSprite(this,this._positionQuad,this._uvRect,this.tintColor,this.texture,this.renderMode,e)}},{key:"_transformByMatrix",value:function(){if(this.transformMatrix){var e=this.transformMatrix,t=this._positionQuad.leftTop,n=i._tempVec40;n.setValue(t.x,t.y,t.z,1),t=this._positionQuad.leftBottom;var r=i._tempVec41;r.setValue(t.x,t.y,t.z,1),t=this._positionQuad.rightTop;var a=i._tempVec42;a.setValue(t.x,t.y,t.z,1),t=this._positionQuad.rightBottom;var o=i._tempVec43;o.setValue(t.x,t.y,t.z,1),U.transform(n,e,n),U.transform(r,e,r),U.transform(a,e,a),U.transform(o,e,o),this._positionQuad.leftTop.setValue(n.x,n.y,n.z),this._positionQuad.leftBottom.setValue(r.x,r.y,r.z),this._positionQuad.rightTop.setValue(a.x,a.y,a.z),this._positionQuad.rightBottom.setValue(o.x,o.y,o.z)}}},{key:"_updatePositionQuad",value:function(e){if("2D"===this.renderMode){var t=e.viewMatrix.elements,n=new w(t[0],t[4],t[8]),i=new w(t[1],t[5],t[9]),r=this.entity.worldPosition.clone(),a=this._worldSize,o=this.entity.scale;if(n.scale(a[0]*o.x),i.scale(a[1]*o.y),0!==this._rotationAngle){var s=new w(t[2],t[6],t[10]),u=new O;O.rotationAxisAngle(s,this._rotationAngle,u),w.transformByQuat(n,u,n),w.transformByQuat(i,u,i)}var l=new w,c=new w;w.scale(n,2*(this.anchor[0]-.5),l),w.scale(i,2*(this.anchor[1]-.5),c),r.subtract(l).add(c);var h=this._positionQuad.leftTop;w.subtract(r,n,h),h.add(i);var d=this._positionQuad.leftBottom;w.subtract(r,n,d),d.subtract(i);var f=this._positionQuad.rightBottom;w.add(r,n,f),f.subtract(i);var _=this._positionQuad.rightTop;w.add(r,n,_),_.add(i)}}},{key:"texture",set:function(e){this.setTexture(e),this.setRect(),this.setUvRect(),this.setWorldSize()},get:function(){return this._texture}},{key:"anchor",set:function(e){this._anchor=e||[.5,.5]},get:function(){return this._anchor}},{key:"rect",set:function(e){this.setRect(e),this.setUvRect(),this.setWorldSize()},get:function(){return this._rect}},{key:"rotationAngle",get:function(){return this._rotationAngle},set:function(e){this._rotationAngle=e}}]),i}(dt);Wn._tempVec40=new U,Wn._tempVec41=new U,Wn._tempVec42=new U,Wn._tempVec43=new U,(Dn=e.WrapMode||(e.WrapMode={}))[Dn.ONCE=0]="ONCE",Dn[Dn.LOOP=1]="LOOP",(Nn=e.AnimationEvent||(e.AnimationEvent={}))[Nn.FINISHED=0]="FINISHED",Nn[Nn.LOOP_END=1]="LOOP_END",Nn[Nn.FRAME_EVENT=2]="FRAME_EVENT",(Bn=e.InterpolationType||(e.InterpolationType={}))[Bn.LINEAR=0]="LINEAR",Bn[Bn.CUBICSPLINE=1]="CUBICSPLINE",Bn[Bn.STEP=2]="STEP",(Gn=zn||(zn={}))[Gn.position=0]="position",Gn[Gn.rotation=1]="rotation",Gn[Gn.scale=2]="scale",Gn[Gn.other=3]="other";var qn=function(t){l(a,t);var i=m(a);function a(e){var t;return n(this,a),(t=i.call(this,null)).name=e,t.samplers=[],t.channels=[],t}return r(a,[{key:"addSampler",value:function(t,n,i){var r=arguments.length>3&&void 0!==arguments[3]?arguments[3]:e.InterpolationType.LINEAR;r===e.InterpolationType.CUBICSPLINE&&(i<=4?r=e.InterpolationType.LINEAR:i/=3);var a={input:t,output:n,outputSize:i,interpolation:r};this.samplers.push(a)}},{key:"addChannel",value:function(e,t,n){var i=this.samplers[e],r=a._tagetTypeMap[n],o={sampler:i,target:{id:t,path:n,pathType:null!=r?r:3}};this.channels.push(o)}},{key:"getChannelCount",value:function(){return this.channels.length}},{key:"getChannelObject",value:function(e){return this.channels[e]}},{key:"getFrameCount",value:function(e){return this.channels[e].sampler.input.length}},{key:"getFrameTime",value:function(e,t){return this.channels[e].sampler.input[t]}},{key:"getChannelTimeLength",value:function(e){var t=this.channels[e].sampler,n=t.input.length;return t.input[n-1]}},{key:"createChannelValue",value:function(e){var t=this.channels[e].sampler;return new Float32Array(t.outputSize)}},{key:"evaluate",value:function(t,n,i,r,a){var o=this.channels[n],s=o.sampler.output,u=o.sampler.outputSize;switch(o.sampler.interpolation){case e.InterpolationType.CUBICSPLINE:this.evaluateCubicSpline(t,s,u,i,r,a);break;case e.InterpolationType.LINEAR:this.evaluateLinear(t,s,u,i,r,a)}return t}},{key:"evaluateCubicSpline",value:function(e,t,n,i,r,a){for(var o=a*a,s=a*o,u=2*s-3*o+1,l=-2*s+3*o,c=s-2*o+a,h=s-o,d=n;d>=0;d--){var f=t[i*n*3+d],_=t[i*n*3+n+d],p=t[i*n*3+2*n+d],v=t[r*n*3+n+d];e[d]=_*u+v*l+f*c+p*h}}},{key:"evaluateLinear",value:function(e,t,n,i,r,a){switch(n){case 1:e[0]=t[i]*(1-a)+t[r]*a;break;case 4:this._quaSlerp(e,t,i*n,t,r*n,a);break;default:for(var o=n;o>=0;o--)e[o]=t[i*n+o]*(1-a)+t[r*n+o]*a}}},{key:"_quaSlerp",value:function(e,t,n,i,r,a){var o,s,u,l,c,h=t[0+n],d=t[1+n],f=t[2+n],_=t[3+n],p=i[0+r],v=i[1+r],m=i[2+r],g=i[3+r];return(s=h*p+d*v+f*m+_*g)<0&&(s=-s,p=-p,v=-v,m=-m,g=-g),1-s>1e-6?(o=Math.acos(s),u=Math.sin(o),l=Math.sin((1-a)*o)/u,c=Math.sin(a*o)/u):(l=1-a,c=a),e[0]=l*h+c*p,e[1]=l*d+c*v,e[2]=l*f+c*m,e[3]=l*_+c*g,e}}]),a}(nt);qn._tagetTypeMap={position:0,rotation:1,scale:2};var Xn=function(t){l(a,t);var i=m(a);function a(){var e;return n(this,a),(e=i.call(this,null)).layerWeight=1,e._activedEvents=[],e}return r(a,[{key:"isPlaying",get:function(){return this._animClip&&this._isPlaying}}]),r(a,[{key:"canMix",value:function(e,t){if(!this._animClip||!this._isPlaying||this.isMixLayer||this.isFading)return!1;if(this._animClip.getChannelCount()!==e.getChannelCount())return!1;for(var n=this._animClip.getChannelCount()-1;n>=0;n--){var i=this._animClip.getChannelObject(n),r=this._findChannelTarget(t,i.target),a=e.getChannelObject(n);if(r!==this._findChannelTarget(t,a.target))return!1}return!0}},{key:"mix",value:function(e,t,n,i){var r=arguments.length>4&&void 0!==arguments[4]?arguments[4]:{};if(this._isPlaying=t.isPlaying,this._animClip=e,this._wrapMode=void 0!==r.wrapMode?r.wrapMode:t._wrapMode,this._addEvents(r),this._channelStates=[],this._animClipLength=0,this._isPlaying){for(var a=t._channelStates,o=this._animClip.getChannelCount(),s=o-1;s>=0;s--){var u=this._animClip.getChannelObject(s),l=this._findChannelTarget(i,u.target);this._channelStates[s]={frameTime:0,currentFrame:0,currentValue:this._animClip.createChannelValue(s),mixWeight:l?1:0},a[s].mixWeight=void 0===a[s].mixWeight?1:a[s].mixWeight,1===a[s].mixWeight&&(a[s].mixWeight=l?0:1);var c=this._animClip.getChannelTimeLength(s);this._animClipLength=this._animClipLength>c?this._animClipLength:c}return!0}return!1}},{key:"removeMixWeight",value:function(){for(var e=this._channelStates.length-1;e>=0;e--)1===this._channelStates[e].mixWeight&&(this.mixTagetLayer._channelStates[e].mixWeight=1)}},{key:"play",value:function(t,n){var i=arguments.length>2&&void 0!==arguments[2]?arguments[2]:{wrapMode:e.WrapMode.LOOP};if(this._isPlaying=!!t,this._animClip=t,this._wrapMode=void 0!==i.wrapMode?i.wrapMode:e.WrapMode.LOOP,this._addEvents(i),this._channelStates=[],this._animClipLength=0,this._isPlaying){for(var r=this._animClip.getChannelCount(),a=[],o=r-1;o>=0;o--){var s=this._animClip.getChannelObject(o),u=this._findChannelTarget(n,s.target);u||Le.warn("Can not find channel target:"+s.target.id),this._channelStates[o]={frameTime:0,currentFrame:0,currentValue:this._animClip.createChannelValue(o)},a[o]={targetObject:u,path:s.target.path,pathType:s.target.pathType,outputSize:s.sampler.outputSize};var l=this._animClip.getChannelTimeLength(o);this._animClipLength=this._animClipLength>l?this._animClipLength:l}return a}return!1}},{key:"stop",value:function(t){this._animClip&&this._isPlaying&&(t?this._isPlaying=!1:this._wrapMode=e.WrapMode.ONCE)}},{key:"updateState",value:function(e){if(this._animClip&&this._isPlaying){this.isFading?(this.fadeDeltaTime+=e,this.layerWeight=1-this.fadeDeltaTime/this.fadeDuration,this.layerWeight<=0&&(this._isPlaying=!1)):this.crossFadeDuration&&(this.crossFadeDeltaTime+=e,this.layerWeight=this.crossFadeDeltaTime/this.crossFadeDuration,this.layerWeight>=1&&(this.layerWeight=1,delete this.crossFadeDuration)),e/=1e3,this._activeEvents(e);for(var t=0,n=this._animClip.getChannelCount()-1;n>=0;n--)this._updateChannelState(e,n)&&t++;0===t&&(this._isPlaying=!1,this.isMixLayer&&this.removeMixWeight())}}},{key:"getChannelLayerWeight",value:function(e){return(this.hasMixLayer||this.isMixLayer)&&e<this._channelStates.length?this._channelStates[e].mixWeight*(this.isMixLayer?this.mixTagetLayer.layerWeight:this.layerWeight):this.layerWeight}},{key:"getChannelValue",value:function(e){return this._channelStates[e].currentValue}},{key:"triggerEvents",value:function(){var e=this;this._activedEvents&&this._activedEvents.forEach((function(t){e.trigger(t)})),this._activedEvents.length=0}},{key:"jumpToFrame",value:function(e){for(var t=this._animClip.getChannelCount()-1;t>=0;t--){this._channelStates[t].frameTime=0,this._updateChannelState(e,t)}}},{key:"_updateChannelState",value:function(t,n){var i=this._animClip,r=this._channelStates[n],a=i.getChannelTimeLength(n);if(r.frameTime+=t,r.frameTime>a)switch(this._wrapMode){case e.WrapMode.ONCE:r.frameTime=a;break;case e.WrapMode.LOOP:r.frameTime=r.frameTime%this._animClipLength;break;default:Le.error("Unknown Anim wrap Mode: "+this._wrapMode)}if(r.mixWeight&&0===r.mixWeight)return!0;var o=Math.min(r.frameTime,a),s=this._getKeyAndAlpha(i.getChannelObject(n),o);return r.currentValue=i.evaluate(r.currentValue,n,s.currentKey,s.nextKey,s.alpha),!(this._wrapMode===e.WrapMode.ONCE&&r.frameTime>=a)}},{key:"_addEvents",value:function(t){var n=this;if(this.removeAllEventListeners(),this._frameEvents=[],t.events)for(var i=0,r=function(r){var a=t.events[r],o=a.type;a.type===e.AnimationEvent.FRAME_EVENT&&(o="frameEvent"+i,i++,n._frameEvents.push({eventType:o,triggerTime:a.triggerTime,triggered:!1})),n.addEventListener(o,(function(e){a.callback()}))},a=t.events.length-1;a>=0;a--)r(a)}},{key:"_activeEvents",value:function(t){var n=this._animClip.durationIndex;if(this._frameEvents.length>0&&this._channelStates.length>0)for(var i=this._channelStates[n].frameTime+t,r=this._frameEvents.length-1;r>=0;r--){var a=this._frameEvents[r];!a.triggered&&i>a.triggerTime&&(this._activedEvents.push(new Y(a.eventType,this)),a.triggered=!0)}if(this._channelStates.length>0&&this._channelStates[n].frameTime+t>=this._animClip.duration)if(this._wrapMode===e.WrapMode.LOOP){if(this._frameEvents.length>0)for(var o=this._frameEvents.length-1;o>=0;o--)this._frameEvents[o].triggered=!1;this.hasEvent(e.AnimationEvent.LOOP_END)&&this._activedEvents.push(new Y(e.AnimationEvent.LOOP_END,this))}else this.hasEvent(e.AnimationEvent.FINISHED)&&this._activedEvents.push(new Y(e.AnimationEvent.FINISHED,this))}},{key:"_findChannelTarget",value:function(e,t){var n=t.id,i=null;return i=e.name===n?e:e.findByName(n),"weights"===t.path?i.getComponent(pn):i}},{key:"_getKeyAndAlpha",value:function(t,n){for(var i=0,r=0,a=0,o=t.sampler.input,s=o.length,u=s-1;u>=0;u--)if(n>o[u]){i=n-o[u],r=u;break}if((a=r+1)>=s)switch(this._wrapMode){case e.WrapMode.ONCE:a=s-1;break;case e.WrapMode.LOOP:a=0}var l=o[a]-o[r];return{currentKey:r,nextKey:a,alpha:a===r||l<1e-5?1:i/l}}}]),a}(se),Kn=Object.defineProperty,Qn=Object.getOwnPropertyDescriptor,Yn=function(e,t,n,i){for(var r,a=i>1?void 0:i?Qn(t,n):t,o=e.length-1;o>=0;o--)(r=e[o])&&(a=(i?r(t,n,a):r(a))||a);return i&&a&&Kn(t,n,a),a},Jn=function(e){l(i,e);var t=m(i);function i(e){var r;return n(this,i),(r=t.call(this,e))._onUpdateIndex=-1,r._animSet={},r._animLayers=[new Xn],r._timeScale=1,r}return r(i,[{key:"update",value:function(e){if(this.isPlaying()){e*=this._timeScale;for(var t=this._animLayers.length-1;t>=0;t--){this._animLayers[t].updateState(e)}this._updateValues();for(var n=this._animLayers.length-1;n>=0;n--){var i=this._animLayers[n];i.triggerEvents(),i.isPlaying||!i.isFading&&!i.isMixLayer||(this._animLayers.splice(n,1),this._removeRefMixLayers(i))}}}},{key:"addAnimationClip",value:function(e,t){this._animSet[t]=e}},{key:"removeAnimationClip",value:function(e){this._animSet[e]&&delete this._animSet[e]}},{key:"getAnimationClipLength",value:function(e){var t=this._animSet[e];return t?t.getChannelTimeLength(0):0}},{key:"getAnimationClip",value:function(e){return this._animSet[e]||null}},{key:"isPlaying",value:function(){for(var e=this._animLayers.length-1;e>=0;e--)if(this._animLayers[e].isPlaying)return!0;return!1}},{key:"playAnimationClip",value:function(e,t){var n=this._animSet[e];if(n){for(var i=null,r=this._animLayers.length-1;r>=0;r--)if(!this._animLayers[r].isFading&&!this._animLayers[r].isMixLayer){i=this._animLayers[r];break}i||(i=new Xn,this._animLayers.push(i)),this._removeRefMixLayers(i),this._channelTargets=i.play(n,this.entity,t)}else Le.error("can not find anim clip: "+e)}},{key:"crossFade",value:function(e,t,n){var i=this._animSet[e];if(i)if(!t||t<0)Le.error("crossFadeDuration can not less than 0!");else{for(var r=null,a=this._animLayers.length-1;a>=0;a--)if(this._animLayers[a].canMix(i,this.entity)){r=this._animLayers[a];break}if(r){for(var o=this._animLayers.length-1;o>=0;o--)this._animLayers[o].isFading&&this._animLayers.splice(o,1);r.isFading=!0,r.fadeDuration=t,r.fadeDeltaTime=0;var s=new Xn;s.crossFadeDuration=t,s.crossFadeDeltaTime=0,s.play(i,this.entity,n),this._animLayers.push(s)}else this.playAnimationClip(e,n)}else Le.error("can not find anim clip: "+e)}},{key:"mix",value:function(e,t,n){var i=this._animSet[e];if(i){var r=this.entity.findByName(t);if(r){for(var a=null,o=this._animLayers.length-1;o>=0;o--)if(this._animLayers[o].canMix(i,this.entity)){a=this._animLayers[o];break}if(a){this._removeRefMixLayers(null,r),a.hasMixLayer=!0;var s=new Xn;s.isMixLayer=!0,s.mixTagetLayer=a,s.mixEntity=r,s.mix(i,a,this.entity,r,n),this._animLayers.push(s)}}else Le.error("can not find mix bone!")}else Le.error("can not find anim clip: "+e)}},{key:"stop",value:function(e){for(var t=this._animLayers.length-1;t>=0;t--)this._animLayers[t].isFading?this._animLayers.splice(t,1):this._animLayers[t].stop(e)}},{key:"jumpToFrame",value:function(e){e/=1e3;for(var t=this._animLayers.length-1;t>=0;t--)this._animLayers[t].jumpToFrame(e);this._updateValues()}},{key:"_removeRefMixLayers",value:function(e,t){if(e&&e.hasMixLayer)for(var n=this._animLayers.length-1;n>=0;n--){var i=this._animLayers[n];i.isMixLayer&&i.mixTagetLayer===e&&(i.removeMixWeight(),this._animLayers.splice(n,1))}if(t)for(var r=this._animLayers.length-1;r>=0;r--){var a=this._animLayers[r];a.isMixLayer&&(a.mixEntity===t||a.mixEntity.findByName(t)||t.findByName(a.mixEntity))&&(a.removeMixWeight(),this._animLayers.splice(r,1))}}},{key:"_updateValues",value:function(){if(0!==this._animLayers.length&&this._channelTargets)for(var e=this._channelTargets.length-1;e>=0;e--){var t=this._channelTargets[e],n=this._getChannelValue(e,t.outputSize),i=t.targetObject,r=t.path;if("weights"===r)i.setWeights(n);else{var a=n,o=i.transform;switch(t.pathType){case zn.position:var s=o.position;s.setValue(a[0],a[1],a[2]),o.position=s;break;case zn.rotation:var u=o.rotationQuaternion;u.setValue(a[0],a[1],a[2],a[3]),o.rotationQuaternion=u;break;case zn.scale:var l=o.scale;l.setValue(a[0],a[1],a[2]),o.scale=l;break;default:i[r]=n}}}}},{key:"_getChannelValue",value:function(e,t){for(var n=[],r=[],a=this._animLayers.length-1;a>=0;a--){var o=this._animLayers[a].getChannelLayerWeight(e);o>0&&(n.push(o),r.push(this._animLayers[a].getChannelValue(e)))}return 1===r.length?r[0]:2===r.length?i.lerp(r[0],r[0],r[1],n[1],t):(Le.error("Can not get channel value!"),!1)}},{key:"_onEnable",value:function(){this.engine._componentsManager.addOnUpdateAnimations(this)}},{key:"_onDisable",value:function(){this.engine._componentsManager.removeOnUpdateAnimations(this)}},{key:"timeScale",get:function(){return this._timeScale},set:function(e){e>0&&(this._timeScale=e)}}],[{key:"lerp",value:function(e,t,n,i,r){switch(r){case 1:e=t*(1-i)+n*i;break;case 4:var a=f(O,x(t)),o=f(O,x(n)),s=new O;O.slerp(a,o,i,s),e[0]=s.x,e[1]=s.y,e[2]=s.z,e[3]=s.w;break;default:for(var u=r;u>=0;u--)e[u]=t[u]*(1-i)+n[u]*i}return e}}]),i}(Ue);Yn([J],Jn.prototype,"_onUpdateIndex",2),Yn([Z],Jn.prototype,"_animSet",2),Yn([J],Jn.prototype,"_animLayers",2),Yn([J],Jn.prototype,"_timeScale",2),Yn([J],Jn.prototype,"_channelTargets",2);var Zn=function(t){l(a,t);var i=m(a);function a(e,t){var r;return n(this,a),(r=i.call(this,e,t)).renderStates={enable:[],disable:[],functions:{}},r.emission=new U(0,0,0,1),r.ambient=new U(0,0,0,1),r.renderStates={},r}return r(a,[{key:"prepareDrawing",value:function(e,t,n){var i=e.camera,r=i.scene.findFeature(Vt);r.bindMaterialValues(this);var o=r.lightSortAmount.ambientLightCount;this._technique&&this._ambientLightCount===o||(this._ambientLightCount=o,this._generateTechnique(),this.bindLightUniformDefine(i)),g(c(a.prototype),"prepareDrawing",this).call(this,e,t,n)}},{key:"bindLightUniformDefine",value:function(e){var t=e.scene.findFeature(Vt);this._technique.uniforms=u(u({},t.getUniformDefine()),this._technique.uniforms)}},{key:"_internalGenerate",value:function(e,t){var n=this._generateMacros(),i=this._generateFragmentUniform(),r=new In(e);r.isValid=!0,r.uniforms=i,r.attributes={},r.states=this.renderStates,r.customMacros=n,r.vertexShader="#include <common>\n#include <common_vert>\n#include <uv_share>\n#include <normal_share>\n#include <worldpos_share>\n#include <shadow_share>\n#include <morph_target_vert>\n\n#include <fog_share>\n\nvoid main() {\n\n    #include <begin_position_vert>\n    #include <begin_normal_vert>\n\n    #include <morph_vert>\n    #include <skinning_vert>\n    #include <uv_vert>\n    #include <normal_vert>\n    #include <worldpos_vert>\n    #include <shadow_vert>\n    #include <position_vert>\n\n    #include <fog_vert>\n\n}\n",r.fragmentShader=t,this._technique=r}},{key:"_generateMacros",value:function(){var e=[];return this.emission instanceof hn&&e.push("O3_EMISSION_TEXTURE"),this.ambient instanceof hn&&e.push("O3_AMBIENT_TEXTURE"),this._ambientLightCount&&e.push("O3_HAS_AMBIENT_LIGHT"),e}},{key:"_generateFragmentUniform",value:function(){var t={u_emission:{name:"u_emission",type:e.DataType.FLOAT_VEC4},u_ambient:{name:"u_ambient",type:e.DataType.FLOAT_VEC4}};return this.emission instanceof hn&&(t.u_emission.type=e.DataType.SAMPLER_2D),this.ambient instanceof hn&&(t.u_ambient.type=e.DataType.SAMPLER_2D),t}},{key:"emission",get:function(){return this.getValue("u_emission")},set:function(e){this.setValue("u_emission",e)}},{key:"ambient",get:function(){return this.getValue("u_ambient")},set:function(e){this.setValue("u_ambient",e)}}]),a}(xn),$n=function(e){l(i,e);var t=m(i);function i(){return n(this,i),t.apply(this,arguments)}return r(i,[{key:"_generateTechnique",value:function(){this._internalGenerate("ConstantMaterial","#include <common>\n#include <common_frag>\n#include <uv_share>\n#include <mobile_material_frag>\n\n#include <fog_share>\n#include <ambient_light_frag>\n\nvoid main() {\n\n    #include <begin_mobile_frag>\n\n    gl_FragColor = emission + ambient;\n\n    #include <fog_frag>\n\n}\n")}}]),i}(Zn),ei=function(t){l(a,t);var i=m(a);function a(e,t){var r;return n(this,a),(r=i.call(this,e,t))._directLightCount=0,r.diffuse=new U(1,1,1,1),r}return r(a,[{key:"_generateTechnique",value:function(){this._internalGenerate("LambertMaterial","#include <common>\n#include <common_frag>\n#include <uv_share>\n#include <normal_share>\n\n#include <ambient_light_frag>\n#include <direct_light_frag>\n#include <mobile_material_frag>\n\n#include <fog_share>\n\nvoid main() {\n\n    #include <begin_mobile_frag>\n    #include <begin_normal_frag>\n    #include <mobile_lambert_frag>\n\n    gl_FragColor = emission + ambient + diffuse;\n\n    #include <fog_frag>\n\n}\n")}},{key:"prepareDrawing",value:function(e,t,n){var i=e.camera,r=i.scene.findFeature(Vt).lightSortAmount.directLightCount;null!==this._technique&&this._directLightCount==r||(this._directLightCount=r,this._generateTechnique(),this.bindLightUniformDefine(i)),g(c(a.prototype),"prepareDrawing",this).call(this,e,t,n)}},{key:"_generateFragmentUniform",value:function(){var t={};return this.diffuse instanceof hn?t.u_diffuse={name:"u_diffuse",type:e.DataType.SAMPLER_2D}:t.u_diffuse={name:"u_diffuse",type:e.DataType.FLOAT_VEC4},o(g(c(a.prototype),"_generateFragmentUniform",this).call(this),t)}},{key:"_generateMacros",value:function(){var e=g(c(a.prototype),"_generateMacros",this).call(this);return e.push("O3_NEED_WORLDPOS"),this._directLightCount>0&&e.push("O3_DIRECT_LIGHT_COUNT ".concat(this._directLightCount)),this.diffuse instanceof hn&&e.push("O3_DIFFUSE_TEXTURE"),e}},{key:"diffuse",get:function(){return this.getValue("u_diffuse")},set:function(e){this.setValue("u_diffuse",e)}}]),a}(Zn),ti=function(t){l(a,t);var i=m(a);function a(e,t){var r;return n(this,a),(r=i.call(this,e,t))._directLightCount=0,r._pointLightCount=0,r._spotLightCount=0,r.diffuse=new U(1,1,1,1),r.specular=new U(1,1,1,1),r.shininess=16,r}return r(a,[{key:"_generateTechnique",value:function(){this._internalGenerate("BlinnPhongMaterial","#include <common>\n#include <common_frag>\n\n#include <uv_share>\n#include <normal_share>\n#include <worldpos_share>\n\n#include <ambient_light_frag>\n#include <direct_light_frag>\n#include <point_light_frag>\n#include <spot_light_frag>\n#include <mobile_material_frag>\n\n#include <fog_share>\n\nvoid main() {\n\n    #include <begin_mobile_frag>\n    #include <begin_normal_frag>\n    #include <begin_viewdir_frag>\n    #include <mobile_blinnphong_frag>\n\n    gl_FragColor = emission + ambient + diffuse + specular;\n\n    #include <fog_frag>\n\n}\n")}},{key:"_generateMacros",value:function(){var e=g(c(a.prototype),"_generateMacros",this).call(this);return e.push("O3_NEED_WORLDPOS"),this.diffuse instanceof hn&&e.push("O3_DIFFUSE_TEXTURE"),this.specular instanceof hn&&e.push("O3_SPECULAR_TEXTURE"),this._directLightCount>0&&e.push("O3_DIRECT_LIGHT_COUNT ".concat(this._directLightCount)),this._pointLightCount>0&&e.push("O3_POINT_LIGHT_COUNT ".concat(this._pointLightCount)),this._spotLightCount>0&&e.push("O3_SPOT_LIGHT_COUNT ".concat(this._spotLightCount)),e}},{key:"prepareDrawing",value:function(e,t,n){var i=e.camera,r=i.scene.findFeature(Vt).lightSortAmount,o=r.directLightCount,s=r.pointLightCount,u=r.spotLightCount;null!==this._technique&&this._directLightCount==o&&this._pointLightCount==s&&this._spotLightCount==u||(this._directLightCount=o,this._pointLightCount=s,this._spotLightCount=u,this._generateTechnique(),this.bindLightUniformDefine(i)),g(c(a.prototype),"prepareDrawing",this).call(this,e,t,n)}},{key:"_generateFragmentUniform",value:function(){var t={};return this.diffuse instanceof hn?t.u_diffuse={name:"u_diffuse",type:e.DataType.SAMPLER_2D}:t.u_diffuse={name:"u_diffuse",type:e.DataType.FLOAT_VEC4},this.specular instanceof hn?t.u_specular={name:"u_specular",type:e.DataType.SAMPLER_2D}:t.u_specular={name:"u_specular",type:e.DataType.FLOAT_VEC4},t.u_shininess={name:"u_shininess",type:e.DataType.FLOAT},o(g(c(a.prototype),"_generateFragmentUniform",this).call(this),t)}},{key:"diffuse",get:function(){return this.getValue("u_diffuse")},set:function(e){this.setValue("u_diffuse",e)}},{key:"specular",get:function(){return this.getValue("u_specular")},set:function(e){this.setValue("u_specular",e)}},{key:"shininess",get:function(){return this.getValue("u_shininess")},set:function(e){this.setValue("u_shininess",e)}}]),a}(Zn),ni="#include <common>\n#include <common_frag>\n\nuniform sampler2D u_diffuse;\nvarying vec3 v_pos;\nuniform vec4 u_tintColor;\nuniform float u_opacity;\n\nvoid main()\n{\n  #ifdef O3_DIFFUSE_TEXTURE\n    gl_FragColor = texture2D(u_diffuse, v_uv);\n  #else\n    gl_FragColor = vec4(1);\n  #endif\n}\n",ii=function(t){l(a,t);var i=m(a);function a(e,t){return n(this,a),i.call(this,e,t||"TextureMaterial")}return r(a,[{key:"_generateTechnique",value:function(){this._internalGenerate("Texture",ni)}},{key:"setValue",value:function(e,t){"doubleSided"===e&&this._setDoubleSidedDisplay(t),g(c(a.prototype),"setValue",this).call(this,e,t)}},{key:"_generateFragmentUniform",value:function(){var t={};return this.texture instanceof hn&&(t.u_diffuse={name:"u_diffuse",paramName:"_MainTex",type:e.DataType.SAMPLER_2D}),u(u({},g(c(a.prototype),"_generateFragmentUniform",this).call(this)),t)}},{key:"_generateMacros",value:function(){var e=g(c(a.prototype),"_generateMacros",this).call(this);return this.texture instanceof hn&&e.push("O3_DIFFUSE_TEXTURE"),e}},{key:"_setDoubleSidedDisplay",value:function(t){this._technique.states.disable=[],t&&this._technique.states.disable.push(e.RenderState.CULL_FACE)}},{key:"texture",set:function(e){this.setValue("u_diffuse",e)},get:function(){return this.getValue("u_diffuse")}},{key:"doubleSided",set:function(e){this.setValue("doubleSided",e)},get:function(){return this.getValue("doubleSided")}}]),a}(Zn);ii.TECH_NAME="Texture";var ri=function(t){l(a,t);var i=m(a);function a(e,t){return n(this,a),i.call(this,e,t||"TransparentMaterial")}return r(a,[{key:"_generateTechnique",value:function(){this.renderStates={enable:[e.RenderState.BLEND],disable:[e.RenderState.CULL_FACE],functions:{blendFunc:[e.BlendFunc.SRC_ALPHA,e.BlendFunc.ONE_MINUS_SRC_ALPHA],depthMask:[!1]}},this.renderType=e.MaterialType.TRANSPARENT,this._internalGenerate("Transparent",ni)}},{key:"_generateFragmentUniform",value:function(){var t={};return this.texture instanceof hn&&(t.u_diffuse={name:"u_diffuse",paramName:"_MainTex",type:e.DataType.SAMPLER_2D}),u(u({},g(c(a.prototype),"_generateFragmentUniform",this).call(this)),t)}},{key:"_generateMacros",value:function(){var e=g(c(a.prototype),"_generateMacros",this).call(this);return this.texture instanceof hn&&e.push("O3_DIFFUSE_TEXTURE"),e}},{key:"texture",set:function(e){this.setValue("u_diffuse",e)},get:function(){return this.getValue("u_diffuse")}}]),a}(Zn);ri.TECH_NAME="Transparent";var ai=function(t){l(a,t);var i=m(a);function a(t,r){var o;return n(this,a),(o=i.call(this,t,r)).vertexShader="",o.fragmentShader="",o.isValid=!0,o.attributes={},o._uniforms=a.commonUniforms,o._renderStates={enable:[],disable:[],functions:{}},o._enableConfig=[],o._disableConfig=[],o._functionsConfig={blendFunc:[e.BlendFunc.SRC_ALPHA,e.BlendFunc.ONE_MINUS_SRC_ALPHA]},o}return r(a,[{key:"prepareDrawing",value:function(e,t,n){var i=e.camera;if(!this._technique){var r=this._generateTechnique(i,t,n);this._technique=r}g(c(a.prototype),"prepareDrawing",this).call(this,e,t,n)}},{key:"updateTechnique",value:function(){this._technique=null}},{key:"_generateTechnique",value:function(e,t,n){var i=new In("ShaderMaterial");return i.isValid=this.isValid,i.uniforms=this.uniforms,i.attributes=this.attributes,i.states=this.renderStates,i.vertexShader=this.vertexShader,i.fragmentShader=this.fragmentShader,i}},{key:"addState",value:function(e,t){this.renderStates[e]=oi(this.renderStates[e],t)}},{key:"removeState",value:function(e,t){this.renderStates[e]=this.renderStates[e].filter((function(e){return e!==t}))}},{key:"renderStates",get:function(){return this._renderStates},set:function(e){var t=e.enable,n=void 0===t?[]:t,i=e.disable,r=void 0===i?[]:i,s=e.functions,u=void 0===s?{}:s,l=n.filter((function(e){return a.commonEnable.indexOf(e)<0})),c=r.filter((function(e){return a.commonDisable.indexOf(e)<0}));this._renderStates.enable=oi(l,this._enableConfig),this._renderStates.disable=oi(c,this._disableConfig),this._renderStates.functions=o({},u,this._functionsConfig)}},{key:"uniforms",get:function(){return this._uniforms},set:function(e){this._uniforms=o({},a.commonUniforms,e)}},{key:"blend",set:function(t){t?this._enableConfig=oi(this._enableConfig,[e.RenderState.BLEND]):(this._enableConfig=this._enableConfig.filter((function(t){return t!==e.RenderState.BLEND})),this.removeState("enable",e.RenderState.BLEND)),this.renderStates=this._renderStates}},{key:"blendSrcFactor",set:function(e){this._functionsConfig.blendFunc[0]=e,this.renderStates=this._renderStates}},{key:"blendDstFactor",set:function(e){this._functionsConfig.blendFunc[1]=e,this.renderStates=this._renderStates}},{key:"doubleSide",set:function(t){t?this._disableConfig=oi(this._disableConfig,[e.RenderState.CULL_FACE]):(this._disableConfig=this._disableConfig.filter((function(t){return t!==e.RenderState.CULL_FACE})),this.removeState("disable",e.RenderState.CULL_FACE)),this.renderStates=this._renderStates}},{key:"depthTest",set:function(t){t?(this._disableConfig=this._disableConfig.filter((function(t){return t!==e.RenderState.DEPTH_TEST})),this.removeState("disable",e.RenderState.DEPTH_TEST)):this._disableConfig=oi(this._disableConfig,[e.RenderState.DEPTH_TEST]),this.renderStates=this._renderStates}}]),a}(xn);function oi(e,t){return e.concat(t.filter((function(t){return!(e.indexOf(t)>-1)})))}ai.commonUniforms={matModelViewProjection:{name:"matModelViewProjection",semantic:e.UniformSemantic.MODELVIEWPROJECTION,type:e.DataType.FLOAT_MAT4},matModelView:{name:"matModelView",semantic:e.UniformSemantic.MODELVIEW,type:e.DataType.FLOAT_MAT4}},ai.commonEnable=[e.RenderState.BLEND],ai.commonDisable=[e.RenderState.CULL_FACE,e.RenderState.DEPTH_TEST];var si,ui,li=function(t){l(a,t);var i=m(a);function a(e,t){var r;return n(this,a),(r=i.call(this,e))._subGeometries=[],r._primitive=new Mn(e),r.name=t,r}return r(a,[{key:"setVertexBufferBinding",value:function(e){var t=arguments.length>1&&void 0!==arguments[1]?arguments[1]:0,n=arguments.length>2&&void 0!==arguments[2]?arguments[2]:0;this._primitive.setVertexBufferBinding(e,t,n)}},{key:"setVertexBufferBindings",value:function(e){var t=arguments.length>1&&void 0!==arguments[1]?arguments[1]:0;this._primitive.setVertexBufferBindings(e,t)}},{key:"setIndexBufferBinding",value:function(e,t){this._primitive.setIndexBufferBinding(e,t)}},{key:"setVertexElements",value:function(e){this._primitive.setVertexElements(e)}},{key:"addSubGeometry",value:function(t,n){var i=arguments.length>2&&void 0!==arguments[2]?arguments[2]:e.PrimitiveTopology.Triangles,r=new Pn(t,n,i);return this._subGeometries.push(r),r}},{key:"removeSubGeometry",value:function(e){var t=this._subGeometries,n=t.indexOf(e);-1!==n&&t.splice(n,1)}},{key:"clearSubGeometry",value:function(){this._subGeometries.length=0}},{key:"destroy",value:function(){this._primitive&&(this._primitive.destroy(),this._primitive=null)}},{key:"vertexBufferBindings",get:function(){return this._primitive.vertexBufferBindings}},{key:"indexBufferBinding",get:function(){return this._primitive.indexBufferBinding}},{key:"vertexElements",get:function(){return this._primitive.vertexElements}},{key:"subGeometry",get:function(){return this._subGeometries[0]||null}},{key:"subGeometries",get:function(){return this._subGeometries}},{key:"instanceCount",get:function(){return this._primitive.instanceCount},set:function(e){this._primitive.instanceCount=e}},{key:"bounds",get:function(){return this._bounds},set:function(e){this._bounds=e}}]),a}(re),ci=function(e){l(i,e);var t=m(i);function i(){return n(this,i),t.apply(this,arguments)}return r(i,[{key:"render",value:function(e){var t=this.geometry;if(t){for(var n=t.subGeometries,i=e._renderPipeline,r=this._material,a=0,o=n.length;a<o;a++)if(r){var s=Qe.getFromPool();s.setValue(this,t._primitive,n[a],r),i.pushPrimitive(s)}}else Le.error("geometry is null.")}},{key:"_updateBounds",value:function(e){var t=this._geometry.bounds;if(t){var n=this._entity.transform.worldMatrix;w.transformCoordinate(t.min,n,e.min),w.transformCoordinate(t.max,n,e.max)}else e.min.setValue(Number.POSITIVE_INFINITY,Number.POSITIVE_INFINITY,Number.POSITIVE_INFINITY),e.max.setValue(Number.NEGATIVE_INFINITY,Number.NEGATIVE_INFINITY,Number.NEGATIVE_INFINITY)}},{key:"geometry",set:function(e){this._geometry&&this._geometry._primitive._addRefCount(-1),e._primitive._addRefCount(1),this._geometry=e},get:function(){return this._geometry}},{key:"material",set:function(e){this._material&&this._material._addRefCount(-1),e._addRefCount(1),this._material=e},get:function(){return this._material}}]),i}(dt),hi=function(t){l(a,t);var i=m(a);function a(){return n(this,a),i.apply(this,arguments)}return r(a,[{key:"_initialize",value:function(t,n,i){var r=[new Ln("POSITION",0,e.VertexElementFormat.Vector3,0),new Ln("NORMAL",12,e.VertexElementFormat.Vector3,0),new Ln("TEXCOORD_0",24,e.VertexElementFormat.Vector2,0)];this._initBuffer(t,n,i,32,r)}},{key:"_initBuffer",value:function(t,n,i,r,a){var o=a[0],s=new bn(t,e.BufferBindFlag.VertexBuffer,n,e.BufferUsage.Static),u=new bn(t,e.BufferBindFlag.IndexBuffer,i,e.BufferUsage.Static);this.setVertexBufferBinding(s,r),this.setIndexBufferBinding(u,e.IndexFormat.UInt16),this.setVertexElements(a),this.addSubGeometry(0,i.length),this._computeBounds(o,n)}},{key:"_computeBounds",value:function(e,t){var n=e,i=n.bindingIndex,r=this._primitive.vertexBufferBindings[i],a=r.stride,o=n.offset,s=r.buffer.byteLength/a,u=t;u instanceof ArrayBuffer||(u=u.buffer);for(var l=new DataView(u,o),c=new w(1/0,1/0,1/0),h=new w(-1/0,-1/0,-1/0),d=0;d<s;d++){var f=o+a*d,_=new w(l.getFloat32(f,!0),l.getFloat32(f+4,!0),l.getFloat32(f+8,!0));w.min(c,_,c),w.max(h,_,h)}var p=this.bounds;p?(c.cloneTo(p.min),h.cloneTo(p.max)):(p={min:c,max:h},this.bounds=p)}}]),a}(li),di=function(e){l(i,e);var t=m(i);function i(e){var r,a=arguments.length>1&&void 0!==arguments[1]?arguments[1]:1,o=arguments.length>2&&void 0!==arguments[2]?arguments[2]:1,s=arguments.length>3&&void 0!==arguments[3]?arguments[3]:1;n(this,i),r=t.call(this,e);var u=a/2,l=o/2,c=s/2,h=new Float32Array([-u,l,-c,0,1,0,0,0,u,l,-c,0,1,0,1,0,u,l,c,0,1,0,1,1,-u,l,c,0,1,0,0,1,-u,-l,-c,0,-1,0,0,1,u,-l,-c,0,-1,0,1,1,u,-l,c,0,-1,0,1,0,-u,-l,c,0,-1,0,0,0,-u,l,-c,-1,0,0,0,0,-u,l,c,-1,0,0,1,0,-u,-l,c,-1,0,0,1,1,-u,-l,-c,-1,0,0,0,1,u,l,-c,1,0,0,1,0,u,l,c,1,0,0,0,0,u,-l,c,1,0,0,0,1,u,-l,-c,1,0,0,1,1,-u,l,c,0,0,1,0,0,u,l,c,0,0,1,1,0,u,-l,c,0,0,1,1,1,-u,-l,c,0,0,1,0,1,-u,l,-c,0,0,-1,1,0,u,l,-c,0,0,-1,0,0,u,-l,-c,0,0,-1,0,1,-u,-l,-c,0,0,-1,1,1]),d=new Uint16Array([0,2,1,2,0,3,4,6,7,6,4,5,8,10,9,10,8,11,12,14,15,14,12,13,16,18,17,18,16,19,20,22,23,22,20,21]);return r._initialize(e,h,d),r}return i}(hi),fi=function(e){l(i,e);var t=m(i);function i(e){var r,a=arguments.length>1&&void 0!==arguments[1]?arguments[1]:1,o=arguments.length>2&&void 0!==arguments[2]?arguments[2]:8,s=arguments.length>3&&void 0!==arguments[3]?arguments[3]:6,u=arguments.length>4&&void 0!==arguments[4]?arguments[4]:0,l=arguments.length>5&&void 0!==arguments[5]?arguments[5]:2*Math.PI,c=arguments.length>6&&void 0!==arguments[6]?arguments[6]:0,h=arguments.length>7&&void 0!==arguments[7]?arguments[7]:Math.PI;return n(this,i),(r=t.call(this,e))._parameters={radius:a||1,horizontalSegments:Math.max(3,Math.floor(o)),verticalSegments:Math.max(2,Math.floor(s)),alphaStart:u,alphaRange:l,thetaStart:c,thetaRange:h},r._thetaEnd=r._parameters.thetaStart+r._parameters.thetaRange,r.initialize(e),r}return r(i,[{key:"initialize",value:function(e){for(var t=this._parameters,n=t.verticalSegments,i=t.horizontalSegments,r=0,a=[],o=new Float32Array((n+1)*(i+1)*8),s=[],u=0;u<=n;u++){for(var l=[],c=u/n,h=0;h<=i;h++){var d=h/i,f=-this._parameters.radius*Math.cos(this._parameters.alphaStart+d*this._parameters.alphaRange)*Math.sin(this._parameters.thetaStart+c*this._parameters.thetaRange),_=this._parameters.radius*Math.cos(this._parameters.thetaStart+c*this._parameters.thetaRange),p=this._parameters.radius*Math.sin(this._parameters.alphaStart+d*this._parameters.alphaRange)*Math.sin(this._parameters.thetaStart+c*this._parameters.thetaRange);f=Math.abs(f)<1e-6?0:f,_=Math.abs(_)<1e-6?0:_,p=Math.abs(p)<1e-6?0:p;var v=8*r;o[v]=f,o[v+1]=_,o[v+2]=p,o[v+3]=f,o[v+4]=_,o[v+5]=p,o[v+6]=d,o[v+7]=1-c,l.push(r++)}a.push(l)}for(var m=0;m<n;m++)for(var g=0;g<i;g++){var y=a[m][g+1],x=a[m][g],T=a[m+1][g],A=a[m+1][g+1];(0!==m||this._parameters.thetaStart>0)&&s.push(y,x,A),(m!==n-1||this._thetaEnd<Math.PI)&&s.push(x,T,A)}this._initialize(e,o,Uint16Array.from(s))}}]),i}(hi),_i=function(e){l(i,e);var t=m(i);function i(e){var r,a=arguments.length>1&&void 0!==arguments[1]?arguments[1]:1,o=arguments.length>2&&void 0!==arguments[2]?arguments[2]:1,s=arguments.length>3&&void 0!==arguments[3]?arguments[3]:1,u=arguments.length>4&&void 0!==arguments[4]?arguments[4]:1;return n(this,i),(r=t.call(this,e))._parameters={width:a,height:o,horizontalSegments:Math.floor(s),verticalSegments:Math.floor(u)},r.halfWidth=r._parameters.width/2,r.halfHeight=r._parameters.height/2,r.initialize(e),r}return r(i,[{key:"initialize",value:function(e){for(var t=this._parameters,n=t.verticalSegments,i=t.horizontalSegments,r=0,a=0,o=[],s=new Float32Array((n+1)*(i+1)*8),u=new Uint16Array(n*i*6),l=0;l<=n;l++){for(var c=[],h=l/n,d=0;d<=i;d++){var f=d/i,_=f*this._parameters.width-this.halfWidth,p=h*this._parameters.height-this.halfHeight;s[a++]=_,s[a++]=p,s[a++]=0,s[a++]=0,s[a++]=0,s[a++]=1,s[a++]=f,s[a++]=1-h,c.push(r++)}o.push(c)}r=0;for(var v=0;v<n;v++)for(var m=0;m<i;m++){var g=o[v][m+1],y=o[v][m],x=o[v+1][m],T=o[v+1][m+1];u[r++]=g,u[r++]=x,u[r++]=y,u[r++]=g,u[r++]=T,u[r++]=x}this._initialize(e,s,u)}}]),i}(hi),pi=function(t){l(a,t);var i=m(a);function a(t){var r,o=arguments.length>1&&void 0!==arguments[1]?arguments[1]:1,s=arguments.length>2&&void 0!==arguments[2]?arguments[2]:1,u=arguments.length>3&&void 0!==arguments[3]?arguments[3]:1,l=arguments.length>4&&void 0!==arguments[4]?arguments[4]:8,c=arguments.length>5&&void 0!==arguments[5]?arguments[5]:1,h=arguments.length>6&&void 0!==arguments[6]&&arguments[6],d=arguments.length>7&&void 0!==arguments[7]?arguments[7]:0,f=arguments.length>8&&void 0!==arguments[8]?arguments[8]:2*Math.PI,_=arguments.length>9&&void 0!==arguments[9]?arguments[9]:e.FrontFace.CCW;return n(this,a),(r=i.call(this,t)).FrontFace=_,r._parameters={radiusTop:o,radiusBottom:s,height:u,radialSegments:l,heightSegments:c,openEnded:h,thetaStart:d,thetaLength:f},r._vertices=[],r._indices=[],r.index=0,r.indexArray=[],r.halfHeight=r._parameters.height/2,r.generateTorso(),!1===r._parameters.openEnded&&(r._parameters.radiusTop>0&&r.generateCap(!0),r._parameters.radiusBottom>0&&r.generateCap(!1)),r._initialize(t,Float32Array.from(r._vertices),Uint16Array.from(r._indices)),r}return r(a,[{key:"generateTorso",value:function(){var t,n,i=this._parameters,r=i.radialSegments,a=i.heightSegments,o=i.radiusBottom,s=i.radiusTop,u=i.height,l=new w,c=(o-s)/u;for(n=0;n<=a;n++){var h=[],d=n/a,f=d*(o-s)+s;for(t=0;t<=r;t++){var _=t/r,p=_*this._parameters.thetaLength+this._parameters.thetaStart,v=Math.sin(p),m=Math.cos(p),g=f*v,y=-d*u+this.halfHeight,x=f*m;this._vertices.push(g,y,x),l.setValue(v,c,m),l.normalize(),this._vertices.push(l.x,l.y,l.z),this.FrontFace===e.FrontFace.CCW?this._vertices.push(_,d):this._vertices.push(1-_,d),h.push(this.index++)}this.indexArray.push(h)}for(t=0;t<r;t++)for(n=0;n<a;n++){var T=this.indexArray[n][t],A=this.indexArray[n+1][t],S=this.indexArray[n+1][t+1],E=this.indexArray[n][t+1];this._indices.push(T,A,E),this._indices.push(A,S,E)}}},{key:"generateCap",value:function(e){var t,n=this._parameters.radialSegments,i=!0===e?this._parameters.radiusTop:this._parameters.radiusBottom,r=!0===e?1:-1,a=this.index;for(t=1;t<=n;t++)this._vertices.push(0,this.halfHeight*r,0),this._vertices.push(0,r,0),this._vertices.push(.5,.5),this.index++;var o=this.index;for(t=0;t<=n;t++){var s=t/n*this._parameters.thetaLength+this._parameters.thetaStart,u=Math.cos(s),l=Math.sin(s),c=i*l,h=this.halfHeight*r,d=i*u;this._vertices.push(c,h,d),this._vertices.push(0,r,0);var f=.5*u+.5,_=.5*l*r+.5;this._vertices.push(f,_),this.index++}for(t=0;t<n;t++){var p=a+t,v=o+t;!0===e?this._indices.push(v,v+1,p):this._indices.push(v+1,v,p)}}}]),a}(hi),vi=function(e){l(i,e);var t=m(i);function i(e){var r,a=arguments.length>1&&void 0!==arguments[1]?arguments[1]:{};n(this,i),(r=t.call(this,e)).radius=1,r.segments=16,r.thetaStart=0,r.thetaLength=2*Math.PI,r.radius=a.radius||r.radius,r.segments=a.segments||r.segments,r.thetaStart=a.thetaStart||r.thetaStart,r.thetaLength=a.thetaLength||r.thetaLength;var o=p(r),s=o.segments,u=o.radius,l=new Float32Array(8*(s+2));l.set([0,0,0,0,0,1,.5,.5]);for(var c=8,h=0;h<=s;h++){var d=r.thetaStart+h/s*r.thetaLength,f=u*Math.cos(d),_=u*Math.sin(d);l[c++]=f,l[c++]=_,l[c++]=0,l[c++]=0,l[c++]=0,l[c++]=1,l[c++]=.5*(f/u+1),l[c++]=.5*(_/u+1)}var v=new Uint16Array(3*s);c=0;for(var m=1;m<=s;m++)v[c++]=m,v[c++]=m+1,v[c++]=0;return r._initialize(e,l,v),r}return i}(hi),mi=function(t){l(a,t);var i=m(a);function a(t){var r;n(this,a),r=i.call(this,t);var o=new Float32Array([-1,-1,0,0,0,1,-1,0,1,0,1,1,0,1,1,-1,1,0,0,1]),s=new Uint16Array([0,1,2,3]);return r._initialize(t,o,s),r.subGeometry.topology=e.PrimitiveTopology.TriangleFan,r}return r(a,[{key:"_initialize",value:function(t,n,i){var r=[new Ln("POSITION",0,e.VertexElementFormat.Vector3,0),new Ln("TEXCOORD_0",12,e.VertexElementFormat.Vector2,0)];this._initBuffer(t,n,i,20,r)}}]),a}(hi),gi=function(t){l(a,t);var i=m(a);function a(){var e,t=arguments.length>0&&void 0!==arguments[0]?arguments[0]:{},r=arguments.length>1?arguments[1]:void 0;n(this,a),(e=i.call(this,r)).parameters=t;for(var o=e.parameters.radius||1,s=e.parameters.tube||.4,u=Math.floor(e.parameters.radialSegments)||8,l=Math.floor(e.parameters.tubularSegments)||6,c=e.parameters.arc||2*Math.PI,h=new Float32Array((u+1)*(l+1)*3),d=new Uint16Array(u*l*6),f=0,_=0;_<=u;_++)for(var p=0;p<=l;p++){var v=p/l*c,m=_/u*Math.PI*2;h[f++]=(o+s*Math.cos(m))*Math.cos(v),h[f++]=(o+s*Math.cos(m))*Math.sin(v),h[f++]=s*Math.sin(m)}f=0;for(var g=1;g<=u;g++)for(var y=1;y<=l;y++){var x=(l+1)*g+y-1,T=(l+1)*(g-1)+y-1,A=(l+1)*(g-1)+y,S=(l+1)*g+y;d[f++]=x,d[f++]=T,d[f++]=S,d[f++]=T,d[f++]=A,d[f++]=S}return e._initialize(r,h,d),e}return r(a,[{key:"_initialize",value:function(t,n,i){var r=[new Ln("POSITION",0,e.VertexElementFormat.Vector3,0)];this._initBuffer(t,n,i,12,r)}}]),a}(hi),yi=function(e){l(i,e);var t=m(i);function i(e){return n(this,i),t.call(this,e)}return r(i,[{key:"geometryType",set:function(e){switch(e){case"Sphere":var t=this._props,n=t.sphereRadius,i=t.sphereHorizontalSegments,r=t.sphereVerticalSegments,a=t.sphereAlphaStart,o=t.sphereAlphaRange,s=t.sphereThetaStart,u=t.sphereThetaRange;this.geometry=new fi(this.engine,n,i,r,a,o,s,u);break;case"Cylinder":var l=this._props,c=l.cylinderRadiusTop,h=l.cylinderRadiusBottom,d=l.cylinderHeight,f=l.cylinderRadialSegments,_=l.cylinderHeightSegments,p=l.cylinderOpenEnded;this.geometry=new pi(this.engine,c,h,d,f,_,p,void 0,void 0,void 0);break;case"Plane":var v=this._props,m=v.planeWidth,g=v.planeHeight,y=v.planeHorizontalSegments,x=v.planeVerticalSegments;this.geometry=new _i(this.engine,m,g,y,x);break;case"Box":var T=this._props,A=T.boxWidth,S=T.boxHeight,E=T.boxDepth;this.geometry=new di(this.engine,A,S,E)}this._geometryType=e},get:function(){return this._geometryType}}]),r(i,[{key:"init",value:function(e){this._props=e;var t=e.geometryType,n=void 0===t?si.Box:t;this.material=e.material,this.geometryType=n}},{key:"setProp",value:function(e,t){this._props[e]=t,"material"===e?this.material=t:this.geometryType=this._props.geometryType}},{key:"material",get:function(){return this._material},set:function(e){this._material=e||new ti(this.engine,"mtl")}}]),i}(ci);(ui=si||(si={})).Box="Box",ui.Cylinder="Cylinder",ui.Plane="Plane",ui.Sphere="Sphere";var xi=function(e){l(i,e);var t=m(i);function i(e){var r=arguments.length>1&&void 0!==arguments[1]?arguments[1]:i.defaultName;return n(this,i),t.call(this,e,r)}return r(i,[{key:"setModel",value:function(e){this.modelMatrix=e}},{key:"prepareDrawing",value:function(e,t){null===this._technique&&this._generateTechnique(),this._cacheMat1||(this._cacheMat1=new F,this._cacheMat2=new F);var n=e.viewMatrix,r=e.projectionMatrix;F.multiply(n,this.modelMatrix,this._cacheMat1);var a=this._cacheMat1.elements;a[12]=a[13]=a[14]=0,F.multiply(r,this._cacheMat1,this._cacheMat2),this.setValue("u_mvpNoscale",this._cacheMat2),g(c(i.prototype),"prepareDrawing",this).call(this,e,t,void 0)}},{key:"_generateTechnique",value:function(){var e=new In(i.techniqueName);e.isValid=!0,e.uniforms=i.techniqueConfig.uniforms,e.attributes=i.techniqueConfig.attributes,e.states=i.techniqueConfig.states,e.vertexShader=i.vertexShader,e.fragmentShader=i.fragmentShader,this._technique=e}}]),i}(xn);xi.defaultName="SKY_BOX_MATERIAL",xi.techniqueName="SKY_BOX_TECHNIQUE",xi.vertexShader="#include <common_vert>\n\nuniform mat4 u_mvpNoscale;\n\nvarying vec3 v_cubeUV;\n\nvoid main() {\n\n    v_cubeUV = a_position.xyz;\n    gl_Position = u_mvpNoscale * vec4( a_position, 1.0 );\n    gl_Position.z = gl_Position.w;\n\n}\n",xi.fragmentShader="uniform samplerCube u_cube;\n\nvarying vec3 v_cubeUV;\n\nvoid main() {\n\n    gl_FragColor = textureCube( u_cube, v_cubeUV );\n\n}\n",xi.techniqueConfig={attributes:{},uniforms:{u_mvpNoscale:{name:"u_mvpNoscale",type:e.DataType.FLOAT_MAT4},u_cube:{name:"u_cube",type:e.DataType.SAMPLER_CUBE}},states:{disable:[e.RenderState.CULL_FACE],functions:{depthFunc:e.CompFunc.LEQUAL}}};var Ti=function(e){l(i,e);var t=m(i);function i(e){var r;return n(this,i),(r=t.call(this,e)).geometry=new di(r.engine,2,2,2),r.material=new xi(r.engine),r}return r(i,[{key:"update",value:function(){this.material.setModel(this.entity.transform.worldMatrix)}},{key:"render",value:function(e){this._skyBoxMap&&g(c(i.prototype),"render",this).call(this,e)}},{key:"skyBoxMap",get:function(){return this._skyBoxMap},set:function(e){this._skyBoxMap=e,this.material.setValue("u_cube",e)}}]),i}(ci),Ai=function(t){l(a,t);var i=m(a);function a(e){var t,r=arguments.length>1&&void 0!==arguments[1]?arguments[1]:a.MATERIAL_NAME,o=arguments.length>2&&void 0!==arguments[2]?arguments[2]:{};return n(this,a),(t=i.call(this,e,r)).createDefaulteValues(),t.setUniforms(o),t.setStates(o),t}return r(a,[{key:"createDefaulteValues",value:function(){var t=this;this._uniformObj={baseColorFactor:new U(1,1,1,1),metallicFactor:1,roughnessFactor:1,metallicRoughness:new z(1,1),normalScale:1,emissiveFactor:new w(0,0,0),occlusionStrength:1,alphaCutoff:.5,specularFactor:new w(1,1,1),glossinessFactor:0,envMapIntensity:1,refractionRatio:1/1.33,refractionDepth:1,perturbationUOffset:0,perturbationVOffset:0},this._stateObj={alphaMode:"OPAQUE",doubleSided:!1,side:e.Side.FRONT,unlit:!1,srgb:!1,srgbFast:!1,gamma:!1,blendFunc:[],blendFuncSeparate:[e.BlendFunc.SRC_ALPHA,e.BlendFunc.ONE_MINUS_SRC_ALPHA,e.BlendFunc.ONE,e.BlendFunc.ONE],depthMask:[!1],getOpacityFromRGB:!1,isMetallicWorkflow:!0,envMapModeRefract:!1},Object.keys(this._uniformObj).forEach((function(e){return t.setValueByParamName(e,t._uniformObj[e])}))}},{key:"setUniforms",value:function(e){var t=this;Object.keys(e).forEach((function(n){switch(n){case"baseColorFactor":t.baseColorFactor=e[n];break;case"opacity":t.opacity=e[n];break;case"opacityTexture":t.opacityTexture=e[n];break;case"baseColorTexture":t.baseColorTexture=e[n];break;case"metallicFactor":t.metallicFactor=e[n];break;case"roughnessFactor":t.roughnessFactor=e[n];break;case"metallicTexture":t.metallicTexture=e[n];break;case"roughnessTexture":t.roughnessTexture=e[n];break;case"metallicRoughnessTexture":t.metallicRoughnessTexture=e[n];break;case"normalTexture":t.normalTexture=e[n];break;case"normalScale":t.normalScale=e[n];break;case"emissiveTexture":t.emissiveTexture=e[n];break;case"emissiveFactor":t.emissiveFactor=e[n];break;case"occlusionTexture":t.occlusionTexture=e[n];break;case"occlusionStrength":t.occlusionStrength=e[n];break;case"alphaCutoff":t.alphaCutoff=e[n];break;case"specularFactor":t.specularFactor=e[n];break;case"glossinessFactor":t.glossinessFactor=e[n];break;case"specularGlossinessTexture":t.specularGlossinessTexture=e[n];break;case"reflectionTexture":t.reflectionTexture=e[n];break;case"envMapIntensity":t.envMapIntensity=e[n];break;case"refractionRatio":t.refractionRatio=e[n];break;case"refractionDepth":t.refractionDepth=e[n];break;case"refractionTexture":t.refractionTexture=e[n];break;case"perturbationTexture":t.perturbationTexture=e[n];break;case"perturbationUOffset":t.perturbationUOffset=e[n];break;case"perturbationVOffset":t.perturbationVOffset=e[n]}}))}},{key:"setStates",value:function(e){var t=this;Object.keys(e).forEach((function(n){switch(n){case"doubleSided":t.doubleSided=e[n];break;case"side":t.side=e[n];break;case"alphaMode":t.alphaMode=e[n];break;case"unlit":t.unlit=e[n];break;case"srgb":t.srgb=e[n];break;case"srgbFast":t.srgbFast=e[n];break;case"gamma":t.gamma=e[n];break;case"blendFunc":t.blendFunc=e[n];break;case"blendFuncSeparate":t.blendFuncSeparate=e[n];break;case"depthMask":t.depthMask=e[n];break;case"getOpacityFromRGB":t.getOpacityFromRGB=e[n];break;case"isMetallicWorkflow":t.isMetallicWorkflow=e[n];break;case"envMapModeRefract":t.envMapModeRefract=e[n]}}))}},{key:"setValueByParamName",value:function(e,t){var n=a.TECH_CONFIG.uniforms,i=Object.keys(n).find((function(t){return n[t].paramName===e}));i&&this.setValue(i,t)}},{key:"updateTechnique",value:function(t,n){var i;if(this[t]!==n){this._stateObj[t]=n;var r=null===(i=this.technique)||void 0===i?void 0:i.states;if(r)switch(t){case"doubleSided":case"side":if(this.doubleSided)r.disable.push(e.RenderState.CULL_FACE);else{var a=r.disable.indexOf(e.RenderState.CULL_FACE);switch(a>-1&&r.disable.splice(a,1),this.side){case e.Side.FRONT:r.functions.cullFace=[e.CullFace.BACK];break;case e.Side.BACK:r.functions.cullFace=[e.CullFace.FRONT];break;case e.Side.NONE:r.functions.cullFace=[e.CullFace.FRONT_AND_BACK];break;default:delete r.functions.cullFace}}break;case"blendFunc":case"blendFuncSeparate":this.blendFunc.length?r.functions.blendFunc=this.blendFunc:r.functions.blendFuncSeparate=this.blendFuncSeparate;break;case"depthMask":r.functions.depthMask=n;break;default:this._technique=null}}}},{key:"prepareDrawing",value:function(e,t,n){var i,r=e.camera,o=r.scene,s=o.engine.canvas,u=o.findFeature(Vt),l=r._renderPipeline.canOIT;u.bindMaterialValues(this),this.setValue("u_resolution",new z(s.width,s.height));for(var h=0;h<this._clipPlaneCount;h++)this.setValue("u_clipPlanes[".concat(h,"]"),o.clipPlanes[h]);l&&this.setValue("u_depthSampler",r._renderPipeline.depthTexture);var d,f=u.lightSortAmount,_=f.ambientLightCount,p=f.directLightCount,v=f.pointLightCount,m=f.spotLightCount,y=f.envMapLightCount,x=f.useDiffuseEnv,T=f.useSpecularEnv;this._technique&&this._ambientLightCount===_&&this._envMapLightCount===y&&this._useDiffuseEnv===x&&this._useSpecularEnv===T&&this._directLightCount===p&&this._pointLightCount===v&&this._spotLightCount===m&&this._clipPlaneCount===(null===(i=o.clipPlanes)||void 0===i?void 0:i.length)&&this._useOIT===l||(this._ambientLightCount=_,this._envMapLightCount=y,this._useDiffuseEnv=x,this._useSpecularEnv=T,this._directLightCount=p,this._pointLightCount=v,this._spotLightCount=m,this._clipPlaneCount=null===(d=o.clipPlanes)||void 0===d?void 0:d.length,this._useOIT=l,this._generateTechnique(r,t,n));g(c(a.prototype),"prepareDrawing",this).call(this,e,t,n)}},{key:"_generateTechnique",value:function(e,t,n){var i=this._generateShaderMacros(e,t,n),r=a.TECHNIQUE_NAME,o=a.STATIC_VERTEX_SHADER,s=a.STATIC_FRAGMENT_SHADER,l=this._generateConfig(),c=e.scene.findFeature(Vt),h=new In(r);return h.isValid=!0,h.uniforms=u(u({},c.getUniformDefine()),l.uniforms),h.attributes=l.attributes,h.fragmentPrecision="highp",h.customMacros=i,h.states=l.states,h.vertexShader=o,h.fragmentShader=s,this._technique=h,h}},{key:"_generateShaderMacros",value:function(t,n,i){var r=t.scene.engine._hardwareRenderer,a=["O3_NEED_WORLDPOS"];i._vertexElementMap.NORMAL&&i._vertexElementMap.TANGENT||r.canIUse(e.GLCapabilityType.standardDerivatives)&&a.push("HAS_DERIVATIVES");var o=Object.keys(this._values);return o.indexOf("u_baseColorSampler")>-1&&a.push("HAS_BASECOLORMAP"),o.indexOf("u_normalSampler")>-1&&a.push("O3_HAS_NORMALMAP"),o.indexOf("u_metallicSampler")>-1&&a.push("HAS_METALMAP"),o.indexOf("u_roughnessSampler")>-1&&a.push("HAS_ROUGHNESSMAP"),o.indexOf("u_metallicRoughnessSampler")>-1&&a.push("HAS_METALROUGHNESSMAP"),o.indexOf("u_emissiveSampler")>-1&&a.push("HAS_EMISSIVEMAP"),o.indexOf("u_occlusionSampler")>-1&&a.push("HAS_OCCLUSIONMAP"),o.indexOf("u_specularGlossinessSampler")>-1&&a.push("HAS_SPECULARGLOSSINESSMAP"),o.indexOf("u_perturbationSampler")>-1&&a.push("HAS_PERTURBATIONMAP"),o.indexOf("u_reflectionSampler")>-1&&a.push("HAS_REFLECTIONMAP"),o.indexOf("u_refractionSampler")>-1&&(this.setValueByParamName("PTMMatrix",new F(.5,0,0,0,0,.5,0,0,0,0,.5,0,.5,.5,.5,1)),a.push("HAS_REFRACTIONMAP")),"MASK"===this.alphaMode?a.push("ALPHA_MASK"):"BLEND"!==this.alphaMode||this.refractionTexture||(a.push("ALPHA_BLEND"),o.indexOf("u_opacitySampler")>-1&&(a.push("HAS_OPACITYMAP"),this.getOpacityFromRGB&&a.push("GETOPACITYFROMRGB"))),this._envMapLightCount&&(a.push("O3_HAS_ENVMAP_LIGHT"),this._useDiffuseEnv&&a.push("O3_USE_DIFFUSE_ENV"),this._useSpecularEnv&&a.push("O3_USE_SPECULAR_ENV"),r.canIUse(e.GLCapabilityType.shaderTextureLod)&&a.push("HAS_TEX_LOD")),this._ambientLightCount&&a.push("O3_HAS_AMBIENT_LIGHT"),this._directLightCount&&a.push("O3_DIRECT_LIGHT_COUNT ".concat(this._directLightCount)),this._pointLightCount&&a.push("O3_POINT_LIGHT_COUNT ".concat(this._pointLightCount)),this._spotLightCount&&a.push("O3_SPOT_LIGHT_COUNT ".concat(this._spotLightCount)),this._clipPlaneCount&&a.push("O3_CLIPPLANE_NUM ".concat(this._clipPlaneCount)),this._stateObj.unlit&&a.push("UNLIT"),this._stateObj.srgb&&a.push("MANUAL_SRGB"),this._stateObj.srgbFast&&a.push("SRGB_FAST_APPROXIMATION"),this._stateObj.gamma&&a.push("GAMMA"),this._stateObj.isMetallicWorkflow&&a.push("IS_METALLIC_WORKFLOW"),this._stateObj.envMapModeRefract&&a.push("ENVMAPMODE_REFRACT"),t._renderPipeline.canOIT&&a.push("OIT_ENABLE"),a}},{key:"_generateConfig",value:function(){var t=a.TECH_CONFIG.states,n={disable:t.disable.slice(),enable:t.enable.slice(),functions:o({},t.functions)};if(this.doubleSided)n.disable.push(e.RenderState.CULL_FACE);else switch(this.side){case e.Side.FRONT:n.functions.cullFace=[e.CullFace.BACK];break;case e.Side.BACK:n.functions.cullFace=[e.CullFace.FRONT];break;case e.Side.NONE:n.functions.cullFace=[e.CullFace.FRONT_AND_BACK];break;default:delete n.functions.cullFace}"BLEND"!==this.alphaMode||this.refractionTexture?this.renderType=e.MaterialType.OPAQUE:(n.enable.push(e.RenderState.BLEND),this.blendFunc.length?n.functions.blendFunc=this._stateObj.blendFunc:n.functions.blendFuncSeparate=this._stateObj.blendFuncSeparate,n.functions.depthMask=this._stateObj.depthMask,this.renderType=e.MaterialType.TRANSPARENT);for(var i={},r=0;r<this._clipPlaneCount;r++)i["u_clipPlanes[".concat(r,"]")]={name:"u_clipPlanes[".concat(r,"]"),type:e.DataType.FLOAT_VEC4};return a.TECH_CONFIG.uniforms=o({},a.TECH_CONFIG.uniforms,i),o({},a.TECH_CONFIG,{states:n})}},{key:"clone",value:function(e){var t=new a(this._engine,e||this.name);for(var n in t.renderType=this.renderType,t.useFog=this.useFog,this._uniformObj){var i=this._uniformObj[n];t[n]=i instanceof cn?i:H.clone(i)}return this._stateObj&&(t._stateObj=H.clone(this._stateObj)),t}},{key:"baseColorFactor",get:function(){return this._uniformObj.baseColorFactor},set:function(e){this._uniformObj.baseColorFactor=e,this.setValueByParamName("baseColorFactor",e)}},{key:"opacity",get:function(){return this.baseColorFactor.w},set:function(e){this.baseColorFactor.w=e}},{key:"baseColorTexture",get:function(){return this._uniformObj.baseColorTexture},set:function(e){this.setValueByParamName("baseColorTexture",e),this._uniformObj.baseColorTexture=e}},{key:"opacityTexture",get:function(){return this._uniformObj.opacityTexture},set:function(e){this.setValueByParamName("opacityTexture",e),this._uniformObj.opacityTexture=e}},{key:"metallicFactor",get:function(){return this._uniformObj.metallicFactor},set:function(e){this._uniformObj.metallicFactor=e,this._uniformObj.metallicRoughness.x=e,this.setValueByParamName("metallicRoughness",this._uniformObj.metallicRoughness)}},{key:"roughnessFactor",get:function(){return this._uniformObj.roughnessFactor},set:function(e){this._uniformObj.roughnessFactor=e,this._uniformObj.metallicRoughness.y=e,this.setValueByParamName("metallicRoughness",this._uniformObj.metallicRoughness)}},{key:"metallicTexture",get:function(){return this._uniformObj.metallicTexture},set:function(e){this.setValueByParamName("metallicTexture",e),this._uniformObj.metallicTexture=e}},{key:"roughnessTexture",get:function(){return this._uniformObj.roughnessTexture},set:function(e){this.setValueByParamName("roughnessTexture",e),this._uniformObj.roughnessTexture=e}},{key:"metallicRoughnessTexture",get:function(){return this._uniformObj.metallicRoughnessTexture},set:function(e){this.setValueByParamName("metallicRoughnessTexture",e),this._uniformObj.metallicRoughnessTexture=e}},{key:"normalTexture",get:function(){return this._uniformObj.normalTexture},set:function(e){this.setValueByParamName("normalTexture",e),this._uniformObj.normalTexture=e}},{key:"normalScale",get:function(){return this._uniformObj.normalScale},set:function(e){this._uniformObj.normalScale=e,this.setValueByParamName("normalScale",e)}},{key:"emissiveTexture",get:function(){return this._uniformObj.emissiveTexture},set:function(e){this.setValueByParamName("emissiveTexture",e),this._uniformObj.emissiveTexture=e}},{key:"emissiveFactor",get:function(){return this._uniformObj.emissiveFactor},set:function(e){this._uniformObj.emissiveFactor=e,this.setValueByParamName("emissiveFactor",e)}},{key:"occlusionTexture",get:function(){return this._uniformObj.occlusionTexture},set:function(e){this.setValueByParamName("occlusionTexture",e),this._uniformObj.occlusionTexture=e}},{key:"occlusionStrength",get:function(){return this._uniformObj.occlusionStrength},set:function(e){this._uniformObj.occlusionStrength=e,this.setValueByParamName("occlusionStrength",e)}},{key:"alphaCutoff",get:function(){return this._uniformObj.alphaCutoff},set:function(e){this._uniformObj.alphaCutoff=e,this.setValueByParamName("alphaCutoff",e)}},{key:"specularFactor",get:function(){return this._uniformObj.specularFactor},set:function(e){this.setValueByParamName("specularFactor",e),this._uniformObj.specularFactor=e}},{key:"glossinessFactor",get:function(){return this._uniformObj.glossinessFactor},set:function(e){this.setValueByParamName("glossinessFactor",e),this._uniformObj.glossinessFactor=e}},{key:"specularGlossinessTexture",get:function(){return this._uniformObj.specularGlossinessTexture},set:function(e){this.setValueByParamName("specularGlossinessTexture",e),this._uniformObj.specularGlossinessTexture=e}},{key:"reflectionTexture",get:function(){return this._uniformObj.reflectionTexture},set:function(e){this.setValueByParamName("reflectionTexture",e),this._uniformObj.reflectionTexture=e}},{key:"envMapIntensity",get:function(){return this._uniformObj.envMapIntensity},set:function(e){this.setValueByParamName("envMapIntensity",e),this._uniformObj.envMapIntensity=e}},{key:"refractionRatio",get:function(){return this._uniformObj.refractionRatio},set:function(e){this.setValueByParamName("refractionRatio",e),this._uniformObj.refractionRatio=e}},{key:"refractionDepth",get:function(){return this._uniformObj.refractionDepth},set:function(e){this.setValueByParamName("refractionDepth",e),this._uniformObj.refractionDepth=e}},{key:"refractionTexture",get:function(){return this._uniformObj.refractionTexture},set:function(e){this.setValueByParamName("refractionTexture",e),this._uniformObj.refractionTexture=e}},{key:"perturbationTexture",get:function(){return this._uniformObj.perturbationTexture},set:function(e){this.setValueByParamName("perturbationTexture",e),this._uniformObj.perturbationTexture=e}},{key:"perturbationUOffset",get:function(){return this._uniformObj.perturbationUOffset},set:function(e){this.setValueByParamName("perturbationUOffset",e),this._uniformObj.perturbationUOffset=e}},{key:"perturbationVOffset",get:function(){return this._uniformObj.perturbationVOffset},set:function(e){this.setValueByParamName("perturbationVOffset",e),this._uniformObj.perturbationVOffset=e}},{key:"alphaMode",get:function(){return this._stateObj.alphaMode},set:function(e){this.updateTechnique("alphaMode",e)}},{key:"doubleSided",get:function(){return this._stateObj.doubleSided},set:function(t){t?this._stateObj.side=e.Side.DOUBLE:this._stateObj.side===e.Side.DOUBLE&&(this._stateObj.side=e.Side.FRONT),this.updateTechnique("doubleSided",t)}},{key:"side",get:function(){return this._stateObj.side},set:function(t){t===e.Side.DOUBLE?this._stateObj.doubleSided=!0:this._stateObj.doubleSided=!1,this.updateTechnique("side",t)}},{key:"unlit",get:function(){return this._stateObj.unlit},set:function(e){this.updateTechnique("unlit",e)}},{key:"srgb",get:function(){return this._stateObj.srgb},set:function(e){this.updateTechnique("srgb",e)}},{key:"srgbFast",get:function(){return this._stateObj.srgbFast},set:function(e){this.updateTechnique("srgbFast",e)}},{key:"gamma",get:function(){return this._stateObj.gamma},set:function(e){this.updateTechnique("gamma",e)}},{key:"blendFunc",get:function(){return this._stateObj.blendFunc},set:function(e){this.updateTechnique("blendFunc",e)}},{key:"blendFuncSeparate",get:function(){return this._stateObj.blendFuncSeparate},set:function(e){this.updateTechnique("blendFuncSeparate",e)}},{key:"depthMask",get:function(){return this._stateObj.depthMask},set:function(e){this.updateTechnique("depthMask",e)}},{key:"getOpacityFromRGB",get:function(){return this._stateObj.getOpacityFromRGB},set:function(e){this.updateTechnique("getOpacityFromRGB",e)}},{key:"isMetallicWorkflow",get:function(){return this._stateObj.isMetallicWorkflow},set:function(e){this.updateTechnique("isMetallicWorkflow",e)}},{key:"envMapModeRefract",get:function(){return this._stateObj.envMapModeRefract},set:function(e){this.updateTechnique("envMapModeRefract",e)}}]),a}(xn);Ai.MATERIAL_NAME="PBR_MATERIAL",Ai.TECHNIQUE_NAME="PBR_TECHNIQUE",Ai.STATIC_VERTEX_SHADER="#include <common>\n#include <common_vert>\n#include <uv_share>\n#include <color_share>\n#include <normal_share>\n#include <worldpos_share>\n#include <clipPlane_vert_define>\n#include <morph_target_vert>\n\n#include <fog_share>\n\nvoid main() {\n\n    #include <begin_position_vert>\n    #include <begin_normal_vert>\n\n    #include <morph_vert>\n    #include <skinning_vert>\n    #include <uv_vert>\n    #include <color_vert>\n    #include <normal_vert>\n    #include <worldpos_vert>\n    #include <clipPlane_vert>\n    #include <position_vert>\n\n    #include <fog_vert>\n}\n",Ai.STATIC_FRAGMENT_SHADER="#include <common>\n#include <common_frag>\n#include <pbr_common_frag_define>\n#include <pbr_util_frag_define>\n\n#include <fog_share>\n\n#include <uv_share>\n#include <normal_share>\n#include <color_share>\n#include <worldpos_share>\n#include <refraction_share>\n#include <perturbation_share>\n#include <clipPlane_frag_define>\n\n// light\n#include <ambient_light_frag>\n#include <direct_light_frag>\n#include <point_light_frag>\n#include <spot_light_frag>\n#include <pbr_envmap_light_frag_define>\n\n// prop & texture\n#include <pbr_base_frag_define>\n#include <pbr_texture_frag_define>\n\n// runtime context\n#include <pbr_runtime_frag_define>\n\n// todo: generalize\n#include <pbr_normal_frag_define>\n\n\n// todo: BxDF\n#include <pbr_brdf_cook_torrance_frag_define>\n\n\n// direct + indirect\n#include <pbr_direct_irradiance_frag_define>\n#include <pbr_ibl_diffuse_frag_define>\n#include <pbr_ibl_specular_frag_define>\n\n#include <oit_frag_define>\n\n\nvoid main() {\n    #include <clipPlane_frag>\n\n    #include <pbr_begin_frag>\n    #include <pbr_direct_irradiance_frag>\n    #include <pbr_ibl_diffuse_frag>\n    #include <pbr_ibl_specular_frag>\n    // todo: generalize texture logic\n    #include <pbr_end_frag>\n    #include <gamma_frag>\n    #include <refraction_frag>\n    #include <perturbation_frag>\n    #include <fog_frag>\n\n    #include <oit_frag>\n\n    // gl_FragColor = texture2D( u_baseColorSampler, v_uv );\n}\n",Ai.attribUniformVec4=12,Ai.TECH_CONFIG={attributes:{},uniforms:o({u_baseColorSampler:{name:"u_baseColorSampler",paramName:"baseColorTexture",type:e.DataType.SAMPLER_2D},u_baseColorFactor:{name:"u_baseColorFactor",paramName:"baseColorFactor",type:e.DataType.FLOAT_VEC4},u_normalSampler:{name:"u_normalSampler",paramName:"normalTexture",type:e.DataType.SAMPLER_2D},u_normalScale:{name:"u_normalScale",paramName:"normalScale",type:e.DataType.FLOAT},u_lightDirection:{name:"u_lightDirection",type:e.DataType.FLOAT_VEC3},u_lightColor:{name:"u_lightColor",type:e.DataType.FLOAT_VEC3},u_metallicRoughnessValue:{name:"u_metallicRoughnessValue",paramName:"metallicRoughness",type:e.DataType.FLOAT_VEC2},u_metallicSampler:{name:"u_metallicSampler",paramName:"metallicTexture",type:e.DataType.SAMPLER_2D},u_roughnessSampler:{name:"u_roughnessSampler",paramName:"roughnessTexture",type:e.DataType.SAMPLER_2D},u_metallicRoughnessSampler:{name:"u_metallicRoughnessSampler",paramName:"metallicRoughnessTexture",type:e.DataType.SAMPLER_2D},u_emissiveFactor:{name:"u_emissiveFactor",paramName:"emissiveFactor",type:e.DataType.FLOAT_VEC3},u_emissiveSampler:{name:"u_emissiveSampler",paramName:"emissiveTexture",type:e.DataType.SAMPLER_2D},u_occlusionSampler:{name:"u_occlusionSampler",paramName:"occlusionTexture",type:e.DataType.SAMPLER_2D},u_occlusionStrength:{name:"u_occlusionStrength",paramName:"occlusionStrength",type:e.DataType.FLOAT},u_alphaCutoff:{name:"u_alphaCutoff",paramName:"alphaCutoff",type:e.DataType.FLOAT},u_opacitySampler:{name:"u_opacitySampler",paramName:"opacityTexture",type:e.DataType.SAMPLER_2D},u_specularFactor:{name:"u_specularFactor",paramName:"specularFactor",type:e.DataType.FLOAT_VEC3},u_glossinessFactor:{name:"u_glossinessFactor",paramName:"glossinessFactor",type:e.DataType.FLOAT},u_specularGlossinessSampler:{name:"u_specularGlossinessSampler",paramName:"specularGlossinessTexture",type:e.DataType.SAMPLER_2D},u_reflectionSampler:{name:"u_reflectionSampler",paramName:"reflectionTexture",type:e.DataType.SAMPLER_CUBE},u_PTMMatrix:{name:"u_PTMMatrix",paramName:"PTMMatrix",type:e.DataType.FLOAT_MAT4},u_envMapIntensity:{name:"u_envMapIntensity",paramName:"envMapIntensity",type:e.DataType.FLOAT},u_refractionRatio:{name:"u_refractionRatio",paramName:"refractionRatio",type:e.DataType.FLOAT},u_refractionDepth:{name:"u_refractionDepth",paramName:"refractionDepth",type:e.DataType.FLOAT},u_refractionSampler:{name:"u_refractionSampler",paramName:"refractionTexture",type:e.DataType.SAMPLER_2D},u_resolution:{name:"u_resolution",paramName:"resolution",type:e.DataType.FLOAT_VEC2},u_perturbationSampler:{name:"u_perturbationSampler",paramName:"perturbationTexture",type:e.DataType.SAMPLER_2D},u_perturbationUOffset:{name:"u_perturbationUOffset",paramName:"perturbationUOffset",type:e.DataType.FLOAT},u_perturbationVOffset:{name:"u_perturbationVOffset",paramName:"perturbationVOffset",type:e.DataType.FLOAT},u_depthSampler:{name:"u_depthSampler",type:e.DataType.SAMPLER_2D}}),states:{disable:[],enable:[],functions:{}}};var Si=function(t){l(a,t);var i=m(a);function a(e){var t;return n(this,a),(t=i.call(this,e))._time=0,t._isInit=!1,t._isStart=!1,t}return r(a,[{key:"initialize",value:function(t){this.maxCount=void 0!==t.maxCount?t.maxCount:1e3,this.once=t.once||!1,this.options=t.options||{},this.getOptions=t.getOptions,this.rotateToVelocity=t.rotateToVelocity||!1,t.blendFuncSeparate&&(this.blendFuncSeparate=t.blendFuncSeparate),this.blendFunc=t.blendFunc||[e.BlendFunc.SRC_ALPHA,e.BlendFunc.ONE_MINUS_SRC_ALPHA],this.useOriginColor=void 0===t.useOriginColor||t.useOriginColor,this.fragmentShader=t.fragmentShader||null,this.vertexShader=t.vertexShader||null,this.particleTex=t.texture||null,this.fadeIn=t.fadeIn||!1,this.fadeOut=void 0===t.fadeOut||t.fadeOut,this.particleMaskTex=t.maskTexture||null,this.isScaleByLifetime=t.isScaleByLifetime||!1,this.scaleFactor=t.scaleFactor||1,this.spriteSheet=t.spriteSheet||null,this.is2d=void 0===t.is2d||t.is2d,this.interleaved=t.spriteSheet||!0,this.setMaterial(),this.geometry=this._createGeometry(),this._isInit=!0;for(var n=this.getOptions?this.getOptions(this._time):this.options,i=0;i<this.maxCount;i++)this._spawnParticle(n,i);return this._vertexBuffer.setData(this._vertices),this}},{key:"update",value:function(e){this._isInit&&this._isStart&&(this._time+=e/1e3,this.material.setValue("uTime",this._time))}},{key:"setOptions",value:function(e){return void 0!==e&&(this.options=u(u({},this.options),e)),this}},{key:"start",value:function(){this._isStart=!0,this._time=0,this.material.setValue("uActive",1)}},{key:"stop",value:function(){this.material.setValue("uActive",0)}},{key:"destroy",value:function(){g(c(a.prototype),"destroy",this).call(this),this.options=null,this.particleTex&&(this.particleTex=null),this.particleMaskTex&&(this.particleMaskTex=null)}},{key:"setMaterial",value:function(){var t=this._createTechnique(),n=new xn(this.engine,"particleMaterial");n.technique=t,n.renderType=e.MaterialType.TRANSPARENT,n.setValue("uOnce",this.once?1:0),n.setValue("uTime",this._time),this.particleTex&&(this.particleTex.wrapModeU=this.particleTex.wrapModeV=e.TextureWrapMode.Clamp,n.setValue("particleTex",this.particleTex)),this.particleMaskTex&&(this.particleMaskTex.wrapModeU=this.particleTex.wrapModeV=e.TextureWrapMode.Clamp,n.setValue("particleMaskTex",this.particleMaskTex)),this.material=n}},{key:"_createTechnique",value:function(){var t={attributes:{positionStart:{name:"positionStart",semantic:"POSITIONSTART",type:e.DataType.FLOAT_VEC3},color:{name:"color",semantic:"COLOR",type:e.DataType.FLOAT_VEC3},alpha:{name:"alpha",semantic:"ALPHA",type:e.DataType.FLOAT},acceleration:{name:"acceleration",semantic:"ACCELERATION",type:e.DataType.FLOAT_VEC3},velocity:{name:"velocity",semantic:"VELOCITY",type:e.DataType.FLOAT_VEC3},startAngle:{name:"startAngle",semantic:"STARTANGLE",type:e.DataType.FLOAT},lifeTime:{name:"lifeTime",semantic:"LIFETIME",type:e.DataType.FLOAT},startTime:{name:"startTime",semantic:"STARTTIME",type:e.DataType.FLOAT},size:{name:"size",semantic:"SIZE",type:e.DataType.FLOAT},rotateRate:{name:"rotateRate",semantic:"ROTATERATE",type:e.DataType.FLOAT},scaleFactor:{name:"scaleFactor",semantic:"SCALEFACTOR",type:e.DataType.FLOAT},uv:{name:"uv",semantic:"UV",type:e.DataType.FLOAT_VEC3},normalizedUv:{name:"normalizedUv",semantic:"NORMALIZED_UV",type:e.DataType.FLOAT_VEC2}},uniforms:{uOnce:{name:"uOnce",type:e.DataType.FLOAT},uActive:{name:"uActive",type:e.DataType.FLOAT},uTime:{name:"uTime",type:e.DataType.FLOAT},matModelViewProjection:{name:"matModelViewProjection",semantic:e.UniformSemantic.MODELVIEWPROJECTION,type:e.DataType.FLOAT_MAT4},matModelView:{name:"matModelView",semantic:e.UniformSemantic.MODELVIEW,type:e.DataType.FLOAT_MAT4}},states:{enable:[e.RenderState.BLEND],functions:{depthMask:[!1]}}};this.is2d?(t.uniforms.matViewInverse={name:"matViewInverse",semantic:e.UniformSemantic.VIEWINVERSE,type:e.DataType.FLOAT_MAT4},t.uniforms.matProjection={name:"matProjection",semantic:e.UniformSemantic.PROJECTION,type:e.DataType.FLOAT_MAT4},t.uniforms.matView={name:"matView",semantic:e.UniformSemantic.VIEW,type:e.DataType.FLOAT_MAT4},t.uniforms.matWorld={name:"matWorld",semantic:e.UniformSemantic.MODEL,type:e.DataType.FLOAT_MAT4}):t.states.disable=[e.RenderState.CULL_FACE],this.blendFuncSeparate?t.states.functions.blendFuncSeparate=this.blendFuncSeparate:t.states.functions.blendFunc=this.blendFunc,this.particleTex&&(t.uniforms.particleTex={name:"particleTex",type:e.DataType.SAMPLER_2D}),this.particleMaskTex&&(t.uniforms.particleMaskTex={name:"particleMaskTex",type:e.DataType.SAMPLER_2D});var n=new In("particleTech");return n.isValid=!0,n.uniforms=t.uniforms,n.attributes=t.attributes,n.states=t.states,n.vertexShader=this._createVertexShader(),n.fragmentShader=this._createFragmentShader(),n}},{key:"_createGeometry",value:function(){for(var t=new li(this._entity.engine,"particleGeometry"),n=4*this.maxCount*96,i=new Float32Array(n),r=new Uint16Array(6*this.maxCount),a=0,o=0;a<this.maxCount;++a){var s=4*a;r[o++]=s+0,r[o++]=s+1,r[o++]=s+2,r[o++]=s+0,r[o++]=s+2,r[o++]=s+3}var u=[new Ln("POSITIONSTART",0,e.VertexElementFormat.Vector3,0),new Ln("VELOCITY",12,e.VertexElementFormat.Vector3,0),new Ln("ACCELERATION",24,e.VertexElementFormat.Vector3,0),new Ln("COLOR",36,e.VertexElementFormat.Vector3,0),new Ln("ALPHA",48,e.VertexElementFormat.Float,0),new Ln("SIZE",52,e.VertexElementFormat.Float,0),new Ln("ROTATERATE",56,e.VertexElementFormat.Float,0),new Ln("STARTTIME",60,e.VertexElementFormat.Float,0),new Ln("LIFETIME",64,e.VertexElementFormat.Float,0),new Ln("STARTANGLE",68,e.VertexElementFormat.Float,0),new Ln("SCALEFACTOR",72,e.VertexElementFormat.Float,0),new Ln("UV",76,e.VertexElementFormat.Vector3,0),new Ln("NORMALIZED_UV",88,e.VertexElementFormat.Vector2,0)],l=new bn(this.engine,e.BufferBindFlag.VertexBuffer,4*n,e.BufferUsage.Dynamic),c=new bn(this.engine,e.BufferBindFlag.IndexBuffer,r,e.BufferUsage.Dynamic);return t.setVertexBufferBinding(l,96),t.setIndexBufferBinding(c,e.IndexFormat.UInt16),t.setVertexElements(u),t.addSubGeometry(0,r.length),this._vertexBuffer=l,this._vertexStride=96,this._vertices=i,t}},{key:"_spawnParticle",value:function(e,t){var n=void 0!==e.position?e.position.clone():new w,i=void 0!==e.positionRandomness?e.positionRandomness.clone():new w,r=e.positionArray,a=void 0!==e.velocity?e.velocity.clone():new w,o=void 0!==e.velocityRandomness?e.velocityRandomness.clone():new w,s=void 0!==e.color?e.color.clone():new w(1,1,1),u=void 0!==e.colorRandomness?e.colorRandomness:1,l=void 0!==e.alpha?e.alpha:1,c=void 0!==e.alphaRandomness?e.alphaRandomness:0,h=void 0!==e.lifetime?e.lifetime:5,d=void 0!==e.size?e.size:1,f=void 0!==e.sizeRandomness?e.sizeRandomness:0,_=void 0!==e.smoothPosition&&e.smoothPosition,p=void 0!==e.startTimeRandomness?e.startTimeRandomness:0,v=void 0!==e.acceleration?e.acceleration.clone():new w,m=void 0!==e.accelerationRandomness?e.accelerationRandomness.clone():new w,g=void 0!==e.startAngle?e.startAngle:0,y=void 0!==e.startAngleRandomness?e.startAngleRandomness:0,x=void 0!==e.rotateRate?e.rotateRate:0,T=void 0!==e.rotateRateRandomness?e.rotateRateRandomness:0,A=void 0!==e.scaleFactor?e.scaleFactor:1,S=n.x,E=n.y,C=n.z;if(r){if(r.length!==this.maxCount)throw Error("The length of positionArray must be equal to maxCount.");S+=r[t].x,E+=r[t].y,C+=r[t].z}else S+=this._getRandom()*i.x,E+=this._getRandom()*i.y,C+=this._getRandom()*i.z;!0===_&&(S+=-a.x*this._getRandom(),E+=-a.y*this._getRandom(),C+=-a.z*this._getRandom());var b=a.x+this._getRandom()*o.x,M=a.y+this._getRandom()*o.y,L=a.z+this._getRandom()*o.z,P=v.x+this._getRandom()*m.x,O=v.y+this._getRandom()*m.y,F=v.z+this._getRandom()*m.z;s.x=R.clamp(s.x+this._getRandom()*u,0,1),s.y=R.clamp(s.y+this._getRandom()*u,0,1),s.z=R.clamp(s.z+this._getRandom()*u,0,1),d=Math.max(d+this._getRandom()*f*d*2,0);for(var k=h+this._getRandom()*h,I=g+this._getRandom()*Math.PI*y*2,D=x+this._getRandom()*T,N=R.clamp(l+this._getRandom()*c,0,1),B=Math.random()*p,z=this._vertices,G=0;G<4;G++){var U=(4*t+G)*this._vertexStride/4;z[U]=S,z[U+1]=E,z[U+2]=C,z[U+3]=b,z[U+4]=M,z[U+5]=L,z[U+6]=P,z[U+7]=O,z[U+8]=F,z[U+9]=s[0],z[U+10]=s[1],z[U+11]=s[2],z[U+12]=N,z[U+13]=d,z[U+14]=D,z[U+15]=B,z[U+16]=k,z[U+17]=I,z[U+18]=A,this._setUvs(t,G,U)}}},{key:"_setUvs",value:function(e,t,n){var i,r=this.spriteSheet,a=this.particleTex;if(a){var o=a.image?a.image.width:a.width,s=a.image?a.image.height:a.height;if(r){var u=r[e%r.length],l=u.x,c=u.y,h=u.w,d=u.h,f=l/o,_=c/s,p=f+h/o,v=_+d/s;i=[[f,v,d/h],[p,v,d/h],[p,_,d/h],[f,_,d/h]]}else i=[[0,0,s/o],[1,0,s/o],[1,1,s/o],[0,1,s/o]]}else i=[[0,0,1],[1,0,1],[1,1,1],[0,1,1]];var m=this._vertices,g=i[t];m[n+19]=g[0],m[n+20]=g[1],m[n+21]=g[2];var y=[[-.5,-.5],[.5,-.5],[.5,.5],[-.5,.5]][t];m[n+22]=y[0],m[n+23]=y[1]}},{key:"_getRandom",value:function(){return Math.random()-.5}},{key:"_getShader",value:function(){return{vertexShader:"\n        precision highp float;\n        precision highp int;\n\n        attribute float lifeTime;\n        attribute float startTime;\n        attribute float size;\n        attribute float rotateRate;\n        attribute vec3 velocity;\n        attribute vec3 acceleration;\n        attribute vec3 positionStart;\n        attribute vec3 color;\n        attribute float alpha;\n        attribute float startAngle;\n        attribute float scaleFactor;\n        attribute vec3 uv;\n        attribute vec2 normalizedUv;\n        \n        uniform float uTime;\n        uniform float uOnce;\n        uniform float uActive;\n        uniform mat4 matModelViewProjection;\n        uniform mat4 matModelView;\n        uniform mat4 matViewInverse;\n        uniform mat4 matView;\n        uniform mat4 matProjection;\n        uniform mat4 matWorld;\n\n        varying vec3 v_color;\n        varying float v_alpha;\n        varying float lifeLeft;\n        varying mat2 vTextureMat;\n        varying vec2 v_uv;\n\n        mat2 rotation2d(float angle) {\n          float s = sin(angle);\n          float c = cos(angle);\n        \n          return mat2(\n            c, -s,\n            s, c\n          );\n        }\n\n        void main()\n        {\n          v_color = color;\n          v_uv = uv.xy;\n          v_alpha = alpha;\n          \n          // float deltaTime = max(mod(uTime, lifeTime), 0.0);\n          // 真实的生命周期\n          float life = lifeTime + startTime;\n          // 当前已过去的时间\n          float deltaTime = max(mod(uTime, life) - startTime, 0.0);\n\n          bool isDying = false;\n\n          if (uOnce == 1.0 || uActive == 0.0) {\n            isDying = true;\n          }\n\n          if ((isDying && uTime > life)) {\n            deltaTime = life;\n          }\n\n          // 没出生就代表死亡，否则没出生就显示了\n          if (deltaTime == 0.0) {\n            deltaTime = life;\n          }\n\n          lifeLeft = 1.0 - deltaTime / lifeTime;\n          float scale = size;\n          vec3 position = positionStart + (velocity + acceleration * deltaTime * 0.5) * deltaTime;\n      ",postionShader:"\n        gl_Position = matModelViewProjection * vec4(position, 1.0 );\n      ",sizeVertexShader:"\n          scale *= pow(scaleFactor, deltaTime);\n      ",isScaleByLifetimeVertexShader:"\n          scale *= lifeLeft;\n      ",rotateToVelocityVertexShader:"\n        vec3 v = velocity + acceleration * deltaTime;\n        float angle = atan(v.z, v.x) * 2.0;\n        float s = sin(angle);\n        float c = cos(angle);\n      ",rotationVertexShader:"\n        float deltaAngle = deltaTime * rotateRate;\n        float angle = startAngle + deltaAngle;\n        float s = sin(angle);\n        float c = cos(angle);\n\n      ",rotation2dShader:"\n        vec2 rotatedPoint = rotation2d(angle) * vec2(normalizedUv.x, normalizedUv.y * uv.z);\n\n        vec3 basisX = matViewInverse[0].xyz;\n        vec3 basisZ = matViewInverse[1].xyz;\n\n        vec3 localPosition = vec3(basisX * rotatedPoint.x + \n                    basisZ * rotatedPoint.y) * scale + position;\n\n        gl_Position = matProjection * matView * vec4(localPosition + matWorld[3].xyz, 1.);\n      ",rotation3dShader:"\n        vec4 rotatedPoint = vec4((normalizedUv.x * c + normalizedUv.y * uv.z * s) * scale , 0., \n                                 (normalizedUv.x * s - normalizedUv.y * uv.z * c) * scale, 1.);\n      \n        vec4 orientation = vec4(0, 0, 0, 1);\n        vec4 q2 = orientation + orientation;\n        vec4 qx = orientation.xxxw * q2.xyzx;\n        vec4 qy = orientation.xyyw * q2.xyzy;\n        vec4 qz = orientation.xxzw * q2.xxzz;\n      \n        mat4 localMatrix = mat4(\n            (1.0 - qy.y) - qz.z, \n            qx.y + qz.w, \n            qx.z - qy.w,\n            0,\n      \n            qx.y - qz.w, \n            (1.0 - qx.x) - qz.z, \n            qy.z + qx.w,\n            0,\n      \n            qx.z + qy.w, \n            qy.z - qx.w, \n            (1.0 - qx.x) - qy.y,\n            0,\n      \n            position.x, position.y, position.z, 1);\n\n        rotatedPoint = localMatrix * rotatedPoint;\n\n        gl_Position = matModelViewProjection * rotatedPoint;\n      ",fragmentShader:"\n        precision mediump float;\n        precision mediump int;\n\n        varying vec3 v_color;\n        varying float v_alpha;\n        varying float lifeLeft;\n        varying vec2 v_uv;\n        uniform sampler2D particleTex;\n        uniform sampler2D particleMaskTex;\n\n        void main()\n        {\n          float alphaFactor = 1.0;\n      ",fadeInFragmentShader:"\n        float fadeInFactor = step(0.5, lifeLeft);\n        alphaFactor = 2.0 * fadeInFactor * (1.0 - lifeLeft) + (1.0 - fadeInFactor);\n      ",fadeOutFragmentShader:"\n        float fadeOutFactor = step(0.5, lifeLeft);\n        alphaFactor = alphaFactor * 2.0 * (1.0 - fadeOutFactor) * lifeLeft + alphaFactor * fadeOutFactor;\n      ",noImgFragmentShader:" \n        gl_FragColor = vec4( v_color, alphaFactor * v_alpha);\n      ",imgFragmentShader:"\n        vec4 tex = texture2D(particleTex, v_uv);\n      ",originColorFragmentShader:"\n        gl_FragColor = vec4(tex.rgb, alphaFactor * tex.a * v_alpha);\n      ",createColorFragmentShader:"\n        gl_FragColor = vec4(v_color * tex.rgb, alphaFactor * tex.a * v_alpha);\n      ",createColorWithMaskFragmentShader:"\n        vec4 maskTex = texture2D( particleMaskTex, v_uv);\n        gl_FragColor = vec4(v_color * tex.rgb + maskTex.a, alphaFactor * tex.a * v_alpha);\n      "}}},{key:"_createVertexShader",value:function(){var e=this._getShader(),t="";return this.vertexShader?t=this.vertexShader:(t=e.vertexShader,this.isScaleByLifetime?t+=e.isScaleByLifetimeVertexShader:t+=e.sizeVertexShader,this.rotateToVelocity?t+=e.rotateToVelocityVertexShader:t+=e.rotationVertexShader,this.is2d?t+=e.rotation2dShader:t+=e.rotation3dShader,t+="}"),t}},{key:"_createFragmentShader",value:function(){var e=this._getShader(),t="";return this.fragmentShader?t=this.fragmentShader:(t=e.fragmentShader,this.fadeIn&&(t+=e.fadeInFragmentShader),this.fadeOut&&(t+=e.fadeOutFragmentShader),this.particleTex?(t+=e.imgFragmentShader,this.useOriginColor?t+=e.originColorFragmentShader:this.particleMaskTex?t+=e.createColorWithMaskFragmentShader:t+=e.createColorFragmentShader):t+=e.noImgFragmentShader,t+="}"),t}}]),a}(ci),Ei=function(i){l(s,i);var o=m(s);function s(e){return n(this,s),o.call(this,e)}return r(s,[{key:"init",value:function(n){if(this._options={position:n.__position,positionRandomness:n.__positionRandomness,velocity:n.__velocity,velocityRandomness:n.__velocityRandomness,acceleration:n.__acceleration,accelerationRandomness:n.__accelerationRandomness,color:n.__color,colorRandomness:n.__colorRandomness,lifetime:n.__lifetime,size:n.__size,sizeRandomness:n.__sizeRandomness,startAngle:n.__startAngle,startAngleRandomness:n.__startAngleRandomness,rotateRate:n.__rotateRate,rotateRateRandomness:n.__rotateRateRandomness,scaleFactor:n.__scaleFactor,alpha:n.__alpha,alphaRandomness:n.__alphaRandomness,startTimeRandomness:n.__startTimeRandomness},this._config={maxCount:n.__maxCount,once:n.__once,rotateToVelocity:n.__rotateToVelocity,isScaleByLifetime:n.__isScaleByLifetime,fadeIn:n.__fadeIn,fadeOut:n.__fadeOut,texture:n.__texture?n.__texture:null,maskTexture:n.__maskTexture?n.__maskTexture:null,useOriginColor:n.__useOriginColor,is2d:n.__is2d,options:this._options},n.__spriteSheet)if("object"===t(n.__spriteSheet)&&n.__spriteSheet.length)this._config.spriteSheet=n.__spriteSheet;else if("string"==typeof n.__spriteSheet)try{var i=JSON.parse(n.__spriteSheet);i.length&&(this._config.spriteSheet=i)}catch(e){}if(n.__positionArray)if("object"===t(n.__positionArray)&&n.__positionArray.length)this._options.positionArray=n.__positionArray;else if("string"==typeof n.__positionArray)try{var r=JSON.parse(n.__positionArray);r.length&&(this._options.positionArray=r)}catch(e){}n.__separate?this._config.blendFuncSeparate=[e.BlendFunc[n.__srcRGB||"SRC_ALPHA"],e.BlendFunc[n.__dstRGB||"ONE_MINUS_SRC_ALPHA"],e.BlendFunc[n.__srcAlpha||"SRC_ALPHA"],e.BlendFunc[n.__dstAlpha||"ONE_MINUS_SRC_ALPHA"]]:n.__src&&n.__dst&&(this._config.blendFunc=[e.BlendFunc[n.__src],e.BlendFunc[n.__dst]]),this.initialize(this._config),!0!==n.__defaultStart&&void 0!==n.__defaultStart||this.start()}},{key:"updateOption",value:function(e,t){this._options=u(u({},this._options),{},a({},e,t)),this._config=u(u({},this._config),{},{options:u({},this._options)}),this.initialize(this._config),this.start()}},{key:"updateConfig",value:function(e,t){this._config=u(u({},this._config),{},a({},e,t)),this.initialize(this._config),this.start()}},{key:"__position",set:function(e){this.updateOption("position",e)}},{key:"__positionRandomness",set:function(e){this.updateOption("positionRandomness",e)}},{key:"__velocity",set:function(e){this.updateOption("velocity",e)}},{key:"__velocityRandomness",set:function(e){this.updateOption("velocityRandomness",e)}},{key:"__acceleration",set:function(e){this.updateOption("acceleration",e)}},{key:"__accelerationRandomness",set:function(e){this.updateOption("accelerationRandomness",e)}},{key:"__color",set:function(e){this.updateOption("color",e)}},{key:"__colorRandomness",set:function(e){this.updateOption("colorRandomness",e)}},{key:"__lifetime",set:function(e){this.updateOption("lifetime",e)}},{key:"__size",set:function(e){this.updateOption("size",e)}},{key:"__sizeRandomness",set:function(e){this.updateOption("sizeRandomness",e)}},{key:"__startAngle",set:function(e){this.updateOption("startAngle",e)}},{key:"__startAngleRandomness",set:function(e){this.updateOption("startAngleRandomness",e)}},{key:"__rotateRate",set:function(e){this.updateOption("rotateRate",e)}},{key:"__rotateRateRandomness",set:function(e){this.updateOption("rotateRateRandomness",e)}},{key:"__scaleFactor",set:function(e){this.updateOption("scaleFactor",e)}},{key:"__alpha",set:function(e){this.updateOption("alpha",e)}},{key:"__alphaRandomness",set:function(e){this.updateOption("alphaRandomness",e)}},{key:"__startTimeRandomness",set:function(e){this.updateOption("startTimeRandomness",e)}},{key:"__positionArray",set:function(e){if("object"===t(e)&&e.length)this.updateOption("positionArray",e);else if("string"==typeof e)try{var n=JSON.parse(e);n.length?this.updateOption("positionArray",n):this.updateOption("positionArray",null)}catch(e){this.updateOption("positionArray",null)}else this.updateOption("positionArray",null)}},{key:"__maxCount",set:function(e){this.updateConfig("maxCount",e)}},{key:"__useOriginColor",set:function(e){this.updateConfig("useOriginColor",e)}},{key:"__once",set:function(e){this.updateConfig("once",e)}},{key:"__rotateToVelocity",set:function(e){this.updateConfig("rotateToVelocity",e)}},{key:"__isScaleByLifetime",set:function(e){this.updateConfig("isScaleByLifetime",e)}},{key:"__fadeIn",set:function(e){this.updateConfig("fadeIn",e)}},{key:"__fadeOut",set:function(e){this.updateConfig("fadeOut",e)}},{key:"__texture",set:function(e){this.updateConfig("texture",e)}},{key:"__maskTexture",set:function(e){this.updateConfig("maskTexture",e)}},{key:"__spriteSheet",set:function(e){if("object"===t(e)&&e.length)this.updateConfig("spriteSheet",e);else if("string"==typeof e)try{var n=JSON.parse(e);n.length?this.updateConfig("spriteSheet",n):this.updateConfig("spriteSheet",null)}catch(e){this.updateConfig("spriteSheet",null)}else this.updateConfig("spriteSheet",null)}},{key:"__is2d",set:function(e){this.updateConfig("is2d",e)}}]),s}(Si),Ci=function(t){l(a,t);var i=m(a);function a(){return n(this,a),i.apply(this,arguments)}return r(a,[{key:"_generateTechnique",value:function(){var t=new In("trail_tech");t.isValid=!0,t.uniforms={u_texture:{name:"u_texture",type:e.DataType.SAMPLER_2D}},t.attributes={},t.states={enable:[e.RenderState.BLEND],functions:{blendFunc:[e.BlendFunc.SRC_ALPHA,e.BlendFunc.ONE],depthMask:[!1]}},t.customMacros=[],t.vertexShader="attribute vec3 a_position;\nattribute vec2 a_uv;\n\nvarying vec2 v_uv;\n\nuniform mat4 u_projMat;\nuniform mat4 u_viewMat;\n\nvoid main() {\n\n  gl_Position = u_projMat * u_viewMat * vec4( a_position, 1.0 );\n  v_uv = a_uv;\n\n}\n",t.fragmentShader="varying vec2 v_uv;\n\nuniform sampler2D u_texture;\n\nvoid main(void) {\n\n  gl_FragColor = texture2D(u_texture, v_uv);\n\n}\n",this._technique=t,this.renderType=e.MaterialType.TRANSPARENT}},{key:"prepareDrawing",value:function(e,t,n){null===this._technique&&this._generateTechnique(),g(c(a.prototype),"prepareDrawing",this).call(this,e,t,n)}}]),a}(xn),bi=new w,Ri=function(t){l(a,t);var i=m(a);function a(e,t){var r;n(this,a),(r=i.call(this,e))._stroke=t.stroke||.2,r._minSeg=t.minSeg||.02,r._lifetime=t.lifetime||1e3,r._maxPointNum=r._lifetime/1e3*e.engine.targetFrameRate,r._points=[],r._pointStates=[],r._strapPoints=[];for(var o=0;o<r._maxPointNum;o++)r._points.push(new w),r._pointStates.push(r._lifetime),r._strapPoints.push(new w),r._strapPoints.push(new w);r._curPointNum=0;var s=t.material||new Ci(r.engine,"trial_mtl");return r.material=s,r.setTexture(t.texture),r._initGeometry(),r}return r(a,[{key:"update",value:function(e){for(var t=0,n=0,i=0;i<this._curPointNum;i++)this._pointStates[i]-=e,this._pointStates[i]<0?t++:t>0&&(n=i-t,this._pointStates[n]=this._pointStates[i],this._points[i].cloneTo(this._points[n]));this._curPointNum-=t;var r=!0;if(this._curPointNum===this._maxPointNum)r=!1;else if(this._curPointNum>0){var a=this._points[this._points.length-1];w.distance(this.entity.worldPosition,a)<this._minSeg&&(r=!1)}r&&(this._pointStates[this._curPointNum]=this._lifetime,this.entity.worldPosition.cloneTo(this._points[this._curPointNum]),this._curPointNum++)}},{key:"render",value:function(e){this._updateStrapVertices(e,this._points),this._updateStrapCoords(),this._vertexBuffer.setData(this._vertices),g(c(a.prototype),"render",this).call(this,e)}},{key:"setTexture",value:function(e){e&&this.material.setValue("u_texture",e)}},{key:"_initGeometry",value:function(){var t=new li(this._entity.engine),n=2*this._maxPointNum,i=20*n,r=new Float32Array(i),a=[new Ln("POSITION",0,e.VertexElementFormat.Vector3,0),new Ln("TEXCOORD_0",12,e.VertexElementFormat.Vector2,0)],o=new bn(this.engine,4*i,e.BufferUsage.Dynamic);t.setVertexBufferBinding(o,20),t.setVertexElements(a),t.addSubGeometry(0,n,e.PrimitiveTopology.TriangleStrip),this._vertexBuffer=o,this._vertexStride=20,this._vertices=r,this.geometry=t}},{key:"_updateStrapVertices",value:function(e,t){var n=e.viewMatrix.elements,i=new w(n[0],n[4],n[8]),r=new w(n[1],n[5],n[9]),a=new w(n[2],n[6],n[10]),o=this._stroke;r.scale(o);var s=new w,u=new w,l=new O;w.transformByQuat(i,l,i),w.transformByQuat(r,l,r);var c=new w,h=new w,d=new w;i.normalize();for(var f=this._vertices,_=0;_<this._maxPointNum;_++){if(_<this._curPointNum){var p=t[_];_===this._curPointNum-1&&0!==_?w.subtract(p,t[_-1],d):w.subtract(t[_+1],p,d),this._projectOnPlane(d,a,d),d.normalize();var v=Math.acos(w.dot(i,d));w.cross(i,d,h),w.dot(h,a)<=0&&(v=2*Math.PI-v),O.rotationAxisAngle(a,v,l),w.transformByQuat(r,l,c),w.add(p,c,s),w.subtract(p,c,u)}var m=2*_*this._vertexStride/4,g=(2*_+1)*this._vertexStride/4;f[m]=s.x,f[m+1]=s.y,f[m+2]=s.z,f[g]=u.x,f[g+1]=u.y,f[g+2]=u.z}}},{key:"_updateStrapCoords",value:function(){if(this._prePointsNum!==this._curPointNum){this._prePointsNum=this._curPointNum;for(var e=this._curPointNum,t=1/e,n=this._vertices,i=0;i<e;i++){var r=1-i*t,a=2*i*this._vertexStride/4,o=(2*i+1)*this._vertexStride/4;n[a]=0,n[a+1]=r,n[o]=1,n[o+1]=r}}}},{key:"_projectOnVector",value:function(e,t,n){var i=t.clone();w.normalize(i,i);var r=w.dot(e,i);n.x=i.x*r,n.y=i.y*r,n.z=i.z*r}},{key:"_projectOnPlane",value:function(e,t,n){this._projectOnVector(e,t,bi),w.subtract(e,bi,n)}}]),a}(ci),wi=function(e){l(i,e);var t=m(i);function i(e){var r;return n(this,i),(r=t.call(this,e))._center=new w,r._size=new w,r.isShowCollider=!0,r.center=r.center,r.size=r.size,r.isShowCollider=r.isShowCollider,r}return r(i,[{key:"center",get:function(){return this._center},set:function(e){this._center=e,this.setBoxCenterSize(this._center,this._size)}},{key:"size",get:function(){return this._size},set:function(e){this._size=e,this.setBoxCenterSize(this._center,this._size)}}]),i}(Wt),Mi=function(e){l(i,e);var t=m(i);function i(e){var r;return n(this,i),(r=t.call(this,e)).__center=new w,r.__radius=1,r.isShowCollider=!0,r._center=r._center,r._radius=r._radius,r.isShowCollider=r.isShowCollider,r}return r(i,[{key:"_center",get:function(){return this.__center},set:function(e){this.__center=e,this.setSphere(this.__center,this.__radius)}},{key:"_radius",get:function(){return this.__radius},set:function(e){this.__radius=e,this.setSphere(this.__center,this.__radius)}}]),i}(qt);function Li(e,t){var n=e.center,i=new w(Math.max(t.min.x,Math.min(n.x,t.max.x)),Math.max(t.min.y,Math.min(n.y,t.max.y)),Math.max(t.min.z,Math.min(n.z,t.max.z)));return w.distance(n,i)<e.radius}Ye.registerFeature(Ht);var Pi=function(e){l(i,e);var t=m(i);function i(e){var r;return n(this,i),(r=t.call(this,e))._colliderManager=null,r._myCollider=null,r._overlopCollider=null,r}return r(i,[{key:"onUpdate",value:function(e){g(c(i.prototype),"onUpdate",this).call(this,e);var t=null;if(this._colliderManager&&this._myCollider){var n=this._colliderManager.colliders;if(this._myCollider instanceof Wt){this._box=this._getWorldBox(this._myCollider);for(var r=0,a=n.length;r<a;r++){var o=n[r];o!=this._myCollider&&this._boxCollision(o)&&(t=o,this.trigger(new Y("collision",this,{collider:o})))}}else if(this._myCollider instanceof qt){this._sphere=this._getWorldSphere(this._myCollider);for(var s=0,u=n.length;s<u;s++){var l=n[s];l!=this._myCollider&&this._sphereCollision(l)&&(t=l,this.trigger(new Y("collision",this,{collider:l})))}}}if(null!=t&&this._overlopCollider!=t&&this.trigger(new Y("begin_overlop",this,{collider:t})),null!=this._overlopCollider&&this._overlopCollider!=t){var h=this._overlopCollider;this.trigger(new Y("end_overlop",this,{collider:h}))}this._overlopCollider=t}},{key:"_getWorldBox",value:function(e){var t=e.entity.transform.worldMatrix,n=new w,r=new w;w.transformCoordinate(e.boxMax,t,n),w.transformCoordinate(e.boxMin,t,r);for(var a=i._tempVec3,o=e.getCorners(),s=0;s<8;s++)w.transformCoordinate(o[s],t,a),a.x>n.x&&(n.x=a.x),a.y>n.y&&(n.y=a.y),a.z>n.z&&(n.z=a.z),a.x<r.x&&(r.x=a.x),a.y<r.y&&(r.y=a.y),a.z<r.z&&(r.z=a.z);return{min:r,max:n}}},{key:"_getWorldSphere",value:function(e){var t=new w;return w.transformCoordinate(e.center,e.entity.transform.worldMatrix,t),{radius:e.radius,center:t}}},{key:"_boxCollision",value:function(e){if(e instanceof Wt){var t=this._getWorldBox(e);return n=t,i=this._box,n.min.x<=i.max.x&&n.max.x>=i.min.x&&n.min.y<=i.max.y&&n.max.y>=i.min.y&&n.min.z<=i.max.z&&n.max.z>=i.min.z}var n,i;return e instanceof qt&&Li(this._getWorldSphere(e),this._box)}},{key:"_sphereCollision",value:function(e){if(e instanceof Wt){var t=this._getWorldBox(e);return Li(this._sphere,t)}if(e instanceof qt){var n=this._getWorldSphere(e);return i=n,r=this._sphere,w.distance(i.center,r.center)<i.radius+i.radius}var i,r;return!1}},{key:"onAwake",value:function(){this._colliderManager=this.scene.findFeature(Ht),this._myCollider=this.entity.getComponent(jt)}},{key:"overlopCollider",get:function(){return this._overlopCollider}}]),i}(ut);Pi._tempVec3=new w;var Oi=function(e){l(i,e);var t=m(i);function i(e){var r;return n(this,i),(r=t.call(this,e)).color=new w(1,0,0),r}return r(i,[{key:"_onEnable",value:function(){this.scene.findFeature(Ni).fog=this}},{key:"_onDisable",value:function(){this.scene.findFeature(Ni).fog=null}},{key:"bindMaterialValues",value:function(e){}}]),i}(Ue),Fi=function(e){l(i,e);var t=m(i);function i(){var e;return n(this,i),(e=t.apply(this,arguments)).density=.0025,e}return r(i,[{key:"bindMaterialValues",value:function(e){e.setValue("u_fogColor",this.color),e.setValue("u_fogDensity",this.density)}}]),i}(Oi);function ki(){return!0}function Ii(){return this.findFeature(Ni).macro}function Di(e){this.findFeature(Ni).bindFogToMaterial(e)}var Ni=function(e){l(i,e);var t=m(i);function i(){var e;return n(this,i),(e=t.call(this))._fog=null,e._macros=[],e}return r(i,[{key:"bindFogToMaterial",value:function(e){return this.fog&&e.useFog&&this.fog.bindMaterialValues(e),this}},{key:"fog",get:function(){return this._fog},set:function(e){if(e!==this._fog){this._fog=e;var t=[];e instanceof Oi&&(t.push("O3_HAS_FOG"),e instanceof Fi&&t.push("O3_FOG_EXP2")),this._macros.length!==t.length&&(this._macros=t)}}},{key:"macro",get:function(){return this._macros}}]),i}(rt),Bi=function(e){l(i,e);var t=m(i);function i(){var e;return n(this,i),(e=t.apply(this,arguments)).near=1,e.far=1e3,e}return r(i,[{key:"bindMaterialValues",value:function(e){e.setValue("u_fogColor",this.color),e.setValue("u_fogNear",this.near),e.setValue("u_fogFar",this.far)}}]),i}(Oi);Ye.registerFeature(Ni),Ye.prototype.hasFogFeature=ki,Ye.prototype.getFogMacro=Ii,Ye.prototype.bindFogToMaterial=Di;var zi=0,Gi=function(t){l(a,t);var i=m(a);function a(e){var t;return n(this,a),(t=i.call(this,e)).cacheId=zi++,t.renderPass=new _t("_renderPass"+t.cacheId,-10),t.renderPass.renderOverride=!0,t.renderPass.preRender=t.preRender.bind(p(t)),t.renderPass.render=t.render.bind(p(t)),t.renderPass.postRender=t.postRender.bind(p(t)),t.addEventListener("enabled",(function(){t.renderPass.enabled=!0})),t.addEventListener("disabled",(function(){t.renderPass.enabled=!1})),t}return r(a,[{key:"camera",set:function(e){e!==this._camera&&(this._camera&&this.renderPipeline.removeRenderPass(this.renderPass),this._camera=e,e&&this.renderPipeline.addRenderPass(this.renderPass))},get:function(){return this._camera}},{key:"texture",get:function(){var e;return null===(e=this.renderPass.renderTarget)||void 0===e?void 0:e.getColorTexture()}},{key:"depthTexture",get:function(){var e;return null===(e=this.renderPass.renderTarget)||void 0===e?void 0:e.depthTexture}},{key:"cubeTexture",get:function(){var e;return null===(e=this.renderPass.renderTarget)||void 0===e?void 0:e.getColorTexture()}},{key:"renderPipeline",get:function(){return this.camera._renderPipeline}},{key:"rhi",get:function(){return this.camera.scene.engine._hardwareRenderer}},{key:"renderItems",get:function(){var e=this,t=this.renderPipeline.opaqueQueue,n=this.renderPipeline.transparentQueue;return t.items.concat(n.items).filter((function(t){return!!t.primitive&&(!e.excludeRenderList.includes(t.material)&&(!!e.renderAll||(!!e.renderList.includes(t.material)||void 0)))}))}},{key:"samples",get:function(){return this.renderTarget.antiAliasing}}]),r(a,[{key:"init",value:function(){var t=arguments.length>0&&void 0!==arguments[0]?arguments[0]:{};this.isCube=!!t.isCube,this.camera=t.camera||this.scene._activeCameras[0],this.excludeRenderList=t.excludeRenderList||[],this.renderAll=!!t.renderAll,this.renderList=t.renderList||[],this.clipPlanes=t.clipPlanes||[];var n=t.width||1024,i=t.height||1024,r=t.samples||1;this.renderTarget=new Hn(this.engine,n,i,new jn(this.engine,n,i,void 0,!1,this.isCube),e.RenderBufferDepthFormat.Depth,r),this.renderTargetSwap=new Hn(this.engine,n,i,new jn(this.engine,n,i,void 0,!1,this.isCube),e.RenderBufferDepthFormat.Depth,r),this.renderPass.renderTarget=this.renderTarget}},{key:"preRender",value:function(){this.oriClipPlane=this.scene.clipPlanes,this.scene.clipPlanes=this.clipPlanes}},{key:"render",value:function(){var e=this,t=pt._getRenderContext(this.camera);this.renderItems.forEach((function(n){var i=n.component,r=n.primitive,a=n.subPrimitive,o=n.material;i.renderPassFlag&e.renderPassFlag&&(o.prepareDrawing(t,i,r),e.rhi.drawPrimitive(r,a,o))}))}},{key:"postRender",value:function(){this.scene.clipPlanes=this.oriClipPlane,this.renderPass.enabled&&(this.onTextureChange&&(this.isCube?this.onTextureChange(this.cubeTexture):this.onTextureChange(this.texture,this.depthTexture)),this.renderPass.renderTarget===this.renderTarget?this.renderPass.renderTarget=this.renderTargetSwap:this.renderPass.renderTarget=this.renderTarget)}},{key:"destroy",value:function(){this.enabled=!1,this.renderPipeline.removeRenderPass(this.renderPass),g(c(a.prototype),"destroy",this).call(this),this.renderTarget.destroy(),this.renderTargetSwap.destroy()}},{key:"onTextureChange",value:function(e,t){}}]),a}(Ue),Ui=function(t){l(a,t);var i=m(a);function a(e){return n(this,a),i.call(this,e)}return r(a,[{key:"init",value:function(){var e=arguments.length>0&&void 0!==arguments[0]?arguments[0]:{};g(c(a.prototype),"init",this).call(this,e)}},{key:"storeMaterial",value:function(){this.renderItems.forEach((function(t){var n=t.material;t.initialSide=n.side,n.side=e.Side.BACK}))}},{key:"restoreMaterial",value:function(){this.renderItems.forEach((function(e){e.material.side=e.initialSide,delete e.initialSide}))}},{key:"preRender",value:function(){g(c(a.prototype),"preRender",this).call(this),this.storeMaterial()}},{key:"postRender",value:function(){g(c(a.prototype),"postRender",this).call(this),this.restoreMaterial()}}]),a}(Gi),Vi=new w,Hi=new w,ji=new w,Wi=90*Math.PI/180,qi=function(e){l(i,e);var t=m(i);function i(e){var r;return n(this,i),(r=t.call(this,e)).oriViewMatrix=new F,r.oriInverseViewMatrix=new F,r.oriProjectionMatrix=new F,r.oriInverseProjectionMatrix=new F,r}return r(i,[{key:"init",value:function(){var e=arguments.length>0&&void 0!==arguments[0]?arguments[0]:{};g(c(i.prototype),"init",this).call(this,u(u({},e),{},{isCube:!0})),this.position=e.position||new w}},{key:"storeCamera",value:function(){this.camera.viewMatrix.cloneTo(this.oriViewMatrix),this.camera.inverseViewMatrix.cloneTo(this.oriInverseViewMatrix),this.camera.projectionMatrix.cloneTo(this.oriProjectionMatrix),this.camera.inverseProjectionMatrix.cloneTo(this.oriInverseProjectionMatrix)}},{key:"restoreCamera",value:function(){this.oriViewMatrix.cloneTo(this.camera.viewMatrix),this.oriInverseViewMatrix.cloneTo(this.camera.inverseViewMatrix),this.oriProjectionMatrix.cloneTo(this.camera.projectionMatrix),this.oriInverseProjectionMatrix.cloneTo(this.camera.inverseProjectionMatrix)}},{key:"preRender",value:function(){g(c(i.prototype),"preRender",this).call(this),this.storeCamera()}},{key:"render",value:function(){for(var e=0;e<6;e++)this.rhi.setRenderTargetFace(this.renderPass.renderTarget,e),this.rhi.clearRenderTarget(this.renderPass.clearMode,this.renderPass.clearParam),this.setCamera(e),g(c(i.prototype),"render",this).call(this),e<5&&this.rhi.blitRenderTarget(this.renderPass.renderTarget)}},{key:"postRender",value:function(){g(c(i.prototype),"postRender",this).call(this),this.restoreCamera()}},{key:"setCamera",value:function(e){switch(e){case 0:Hi.setValue(0,-1,0),ji.setValue(1,0,0);break;case 1:Hi.setValue(0,-1,0),ji.setValue(-1,0,0);break;case 2:Hi.setValue(0,0,1),ji.setValue(0,1,0);break;case 3:Hi.setValue(0,0,-1),ji.setValue(0,-1,0);break;case 4:Hi.setValue(0,-1,0),ji.setValue(0,0,1);break;case 5:Hi.setValue(0,-1,0),ji.setValue(0,0,-1)}w.add(this.position,ji,Vi),F.lookAt(this.position,Vi,Hi,this.camera.viewMatrix),F.invert(this.camera.viewMatrix,this.camera.inverseViewMatrix),F.perspective(Wi,1,this.camera.nearClipPlane,this.camera.farClipPlane,this.camera.projectionMatrix),F.invert(this.camera.projectionMatrix,this.camera.inverseProjectionMatrix)}}]),i}(Gi),Xi=function(){function t(){var e=arguments.length>0&&void 0!==arguments[0]?arguments[0]:{engine:null,width:512,height:512};n(this,t),this._mapSize=new z(e.width,e.height),this._renderTarget=new Hn(e.engine,e.width,e.height,new jn(e.engine,e.width,e.height)),this.bias=.005,this.intensity=.2,this.radius=1,this.projectionMatrix=new F}return r(t,[{key:"initShadowProjectionMatrix",value:function(e){if(e instanceof Nt&&F.ortho(-5,5,-5,5,.1,50,this.projectionMatrix),e instanceof Gt&&F.perspective(R.degreeToRadian(50),1,.5,50,this.projectionMatrix),e instanceof Ut){var t=Math.min(Math.PI/2,2*e.angle*Math.sqrt(2));F.perspective(t,1,.1,e.distance+5,this.projectionMatrix)}}},{key:"bindShadowValues",value:function(e,t,n){e.setValue("u_viewMatFromLight[".concat(t,"]"),n.viewMatrix),e.setValue("u_projMatFromLight[".concat(t,"]"),this.projectionMatrix);var i="u_shadows[".concat(t,"]");e.setValue(i+".bias",this.bias),e.setValue(i+".intensity",this.intensity),e.setValue(i+".radius",this.radius),e.setValue(i+".mapSize",this._mapSize),e.setValue("u_shadowMaps[".concat(t,"]"),this.map)}},{key:"renderTarget",get:function(){return this._renderTarget}},{key:"map",get:function(){return this._renderTarget.getColorTexture()}},{key:"mapSize",get:function(){return this._mapSize}}],[{key:"getUniformDefine",value:function(t){var n={};n["u_viewMatFromLight[".concat(t,"]")]={name:"u_viewMatFromLight[".concat(t,"]"),type:e.DataType.FLOAT_MAT4},n["u_projMatFromLight[".concat(t,"]")]={name:"u_projMatFromLight[".concat(t,"]"),type:e.DataType.FLOAT_MAT4};var i="u_shadows[".concat(t,"]");return n[i+".bias"]={name:i+".bias",type:e.DataType.FLOAT},n[i+".intensity"]={name:i+".intensity",type:e.DataType.FLOAT},n[i+".radius"]={name:i+".radius",type:e.DataType.FLOAT},n[i+".mapSize"]={name:i+".mapSize",type:e.DataType.FLOAT_VEC2},n["u_shadowMaps[".concat(t,"]")]={name:"u_shadowMaps[".concat(t,"]"),type:e.DataType.SAMPLER_2D},n}}]),t}();Object.defineProperty(It.prototype,"enableShadow",{get:function(){return this._enableShadow},set:function(e){if(this._enableShadow=e,this._enableShadow){if(this instanceof Dt)return void Le.warn("Has no shadow!");this.shadow=this.shadow||new Xi({engine:this.engine,width:512,height:512}),this.shadow.initShadowProjectionMatrix(this)}}}),Object.defineProperty(Ue.prototype,"recieveShadow",{get:function(){return this._recieveShadow},set:function(e){this._recieveShadow=e}}),Object.defineProperty(Ue.prototype,"castShadow",{get:function(){return this._castShadow},set:function(e){this._castShadow=e}});var Ki="#include <common_vert>\n#include <normal_share>\n#include <shadow_share>\n\nvoid main() {\n\n    #include <begin_position_vert>\n    #include <begin_normal_vert>\n    #include <skinning_vert>\n    #include <shadow_vert>\n    #include <position_vert>\n\n}\n",Qi=function(t){l(a,t);var i=m(a);function a(){return n(this,a),i.apply(this,arguments)}return r(a,[{key:"_generateTechnique",value:function(e,t){var n=this._generateMacros(),i=this._generateFragmentUniform(),r=new In(this.name);return r.isValid=!0,r.uniforms=i,r.attributes={},r.states={},r.customMacros=n,r.vertexShader=Ki,r.fragmentShader="precision mediump float;\n\n/**\n * 分解保存深度值\n*/\nvec4 pack (float depth) {\n\n  // 使用rgba 4字节共32位来存储z值,1个字节精度为1/256\n  const vec4 bitShift = vec4(1.0, 256.0, 256.0 * 256.0, 256.0 * 256.0 * 256.0);\n  const vec4 bitMask = vec4(1.0/256.0, 1.0/256.0, 1.0/256.0, 0.0);\n\n  vec4 rgbaDepth = fract(depth * bitShift); //计算每个点的z值\n\n  // Cut off the value which do not fit in 8 bits\n  rgbaDepth -= rgbaDepth.gbaa * bitMask;\n\n  return rgbaDepth;\n}\n\nvoid main() {\n\n  // 将z值分开存储到rgba分量中,阴影颜色的同时也是深度值z\n  gl_FragColor = pack(gl_FragCoord.z);\n\n}",r}},{key:"_generateFragmentUniform",value:function(){return{u_viewMatFromLight:{name:"u_viewMatFromLight",type:e.DataType.FLOAT_MAT4},u_projMatFromLight:{name:"u_projMatFromLight",type:e.DataType.FLOAT_MAT4}}}},{key:"_generateMacros",value:function(){var e=[];return e.push("O3_GENERATE_SHADOW_MAP"),e}}]),a}(Tn),Yi=function(e){l(i,e);var t=m(i);function i(e,r,a,o,s,u){var l;return n(this,i),(l=t.call(this,e,r,a,o,s)).light=u,l}return r(i,[{key:"preRender",value:function(e,t,n){this.replaceMaterial.setValue("u_viewMatFromLight",this.light.viewMatrix),this.replaceMaterial.setValue("u_projMatFromLight",this.light.shadow.projectionMatrix)}}]),i}(_t),Ji=function(t){l(a,t);var i=m(a);function a(){return n(this,a),i.apply(this,arguments)}return r(a,[{key:"_generateTechnique",value:function(t,n){var i=this._generateMacros(),r=this._generateFragmentUniform(),a=new In(this.name);return a.autoConvert=!1,a.isValid=!0,a.uniforms=r,a.attributes={},a.states={},a.customMacros=i,a.vertexShader=Ki,a.fragmentShader="varying vec2 v_uv;\n\nuniform vec4 u_ambientLight;\n\n#ifdef O3_SHADOW_MAP_COUNT\n\nstruct Shadow {\n  float     bias;\n  float     intensity;\n  vec2      mapSize;\n  float     radius;\n};\n\nuniform Shadow u_shadows[O3_SHADOW_MAP_COUNT];\n\nuniform sampler2D u_shadowMaps[O3_SHADOW_MAP_COUNT];\n\nvarying vec4 v_PositionFromLight[O3_SHADOW_MAP_COUNT];\n\nconst vec4 bitShift = vec4(1.0, 1.0/256.0, 1.0/(256.0*256.0), 1.0/(256.0*256.0*256.0));\n\n/**\n* 释出深度值\n*/\nfloat unpack(const in vec4 rgbaDepth) {\n  return dot(rgbaDepth, bitShift);\n}\n\n/**\n* 判断是否需要显示阴影\n*/\nfloat getVisibility(vec4 positionFromLight, const in sampler2D shadowMap, vec2 mapSize, float intensity, float bias, float radius) {\n\n    vec3 shadowCoord = (positionFromLight.xyz/positionFromLight.w)/2.0 + 0.5;\n    float filterX = step(0.0, shadowCoord.x) * (1.0 - step(1.0, shadowCoord.x));\n    float filterY = step(0.0, shadowCoord.y) * (1.0 - step(1.0, shadowCoord.y));\n\n    shadowCoord.z -= bias;\n    vec2 texelSize = vec2( 1.0 ) / mapSize;\n\n    float visibility = 0.0;\n    for (float y = -1.0 ; y <=1.0 ; y+=1.0) {\n      for (float x = -1.0 ; x <=1.0 ; x+=1.0) {\n        vec2 uv = shadowCoord.xy + texelSize * vec2(x, y) * radius;\n        vec4 rgbaDepth = texture2D(shadowMap, uv);\n        float depth = unpack(rgbaDepth);\n        visibility += step(depth, shadowCoord.z) * intensity;\n      }\n    }\n\n    visibility *= ( 1.0 / 9.0 );\n    return visibility * filterX * filterY;\n\n}\n\n#endif\n\nvoid main() {\n\n  vec4 shadowColor = vec4(1.0, 1.0, 1.0, 1.0);\n\n#ifdef O3_SHADOW_MAP_COUNT\n\n  float visibility = 1.0;\n\n  for(int i = 0; i < O3_SHADOW_MAP_COUNT; i++) {\n\n   visibility -= getVisibility(v_PositionFromLight[i], u_shadowMaps[i], u_shadows[i].mapSize, u_shadows[i].intensity, u_shadows[i].bias, u_shadows[i].radius);\n\n  }\n\n  visibility = clamp(visibility, 0.0, 1.0);\n  shadowColor = vec4(visibility, visibility, visibility, 1.0);\n\n#endif\n\n  gl_FragColor = shadowColor;\n}",a.states={enable:[e.RenderState.BLEND],functions:{depthFunc:[e.CompFunc.LEQUAL],blendFunc:[e.BlendFunc.DST_COLOR,e.BlendFunc.ZERO]}},a}},{key:"_generateFragmentUniform",value:function(){for(var e={},t=0;t<this.shadowMapCount;t++){var n=Xi.getUniformDefine(t);e=u(u({},e),n)}return e}},{key:"_generateMacros",value:function(){var e=[];return this.shadowMapCount>0&&e.push("O3_SHADOW_MAP_COUNT ".concat(this.shadowMapCount)),e}}]),a}(Tn),Zi=function(t){l(a,t);var i=m(a);function a(){var t;n(this,a);for(var r=arguments.length,o=new Array(r),s=0;s<r;s++)o[s]=arguments[s];return(t=i.call.apply(i,[this].concat(o))).clearMode=e.ClearMode.DONT_CLEAR,t}return r(a,[{key:"preRender",value:function(e,t,n){this.enabled=!1;var i=e.scene.findFeature(Vt);if(i){var r=e._renderPipeline.defaultRenderPass;this.renderTarget=r.renderTarget;for(var a=i.visibleLights,o=0,s=0,u=a.length;s<u;s++){var l=a[s];l.enableShadow&&(l.shadow.bindShadowValues(this.replaceMaterial,o,l),o++)}o!==this.replaceMaterial.shadowMapCount&&(this.replaceMaterial.shadowMapCount=o,this.replaceMaterial.clearTechniques()),o&&(this.enabled=!0)}}}]),a}(_t),$i=function(t){l(a,t);var i=m(a);function a(){return n(this,a),i.apply(this,arguments)}return r(a,[{key:"preRender",value:function(e,t){var n=t.scene.findFeature(Vt);if(n&&n.visibleLights.length>0){this._shadowPass||this.addShadowPass(t);for(var i=n.visibleLights,r=0,a=i.length;r<a;r++){var o=i[r];if(o.enableShadow&&!o.shadowMapPass)o.shadowMapPass=this.addShadowMapPass(t,o);else if(!o.enableShadow&&o.shadowMapPass){t._renderPipeline.removeRenderPass(o.shadowMapPass),o.shadowMapPass=null}}this.updatePassRenderFlag(t._renderPipeline.opaqueQueue),this.updatePassRenderFlag(t._renderPipeline.transparentQueue)}}},{key:"addShadowPass",value:function(t){var n=new Ji(t.engine,"shadowMaterial");this._shadowPass=new Zi("ShadowPass",1,null,n,e.MaskList.SHADOW),t._renderPipeline.addRenderPass(this._shadowPass)}},{key:"addShadowMapPass",value:function(t,n){this._shadowMapMaterial=this._shadowMapMaterial||new Qi(t.engine,"shadowMapMaterial");var i=new Yi("ShadowMapPass",-1,n.shadow.renderTarget,this._shadowMapMaterial,e.MaskList.SHADOW_MAP,n);return t._renderPipeline.addRenderPass(i),i}},{key:"updatePassRenderFlag",value:function(t){for(var n=t.items,i=0,r=n.length;i<r;i++){var a=n[i].component,o=a.recieveShadow,s=a.castShadow;!0===o?a.addPassMasks(e.MaskList.SHADOW):!1===o&&a.removePassMasks(e.MaskList.SHADOW),!0===s?a.addPassMasks(e.MaskList.SHADOW_MAP):!1===s&&a.removePassMasks(e.MaskList.SHADOW_MAP)}}}]),a}(rt);Ye.registerFeature($i),Ye.registerFeature(Vt),Ye.prototype.hasLight=function(){return this.findFeature(Vt).visibleLights.length>0};var er=function(){function e(t,i){var r=this;n(this,e),this._costs={},this._currentLoad=0,this._callbacks={},this._worker=new Worker(t),this._worker.onmessage=function(e){var t=e.data;switch(t.type){case"decode":r._callbacks[t.id].resolve(t.geometry);break;case"error":r._callbacks[t.id].reject(t);break;default:Le.error('DRACOWorker: Unexpected message, "'+t.type+'"')}},i?this._worker.postMessage({type:"init",decoderConfig:{wasmBinary:i}}):this._worker.postMessage({type:"init",decoderConfig:{}})}return r(e,[{key:"setCosts",value:function(e,t){this._costs[e]=t}},{key:"addCurrentLoad",value:function(e){this._currentLoad+=e}},{key:"setCallback",value:function(e,t,n){this._callbacks[e]={resolve:t,reject:n}}},{key:"decode",value:function(e,t,n){this._worker.postMessage({type:"decode",id:e,taskConfig:t,buffer:n},[n])}},{key:"releaseTask",value:function(e){this._currentLoad-=this._costs[e],delete this._callbacks[e],delete this._costs[e]}},{key:"currentLoad",get:function(){return this._currentLoad}}]),e}(),tr='let decoderPending;\nlet decoderConfig;\n\nonmessage = function(e) {\n  const message = e.data;\n\n  switch (message.type) {\n    case "init":\n      decoderConfig = message.decoderConfig;\n      decoderPending = new Promise(function(resolve /*, reject*/) {\n        decoderConfig.onModuleLoaded = function(draco) {\n          // Module is Promise-like. Wrap before resolving to avoid loop.\n          resolve({ draco: draco });\n        };\n        DracoDecoderModule(decoderConfig);\n      });\n      break;\n\n    case "decode":\n      const buffer = message.buffer;\n      const taskConfig = message.taskConfig;\n      decoderPending.then(module => {\n        const draco = module.draco;\n        const decoder = new draco.Decoder();\n        const decoderBuffer = new draco.DecoderBuffer();\n        decoderBuffer.Init(new Int8Array(buffer), buffer.byteLength);\n        try {\n          const geometry = decodeGeometry(draco, decoder, decoderBuffer, taskConfig);\n          const buffers = geometry.attributes.map(attr => attr.array.buffer);\n          if (geometry.index) buffers.push(geometry.index.array.buffer);\n          self.postMessage({ type: "decode", id: message.id, geometry }, buffers);\n        } catch (error) {\n          console.error(error);\n          self.postMessage({ type: "error", id: message.id, error: error.message });\n        } finally {\n          draco.destroy(decoderBuffer);\n          draco.destroy(decoder);\n        }\n      });\n      break;\n  }\n};\n\nfunction decodeGeometry(draco, decoder, decoderBuffer, taskConfig) {\n  const attributeIDs = taskConfig.attributeIDs;\n  const attributeTypes = taskConfig.attributeTypes;\n\n  let dracoGeometry;\n  let decodingStatus;\n\n  const geometryType = decoder.GetEncodedGeometryType(decoderBuffer);\n  if (geometryType === draco.TRIANGULAR_MESH) {\n    dracoGeometry = new draco.Mesh();\n    decodingStatus = decoder.DecodeBufferToMesh(decoderBuffer, dracoGeometry);\n  } else {\n    throw new Error("DRACODecoder worker: Unexpected geometry type.");\n  }\n\n  if (!decodingStatus.ok() || dracoGeometry.ptr === 0) {\n    throw new Error("DRACODecoder worker: Decoding failed: " + decodingStatus.error_msg());\n  }\n\n  const geometry = { index: null, attributes: [] };\n\n  // Gather all vertex attributes.\n  for (let attributeName in attributeIDs) {\n    const attributeType = self[attributeTypes[attributeName]];\n\n    let attribute;\n    let attributeID;\n\n    // A Draco file may be created with default vertex attributes, whose attribute IDs\n    // are mapped 1:1 from their semantic name (POSITION, NORMAL, ...). Alternatively,\n    // a Draco file may contain a custom set of attributes, identified by known unique\n    // IDs. glTF files always do the latter, and `.drc` files typically do the former.\n    if (taskConfig.useUniqueIDs) {\n      attributeID = attributeIDs[attributeName];\n      attribute = decoder.GetAttributeByUniqueId(dracoGeometry, attributeID);\n    } else {\n      attributeID = decoder.GetAttributeId(dracoGeometry, draco[attributeIDs[attributeName]]);\n      if (attributeID === -1) continue;\n      attribute = decoder.GetAttribute(dracoGeometry, attributeID);\n    }\n    geometry.attributes.push(decodeAttribute(draco, decoder, dracoGeometry, attributeName, attributeType, attribute));\n  }\n  // Add index.\n  if (geometryType === draco.TRIANGULAR_MESH) {\n    // Generate mesh faces.\n    const numFaces = dracoGeometry.num_faces();\n    const numIndices = numFaces * 3;\n    let dataSize;\n    let ptr;\n    let index;\n    const indexType = self[taskConfig.indexType];\n\n    switch (indexType) {\n      case Uint16Array:\n        dataSize = numIndices * 2;\n        ptr = draco._malloc(dataSize);\n        decoder.GetTrianglesUInt16Array(dracoGeometry, dataSize, ptr);\n        index = new Uint16Array(draco.HEAPU16.buffer, ptr, numIndices).slice();\n        draco._free(ptr);\n        break;\n      case Uint32Array:\n        dataSize = numIndices * 4;\n        ptr = draco._malloc(dataSize);\n        decoder.GetTrianglesUInt32Array(dracoGeometry, dataSize, ptr);\n        index = new Uint32Array(draco.HEAPU32.buffer, ptr, numIndices).slice();\n        draco._free(ptr);\n      default:\n        throw new Error("DRACODecoder: Unexpected index type.");\n    }\n    geometry.index = { array: index, itemSize: 1 };\n  }\n  draco.destroy(dracoGeometry);\n  return geometry;\n}\n\nfunction decodeAttribute(draco, decoder, dracoGeometry, attributeName, attributeType, attribute) {\n  const numComponents = attribute.num_components();\n  const numPoints = dracoGeometry.num_points();\n  const numValues = numPoints * numComponents;\n  let ptr;\n  let array;\n  let dataSize;\n  switch (attributeType) {\n    case Float32Array:\n      dataSize = numValues * 4;\n      ptr = draco._malloc(dataSize);\n      decoder.GetAttributeDataArrayForAllPoints(dracoGeometry, attribute, draco.DT_FLOAT32, dataSize, ptr);\n      array = new Float32Array(draco.HEAPF32.buffer, ptr, numValues).slice();\n      draco._free(ptr);\n      break;\n\n    case Int8Array:\n      ptr = draco._malloc(numValues);\n      decoder.GetAttributeDataArrayForAllPoints(dracoGeometry, attribute, draco.DT_INT8, numValues, ptr);\n      array = new Int8Array(draco.HEAP8.buffer, ptr, numValues).slice();\n      draco._free(ptr);\n      break;\n\n    case Int16Array:\n      dataSize = numValues * 2;\n      ptr = draco._malloc(dataSize);\n      decoder.GetAttributeDataArrayForAllPoints(dracoGeometry, attribute, draco.DT_INT16, dataSize, ptr);\n      array = new Int16Array(draco.HEAP16.buffer, ptr, numValues).slice();\n      draco._free(ptr);\n      break;\n\n    case Int32Array:\n      dataSize = numValues * 4;\n      ptr = draco._malloc(dataSize);\n      decoder.GetAttributeDataArrayForAllPoints(dracoGeometry, attribute, draco.DT_INT32, dataSize, ptr);\n      array = new Int32Array(draco.HEAP32.buffer, ptr, numValues).slice();\n      draco._free(ptr);\n      break;\n\n    case Uint8Array:\n      ptr = draco._malloc(numValues);\n      decoder.GetAttributeDataArrayForAllPoints(dracoGeometry, attribute, draco.DT_UINT8, numValues, ptr);\n      array = new Uint8Array(draco.HEAPU8.buffer, ptr, numValues).slice();\n      draco._free(ptr);\n      break;\n\n    case Uint16Array:\n      dataSize = numValues * 2;\n      ptr = draco._malloc(dataSize);\n      decoder.GetAttributeDataArrayForAllPoints(dracoGeometry, attribute, draco.DT_UINT16, dataSize, ptr);\n      array = new Uint16Array(draco.HEAPU16.buffer, ptr, numValues).slice();\n      draco._free(ptr);\n      break;\n\n    case Uint32Array:\n      dataSize = numValues * 4;\n      ptr = draco._malloc(dataSize);\n      decoder.GetAttributeDataArrayForAllPoints(dracoGeometry, attribute, draco.DT_UINT32, dataSize, ptr);\n      array = new Uint32Array(draco.HEAPU32.buffer, ptr, numValues).slice();\n      draco._free(ptr);\n      break;\n\n    default:\n      throw new Error("DRACODecoder: Unexpected attribute type.");\n  }\n\n  return {\n    name: attributeName,\n    array: array,\n    itemSize: numComponents\n  };\n}\n',nr="https://gw.alipayobjects.com/os/lib/alipay/draco-javascript/1.3.6/lib/",ir=function(){function e(){var i,r=arguments.length>0&&void 0!==arguments[0]?arguments[0]:{type:"wasm",workerLimit:4};(n(this,e),this.pool=[],this.workerLimit=Math.min(navigator.hardwareConcurrency||4,4),this.currentTaskId=1,this.taskCache=new WeakMap,r.workerLimit>this.workerLimit)?Le.warn("DRACOWorkerPool: Can not initialize worker pool with limit:"+r.workerLimit):this.workerLimit=null!==(i=r.workerLimit)&&void 0!==i?i:4;this.useJS="object"!==("undefined"==typeof WebAssembly?"undefined":t(WebAssembly))||"js"===r.type,this.loadLibPromise=this.preloadLib()}return r(e,[{key:"preloadLib",value:function(){var e=this;return this.loadLibPromise?this.loadLibPromise:new Promise((function(t,n){e.useJS?bt("".concat(nr).concat("draco_decoder_gltf.js"),{type:"text"}).then((function(e){var n=[e,tr].join("\n"),i=URL.createObjectURL(new Blob([n]));t({workerSourceURL:i,decoderWASMBinary:null})})).catch((function(e){n(e)})):Promise.all([bt("".concat(nr).concat("draco_wasm_wrapper_gltf.js"),{type:"text"}),bt("".concat(nr).concat("draco_decoder_gltf.r3bin"),{type:"arraybuffer"})]).then((function(e){var n=y(e,2),i=n[0],r=n[1],a=[i,tr].join("\n"),o=URL.createObjectURL(new Blob([a]));t({workerSourceURL:o,decoderWASMBinary:r})})).catch((function(e){n(e)}))}))}},{key:"getWorker",value:function(){var e=this;return this.preloadLib().then((function(t){if(e.pool.length<e.workerLimit){var n=new er(t.workerSourceURL,t.decoderWASMBinary);e.pool.push(n)}else e.pool.sort((function(e,t){return e.currentLoad>t.currentLoad?-1:1}));return e.pool[e.pool.length-1]}))}},{key:"decode",value:function(e,t){var n=this,i=JSON.stringify(t);if(this.taskCache.has(e)){var r=this.taskCache.get(e);if(r.key===i)return r.promise;if(0===e.byteLength)throw new Error("DRACODecoder: Unable to re-decode a buffer with different settings. Buffer has already been transferred.")}var a,o=this.currentTaskId++,s=e.byteLength,u=new Promise((function(i,r){n.getWorker().then((function(n){a=n,n.setCosts(o,s),n.addCurrentLoad(s),n.setCallback(o,i,r),n.decode(o,t,e)})).catch((function(e){r(e)}))}));return u.finally((function(){a&&o&&a.releaseTask(o)})),this.taskCache.set(e,{key:i,promise:u}),u}}]),e}(),rr=Object.defineProperty,ar=Object.getOwnPropertyDescriptor;var or=function(e){l(i,e);var t=m(i);function i(){return n(this,i),t.apply(this,arguments)}return r(i,[{key:"load",value:function(e){var t=e.url;return function(e){return/^data:(.+?);base64,/.test(e)}(t)?new V((function(e){var n=t.slice(13+RegExp.$1.length);e(Uint8Array.from(atob(n),(function(e){return e.charCodeAt(0)})).buffer)})):this.request(t,u(u({},e),{},{type:"arraybuffer"}))}}]),i}(Ot);or=function(e,t,n,i){for(var r,a=i>1?void 0:i?ar(t,n):t,o=e.length-1;o>=0;o--)(r=e[o])&&(a=(i?r(t,n,a):r(a))||a);return i&&a&&rr(t,n,a),a}([X(e.AssetType.Buffer,["bin","r3bin"],!1)],or);var sr,ur={5120:Int8Array,5121:Uint8Array,5122:Int16Array,5123:Uint16Array,5125:Uint32Array,5126:Float32Array};function lr(e){return{SCALAR:1,VEC2:2,VEC3:3,VEC4:4,MAT2:4,MAT3:9,MAT4:16}[e]}function cr(e){return ur[e]}function hr(e,t,n){var i,r,a=e.bufferViews[t.bufferView],o=n[a.buffer],s=t.hasOwnProperty("byteOffset")?t.byteOffset:0,u=a.hasOwnProperty("byteOffset")?a.byteOffset:0,l=s+u,c=lr(t.type),h=c*t.count,d=null!==(i=a.byteStride)&&void 0!==i?i:0,f=cr(t.componentType);if(d){r=new Uint8Array(h*f.BYTES_PER_ELEMENT);for(var _=new Uint8Array(o,u,a.byteLength),p=0,v=c*f.BYTES_PER_ELEMENT,m=0;m<t.count;m++){p=m*d+s;for(var g=0;g<v;g++)r[m*v+g]=_[p+g]}}else r=new Uint8Array(o,l,h*f.BYTES_PER_ELEMENT),r=new Uint8Array(r);return new f(r.buffer)}function dr(e,t){var n=t[e.buffer],i=e.byteOffset||0;return n.slice(i,i+e.byteLength)}function fr(e){return lr(e.type)*cr(e.componentType).BYTES_PER_ELEMENT}function _r(t,n,i,r){var a=lr(i.type);return new Ln(n,0,function(t,n){if(t==e.DataType.FLOAT)switch(n){case 1:return e.VertexElementFormat.Float;case 2:return e.VertexElementFormat.Vector2;case 3:return e.VertexElementFormat.Vector3;case 4:return e.VertexElementFormat.Vector4}if(t==e.DataType.UNSIGNED_SHORT)switch(n){case 2:return e.VertexElementFormat.UShort2;case 4:return e.VertexElementFormat.UShort4}}(i.componentType,a),r)}function pr(e,t){return new Promise((function(n,i){var r=new window.Blob([e],{type:t}),a=new Image;a.src=URL.createObjectURL(r),a.crossOrigin="anonymous",a.onerror=function(){i(new Error("Failed to load image buffer"))},a.onload=function(){requestAnimationFrame((function(){n(a)}))}}))}function vr(e,t){return/^(?:http|blob|data:|\/)/.test(t)?t:e.substring(0,e.lastIndexOf("/")+1)+t}var mr={init:function(){sr||(sr=new ir)},parse:function(e,t,n,i){var r=n.bufferViews,a=n.accessors,o=e.bufferView,s=e.attributes,u={},l={};for(var c in s)u[c]=s[c];for(var h in t.attributes)if(void 0!==s[h]){var d=a[t.attributes[h]];l[h]=cr(d.componentType).name}var f={attributeIDs:u,attributeTypes:l,useUniqueIDs:!0,indexType:cr(a[t.indices].componentType).name},_=dr(r[o],i);return sr.decode(_,f).then((function(e){return e}))}},gr={translation:"position",rotation:"rotation",scale:"scale",weights:"weights"},yr=0,xr={},Tr={},Ar=function(e){var t=new $n(e,"default");return t.emission=new U(.749,.749,.749,1),t},Sr="PBRMaterial",Er="KHR_lights",Cr="KHR_draco_mesh_compression",br=null,Rr={KHR_lights:br,KHR_materials_unlit:Ai,KHR_materials_pbrSpecularGlossiness:Ai,KHR_techniques_webgl:xn,KHR_draco_mesh_compression:mr};var wr=function(e){l(i,e);var t=m(i);function i(){return n(this,i),t.apply(this,arguments)}return i}(re);function Mr(e,t){var n={engine:t,gltf:e.gltf,buffers:e.buffers,asset:new wr(t)};return n.asset.textures=e.textures,n.asset.meta=e.gltf,n.gltf.asset&&n.gltf.asset.version&&(n.gltf.version=Number(n.gltf.asset.version),n.gltf.isGltf2=n.gltf.version>=2&&n.gltf.version<=3),function(e){var t=e.gltf,n=e.asset,i=t.extensions,r=t.extensionsUsed,a=t.extensionsRequired;if(r){Le.info("extensionsUsed: ",r);for(var o=0;o<r.length;o++)Object.keys(Rr).indexOf(r[o])>-1?Rr[r[o]]||Le.warn("extension "+r[o]+" is used, you can add this extension into gltf"):Le.warn("extensionsUsed has unsupported extension "+r[o])}if(a){Le.info("extensionsRequired: ".concat(a));for(var s=0;s<a.length;s++)(Object.keys(Rr).indexOf(a[s])<0||!Rr[a[s]])&&Le.error("model has not supported required extension ".concat(a[s])),a[s]===Cr&&Rr.KHR_draco_mesh_compression.init()}i&&br&&i.KHR_lights&&(n.lights=br.parseLights(i.KHR_lights.lights))}(n),Lr(n,"materials",Pr).then((function(){return Lr(n,"meshes",kr)})).then((function(){return Lr(n,"nodes",Dr)})).then((function(){return Lr(n,"scenes",Nr)})).then((function(){return Lr(n,"skins",Or)})).then((function(){return Lr(n,"animations",Ir)})).then((function(){return function(e){var t,n=e.asset,i=e.gltf,r=i.nodes||[],a=i.meshes;n.defaultScene=Br("scenes",null!==(t=i.scene)&&void 0!==t?t:0,e);for(var o=r.length-1;o>=0;o--){var s=r[o],u=Br("nodes",o,e);if(s.hasOwnProperty("children"))for(var l=s.children||[],c=l.length-1;c>=0;c--){var h=Br("nodes",l[c],e);u.addChild(h)}if(s.hasOwnProperty("mesh")){var d=s.mesh;u.meshIndex=d;var f=a[d].primitives,_=Br("meshes",d,e),p=void 0;if(s.hasOwnProperty("skin")||_.hasOwnProperty("weights")){var v=Br("skins",s.skin,e),m=_.weights,g=u.addComponent(pn);g.mesh=_,g.skin=v,g.setWeights(m),p=g}else(p=u.addComponent(ln)).mesh=_;for(var y=0,x=f.length;y<x;y++){var T=f[y].material;_.primitives[y].materialIndex=T;var A=void 0!==T?Br("materials",T,e):Ar(u.engine);p.setSharedMaterial(y,A)}}}var S=n.defaultScene.nodes;if(1===S.length)n.defaultSceneRoot=S[0];else{for(var E=new Xe(e.engine),C=0;C<S.length;C++)E.addChild(S[C]);n.defaultSceneRoot=E}var b=n.defaultSceneRoot.addComponent(Jn),R=n.animations;R&&R.forEach((function(e){b.addAnimationClip(e,e.name)}));return e.asset}(n)}))}function Lr(e,t,n){var i=e.gltf,r=e.asset;if(r[t]||(r[t]=[]),i.hasOwnProperty(t)){var a=i[t]||[];Le.debug(t+":",a);for(var o=[],s=a.length-1;s>=0;s--)o.push(n(a[s],e));return Promise.all(o).then((function(e){for(var n=0;n<e.length;n++)r[t].push(e[n])}))}return Promise.resolve()}function Pr(e,n){var i,r=n.gltf;n.asset;if(r.isGltf2&&void 0===e.technique){var a={},s={},u=e.pbrMetallicRoughness,l=e.normalTexture,c=e.emissiveTexture,h=(e.emissiveFactor,e.occlusionTexture),d=e.alphaMode,_=e.alphaCutoff,p=e.doubleSided,v=e.extensions;if(u){var m=u.baseColorFactor,g=u.baseColorTexture,y=u.metallicFactor,T=u.roughnessFactor,A=u.metallicRoughnessTexture;g&&(a.baseColorTexture=Br("textures",g.index||0,n,!1)),m&&(a.baseColorFactor=f(U,x(m))),a.metallicFactor=void 0!==y?y:1,a.roughnessFactor=void 0!==T?T:1,A&&(a.metallicRoughnessTexture=Br("textures",A.index||0,n,!1))}if(l){var S=l.index,E=(l.texCoord,l.scale);a.normalTexture=Br("textures",S||0,n,!1),void 0!==t(E)&&(a.normalScale=E)}if(c&&(a.emissiveTexture=Br("textures",c.index||0,n,!1)),h&&(a.occlusionTexture=Br("textures",h.index||0,n,!1),void 0!==h.strength&&(a.occlusionStrength=h.strength)),s.doubleSided=!!p,s.alphaMode=d||"OPAQUE","MASK"===d&&(a.alphaCutoff=void 0===_?.5:_),v&&(v.KHR_materials_unlit&&(s.unlit=!0),v.KHR_materials_pbrSpecularGlossiness)){var C=v.KHR_materials_pbrSpecularGlossiness,b=C.diffuseFactor,R=C.diffuseTexture,M=C.specularFactor,L=C.glossinessFactor,P=C.specularGlossinessTexture;s.isMetallicWorkflow=!1,b&&(a.baseColorFactor=f(U,x(b))),R&&(a.baseColorTexture=Br("textures",R.index||0,n,!1)),M&&(a.specularFactor=f(w,x(M))),void 0!==L&&(a.glossinessFactor=L),P&&(a.specularGlossinessTexture=Br("textures",P.index||0,n,!1))}var O=e.unlit,F=e.srgb,k=e.gamma,I=e.blendFunc,D=e.depthMask;O&&(s.unlit=!0),F&&(s.srgb=!0),k&&(s.gamma=!0),I&&(s.blendFunc=I),void 0!==D&&(s.depthMask=D),i=new Ai(n.engine,e.name||Ai.MATERIAL_NAME,o({},a,s))}else{var N=e.technique;if(Le.warn("Deprecated: Please use a model that meets the glTF 2.0 specification"),"Texture"===N){(i=new Ai(n.engine,e.name||Ai.MATERIAL_NAME)).unlit=!0;var B=e.values._MainTex[0];i.baseColorTexture=Br("textures",B||0,n,!1)}}return Promise.resolve(i)}function Or(e,t){for(var n=t.gltf,i=t.buffers,r=e.joints.length,a=new Jt(e.name),o=hr(n,n.accessors[e.inverseBindMatrices],i),s=0;s<r;s++){var u=16*s,l=u+16;a.inverseBindMatrices[s]=f(F,x(o.subarray(u,l)))}for(var c=0;c<r;c++){var h=Br("nodes",e.joints[c],t);a.joints[c]=h.name}var d=Br("nodes",null==e.skeleton?e.joints[0]:e.skeleton,t);return a.skeleton=d.name,Promise.resolve(a)}function Fr(t,n,i,r,a,o,s,u){var l=0,c=[];for(var h in r.attributes){var d=r.attributes[h],f=a.accessors[d],_=fr(f),p=_r(0,h,f,l);c.push(p);var v=o(h),m=new bn(u,e.BufferBindFlag.VertexBuffer,v.byteLength,e.BufferUsage.Static);if(m.setData(v),n.setVertexBufferBinding(m,_,l++),"POSITION"==p.semantic)for(var g=new w,y=v.length/3,x=t.bounds,T=x.min,A=x.max,S=0;S<y;S++){var E=3*S;g.setValue(v[E],v[E+1],v[E+2]),w.min(T,g,T),w.max(A,g,A)}}n.setVertexElements(c);var C=a.accessors[r.indices],b=s(),R=C.count,M=function(t){switch(t){case e.DataType.UNSIGNED_BYTE:return e.IndexFormat.UInt8;case e.DataType.UNSIGNED_SHORT:return e.IndexFormat.UInt16;case e.DataType.UNSIGNED_INT:return e.IndexFormat.UInt32}}(C.componentType),L=M==e.IndexFormat.UInt32?4:M==e.IndexFormat.UInt16?2:1,P=new bn(u,e.BufferBindFlag.IndexBuffer,R*L,e.BufferUsage.Static);return P.setData(b),n.setIndexBufferBinding(new Rn(P,M)),i.start=0,i.count=R,Promise.resolve(n)}function kr(t,n){for(var i=n.gltf,r=n.buffers,a=n.engine,o=new Yt(t.name),s=[],u=[],l=function(l){s.push(new Promise((function(s,c){var h,d=t.primitives[l],f=new Mn(a,d.name||t.name||l),_=new Pn;if(u.push(_),_.topology=null==d.mode?e.PrimitiveTopology.Triangles:d.mode,d.hasOwnProperty("targets")&&(f.targets=[],o.weights=t.weights||new Array(d.targets.length).fill(0)),d.extensions&&d.extensions[Cr]){var p=Rr.KHR_draco_mesh_compression,v=d.extensions[Cr];h=p.parse(v,d,i,r).then((function(e){return Fr(o,f,_,d,i,(function(t){for(var n=0;n<e.attributes.length;n++)if(e.attributes[n].name===t)return e.attributes[n].array;return null}),(function(){return e.index.array}),n.engine)}))}else h=Fr(o,f,_,d,i,(function(e){var t=d.attributes[e],n=i.accessors[t];return hr(i,n,r)}),(function(){var e=i.accessors[d.indices];return hr(i,e,r)}),n.engine);h.then((function(e){s(e)})).catch((function(e){c(e)}))})))},c=0;c<t.primitives.length;c++)l(c);return Promise.all(s).then((function(e){for(var t=0;t<e.length;t++)o.primitives.push(e[t]),o.groups.push(u[t]);return o}))}function Ir(t,n){for(var i=n.gltf,r=n.buffers,a=t.samplers||[],o=t.channels||[],s=i.animations.indexOf(t),u=new qn(t.name||"Animation".concat(s)),l=-1,c=-1,h=0;h<a.length;h++){var d=a[h],f=i.accessors[d.input],_=i.accessors[d.output],p=hr(i,f,r),v=hr(i,_,r),m=lr(_.type);m*p.length!==v.length&&(m=v.length/p.length);var g=e.InterpolationType.LINEAR;switch(d.interpolation){case"CUBICSPLINE":g=e.InterpolationType.CUBICSPLINE;break;case"STEP":g=e.InterpolationType.STEP}var y=p[p.length-1];y>l&&(l=y,c=h),u.addSampler(p,v,m,g)}u.durationIndex=c,u.duration=l;for(var x=0;x<o.length;x++){var T=o[x],A=T.target,S=T.sampler,E=Br("nodes",A.node,n),C=gr[A.path];u.addChannel(S,E.name,C)}return Promise.resolve(u)}function Dr(t,n){var i=new Xe(n.engine,t.name||"GLTF_NODE_".concat(yr++));if(t.hasOwnProperty("matrix")){var r=t.matrix,a=new F;a.setValueByArray(r);var s=new w,u=new w(1,1,1),l=new O;a.decompose(s,l,u),i.transform.position=s,i.transform.rotationQuaternion=l,i.transform.scale=u}else for(var c in gr)if(t.hasOwnProperty(c)){var h=gr[c];if("weights"===h)i[h]=t[c];else{var d=t[c],f=d.length,_=i[h];2===f?_.setValue(d[0],d[1]):3===f?_.setValue(d[0],d[1],d[2]):4===f&&_.setValue(d[0],d[1],d[2],d[3]),i[h]=_}}if(void 0!==t.camera){var p=n.gltf.cameras[t.camera],v=i.addComponent(e.Camera);if("orthographic"===p.type){v.isOrthographic=!0;var m=p.orthographic,g=m.ymag,y=m.xmag,x=m.zfar,T=m.znear;void 0!==T&&(v.nearClipPlane=T),void 0!==x&&(v.farClipPlane=x),g&&y&&(v.orthographicSize=Math.max(g,y)/2),void 0!==g&&y&&(v.orthographicSize=y/2),void 0!==y&&g&&(v.orthographicSize=g/2)}else{var A=p.perspective,S=(A.aspectRatio,A.yfov),E=A.zfar,C=A.znear;void 0!==S&&(v.fieldOfView=S),void 0!==E&&(v.farClipPlane=E),void 0!==C&&(v.nearClipPlane=C)}}if(t.extensions&&br&&t.extensions.KHR_lights){var b=t.extensions.KHR_lights.light;if(void 0!==b){var R=Br("lights",b,n);if(R)o(i.addComponent(R.ability),R.props)}}return Promise.resolve(i)}function Nr(e,t){for(var n=[],i=0;i<e.nodes.length;i++){var r=Br("nodes",e.nodes[i],t);n.push(r)}if(e.extensions&&br&&e.extensions.KHR_lights){var a=e.extensions.KHR_lights.light;if(void 0!==a){var o=Br("lights",a,t);o&&n[0].addComponent(o.ability,o.props)}}return Promise.resolve({nodes:n})}function Br(e,t,n){var i=!(arguments.length>3&&void 0!==arguments[3])||arguments[3],r=n.asset,a=i?r[e].length-t-1:t;return r[e][a]}function zr(e){var t=1313821514,n=5130562,i=new DataView(e),r={magic:i.getUint32(0,!0),version:i.getUint32(4,!0),length:i.getUint32(8,!0)};if(1179937895!==r.magic)return console.error("Invalid glb magic number. Expected 0x46546C67, found 0x"+r.magic.toString(16)),null;var a=i.getUint32(12,!0),o=i.getUint32(16,!0);if(o!==t)return console.error("Invalid glb chunk type. Expected 0x004E4942, found 0x"+o.toString(16)),null;for(var s=new Uint8Array(e,20,a),u=JSON.parse(function(e){if("undefined"!=typeof TextDecoder)return(new TextDecoder).decode(e);for(var t="",n=0,i=e.length;n<i;n++)t+=String.fromCharCode(e[n]);return decodeURIComponent(encodeURIComponent(t))}(s)),l=[],c=20+a;c<r.length;){if(a=i.getUint32(c,!0),(o=i.getUint32(c+4,!0))!==n)return console.error("Invalid glb chunk type. Expected 0x004E4942, found 0x"+o.toString(16)),null;var h=c+8,d=e.slice(h,h+a);l.push(d),c+=a+8}return{gltf:u,buffers:l}}var Gr=Object.defineProperty,Ur=Object.getOwnPropertyDescriptor,Vr=function(t){l(a,t);var i=m(a);function a(){var t;return n(this,a),(t=i.apply(this,arguments)).requestGLTF=function(e,n){return t.request(e.url,u(u({},e),{},{type:"json"})).then((function(i){return t._loadGLTFResources(e,i,n)}))},t.requestGLB=function(e,n){return t.request(e.url,u(u({},e),{},{type:"arraybuffer"})).then(zr).then((function(t){return u(u({},t),{},{baseUrl:e.url,resourceManager:n})})).then(t._loadImages)},t._loadImages=function(n){var i=n.gltf,r=n.buffers,a=n.baseUrl,o=n.resourceManager;if(!i.images)return Promise.resolve({gltf:i,buffers:r});var s=o.engine._hardwareRenderer;return(i.astc&&s.canIUse(e.GLCapabilityType.pvrtc)?t._loadCompressedTexture(o,i.pvrtc,a):i.pvrtc&&s.canIUse(e.GLCapabilityType.astc)?t._loadCompressedTexture(o,i.astc,a):i.etc&&s.canIUse(e.GLCapabilityType.etc)?t._loadCompressedTexture(o,i.etc,a):t._loadBasicImages(o,i.images,a,r,i)).then((function(e){return{gltf:i,buffers:r,textures:e}}))},t._loadBasicImages=function(t,n,i,r,a){return Promise.all(n.map((function(n){var o=n.uri,s=n.bufferView,u=n.mimeType;return o?t.load({url:vr(i,o),type:e.AssetType.Texture2D}):pr(dr(a.bufferViews[s],r),u).then((function(e){var n=new hn(t.engine,e.width,e.height);return n.setImageSource(e),n.generateMipmaps(),n}))})))},t._loadCompressedTexture=function(t,n,i){var r=n.map((function(n){return t.load({url:vr(i,n.uri),type:e.AssetType.KTX})}));return Promise.all(r)},t}return r(a,[{key:"load",value:function(e,t){var n=this;return new V((function(i,r){(n.isGLB(e.url)?n.requestGLB:n.requestGLTF)(e,t).then((function(e){Mr(e,t.engine).then((function(e){i(e)}))})).catch((function(t){console.error(t),r("Error loading glTF JSON from "+e.url)}))}))}},{key:"isGLB",value:function(e){return"glb"===e.substring(e.lastIndexOf(".")+1)}},{key:"_loadGLTFResources",value:function(e,t,n){return this._loadBuffers(e.url,t,n).then(this._loadImages)}},{key:"_loadBuffers",value:function(t,n,i){return n.buffers?Promise.all(n.buffers.map((function(n){return n instanceof ArrayBuffer?Promise.resolve(n):i.load({url:vr(t,n.uri),type:e.AssetType.Buffer})}))).then((function(e){return{buffers:e,gltf:n,baseUrl:t,resourceManager:i}})):Promise.resolve({baseUrl:t,gltf:n,resourceManager:i})}}]),a}(Ot);Vr=function(e,t,n,i){for(var r,a=i>1?void 0:i?Ur(t,n):t,o=e.length-1;o>=0;o--)(r=e[o])&&(a=(i?r(t,n,a):r(a))||a);return i&&a&&Gr(t,n,a),a}([X(e.AssetType.Perfab,["gltf","glb"])],Vr);var Hr=Object.defineProperty,jr=Object.getOwnPropertyDescriptor,Wr=function(e){l(i,e);var t=m(i);function i(){return n(this,i),t.apply(this,arguments)}return r(i,[{key:"load",value:function(e){return this.request(e.url,u(u({},e),{},{type:"json"}))}}]),i}(Ot);Wr=function(e,t,n,i){for(var r,a=i>1?void 0:i?jr(t,n):t,o=e.length-1;o>=0;o--)(r=e[o])&&(a=(i?r(t,n,a):r(a))||a);return i&&a&&Hr(t,n,a),a}([X(e.AssetType.JSON,["json"],!1)],Wr);function qr(e,t){for(var n=[],i=64+e.bytesOfKeyValueData,r=e.pixelWidth,a=e.pixelHeight,o=t?e.numberOfMipmapLevels:1,s=0;s<o;s++){var u=new Int32Array(e.buffer,i,1)[0];i+=4;for(var l=0;l<e.numberOfFaces;l++){var c=new Uint8Array(e.buffer,i,u);n.push({data:c,width:r,height:a}),i+=u,i+=3-(u+3)%4}r=Math.max(1,.5*r),a=Math.max(1,.5*a)}return n}function Xr(e){if(e.byteLength>=12){var t=new Uint8Array(e,0,12);if(171===t[0]&&75===t[1]&&84===t[2]&&88===t[3]&&32===t[4]&&49===t[5]&&49===t[6]&&187===t[7]&&13===t[8]&&10===t[9]&&26===t[10]&&10===t[11])return!0}return!1}function Kr(t){switch(t){case e.GLCompressedTextureInternalFormat.RGB_S3TC_DXT1_EXT:return e.TextureFormat.DXT1;case e.GLCompressedTextureInternalFormat.RGBA_S3TC_DXT5_EXT:return e.TextureFormat.DXT5;case e.GLCompressedTextureInternalFormat.RGB_ETC1_WEBGL:return e.TextureFormat.ETC1_RGB;case e.GLCompressedTextureInternalFormat.RGB8_ETC2:return e.TextureFormat.ETC2_RGB;case e.GLCompressedTextureInternalFormat.RGB8_PUNCHTHROUGH_ALPHA1_ETC2:return e.TextureFormat.ETC2_RGBA5;case e.GLCompressedTextureInternalFormat.RGBA8_ETC2_EAC:return e.TextureFormat.ETC2_RGBA8;case e.GLCompressedTextureInternalFormat.RGB_PVRTC_2BPPV1_IMG:return e.TextureFormat.PVRTC_RGB2;case e.GLCompressedTextureInternalFormat.RGBA_PVRTC_2BPPV1_IMG:return e.TextureFormat.PVRTC_RGBA2;case e.GLCompressedTextureInternalFormat.RGB_PVRTC_4BPPV1_IMG:return e.TextureFormat.PVRTC_RGB4;case e.GLCompressedTextureInternalFormat.RGBA_PVRTC_4BPPV1_IMG:return e.TextureFormat.PVRTC_RGBA4;case e.GLCompressedTextureInternalFormat.RGBA_ASTC_4X4_KHR:return e.TextureFormat.ASTC_4x4;case e.GLCompressedTextureInternalFormat.RGBA_ASTC_5X5_KHR:return e.TextureFormat.ASTC_5x5;case e.GLCompressedTextureInternalFormat.RGBA_ASTC_6X6_KHR:return e.TextureFormat.ASTC_6x6;case e.GLCompressedTextureInternalFormat.RGBA_ASTC_8X8_KHR:return e.TextureFormat.ASTC_8x8;case e.GLCompressedTextureInternalFormat.RGBA_ASTC_10X10_KHR:return e.TextureFormat.ASTC_10x10;case e.GLCompressedTextureInternalFormat.RGBA_ASTC_12X12_KHR:return e.TextureFormat.ASTC_12x12;default:var n=e.GLCompressedTextureInternalFormat[t];throw new Error("this format is not supported in Oasis Engine: ".concat(n))}}var Qr=function(e,t,n){var i=arguments.length>3&&void 0!==arguments[3]&&arguments[3];if(!Xr(e))throw new Error("khronosTextureContainerParser: invalid KTX file, texture missing KTX identifier");var r=Uint32Array.BYTES_PER_ELEMENT,a=new DataView(e,12,13*r),o=a.getUint32(0,!0),s=67305985===o,u={buffer:e,glType:a.getUint32(1*r,s),glTypeSize:a.getUint32(2*r,s),glFormat:a.getUint32(3*r,s),glInternalFormat:a.getUint32(4*r,s),glBaseInternalFormat:a.getUint32(5*r,s),pixelWidth:a.getUint32(6*r,s),pixelHeight:a.getUint32(7*r,s),pixelDepth:a.getUint32(8*r,s),numberOfArrayElements:a.getUint32(9*r,s),numberOfFaces:a.getUint32(10*r,s),numberOfMipmapLevels:a.getUint32(11*r,s),bytesOfKeyValueData:a.getUint32(12*r,s),loadType:0};if(0!==u.glType)throw new Error("only compressed formats currently supported");if(u.numberOfMipmapLevels=Math.max(1,u.numberOfMipmapLevels),0===u.pixelHeight||0!==u.pixelDepth)throw new Error("only 2D textures currently supported");if(0!==u.numberOfArrayElements)throw new Error("texture arrays not currently supported");if(u.numberOfFaces!==t)throw new Error("number of faces expected"+t+", but found "+u.numberOfFaces);return n&&(u.mipmaps=qr(u,!0)),i&&(u.engineFormat=Kr(u.glInternalFormat)),u};function Yr(e){var t=Qr(e,1,!0,!0);return{mipmaps:t.mipmaps,engineFormat:t.engineFormat,internalFormat:t.glInternalFormat,width:t.pixelWidth,height:t.pixelHeight}}var Jr=Object.defineProperty,Zr=Object.getOwnPropertyDescriptor,$r=function(t){l(a,t);var i=m(a);function a(){return n(this,a),i.apply(this,arguments)}return r(a,[{key:"load",value:function(t,n){var i=this;return new V((function(r,a){Promise.all(t.urls.map((function(e){return i.request(e,u(u({},t),{},{type:"arraybuffer"}))}))).then((function(t){for(var i=function(e){for(var t,n,i,r,a=[],o=0;o<e.length;o++){var s=Qr(e[o],1,!0,!0);a.push(s.mipmaps),0===o&&(i=s.pixelWidth,r=s.pixelHeight,t=s.glInternalFormat,n=s.engineFormat)}return{mipmapsFaces:a,engineFormat:n,internalFormat:t,width:i,height:r}}(t),a=i.width,o=i.mipmapsFaces,s=i.engineFormat,u=o[0].length>1,l=new Un(n.engine,a,s,u),c=0;c<6;c++)for(var h=o[c].length,d=0;d<h;d++){var f=o[c][d],_=f.data,p=f.width,v=f.height;l.setPixelBuffer(e.TextureCubeFace.PositiveX+c,_,d,0,0,p,v)}r(l)})).catch((function(e){a(e)}))}))}}]),a}(Ot);$r=function(e,t,n,i){for(var r,a=i>1?void 0:i?Zr(t,n):t,o=e.length-1;o>=0;o--)(r=e[o])&&(a=(i?r(t,n,a):r(a))||a);return i&&a&&Jr(t,n,a),a}([X(e.AssetType.KTXCube,[])],$r);var ea=Object.defineProperty,ta=Object.getOwnPropertyDescriptor,na=function(e){l(i,e);var t=m(i);function i(){return n(this,i),t.apply(this,arguments)}return r(i,[{key:"load",value:function(e,t){var n=this;return new V((function(i,r){n.request(e.url,u(u({},e),{},{type:"arraybuffer"})).then((function(e){for(var n=Yr(e),r=n.width,a=n.height,o=n.mipmaps,s=n.engineFormat,u=o.length>1,l=new hn(t.engine,r,a,s,u),c=0;c<o.length;c++){var h=o[c],d=h.width,f=h.height,_=h.data;l.setPixelBuffer(_,c,0,0,d,f)}i(l)})).catch((function(e){r(e)}))}))}}]),i}(Ot);na=function(e,t,n,i){for(var r,a=i>1?void 0:i?ta(t,n):t,o=e.length-1;o>=0;o--)(r=e[o])&&(a=(i?r(t,n,a):r(a))||a);return i&&a&&ea(t,n,a),a}([X(e.AssetType.KTX,["ktx"])],na);var ia=Object.defineProperty,ra=Object.getOwnPropertyDescriptor,aa=function(e){l(i,e);var t=m(i);function i(){return n(this,i),t.apply(this,arguments)}return r(i,[{key:"load",value:function(e,t){var n=this;return new V((function(i,r){n.request(e.url,u(u({},e),{},{type:"image"})).then((function(n){var r=new hn(t.engine,n.width,n.height);if(r._glTexture){if(r.setImageSource(n),r.generateMipmaps(),0!==e.url.indexOf("data:")){var a=e.url.split("/");r.name=a[a.length-1]}i(r)}})).catch((function(e){r(e)}))}))}}]),i}(Ot);aa=function(e,t,n,i){for(var r,a=i>1?void 0:i?ra(t,n):t,o=e.length-1;o>=0;o--)(r=e[o])&&(a=(i?r(t,n,a):r(a))||a);return i&&a&&ia(t,n,a),a}([X(e.AssetType.Texture2D,["png","jpg","webp","jpeg"])],aa);var oa=Object.defineProperty,sa=Object.getOwnPropertyDescriptor,ua=function(t){l(a,t);var i=m(a);function a(){return n(this,a),i.apply(this,arguments)}return r(a,[{key:"load",value:function(t,n){var i=this;return new V((function(r,a){Promise.all(t.urls.map((function(e){return i.request(e,u(u({},t),{},{type:"image"}))}))).then((function(t){var i=t[0],a=i.width;if(a===i.height){var o=new Un(n.engine,a);if(o._glTexture){for(var s=0;s<6;s++)o.setImageSource(e.TextureCubeFace.PositiveX+s,t[s],0);o.generateMipmaps(),r(o)}}else console.error("The cube texture must have the same width and height")})).catch((function(e){a(e)}))}))}}]),a}(Ot);ua=function(e,t,n,i){for(var r,a=i>1?void 0:i?sa(t,n):t,o=e.length-1;o>=0;o--)(r=e[o])&&(a=(i?r(t,n,a):r(a))||a);return i&&a&&oa(t,n,a),a}([X(e.AssetType.TextureCube,[""])],ua);var la=function(e){l(i,e);var t=m(i);function i(e){var r;return n(this,i),(r=t.call(this,e))._hasBuiltNode=!1,r}return r(i,[{key:"init",value:function(e){var t=this,n=e.asset,i=void 0===n?null:n,r=e.autoPlay,a=e.loop;if(e.isClone){var o=e.gltfRootName;o&&(this.GLTFNode=this.entity.findByName(o))}if(this.GLTFNode)this._hasBuiltNode=!0;else{var s="GLTF-".concat(Date.now());e.gltfRootName=s,this.GLTFNode=this.entity.createChild(s),this._hasBuiltNode=!1}this.asset=i,this.loop=a,this.autoPlay=r,this.addEventListener("enabled",(function(){t.GLTFNode.isActive=!0})),this.addEventListener("disabled",(function(){t.GLTFNode.isActive=!1}))}},{key:"asset",get:function(){return this._asset},set:function(e){e&&e.defaultSceneRoot===this.GLTFNode||(this._hasBuiltNode||(this.GLTFNode.clearChildren(),null!==e&&(this.GLTFNode&&this.GLTFNode.destroy(),this.GLTFNode=e.defaultSceneRoot.clone(),this._animator=this.GLTFNode.getComponent(Jn),this.entity.addChild(this.GLTFNode))),this._asset=e)}},{key:"animator",get:function(){return this._animator}},{key:"autoPlay",get:function(){return this._autoPlay},set:function(e){this._animator&&(e?this._animator.playAnimationClip(e,{wrapMode:this._loop}):this._animator.stop(!1)),this._autoPlay=e}},{key:"loop",get:function(){return this._loop},set:function(e){this._animator&&this.autoPlay&&this._animator.playAnimationClip(this._autoPlay,{wrapMode:e}),this._loop=e}}]),i}(Ue),ca=function(){function e(){n(this,e),this.registeredPlugins=new Set,this.plugins=[]}return r(e,[{key:"register",value:function(e){this.registeredPlugins.add(e)}},{key:"boot",value:function(e){var t,n=S(this.registeredPlugins.values());try{for(n.s();!(t=n.n()).done;){var i=t.value;"function"==typeof i&&(i=i(e)),this.plugins.push(i)}}catch(e){n.e(e)}finally{n.f()}}},{key:"reset",value:function(){this.registeredPlugins.clear(),this.plugins=[]}},{key:"nodeAdded",value:function(e){this.delegateMethod("nodeAdded",e)}},{key:"delegateMethod",value:function(e){for(var t=arguments.length,n=new Array(t>1?t-1:0),i=1;i<t;i++)n[i-1]=arguments[i];this.plugins.forEach((function(t){return t[e]&&t[e].apply(t,n)}))}}]),e}();function ha(e){return function(t,n,i){var r=i.value;i.value=function(){for(var t,n=this,i=arguments.length,a=new Array(i),o=0;o<i;o++)a[o]=arguments[o];return e.before&&(t=this.oasis.pluginManager).delegateMethod.apply(t,[e.before].concat(a)),Promise.resolve(r.apply(this,arguments)).then((function(t){return e.after&&n.oasis.pluginManager.delegateMethod(e.after,t),t}))}}}function da(e,t,n){if(t!==n&&null!=n){var i=[e[n],e[t]];e[t]=i[0],e[n]=i[1]}}function fa(e){return e&&"asset"===e.type}function _a(e){for(var t=[],n=Object.getPrototypeOf(e),i=Object.getOwnPropertyDescriptors(n),r=0,a=Object.entries(i);r<a.length;r++){var o=y(a[r],2),s=o[0];"function"==typeof o[1].get&&t.push(s)}return t}var pa=function(){function e(t,i){n(this,e),this.resourceManager=t,this._resource=i,this._meta={},this._attachedResources=[],this.setMeta()}return r(e,[{key:"setMeta",value:function(){}},{key:"loadWithAttachedResources",value:function(e,t,n){var i=this;return new Promise((function(r,a){i.load(e,t,n).then((function(){r({resources:[i],structure:{index:0,props:{}}})})).catch((function(e){a(e)}))}))}},{key:"getProps",value:function(){return{}}},{key:"bind",value:function(){}},{key:"attach",value:function(){}},{key:"update",value:function(e,t){if(fa(t)){var n=this.resourceManager.get(t.id);n?this._resource[e]=n.resource:Le.warn("SchemaResource: ".concat(this.meta.name," can't find asset, which id is: ").concat(t.id))}else this._resource[e]=t}},{key:"updateMeta",value:function(e,t){this._meta[e]=t}},{key:"onDestroy",value:function(){}},{key:"resource",get:function(){return this._resource}},{key:"meta",get:function(){return this._meta}},{key:"attachedResources",get:function(){return this._attachedResources}}]),e}(),va=function(t){l(a,t);var i=m(a);function a(){return n(this,a),i.apply(this,arguments)}return r(a,[{key:"load",value:function(t,n,i){var r=this;return new Promise((function(a,o){var s,u,l,c,h=e.AssetType.Texture2D;if(r.resourceManager.useCompressedTexture&&null!=n&&null!==(s=n.props)&&void 0!==s&&null!==(u=s.compression)&&void 0!==u&&u.compressions.length)for(var d=i.engine._hardwareRenderer,f=n.props.compression.compressions,_=0;_<f.length;_++){var p=f[_];if("ktx"===p.container&&d.canIUse(e.GLCapabilityType[p.type])){c=p.url,h=e.AssetType.KTX;break}}c=null!==(l=c)&&void 0!==l?l:n.url,t.load({url:c,type:h}).then((function(e){r._resource=e,a(r)})).catch((function(e){o(e)}))}))}},{key:"setMeta",value:function(){this.resource&&(this._meta.name=this.resource.name,this.resource.image&&(this._meta.url=this.resource.image.src))}}]),a}(pa),ma=function(e){l(i,e);var t=m(i);function i(){return n(this,i),t.apply(this,arguments)}return r(i,[{key:"load",value:function(e,t){var n=this;return new Promise((function(i){var r=new Ai(e.engine,t.name);for(var a in n.configProps=t.props,n.configProps)fa(n.configProps[a])||(r[a]=n.configProps[a]);n._resource=r,n.setMeta(),i(n)}))}},{key:"loadWithAttachedResources",value:function(e,t){var n=this;return new Promise((function(i,r){var a;t.resource instanceof Ai?a=new Promise((function(e){n._resource=t.resource,n.setMeta(),e(n)})):t.props?a=n.load(e,t):r("Load PBRMaterial Error"),a&&a.then((function(){var e={resources:[n],structure:{index:0,props:{}}},t=n._resource;_a(n._resource).forEach((function(i){if(t[i]instanceof cn){var r=new va(n.resourceManager,t[i]);n.attachedResources.push(r),e.resources.push(r),e.structure.props[i]={index:e.resources.length-1}}})),i(e)}))}))}},{key:"setMeta",value:function(){this.resource&&(this.meta.name=this.resource.name)}},{key:"getProps",value:function(){var e=this,t={};return _a(this.resource).forEach((function(n){return t[n]=e.resource[n]})),t}},{key:"bind",value:function(){var e=this,t=this._resource;Object.keys(this.configProps).forEach((function(n){var i=e.configProps[n];if(fa(i)){var r=e.resourceManager.get(i.id);r&&r instanceof va?(t[n]=r.resource,e._attachedResources.push(r)):(t[n]=null,Le.warn("PBRMaterialResource: ".concat(e.meta.name," can't find asset \"").concat(n,'", which id is: ').concat(i.id)))}else{if("side"===n)return;t[n]=i}}))}}]),i}(pa),ga=function(t){l(a,t);var i=m(a);function a(){return n(this,a),i.apply(this,arguments)}return r(a,[{key:"load",value:function(t,n,i){var r,a=this;return null!==(r=n.props)&&void 0!==r&&r.compression&&mr.init(),t.load({url:n.url,type:e.AssetType.Perfab}).then((function(e){var t=e;n.props&&(t.newMaterial=n.props.newMaterial),a._resource=t}))}},{key:"loadWithAttachedResources",value:function(e,t,n){var i=this;return new Promise((function(r){i.load(e,t,n).then((function(){for(var t=i.resource.materials,n=[],a={resources:[i],structure:{index:0,props:{newMaterial:[]}}},o=0;o<t.length;o++){var s=t[o],u=new ma(i.resourceManager);i._attachedResources.push(u),n.push(u.loadWithAttachedResources(e,{type:"PBRMaterial",name:s.name,resource:s}))}Promise.all(n).then((function(e){var t=a.structure.props.newMaterial;e.forEach((function(e){var n=e.structure,i=e.resources[n.index];for(var r in a.resources.push(i),n.index=a.resources.length-1,n.props)if(n.props.hasOwnProperty(r)){var o=n.props[r],s=e.resources[o.index];a.resources.push(s),o.index=a.resources.length-1}t.push(n)})),r(a)}))}))}))}},{key:"setMeta",value:function(e){e&&(this.meta.name=e.name)}},{key:"bind",value:function(){var e=this._resource;this.bindMaterials(e.newMaterial)}},{key:"update",value:function(e,t){"newMaterial"===e?this.bindMaterials(t):this._resource[e]=t}},{key:"bindMaterials",value:function(e){if(e&&e.length){for(var t=this._resource,n=t.meshes,i=0;i<e.length;i++){var r=this.resourceManager.get(e[i].id);r?(this._attachedResources.push(r),t.materials[i]=r.resource):Le.warn("GLTFResource: ".concat(this.meta.name,' can\'t find asset "material", which id is: ').concat(e[i].id))}for(var a=0;a<n.length;a++){var o=this.getNodeByMeshIndex(t.nodes,n.length-1-a);if(o)for(var s=0;s<n[a].primitives.length;s++){var u=n[a].primitives[s],l=o.getComponent(ln),c=t.materials[t.materials.length-1-u.materialIndex];l&&c&&c instanceof xn&&l.setSharedMaterial(s,c)}}}}},{key:"getNodeByMeshIndex",value:function(e,t){for(var n=0;n<=e.length;n++){var i=e[n];if(i.meshIndex===t)return i}return null}}]),a}(pa),ya=function(e){l(i,e);var t=m(i);function i(){return n(this,i),t.apply(this,arguments)}return r(i,[{key:"loadShaderDefine",value:function(e){var t=this;return new Promise((function(n){var i=t.scripts[0].name;if(t.resourceManager.isLocal){var r,a;n(null!==(r=null===(a=e.options)||void 0===a?void 0:a.scripts[i])&&void 0!==r?r:{})}else{var o=document.getElementById(i);o&&document.body.removeChild(o);var s=document.createElement("script");s.crossOrigin="anonymous",s.onload=function(){var e,t=window.o3Scripts;n(null!==(e=t&&t[i])&&void 0!==e?e:{})},s.id=i,s.src=t._meta.url,document.body.appendChild(s)}})).then((function(e){var n=e.vertexShader,i=void 0===n?"":n,r=e.fragmentShader,a=void 0===r?"":r,o=e.states,s=void 0===o?{}:o,u=e.uniforms,l=void 0===u?{}:u,c=e.attributes,h=void 0===c?{}:c;t._resource.uniforms=l,t._resource.attributes=h,t._resource.vertexShader=i,t._resource.fragmentShader=a,t._resource.renderStates=s}))}},{key:"createMaterial",value:function(e){var t=new ai(e,this.meta.name||"shader_mtl");this._resource=t}},{key:"load",value:function(e,t,n){var i=this;return this.setMeta(t),this.scripts=t.props.scripts,this.createMaterial(n.engine),this.loadShaderDefine(n).then((function(){return new Promise((function(e,n){try{for(var r in t.props)i._resource[r]=t.props[r];i._resource.updateTechnique(),e(i)}catch(e){n("[shader material] createTechnique error")}}))}))}},{key:"setMeta",value:function(e){e&&(this._meta.name=e.name,this._meta.url=e.url,this._meta.source=e.source)}},{key:"updateMeta",value:function(e,t){var n=this;g(c(i.prototype),"updateMeta",this).call(this,e,t),"url"===e&&this.loadShaderDefine().then((function(){try{n._resource.updateTechnique()}catch(e){console.error("[shader material] createTechnique error")}}))}},{key:"update",value:function(e,t){this._resource[e]=t,this._resource.updateTechnique()}}]),i}(pa),xa={};var Ta=function(e){l(i,e);var t=m(i);function i(){var e;return n(this,i),(e=t.apply(this,arguments)).isInit=!1,e}return r(i,[{key:"initScriptContext",value:function(){this.isInit||(this.isInit=!0,window.__o3_script_context__={o3:Qa._components.o3,script:function(e){return function(t){xa[e]=t}}})}},{key:"load",value:function(e,t,n){var i=this;return this.initScriptContext(),new Promise((function(e){var r=t.props.scripts;if(i.resourceManager.isLocal){for(var a=0;a<r.length;a++){var o,s=r[a].name;xa[s]=null===(o=n.options)||void 0===o?void 0:o.scripts[s]}e(i)}else{var u=document.createElement("script");u.crossOrigin="anonymous",i.setMeta(t),u.onload=function(){for(var t=window.o3Scripts,n=0;n<r.length;n++){var a=r[n].name;i._resource=t&&t[a],xa[a]=i._resource}e(i)},u.src=t.url,document.body.appendChild(u)}}))}},{key:"setMeta",value:function(e){e&&(this._meta.name=e.name,this._meta.url=e.url,this._meta.source=e.source)}}]),i}(pa),Aa=function(e){l(i,e);var t=m(i);function i(){return n(this,i),t.apply(this,arguments)}return r(i,[{key:"load",value:function(e,t){var n=this;return new Promise((function(i){var r=new ti(e.engine,t.name);for(var a in t.props)r[a]=t.props[a];n._resource=r,n.setMeta(),i(n)}))}},{key:"setMeta",value:function(){this.resource&&(this.meta.name=this.resource.name)}}]),i}(pa),Sa={px:0,nx:1,py:2,ny:3,pz:4,nz:5},Ea=function(t){l(a,t);var i=m(a);function a(){return n(this,a),i.apply(this,arguments)}return r(a,[{key:"load",value:function(t,n,i){var r=this;return new Promise((function(a,o){var s,u,l=[],c=e.AssetType.TextureCube;if(r.resourceManager.useCompressedTexture&&null!=n&&null!==(s=n.props)&&void 0!==s&&null!==(u=s.compression)&&void 0!==u&&u.compressions.length)for(var h=i.engine._hardwareRenderer,d=n.props.compression.compressions,f=0;f<d.length;f++){var _=d[f];if("ktx"===_.container&&h.canIUse(e.GLCapabilityType[_.type])){for(var p in _.files)if(_.files.hasOwnProperty(p)){var v=_.files[p];l[Sa[p]]=v.url}console.warn(_.type),c=e.AssetType.KTXCube;break}}if(c===e.AssetType.TextureCube)for(var m in n.props.images)if(n.props.images.hasOwnProperty(m)){var g=n.props.images[m];l[Sa[m]]=g.url}t.load({urls:l,type:c}).then((function(e){r._resource=e,a(r)})).catch((function(e){o(e)}))}))}},{key:"setMeta",value:function(){this.resource&&(this.meta.name=this.resource.name)}}]),a}(pa),Ca=function(e){l(i,e);var t=m(i);function i(){return n(this,i),t.apply(this,arguments)}return r(i,[{key:"load",value:function(e,t){var n=this;return new Promise((function(e){n._resource=t,n.setMetaData("name",n.resource.name),n.setMetaData("url",n.resource.url),e(n)}))}},{key:"setMetaData",value:function(e,t){this._meta[e]=t}}]),i}(pa),ba=Object.defineProperty,Ra=Object.getOwnPropertyDescriptor,wa=function(e,t,n,i){for(var r,a=i>1?void 0:i?Ra(t,n):t,o=e.length-1;o>=0;o--)(r=e[o])&&(a=(i?r(t,n,a):r(a))||a);return i&&a&&ba(t,n,a),a},Ma=function(){function e(t){n(this,e),this.oasis=t,this.abilityMap={}}return r(e,[{key:"add",value:function(e){var t=e.type,n=e.node,i=e.props,r=e.id,a=e.index,o=this.oasis.nodeManager.get(n),s=this.getCompConstructor(t);if(s){var u=this.mixPropsToExplicitProps(i),l=o.addComponent(s),c=u.enabled;if(void 0!==c&&(l.enabled=c),"Model"===t||"GLTFModel"===t||"Particle"===t)l.init(u);else for(var h in u)null!==u[h]&&(l[h]=u[h]);var d=o._components;return da(d,d.length-1,a),l.id=r,this.abilityMap[r]=l,l}Le.error("".concat(t," abiltiy is not defined"))}},{key:"update",value:function(e,t,n){return"Model"===this.get(e).constructor.name?n&&this.checkIsAsset(n)?this.get(e).setProp(t,this.oasis.resourceManager.get(n.id).resource):this.get(e).setProp(t,n):n&&this.checkIsAsset(n)?this.get(e)[t]=this.oasis.resourceManager.get(n.id).resource:this.get(e)[t]=n,{id:e,key:t,value:n}}},{key:"get",value:function(e){return this.abilityMap[e]}},{key:"delete",value:function(e){return this.abilityMap[e].destroy(),delete this.abilityMap[e],e}},{key:"getCompConstructor",value:function(e){var t=e.split(".");if("script"===t[0])return xa[t[1]];var n=Qa._components.o3[e];if(!n)throw new Error("".concat(e," is not defined"));return n}},{key:"mixPropsToExplicitProps",value:function(e){var t=u({},e);for(var n in e){var i=e[n];if(i&&this.checkIsAsset(i)){var r=this.oasis.resourceManager.get(i.id);r?t[n]=r.resource:(t[n]=null,Le.warn("AbilityManager: can't get asset \"".concat(n,'", which id is ').concat(i.id)))}}return t}},{key:"checkIsAsset",value:function(e){return"asset"===e.type}}]),e}();wa([ha({after:"abilityAdded",before:"beforeAbilityAdded"})],Ma.prototype,"add",1),wa([ha({before:"beforeAbilityUpdated",after:"abilityUpdated"})],Ma.prototype,"update",1),wa([ha({after:"abilityDeleted",before:"beforeAbilityDeleted"})],Ma.prototype,"delete",1);var La=Object.defineProperty,Pa=Object.getOwnPropertyDescriptor,Oa=function(e,t,n,i){for(var r,a=i>1?void 0:i?Pa(t,n):t,o=e.length-1;o>=0;o--)(r=e[o])&&(a=(i?r(t,n,a):r(a))||a);return i&&a&&La(t,n,a),a},Fa=function(){function e(t){n(this,e),this.oasis=t,this.nodeMap={},this.root=new Xe(this.oasis.engine,"root")}return r(e,[{key:"addRootEntity",value:function(){this.oasis.engine.sceneManager.activeScene.addRootEntity(this.root)}},{key:"add",value:function(e){return this.create(e),this.append(e.id,e.parent,e.index),this.get(e.id)}},{key:"update",value:function(e,t,n){return this.get(e)[t]=n,{id:e,key:t,value:n}}},{key:"get",value:function(e){return this.nodeMap[e]}},{key:"reset",value:function(){this.nodeMap={}}},{key:"delete",value:function(e){this.nodeMap[e].destroy(),delete this.nodeMap[e]}},{key:"create",value:function(e){var t=e.isActive,n=e.position,i=e.rotation,r=e.scale,a=e.id,o=e.name,s=new Xe(this.oasis.engine,o);return s.isActive=t,s.transform.position=new w(n[0],n[1],n[2]),s.transform.rotation=new w(i[0],i[1],i[2]),s.transform.scale=new w(r[0],r[1],r[2]),s.id=a,this.nodeMap[a]=s,s}},{key:"append",value:function(e,t,n){var i=this.nodeMap[e],r=this.nodeMap[t]||this.root;r.addChild(i);var a=r._children;da(a,a.length-1,n)}}]),e}();Oa([ha({after:"nodeAdded"})],Fa.prototype,"add",1),Oa([ha({before:"beforeNodeUpdated",after:"nodeUpdated"})],Fa.prototype,"update",1),Oa([ha({before:"beforeNodeDeleted"})],Fa.prototype,"delete",1);var ka=Object.defineProperty,Ia=Object.getOwnPropertyDescriptor,Da=function(e,t,n,i){for(var r,a=i>1?void 0:i?Ia(t,n):t,o=e.length-1;o>=0;o--)(r=e[o])&&(a=(i?r(t,n,a):r(a))||a);return i&&a&&ka(t,n,a),a},Na={script:Ta,gltf:ga,texture:va,cubeTexture:Ea,PBRMaterial:ma,PBRSpecularMaterial:ma,unlitMaterial:ma,ShaderMaterial:ya,BlinnPhongMaterial:Aa,base:Ca},Ba=new Map;for(var za in Na)if(Na.hasOwnProperty(za)){var Ga=Na[za];Ga===ma?Ba.set(Ga,"PBRMaterial"):Ba.set(Ga,za)}var Ua=function(e,t){return new Na[t](e)};var Va=function(){function e(t){n(this,e),this.oasis=t,this.resourceMap={},this.resourceIdMap=new WeakMap,this.maxId=0,this.engineResourceManager=this.oasis.engine.resourceManager}return r(e,[{key:"load",value:function(e){var t=this,n=Ua(this,e.type),i=n.load(this.oasis.engine.resourceManager,e,this.oasis);return this.maxId=Math.max(+e.id,this.maxId),i.then((function(){t.resourceMap[e.id]=n,t.resourceIdMap.set(n,e.id)})),i}},{key:"add",value:function(e){var t=this,n=Ua(this,e.type);return new Promise((function(i){n.loadWithAttachedResources(t.oasis.engine.resourceManager,e,t.oasis).then((function(e){i(t.getAddResourceResult(e.resources,e.structure))}))}))}},{key:"remove",value:function(e){var t=this;return new Promise((function(n){var i=t.resourceMap[e],r=[e],a=!1;if(delete t.resourceMap[e],i)for(var o=i.attachedResources,s=0;s<o.length;s++){var u=o[s],l=t.resourceIdMap.get(u);l&&(a=!0,t.remove(l).then((function(e){r.push.apply(r,x(e)),n(r)})))}a||n(r)}))}},{key:"update",value:function(e,t,n){var i=this.get(e);return i&&i.update(t,n),{resource:i,id:e,key:t,value:n}}},{key:"updateMeta",value:function(e,t,n){var i=this.get(e);i&&i.updateMeta(t,n)}},{key:"get",value:function(e){return this.resourceMap[e]}},{key:"getAll",value:function(){return W(this.resourceMap)}},{key:"getAddResourceResult",value:function(e,t){var n=this,i={},r=e[t.index],a="".concat(++this.maxId);for(var o in this.resourceMap[a]=r,this.resourceIdMap.set(r,a),i.id=this.maxId,i.type=Ba.get(r.constructor),i.meta=r.meta,i.props={},t.props)if(t.props.hasOwnProperty(o)){var s=t.props[o];s&&(Array.isArray(s)?i.props[o]=s.map((function(t){return n.getAddResourceResult(e,t)})):i.props[o]=this.getAddResourceResult(e,s))}return i}},{key:"isLocal",get:function(){return this.oasis.options.local}},{key:"useCompressedTexture",get:function(){var e;return null===(e=this.oasis.options.useCompressedTexture)||void 0===e||e}}]),e}();Da([ha({before:"beforeResourceRemove"})],Va.prototype,"remove",1),Da([ha({after:"resourceUpdated",before:"beforeResourceUpdate"})],Va.prototype,"update",1);var Ha=Object.defineProperty,ja=Object.getOwnPropertyDescriptor,Wa=function(e){l(i,e);var t=m(i);function i(e,r){var a,o;return n(this,i),(o=t.call(this,e.engine))._options=e,o.pluginManager=r,o.engine=null,o.oasis=p(o),o.engine=e.engine,o.resetFeature(),o.schema=e.config,o.timeout=e.timeout,e.scripts=null!==(a=e.scripts)&&void 0!==a?a:{},o.nodeManager=new Fa(p(o)),o.abilityManager=new Ma(p(o)),o.nodeManager.add=o.nodeManager.add.bind(o.nodeManager),o.abilityManager.add=o.abilityManager.add.bind(o.abilityManager),o.resourceManager=new Va(p(o)),e.fps&&(o.engine.targetFrameRate=e.fps,o.engine.vSyncCount=0),o}return r(i,[{key:"updateConfig",value:function(e){this.schema=e,this.init()}},{key:"init",value:function(){var e=this;return this.loadResources().then((function(){e.bindResources(),e.parseEntities(),e.parseNodeAbilities(),e.attach(),e.nodeManager.addRootEntity(),e.pluginManager.boot(e)}))}},{key:"loadResources",value:function(){var e=this,t=this.schema.assets,n=W(void 0===t?{}:t).filter((function(e){return!!Na[e.type]||(console.warn("".concat(e.type," loader is not defined. the ").concat(e.type," type will be ignored.")),!1)})).map((function(t){return e.resourceManager.load(t)}));return Promise.all(n)}},{key:"bindResources",value:function(){this.resourceManager.getAll().forEach((function(e){e.bind()}))}},{key:"parseEntities",value:function(){var e=this.schema.nodes;this.bfsNodes().map((function(t){return e[t]})).forEach(this.nodeManager.add)}},{key:"parseNodeAbilities",value:function(){var e=this.schema.abilities;Object.keys(e).map((function(t){return u({id:t},e[t])})).forEach(this.abilityManager.add)}},{key:"bfsNodes",value:function(){var e=this.schema.nodes,t=W(e).filter((function(t){return!e[t.parent]})).map((function(e){return e.id})),n=[];return function t(i){n=n.concat(i),i.forEach((function(n){var i=e[n].children;i&&t(i)}))}(t),n}},{key:"resetFeature",value:function(){var e=this.engine.sceneManager.activeScene;e.features.splice(2,1),e.features.splice(3,1),e.hasFogFeature=void 0,e.getFogMacro=void 0,e.bindFogToMaterial=void 0}},{key:"attach",value:function(){this.resourceManager.getAll().forEach((function(e){e.attach()}))}},{key:"canvas",get:function(){return this._options.canvas}},{key:"options",get:function(){return this._options}}],[{key:"create",value:function(e,t){var n=new i(e,t);return n.init().then((function(){return e.autoPlay&&n.engine.run(),n}))}}]),i}(se);!function(e,t,n,i){for(var r,a=i>1?void 0:i?ja(t,n):t,o=e.length-1;o>=0;o--)(r=e[o])&&(a=(i?r(t,n,a):r(a))||a);i&&a&&Ha(t,n,a)}([ha({after:"schemaParsed"})],Wa.prototype,"init",1);var qa=["color","center","size","__position","__positionRandomness","__color","__velocity","__velocityRandomness","__acceleration","__accelerationRandomness","_center"];function Xa(e){for(var n=Object.keys(e),i=0,r=n.length;i<r;++i){var a=n[i],o=e[a];null!==o&&"object"===t(o)&&o.length>1&&("backgroundColor"===a||"tintColor"===a?e[a]=new U(o[0],o[1],o[2],o[3]):-1!==qa.indexOf(a)&&(e[a]=new w(o[0],o[1],o[2])))}}function Ka(){var e=arguments.length>0&&void 0!==arguments[0]?arguments[0]:{};if(e)for(var t=Object.keys(e),n=0,i=t.length;n<i;n++){var r=t[n],a=e[r];if("newMaterial"!==r&&"blendFuncSeparate"!==r&&"scripts"!==r)switch(null==a?void 0:a.length){case 2:e[r]=new z(a[0],a[1]);break;case 3:e[r]=new w(a[0],a[1],a[2]);break;case 4:e[r]=new U(a[0],a[1],a[2],a[3])}}}var Qa=function(){function e(){n(this,e),this.pluginManager=new ca}return r(e,[{key:"parse",value:function(e){var t,n;3!==(null==e||null===(t=e.config)||void 0===t?void 0:t.version)&&console.warn('schema-parser: schema version "'.concat(null==e||null===(n=e.config)||void 0===n?void 0:n.version,'" is out of date, please re-pull the latest version (version ').concat(3,") of the schema"));return function(e){for(var t=e.abilities,n=void 0===t?{}:t,i=e.assets,r=void 0===i?{}:i,a=Object.keys(n),o=Object.keys(r),s=0,u=a.length;s<u;++s)Xa(n[a[s]].props);for(var l=0,c=o.length;l<c;++l)Ka(r[o[l]].props)}(e.config),Wa.create(e,this.pluginManager)}},{key:"register",value:function(e){this.pluginManager.register(e)}},{key:"resetPlugins",value:function(){this.pluginManager.reset()}}],[{key:"create",value:function(){return new e}},{key:"registerComponents",value:function(e,t){this._components[e]||(this._components[e]={}),o(this._components[e],t)}}]),e}();Qa._components={};var Ya=Qa.create(),Ja=[];var Za=function(){function e(t,i){n(this,e),this._engine=i,this._gl=t,this._vertexShader=null,this._fragmentShader=null,this._vertexShaderSource=null,this._fragmentShaderSource=null,this._program=null,this._attributeCache={},this._uniformCache={}}return r(e,[{key:"createFromSource",value:function(e,t,n){var i=this._gl,r=this._compileShader(i.VERTEX_SHADER,e);if(!r)return!1;var a=this._compileShader(i.FRAGMENT_SHADER,t);if(!a)return!1;var o=i.createProgram();if(i.attachShader(o,r),i.attachShader(o,a),n)for(var s in n)i.bindAttribLocation(o,n[s],s);if(i.linkProgram(o),i.validateProgram(o),i.isContextLost())return Le.error("Contex lost while linking program."),i.deleteShader(r),i.deleteShader(a),null;if(!i.getProgramParameter(o,i.LINK_STATUS)&&!i.isContextLost()){var u="Could not link WebGL program. \n"+i.getProgramInfoLog(o);return console.error(u),this._engine.dispatch("linkProgramError",u),i.deleteProgram(o),!1}return this._vertexShader=r,this._fragmentShader=a,this._vertexShaderSource=e,this._fragmentShaderSource=t,this._program=o,!0}},{key:"_compileShader",value:function(e,t){var n,i,r,a,o=this._gl,s=o.createShader(e);if(o.shaderSource(s,t),o.compileShader(s),o.isContextLost())return Le.error("Contex lost while compiling shader."),o.deleteShader(s),null;if(!o.getShaderParameter(s,o.COMPILE_STATUS)&&!o.isContextLost()){var u="Could not compile WebGL shader.\n".concat((n=t,r=n.split("\n"),a=(r.length+1).toString().length+6,r.map((function(e,t){if((i="0:".concat(t+1)).length>=a)return i.substring(0,a)+e;for(var n=0;n<a-i.length;n++)i+=" ";return i+e})).join("\n")),"\n").concat(o.getShaderInfoLog(s));return console.error(u),this._engine.dispatch("compileShaderError",u),o.deleteShader(s),null}return s}},{key:"getAttribLocation",value:function(e,t){return this._attributeCache.hasOwnProperty(t)?this._attributeCache[t]:this._attributeCache[t]=this._gl.getAttribLocation(e,t)}},{key:"getUniformLocation",value:function(e,t){return this._uniformCache.hasOwnProperty(t)?this._uniformCache[t]:this._uniformCache[t]=this._gl.getUniformLocation(e,t)}},{key:"finalize",value:function(){var t=this._gl;this._vertexShader&&t.deleteShader(this._vertexShader),this._fragmentShader&&t.deleteShader(this._fragmentShader),this._program&&t.deleteProgram(this._program),this._vertexShader=null,this._fragmentShader=null,this._vertexShaderSource=null,this._fragmentShaderSource=null,this._program=null,this._attributeCache={},this._uniformCache={},e.releaseProgram(this)}},{key:"program",get:function(){return this._program}}],[{key:"requireProgram",value:function(t,n,i){var r=null;if(Ja.some((function(e){if(e._gl===n&&e._vertexShaderSource===t.vertexShader&&e._fragmentShaderSource===t.fragmentShader)return r=e,!0})),!r){if(!(r=new e(n,i)).createFromSource(t.vertexShader,t.fragmentShader,t.attribLocSet))return null;Ja.push(r)}return r}},{key:"releaseProgram",value:function(e){var t=Ja.indexOf(e);-1!==t&&Ja.splice(t,1)}}]),e}(),$a=function(){function e(t,i){n(this,e),this._rhi=t,this.asset=i}return r(e,[{key:"rhi",get:function(){return this._rhi}}]),e}(),eo=function(t){l(a,t);var i=m(a);function a(e,t){var r;n(this,a),(r=i.call(this,e,t)).cacheID=++a.cacheCounter,r._tech=t,r._activeTextureCount=0;var o=e.gl;if(r._program=Za.requireProgram(t,o,e._engine),r._program){r.valid=!0;var s=r._program.program;r._attributes={};var u=t.attributes;for(var l in u)r._attributes[l]={name:l,semantic:u[l].semantic,location:r._program.getAttribLocation(s,l)};r._uniforms={};var c=t.uniforms;for(var h in c){var d=r._program.getUniformLocation(s,h);null!==d&&(r._uniforms[h]={name:h,location:d})}}else r.valid=!1;return r}return r(a,[{key:"finalize",value:function(e){this._program&&e&&(this._program=null)}},{key:"begin",value:function(e){var t=this.rhi.gl,n=this._program.program;this._activeTextureCount=0,t.useProgram(n);var i=this._uniforms,r=this._tech.uniforms;for(var a in r)if(i.hasOwnProperty(a)){var o=e.getValue(a);null!=o&&this._uploadUniformValue(r[a],i[a].location,o)}var s=this.rhi.renderStates;this._tech.states&&(s.pushStateBlock(this._tech.name),this._applyStates(s))}},{key:"end",value:function(){this._tech.states&&this.rhi.renderStates.popStateBlock()}},{key:"_applyStates",value:function(e){var t=this._tech.states,n=t.enable;if(n)for(var i=0,r=n.length;i<r;i++)e.enable(n[i]);var a=t.disable;if(a)for(var o=0,s=a.length;o<s;o++)e.disable(a[o]);var u=t.functions;if(u)for(var l in u){var c=Array.isArray(u[l])?u[l]:[u[l]];e[l].apply(e,c)}}},{key:"_uploadUniformValue",value:function(t,n,i){var r=this.rhi.gl;switch(t.type){case e.DataType.FLOAT:i.length?r.uniform1fv(n,i):r.uniform1f(n,i);break;case e.DataType.FLOAT_ARRAY:r.uniform1fv(n,i);break;case e.DataType.INT:i.length?r.uniform1iv(n,i):r.uniform1i(n,i);break;case e.DataType.INT_ARRAY:r.uniform1iv(n,i);break;case e.DataType.FLOAT_VEC2:r.uniform2f(n,i.x,i.y);break;case e.DataType.FLOAT_VEC2_ARRAY:r.uniform2fv(n,i);break;case e.DataType.FLOAT_VEC3:r.uniform3f(n,i.x,i.y,i.z);break;case e.DataType.FLOAT_VEC3_ARRAY:r.uniform3fv(n,i);break;case e.DataType.FLOAT_VEC4:r.uniform4f(n,i.x,i.y,i.z,i.w);break;case e.DataType.FLOAT_VEC4_ARRAY:r.uniform4fv(n,i);break;case e.DataType.INT_VEC2:r.uniform2i(n,i.x,i.y);break;case e.DataType.INT_VEC2_ARRAY:r.uniform2iv(n,i);break;case e.DataType.INT_VEC3:r.uniform3i(n,i.x,i.y,i.z);break;case e.DataType.INT_VEC3_ARRAY:r.uniform3iv(n,i);break;case e.DataType.INT_VEC4:r.uniform4i(n,i.x,i.y,i.z,i.w);break;case e.DataType.INT_VEC4_ARRAY:r.uniform4iv(n,i);break;case e.DataType.FLOAT_MAT2:r.uniformMatrix2fv(n,!1,i.elements);break;case e.DataType.FLOAT_MAT2_ARRAY:r.uniformMatrix2fv(n,!1,i);break;case e.DataType.FLOAT_MAT3:r.uniformMatrix3fv(n,!1,i.elements);break;case e.DataType.FLOAT_MAT3_ARRAY:r.uniformMatrix3fv(n,!1,i);break;case e.DataType.FLOAT_MAT4:r.uniformMatrix4fv(n,!1,i.elements);break;case e.DataType.FLOAT_MAT4_ARRAY:r.uniformMatrix4fv(n,!1,i);break;case e.DataType.SAMPLER_2D:this._uploadTexture(i,n);break;case e.DataType.SAMPLER_2D_ARRAY:this._uploadTextures(i,n);break;case e.DataType.SAMPLER_CUBE:this._uploadTexture(i,n);break;case e.DataType.SAMPLER_CUBE_ARRAY:this._uploadTextures(i,n);break;default:Le.warn("UNKNOWN uniform type: "+t.type)}}},{key:"_uploadTexture",value:function(e,t){if(e){var n=this.rhi.gl,i=this._activeTextureCount++;n.activeTexture(n.TEXTURE0+i),n.bindTexture(e._target,e._glTexture),n.uniform1i(t,i)}}},{key:"_uploadTextures",value:function(e,t){this._tempSamplerArray&&this._tempSamplerArray.length===e.length||(this._tempSamplerArray=new Int32Array(e.length));for(var n=this.rhi.gl,i=0,r=e.length;i<r;i++){var a=e[i];if(a){var o=this._activeTextureCount++;n.activeTexture(n.TEXTURE0+o),n.bindTexture(a._target,a._glTexture),this._tempSamplerArray[i]=o}else this._tempSamplerArray[i]=-1}n.uniform1iv(t,this._tempSamplerArray)}},{key:"program",get:function(){return this._program}},{key:"attributes",get:function(){return this._attributes}},{key:"uniforms",get:function(){return this._uniforms}}]),a}($a);eo.cacheCounter=0;var to=function(e){l(i,e);var t=m(i);function i(e,r,a){var o;return n(this,i),(o=t.call(this,e,r))._gl=e.gl,o._glTexture=r._glTexture,o._config=r,o._type=a,o}return r(i,[{key:"activeBinding",value:function(e){var t=this._gl;t.activeTexture(t.TEXTURE0+e),t.bindTexture(this._type,this._glTexture)}},{key:"finalize",value:function(){}},{key:"glTexture",get:function(){return this._glTexture}}]),i}($a),no=function(){function e(t){n(this,e),this._scale=new z;var i=t.width,r=t.height;this._webCanvas=t,this._width=i,this._height=r}return r(e,[{key:"resizeByClientSize",value:function(){var e=arguments.length>0&&void 0!==arguments[0]?arguments[0]:window.devicePixelRatio,t=this._webCanvas;if(t instanceof HTMLCanvasElement){var n=t.clientWidth,i=t.clientHeight;this.width=n*e,this.height=i*e}}},{key:"setScale",value:function(e,t){this._scale.setValue(e,t),this.scale=this._scale}},{key:"width",get:function(){return this._width},set:function(e){this._width!==e&&(this._webCanvas.width=e,this._width=e)}},{key:"height",get:function(){return this._height},set:function(e){this._height!==e&&(this._webCanvas.height=e,this._height=e)}},{key:"scale",get:function(){var e=this._webCanvas;return e instanceof HTMLCanvasElement&&this._scale.setValue(e.clientWidth*devicePixelRatio/e.width,e.clientHeight*devicePixelRatio/e.height),this._scale},set:function(e){var t=this._webCanvas;t instanceof HTMLCanvasElement&&(t.style.transformOrigin="left top",t.style.transform="scale(".concat(e.x,", ").concat(e.y,")"))}}]),e}(),io=function(){function t(e){var i=arguments.length>1&&void 0!==arguments[1]?arguments[1]:{};n(this,t),this._rhi=e,this._objectSet={},this._checkList=[],this._nextID=1,this._enableCollect=void 0===i.enableCollect||!!i.enableCollect}return r(t,[{key:"requireObject",value:function(t,n){var i=null;if(t.cacheID&&(i=this._objectSet[t.cacheID]),!i||t.needRecreate){var r=this._nextID++,a=this._objectSet;i=new n(this._rhi,t),a[r]=i,i.cacheID=r,i.asset=t,t.cacheID=r,t.needRecreate=!1,this._enableCollect&&t.type===e.InternalAssetType.Cache&&this._checkList.push(i)}return i.activeFrame=this._rhi.frameCount,i}},{key:"compact",value:function(){if(this._enableCollect)for(var e=this._rhi.frameCount,t=this._checkList,n=this._objectSet,i=t.length-1;i>=0;i--){var r=t[i];r.activeFrame<e&&(delete n[r.cacheID],t.splice(i,1),r.finalize())}}},{key:"finalize",value:function(){for(var e in this._objectSet){this._objectSet[e].finalize(!0)}this._objectSet={},this._checkList=[]}}]),t}(),ro=function(){function t(e){n(this,t),this._rhi=e,this.capabilityList=new Map,this.init(),this.compatibleAllInterface()}return r(t,[{key:"maxDrawBuffers",get:function(){return this._maxDrawBuffers||(this.canIUse(e.GLCapabilityType.drawBuffers)?this._maxDrawBuffers=this._rhi.gl.getParameter(this._rhi.gl.MAX_DRAW_BUFFERS):this._maxDrawBuffers=1),this._maxDrawBuffers}},{key:"maxAnisoLevel",get:function(){if(!this._maxAnisoLevel){var t=this._rhi.requireExtension(e.GLCapabilityType.textureFilterAnisotropic);this._maxAnisoLevel=t?this._rhi.gl.getParameter(t.MAX_TEXTURE_MAX_ANISOTROPY_EXT):1}return this._maxAnisoLevel}},{key:"maxAntiAliasing",get:function(){if(!this._maxAntiAliasing){var t=this._rhi.gl,n=this.canIUse(e.GLCapabilityType.multipleSample);this._maxAntiAliasing=n?t.getParameter(t.MAX_SAMPLES):1}return this._maxAntiAliasing}},{key:"rhi",get:function(){return this._rhi}}]),r(t,[{key:"canIUse",value:function(e){return this.capabilityList.get(e)}},{key:"canIUseCompressedTextureInternalFormat",value:function(t){var n=e.GLCompressedTextureInternalFormat.RGBA_ASTC_4X4_KHR,i=e.GLCompressedTextureInternalFormat.RGBA_ASTC_12X12_KHR,r=e.GLCompressedTextureInternalFormat.SRGB8_ALPHA8_ASTC_4X4_KHR,a=e.GLCompressedTextureInternalFormat.SRGB8_ALPHA8_ASTC_12X12_KHR,o=e.GLCompressedTextureInternalFormat.RGB_ETC1_WEBGL,s=e.GLCompressedTextureInternalFormat.R11_EAC,u=e.GLCompressedTextureInternalFormat.SRGB8_ALPHA8_ETC2_EAC,l=e.GLCompressedTextureInternalFormat.RGB_PVRTC_4BPPV1_IMG,c=e.GLCompressedTextureInternalFormat.RGBA_PVRTC_2BPPV1_IMG,h=e.GLCompressedTextureInternalFormat.RGB_S3TC_DXT1_EXT,d=e.GLCompressedTextureInternalFormat.RGBA_S3TC_DXT5_EXT;return t>=n&&i<=i||t>=r&&t<=a?this.canIUse(e.GLCapabilityType.astc):t===o?this.canIUse(e.GLCapabilityType.etc1):t>=s&&t<=u?this.canIUse(e.GLCapabilityType.etc):t>=l&&t<=c?this.canIUse(e.GLCapabilityType.pvrtc):t>=h&&t<=d&&this.canIUse(e.GLCapabilityType.s3tc)}},{key:"init",value:function(){var t=this.capabilityList,n=this.rhi.isWebGL2,i=this.rhi.requireExtension.bind(this.rhi),r=e.GLCapabilityType.standardDerivatives,a=e.GLCapabilityType.shaderTextureLod,o=e.GLCapabilityType.elementIndexUint,s=e.GLCapabilityType.depthTexture,u=e.GLCapabilityType.vertexArrayObject,l=e.GLCapabilityType.instancedArrays,c=e.GLCapabilityType.multipleSample,h=e.GLCapabilityType.drawBuffers,d=e.GLCapabilityType.astc,f=e.GLCapabilityType.astc_webkit,_=e.GLCapabilityType.etc,p=e.GLCapabilityType.etc_webkit,v=e.GLCapabilityType.etc1,m=e.GLCapabilityType.etc1_webkit,g=e.GLCapabilityType.pvrtc,y=e.GLCapabilityType.pvrtc_webkit,x=e.GLCapabilityType.s3tc,T=e.GLCapabilityType.s3tc_webkit,A=e.GLCapabilityType.textureFloat,S=e.GLCapabilityType.textureHalfFloat,E=e.GLCapabilityType.textureFloatLinear,C=e.GLCapabilityType.textureHalfFloatLinear,b=e.GLCapabilityType.WEBGL_colorBufferFloat,R=e.GLCapabilityType.colorBufferFloat,w=e.GLCapabilityType.colorBufferHalfFloat,M=e.GLCapabilityType.textureFilterAnisotropic;t.set(r,n||!!i(r)),t.set(a,n||!!i(a)),t.set(o,n||!!i(o)),t.set(s,n||!!i(s)),t.set(u,n||!!i(u)),t.set(l,n||!!i(l)),t.set(c,n),t.set(h,n||!!i(h)),t.set(A,n||!!i(A)),t.set(S,n||!!i(S)),t.set(E,!!i(E)),t.set(C,n||!!i(C)),t.set(R,n&&!!i(R)||!!i(b)),t.set(w,n&&!!i(R)||!!i(w)),t.set(M,!!i(M)),t.set(d,!(!i(d)&&!i(f))),t.set(_,!(!i(_)&&!i(p))),t.set(v,!(!i(v)&&!i(m))),t.set(g,!(!i(g)&&!i(y))),t.set(x,!(!i(x)&&!i(T)))}},{key:"compatibleInterface",value:function(e,t){var n,i=this.rhi,r=i.gl;if(n=i.requireExtension(e))for(var a in t){var o=n[t[a]];null!=o&&o.bind?r[a]=o.bind(n):r[a]=o}}},{key:"compatibleAllInterface",value:function(){var t=e.GLCapabilityType.depthTexture,n=e.GLCapabilityType.vertexArrayObject,i=e.GLCapabilityType.instancedArrays,r=e.GLCapabilityType.drawBuffers,a=e.GLCapabilityType.textureFilterAnisotropic,o=e.GLCapabilityType.textureHalfFloat,s=e.GLCapabilityType.colorBufferHalfFloat,l=e.GLCapabilityType.WEBGL_colorBufferFloat;if(!this.rhi.isWebGL2){this.compatibleInterface(t,{UNSIGNED_INT_24_8:"UNSIGNED_INT_24_8_WEBGL"}),this.compatibleInterface(n,{createVertexArray:"createVertexArrayOES",deleteVertexArray:"deleteVertexArrayOES",isVertexArray:"isVertexArrayOES",bindVertexArray:"bindVertexArrayOES"}),this.compatibleInterface(i,{drawArraysInstanced:"drawArraysInstancedANGLE",drawElementsInstanced:"drawElementsInstancedANGLE",vertexAttribDivisor:"vertexAttribDivisorANGLE"}),this.compatibleInterface(r,{MAX_DRAW_BUFFERS:"MAX_DRAW_BUFFERS_WEBGL"});var c={};if(this.canIUse(e.GLCapabilityType.drawBuffers)){for(var h=this.maxDrawBuffers,d=0;d<h;d++)0!=d&&(c["COLOR_ATTACHMENT".concat(d)]="COLOR_ATTACHMENT".concat(d,"_WEBGL")),c["DRAW_BUFFER".concat(d)]="DRAW_BUFFER".concat(d,"_WEBGL");this.compatibleInterface(r,u({drawBuffers:"drawBuffersWEBGL"},c))}this.compatibleInterface(o,{HAFL_FLOAT:"HALF_FLOAT_OES"}),this.compatibleInterface(s,{RGBA16F:"RBGA16F_EXT"}),this.compatibleInterface(l,{RGBA32F:"RBGA32F_EXT"})}this.compatibleInterface(a,{TEXTURE_MAX_ANISOTROPY_EXT:"TEXTURE_MAX_ANISOTROPY_EXT"})}},{key:"canIUseMoreJoints",get:function(){return this.canIUse(e.GLCapabilityType.textureFloat)&&this.rhi.renderStates.getParameter(this.rhi.gl.MAX_VERTEX_TEXTURE_IMAGE_UNITS)>0}}]),t}(),ao=function(){function e(t){n(this,e),this.rhi=t,this._requireResult={}}return r(e,[{key:"requireExtension",value:function(e){return void 0!==this._requireResult[e]||(this._requireResult[e]=this.rhi.gl.getExtension(e)),this._requireResult[e]}}]),e}(),oo=function(){function t(i,r){n(this,t),this.vao=new Map,this._primitive=r,this.canUseInstancedArrays=i.canIUse(e.GLCapabilityType.instancedArrays),this._useVao=i.canIUse(e.GLCapabilityType.vertexArrayObject),this.gl=i.gl}return r(t,[{key:"draw",value:function(e,t){var n=this.gl,i=this._primitive;if(this._useVao){this.vao.has(e.cacheID)||this.registerVAO(e);var r=this.vao.get(e.cacheID);n.bindVertexArray(r)}else this.bindBufferAndAttrib(e);var a=i.indexBufferBinding,o=i.instanceCount,s=i._glIndexType,u=t.topology,l=t.start,c=t.count;if(o)if(this.canUseInstancedArrays)if(a)if(this._useVao)n.drawElementsInstanced(u,c,s,l,o);else{var h=a.buffer._nativeBuffer;n.bindBuffer(n.ELEMENT_ARRAY_BUFFER,h),n.drawElementsInstanced(u,c,s,l,o),n.bindBuffer(n.ELEMENT_ARRAY_BUFFER,null)}else n.drawArraysInstanced(u,l,c,o);else Le.error("ANGLE_instanced_arrays extension is not supported");else if(a)if(this._useVao)n.drawElements(u,c,s,l);else{var d=a.buffer._nativeBuffer;n.bindBuffer(n.ELEMENT_ARRAY_BUFFER,d),n.drawElements(u,c,s,l),n.bindBuffer(n.ELEMENT_ARRAY_BUFFER,null)}else n.drawArrays(u,l,c);this._useVao?n.bindVertexArray(null):this.disableAttrib()}},{key:"destroy",value:function(){if(this._useVao){var e=this.gl;this.vao.forEach((function(t){e.deleteVertexArray(t)}))}}},{key:"bindBufferAndAttrib",value:function(e){var t=this.gl,n=this._primitive,i=n.vertexBufferBindings;this.attribLocArray=[];var r,a,o=e.attributes,s=n._vertexElementMap;for(var u in o){var l=o[u].location;if(-1!==l){var c=s[o[u].semantic];if(c){var h=i[c.bindingIndex],d=h.buffer,f=h.stride;a!==(r=d._nativeBuffer)&&(a=r,t.bindBuffer(t.ARRAY_BUFFER,r)),t.enableVertexAttribArray(l);var _=c._glElementInfo,p=_.size,v=_.type;t.vertexAttribPointer(l,p,v,c.normalized,f,c.offset),this.canUseInstancedArrays&&t.vertexAttribDivisor(l,c.instanceDivisor),this.attribLocArray.push(l)}else Le.warn("vertex attribute not found: "+u)}}t.bindBuffer(t.ARRAY_BUFFER,null)}},{key:"disableAttrib",value:function(){for(var e=this.gl,t=0,n=this.attribLocArray.length;t<n;t++)e.disableVertexAttribArray(this.attribLocArray[t])}},{key:"registerVAO",value:function(e){var t=this.gl,n=t.createVertexArray();t.bindVertexArray(n);var i=this._primitive.indexBufferBinding;i&&t.bindBuffer(t.ELEMENT_ARRAY_BUFFER,i.buffer._nativeBuffer),this.bindBufferAndAttrib(e),t.bindVertexArray(null),t.bindBuffer(t.ELEMENT_ARRAY_BUFFER,null),this.disableAttrib(),this.vao.set(e.cacheID,n)}}]),t}(),so=function(){function e(t){n(this,e),this._stateStack=[],this._parameters={},this._gl=t,this._stateStack=[],this._parameters={},this._parameters[t.MAX_COMBINED_TEXTURE_IMAGE_UNITS]=t.getParameter(t.MAX_COMBINED_TEXTURE_IMAGE_UNITS),this._parameters[t.MAX_VERTEX_UNIFORM_VECTORS]=t.getParameter(t.MAX_VERTEX_UNIFORM_VECTORS),this._parameters[t.MAX_VERTEX_ATTRIBS]=t.getParameter(t.MAX_VERTEX_ATTRIBS),this._parameters[t.MAX_VERTEX_TEXTURE_IMAGE_UNITS]=t.getParameter(t.MAX_VERTEX_TEXTURE_IMAGE_UNITS),this._parameters[t.BLEND]=!1,t.disable(t.BLEND),this._parameters[t.CULL_FACE]=!0,t.enable(t.CULL_FACE),this._parameters[t.DEPTH_TEST]=!0,t.enable(t.DEPTH_TEST),this._parameters[t.DITHER]=!1,t.disable(t.DITHER),this._parameters[t.POLYGON_OFFSET_FILL]=!1,t.disable(t.POLYGON_OFFSET_FILL),this._parameters[t.SAMPLE_ALPHA_TO_COVERAGE]=!1,t.disable(t.SAMPLE_ALPHA_TO_COVERAGE),this._parameters[t.SAMPLE_COVERAGE]=!1,t.disable(t.SAMPLE_COVERAGE),this._parameters[t.SCISSOR_TEST]=!1,t.disable(t.SCISSOR_TEST),this._parameters[t.STENCIL_TEST]=!1,t.disable(t.STENCIL_TEST),this._parameters[t.COLOR_WRITEMASK]=[!0,!0,!0,!0],t.colorMask(!0,!0,!0,!0),this._parameters[t.DEPTH_WRITEMASK]=!0,t.depthMask(!0),this._parameters[t.BLEND_SRC_RGB]=t.ONE,this._parameters[t.BLEND_SRC_ALPHA]=t.ONE,this._parameters[t.BLEND_DST_RGB]=t.ZERO,this._parameters[t.BLEND_DST_ALPHA]=t.ZERO,t.blendFunc(t.ONE,t.ZERO),this._parameters[t.BLEND_EQUATION_RGB]=t.FUNC_ADD,this._parameters[t.BLEND_EQUATION_ALPHA]=t.FUNC_ADD,this._parameters[t.CULL_FACE_MODE]=t.BACK,t.cullFace(t.BACK),this._parameters[t.FRONT_FACE]=t.CCW,t.frontFace(t.CCW),this._parameters[t.DEPTH_FUNC]=t.LESS,t.depthFunc(t.LESS),this._parameters[t.DEPTH_RANGE]=[0,1],t.depthRange(0,1),this._parameters[t.POLYGON_OFFSET_FACTOR]=0,this._parameters[t.POLYGON_OFFSET_UNITS]=0,t.polygonOffset(0,0),this._parameters[t.SCISSOR_BOX]=[0,0,t.canvas.width,t.canvas.height],this._parameters[t.STENCIL_FUNC]=t.ALWAYS,this._parameters[t.STENCIL_VALUE_MASK]=255,this._parameters[t.STENCIL_REF]=0,t.stencilFunc(t.ALWAYS,0,255),this._parameters[t.STENCIL_WRITEMASK]=255,t.stencilMask(255),this._parameters[t.STENCIL_FAIL]=t.KEEP,this._parameters[t.STENCIL_PASS_DEPTH_FAIL]=t.KEEP,this._parameters[t.STENCIL_PASS_DEPTH_PASS]=t.KEEP}return r(e,[{key:"getParameter",value:function(e){return this._parameters[e]}},{key:"pushStateBlock",value:function(e){var t={name:e,states:[]};this._stateStack.push(t)}},{key:"popStateBlock",value:function(){var e,t=S(this._stateStack.pop().states);try{for(t.s();!(e=t.n()).done;){var n=e.value,i=n.func,r=n.args,a=n.parameters;for(var o in i.apply(this._gl,r),a)this._parameters[o]=a[o]}}catch(e){t.e(e)}finally{t.f()}}},{key:"_getStateStackTop",value:function(){var e=this._stateStack.length;return e>0?this._stateStack[e-1]:null}},{key:"_pushState",value:function(e,t,n){var i=this._getStateStackTop();i&&i.states.push({func:e,args:t,parameters:n})}},{key:"enable",value:function(e){if(!0!==this._parameters[e]){this._parameters[e]=!0,this._gl.enable(e);var t={};t[e]=!1,this._pushState(this._gl.disable,[e],t)}}},{key:"disable",value:function(e){if(!1!==this._parameters[e]){this._parameters[e]=!1,this._gl.disable(e);var t={};t[e]=!0,this._pushState(this._gl.enable,[e],t)}}},{key:"blendFunc",value:function(e,t){var n=this._gl,i=this._parameters;if(i[n.BLEND_SRC_RGB]!==e||i[n.BLEND_SRC_ALPHA]!==e||i[n.BLEND_DST_RGB]!==t||i[n.BLEND_DST_ALPHA]!==t){var r=[i[n.BLEND_SRC_RGB],i[n.BLEND_DST_RGB],i[n.BLEND_SRC_ALPHA],i[n.BLEND_DST_ALPHA]],a={};a[n.BLEND_SRC_RGB]=i[n.BLEND_SRC_RGB],a[n.BLEND_DST_RGB]=i[n.BLEND_DST_RGB],a[n.BLEND_SRC_ALPHA]=i[n.BLEND_SRC_ALPHA],a[n.BLEND_DST_ALPHA]=i[n.BLEND_DST_ALPHA],this._pushState(n.blendFuncSeparate,r,a),i[n.BLEND_SRC_RGB]=e,i[n.BLEND_SRC_ALPHA]=e,i[n.BLEND_DST_RGB]=t,i[n.BLEND_DST_ALPHA]=t,n.blendFunc(e,t)}}},{key:"blendFuncSeparate",value:function(e,t,n,i){var r=this._gl,a=this._parameters;if(a[r.BLEND_SRC_RGB]!==e||a[r.BLEND_SRC_ALPHA]!==n||a[r.BLEND_DST_RGB]!==t||a[r.BLEND_DST_ALPHA]!==i){var o=[a[r.BLEND_SRC_RGB],a[r.BLEND_DST_RGB],a[r.BLEND_SRC_ALPHA],a[r.BLEND_DST_ALPHA]],s={};s[r.BLEND_SRC_RGB]=a[r.BLEND_SRC_RGB],s[r.BLEND_DST_RGB]=a[r.BLEND_DST_RGB],s[r.BLEND_SRC_ALPHA]=a[r.BLEND_SRC_ALPHA],s[r.BLEND_DST_ALPHA]=a[r.BLEND_DST_ALPHA],this._pushState(r.blendFuncSeparate,o,s),a[r.BLEND_SRC_RGB]=e,a[r.BLEND_SRC_ALPHA]=n,a[r.BLEND_DST_RGB]=t,a[r.BLEND_DST_ALPHA]=i,r.blendFuncSeparate(e,t,n,i)}}},{key:"blendEquationSeparate",value:function(e,t){var n=this._gl,i=this._parameters;if(i[n.BLEND_EQUATION_RGB]!==e||i[n.BLEND_EQUATION_ALPHA]!==t){var r=[i[n.BLEND_EQUATION_RGB],i[n.BLEND_EQUATION_ALPHA]],a={};a[n.BLEND_EQUATION_RGB]=i[n.BLEND_EQUATION_RGB],a[n.BLEND_EQUATION_ALPHA]=i[n.BLEND_EQUATION_ALPHA],this._pushState(n.blendEquationSeparate,r,a),i[n.BLEND_EQUATION_RGB]=e,i[n.BLEND_EQUATION_ALPHA]=t,n.blendEquationSeparate(e,t)}}},{key:"colorMask",value:function(e,t,n,i){var r=this._gl,a={};a[r.COLOR_WRITEMASK]=this._parameters[r.COLOR_WRITEMASK],this._pushState(r.colorMask,this._parameters[r.COLOR_WRITEMASK],a),this._parameters[r.COLOR_WRITEMASK]=[e,t,n,i],r.colorMask(e,t,n,i)}},{key:"depthMask",value:function(e){var t=this._gl;if(this._parameters[t.DEPTH_WRITEMASK]!==e){var n={};n[t.DEPTH_WRITEMASK]=this._parameters[t.DEPTH_WRITEMASK],this._pushState(t.depthMask,[this._parameters[t.DEPTH_WRITEMASK]],n),this._parameters[t.DEPTH_WRITEMASK]=e,t.depthMask(e)}}},{key:"cullFace",value:function(e){var t=this._gl;if(this._parameters[t.CULL_FACE_MODE]!==e){var n={};n[t.CULL_FACE_MODE]=this._parameters[t.CULL_FACE_MODE],this._pushState(t.cullFace,[this._parameters[t.CULL_FACE_MODE]],n),this._parameters[t.CULL_FACE_MODE]=e,t.cullFace(e)}}},{key:"frontFace",value:function(e){var t=this._gl;if(this._parameters[t.FRONT_FACE]!==e){var n={};n[t.FRONT_FACE]=this._parameters[t.FRONT_FACE],this._pushState(t.frontFace,[this._parameters[t.FRONT_FACE]],n),this._parameters[t.FRONT_FACE]=e,t.frontFace(e)}}},{key:"depthFunc",value:function(e){var t=this._gl;if(this._parameters[t.DEPTH_FUNC]!==e){var n={};n[t.DEPTH_FUNC]=this._parameters[t.DEPTH_FUNC],this._pushState(t.depthFunc,[this._parameters[t.DEPTH_FUNC]],n),this._parameters[t.DEPTH_FUNC]=e,t.depthFunc(e)}}},{key:"depthRange",value:function(e,t){var n=this._gl,i=this._parameters[n.DEPTH_RANGE];if(i[0]!==e||i[1]!==t){var r={};r[n.DEPTH_RANGE]=i,this._pushState(n.depthRange,[this._parameters[n.DEPTH_RANGE]],r),this._parameters[n.DEPTH_RANGE]=[e,t],n.depthRange(e,t)}}},{key:"polygonOffset",value:function(e,t){var n=this._gl;if(this._parameters[n.POLYGON_OFFSET_FACTOR]!==e||this._parameters[n.POLYGON_OFFSET_UNITS]!==t){var i={};i[n.POLYGON_OFFSET_FACTOR]=this._parameters[n.POLYGON_OFFSET_FACTOR],i[n.POLYGON_OFFSET_UNITS]=this._parameters[n.POLYGON_OFFSET_UNITS],this._pushState(n.polygonOffset,[this._parameters[n.POLYGON_OFFSET_FACTOR],this._parameters[n.POLYGON_OFFSET_UNITS]],i),this._parameters[n.POLYGON_OFFSET_FACTOR]=e,this._parameters[n.POLYGON_OFFSET_UNITS]=t,n.polygonOffset(e,t)}}},{key:"scissor",value:function(e,t,n,i){var r=this._gl,a=this._parameters[r.SCISSOR_BOX];if(a[0]!==e||a[1]!==t||a[2]!==n||a[3]!==i){var o={};o[r.SCISSOR_BOX]=a,this._pushState(r.scissor,a,o),this._parameters[r.SCISSOR_BOX]=[e,t,n,i],r.scissor(e,t,n,i)}}},{key:"stencilFunc",value:function(e,t,n){var i=this._gl;if(this._parameters[i.STENCIL_FUNC]!==e||this._parameters[i.STENCIL_REF]!==t||this._parameters[i.STENCIL_VALUE_MASK]!==n){var r=[this._parameters[i.STENCIL_FUNC],this._parameters[i.STENCIL_REF],this._parameters[i.STENCIL_VALUE_MASK]],a={};a[i.STENCIL_FUNC]=r[0],a[i.STENCIL_REF]=r[1],a[i.STENCIL_VALUE_MASK]=r[2],this._pushState(i.stencilFunc,r,a),this._parameters[i.STENCIL_FUNC]=e,this._parameters[i.STENCIL_REF]=t,this._parameters[i.STENCIL_VALUE_MASK]=n,i.stencilFunc(e,t,n)}}},{key:"stencilOp",value:function(e,t,n){var i=this._gl;if(this._parameters[i.STENCIL_FAIL]!==e||this._parameters[i.STENCIL_PASS_DEPTH_FAIL]!==t||this._parameters[i.STENCIL_PASS_DEPTH_PASS]!==n){var r=[this._parameters[i.STENCIL_FAIL],this._parameters[i.STENCIL_PASS_DEPTH_FAIL],this._parameters[i.STENCIL_PASS_DEPTH_PASS]],a={};a[i.STENCIL_FAIL]=r[0],a[i.STENCIL_PASS_DEPTH_FAIL]=r[1],a[i.STENCIL_PASS_DEPTH_PASS]=r[2],this._pushState(i.stencilOp,r,a),this._parameters[i.STENCIL_FAIL]=e,this._parameters[i.STENCIL_BACK_PASS_DEPTH_FAIL]=t,this._parameters[i.STENCIL_PASS_DEPTH_PASS]=n,i.stencilOp(e,t,n)}}},{key:"stencilMask",value:function(e){var t=this._gl;if(this._parameters[t.STENCIL_WRITEMASK]!==e){var n={};n[t.STENCIL_WRITEMASK]=this._parameters[t.STENCIL_WRITEMASK],this._pushState(t.stencilMask,[this._parameters[t.STENCIL_WRITEMASK]],n),this._parameters[t.STENCIL_WRITEMASK]=e,t.stencilMask(e)}}}]),e}(),uo=function(){function e(t){n(this,e),this.gl=t,this._initVertexAttributes(t),this._vbo=t.createBuffer(),this._maxBatchCount=0,this._vertBuffer=null,this._vertCursor=0,this._drawSpriteCount=0}return r(e,[{key:"setMaxBatchCount",value:function(e){var t=6*e*9;this._vertBuffer&&this._vertBuffer.length>=t||(this._maxBatchCount=e,this._vertBuffer=new Float32Array(t))}},{key:"beginDraw",value:function(e){this._vertCursor=0,this._drawSpriteCount=0,e>this._maxBatchCount&&this.setMaxBatchCount(e)}},{key:"drawSprite",value:function(e,t,n){if(this._drawSpriteCount++,this._drawSpriteCount>this._maxBatchCount)Le.warn("Sprite: sprite count overflow");else{var i=n,r=t.u,a=t.v,o=t.u+t.width,s=t.v+t.height;this._pushVertex(e.leftTop,new z(r,a),i),this._pushVertex(e.leftBottom,new z(r,s),i),this._pushVertex(e.rightBottom,new z(o,s),i),this._pushVertex(e.rightBottom,new z(o,s),i),this._pushVertex(e.rightTop,new z(o,a),i),this._pushVertex(e.leftTop,new z(r,a),i)}}},{key:"endDraw",value:function(){var e=this._vertCursor/9;if(!(e<=0)){var t=this.gl;t.bindBuffer(t.ELEMENT_ARRAY_BUFFER,null),t.bindBuffer(t.ARRAY_BUFFER,this._vbo),t.bufferData(t.ARRAY_BUFFER,this._vertBuffer,t.DYNAMIC_DRAW);for(var n=0,i=this._vertAttributes.length;n<i;n++){var r=this._vertAttributes[n];t.vertexAttribPointer(r.lastShaderLoc,r.size,r.type,r.normalized,r.stride,r.offset),t.enableVertexAttribArray(r.lastShaderLoc)}t.drawArrays(t.TRIANGLES,0,e),t.bindBuffer(t.ELEMENT_ARRAY_BUFFER,null),t.bindBuffer(t.ARRAY_BUFFER,null);for(var a=0,o=this._vertAttributes.length;a<o;a++)t.disableVertexAttribArray(this._vertAttributes[a].lastShaderLoc)}}},{key:"_initVertexAttributes",value:function(e){var t={name:"a_pos",size:3,offset:0,lastShaderLoc:0},n={name:"a_uv",size:2,offset:12,lastShaderLoc:1},i={name:"a_color",size:4,offset:20,lastShaderLoc:2};this._vertAttributes=[t,n,i];var r,a=S(this._vertAttributes);try{for(a.s();!(r=a.n()).done;){var o=r.value;o.type=e.FLOAT,o.normalized=!1,o.stride=36}}catch(e){a.e(e)}finally{a.f()}}},{key:"_pushVertex",value:function(e,t,n){var i=this._vertBuffer,r=this._vertCursor;i[r]=e.x,i[r+1]=e.y,i[r+2]=e.z,i[r+3]=t.x,i[r+4]=t.y,i[r+5]=n.x,i[r+6]=n.y,i[r+7]=n.z,i[r+8]=n.w,this._vertCursor+=9}},{key:"finalize",value:function(){this._vbo&&(this.gl.deleteBuffer(this._vbo),this._vbo=null)}}]),e}(),lo={name:"spriteTech3D",vertexShader:"\nprecision highp float;\n\nuniform mat4 matProjection;\nuniform mat4 matView;\n\nattribute vec3 a_pos;\nattribute vec2 a_uv;\nattribute vec4 a_color;\n\nvarying vec2 v_uv;\nvarying vec4 v_color;\n\nvoid main()\n{\n  gl_Position = matProjection * matView * vec4(a_pos,1.0);\n  v_uv = a_uv;\n  v_color = a_color;\n}\n",fragmentShader:"\nprecision mediump float;\nprecision mediump int;\n\nuniform sampler2D s_diffuse;\nvarying vec2 v_uv;\nvarying vec4 v_color;\n\nvoid main()\n{\n  // 只使用贴图的Alpha做Mask，这样Tint Color依然可以控制控件Fade Out\n  vec4 baseColor = texture2D(s_diffuse, v_uv);\n  gl_FragColor = baseColor * v_color;\n}\n",attribLocSet:{a_pos:0,a_uv:1,a_color:2},attributes:{a_pos:{name:"a_pos",semantic:"POSITION",type:e.DataType.FLOAT_VEC3},a_uv:{name:"a_uv",semantic:"TEXCOORD_0",type:e.DataType.FLOAT_VEC2},a_color:{name:"a_color",semantic:"COLOR",type:e.DataType.FLOAT_VEC3}},uniforms:{matProjection:{name:"matProjection",semantic:e.UniformSemantic.PROJECTION,type:e.DataType.FLOAT_MAT4},matView:{name:"matView",semantic:e.UniformSemantic.VIEW,type:e.DataType.FLOAT_MAT4},s_diffuse:{name:"s_diffuse",type:e.DataType.SAMPLER_2D}},states:{disable:[e.RenderState.CULL_FACE],enable:[e.RenderState.BLEND],functions:{blendFunc:[e.BlendFunc.SRC_ALPHA,e.BlendFunc.ONE_MINUS_SRC_ALPHA],depthMask:[!1]}}};var co,ho=function(){function e(t){var i;n(this,e),this._gl=t.gl,this._batchedQueue=[],this._targetTexture=null,this._glSprite=new uo(t.gl),this._glTech=new eo(t,lo),this._material={values:i={},setValue:function(e,t){i[e]=t},getValue:function(e){return i[e]}},this._camera=null}return r(e,[{key:"flush",value:function(){if(0!==this._batchedQueue.length)if(this._targetTexture){this._material.setValue("s_diffuse",this._targetTexture),this._material.setValue("matView",this._camera.viewMatrix),this._material.setValue("matProjection",this._camera.projectionMatrix),this._glTech.begin(this._material),this._glSprite.beginDraw(this._batchedQueue.length);for(var e=0,t=this._batchedQueue.length;e<t;e++){var n=this._batchedQueue[e].positionQuad,i=this._batchedQueue[e].uvRect,r=this._batchedQueue[e].tintColor;this._glSprite.drawSprite(n,i,r)}this._glSprite.endDraw(),this._glTech.end(),this._batchedQueue=[],this._targetTexture=null,this._camera=null}else Le.error("No texture!")}},{key:"canBatch",value:function(e,t,n){return null===this._targetTexture||e===this._targetTexture&&n===this._camera}},{key:"drawSprite",value:function(e,t,n,i,r,a){this.canBatch(i,r,a)||this.flush(),this._targetTexture=i,this._camera=a,this._batchedQueue.push({positionQuad:e,uvRect:t,tintColor:n})}},{key:"finalize",value:function(){this._glSprite.finalize(),this._glTech.finalize()}}]),e}();(co=e.WebGLMode||(e.WebGLMode={}))[co.Auto=0]="Auto",co[co.WebGL2=1]="WebGL2",co[co.WebGL1=2]="WebGL1";var fo=function(){function t(){var e=arguments.length>0&&void 0!==arguments[0]?arguments[0]:{};n(this,t),this._options=e}return r(t,[{key:"isWebGL2",get:function(){return this._isWebGL2}}]),r(t,[{key:"init",value:function(e,t){var n=this._options;this._engine=t;var i,r=e._webCanvas,a=n.webGLMode||0;if(0!=a&&1!=a||(!(i=r.getContext("webgl2",n))&&r instanceof HTMLCanvasElement&&(i=r.getContext("experimental-webgl2",n)),this._isWebGL2=!0),i||0!=a&&2!=a||(!(i=r.getContext("webgl",n))&&r instanceof HTMLCanvasElement&&(i=r.getContext("experimental-webgl",n)),this._isWebGL2=!1),!i)throw new Error("Get GL Context FAILED.");this._gl=i,this._renderStates=new so(i),this._assetsCache=new io(this,n),this._extensions=new ao(this),this._capability=new ro(this),this._frameCount=0,this._options=null}},{key:"createPlatformPrimitive",value:function(e){return new oo(this,e)}},{key:"requireExtension",value:function(e){return this._extensions.requireExtension(e)}},{key:"canIUse",value:function(e){return this.capability.canIUse(e)}},{key:"canIUseCompressedTextureInternalFormat",value:function(e){return this.capability.canIUseCompressedTextureInternalFormat(e)}},{key:"viewport",value:function(e,t,n,i){var r=this._gl;r.viewport(e,r.drawingBufferHeight-t-i,n,i)}},{key:"colorMask",value:function(e,t,n,i){this._gl.colorMask(e,t,n,i)}},{key:"beginFrame",value:function(){this._frameCount++}},{key:"clearRenderTarget",value:function(t,n){var i=this._gl;switch(t){case e.ClearMode.SOLID_COLOR:i.clearColor(n.x,n.y,n.z,n.w),i.clear(i.COLOR_BUFFER_BIT|i.DEPTH_BUFFER_BIT);break;case e.ClearMode.DEPTH_ONLY:i.clear(i.DEPTH_BUFFER_BIT);break;case e.ClearMode.COLOR_ONLY:i.clearColor(n.x,n.y,n.z,n.w),i.clear(i.COLOR_BUFFER_BIT);break;case e.ClearMode.STENCIL_ONLY:i.clear(i.STENCIL_BUFFER_BIT);break;case e.ClearMode.ALL_CLEAR:i.clearColor(n.x,n.y,n.z,n.w),i.clear(i.COLOR_BUFFER_BIT|i.DEPTH_BUFFER_BIT|i.STENCIL_BUFFER_BIT);break;case e.ClearMode.DONT_CLEAR:}}},{key:"drawPrimitive",value:function(e,t,n){var i=n.technique._glTechnique;i||(i=n.technique._glTechnique=new eo(this,n.technique)),i.valid&&(e&&i?(i.begin(n),e.draw(i,t),i.end()):Le.error("draw primitive failed."))}},{key:"drawSprite",value:function(e,t,n,i,r,a){this._spriteBatcher||(this._spriteBatcher=new ho(this)),this._spriteBatcher.drawSprite(e,t,n,i,r,a)}},{key:"flushSprite",value:function(){this._spriteBatcher&&this._spriteBatcher.flush()}},{key:"activeRenderTarget",value:function(e,t){var n=this._gl;if(e){e._activeRenderTarget();var i=e.width,r=e.height;n.viewport(0,0,i,r)}else{n.bindFramebuffer(n.FRAMEBUFFER,null);var a=t.viewport,o=n.drawingBufferWidth,s=n.drawingBufferHeight;this.viewport(a.x*o,a.y*s,a.z*o,a.w*s)}}},{key:"blitRenderTarget",value:function(e){e&&e._MSAAFrameBuffer&&e._blitRenderTarget()}},{key:"setRenderTargetFace",value:function(e,t){e&&e._setRenderTargetFace(t)}},{key:"endFrame",value:function(){this._frameCount%8==0&&this._assetsCache.compact()}},{key:"destroy",value:function(){this._assetsCache.finalize()}},{key:"gl",get:function(){return this._gl}},{key:"assetsCache",get:function(){return this._assetsCache}},{key:"renderStates",get:function(){return this._renderStates}},{key:"capability",get:function(){return this._capability}},{key:"frameCount",get:function(){return this._frameCount}},{key:"canIUseMoreJoints",get:function(){return this.capability.canIUseMoreJoints}}]),t}(),_o=function(e){l(i,e);var t=m(i);function i(e,r){n(this,i);var a=new no("string"==typeof e?document.getElementById(e):e),o=new fo(r);return t.call(this,a,o)}return r(i,[{key:"canvas",get:function(){return this._canvas}}]),i}($e);Qa.registerComponents("o3",{GLTFModel:la,SpriteRenderer:Wn,PointLight:Gt,AmbientLight:Dt,DirectLight:Nt,EnvironmentMapLight:zt,Particle:Ei,SkyBox:Ti,BoxCollider:wi,GeometryRenderer:ci,Camera:e.Camera,Component:Ue,SphereCollider:Mi,PlaneProbe:Ui,Model:yi});var po="0.1.29";console.log("oasis engine version: ".concat(po)),e.ABoxCollider=Wt,e.ACollider=jt,e.ASphereCollider=qt,e.AmbientLight=Dt,e.Animation=Jn,e.AnimationClip=qn,e.AssetObject=nt,e.AssetPromise=V,e.BasicRenderPipeline=xt,e.BlinnPhongMaterial=ti,e.BoundingBox=L,e.BoundingSphere=M,e.BoxCollider=wi,e.Buffer=bn,e.BufferGeometry=li,e.BufferUtil=En,e.CircleGeometry=vi,e.ColliderFeature=Ht,e.CollisionDetection=Pi,e.CommonMaterial=Zn,e.ComplexMaterial=Tn,e.Component=Ue,e.ConstantMaterial=$n,e.CubeProbe=qi,e.CuboidGeometry=di,e.CylinderGeometry=pi,e.DirectLight=Nt,e.EXP2Fog=Fi,e.Engine=$e,e.EngineFeature=tt,e.EngineObject=re,e.Entity=Xe,e.EnvironmentMapLight=zt,e.Event=Y,e.EventDispatcher=se,e.FogFeature=Ni,e.GLShaderProgram=Za,e.GLTFModel=la,e.GLTechnique=eo,e.GLTexture=to,e.GPUParticleSystem=Si,e.GeometryRenderer=ci,e.IndexBufferBinding=Rn,e.LODGroup=yn,e.LambertMaterial=ei,e.Light=It,e.LightFeature=Vt,e.LinearFog=Bi,e.Loader=Ot,e.Logger=Le,e.Material=xn,e.MathUtil=R,e.Matrix=F,e.Matrix3x3=P,e.Mesh=Yt,e.MeshRenderer=ln,e.Model=yi,e.OBB=k,e.Oasis=Wa,e.ObjectValues=W,e.PBRMaterial=Ai,e.Parser=Qa,e.Particle=Ei,e.PlaneCollider=Xt,e.PlaneGeometry=_i,e.PlaneProbe=Ui,e.PointLight=Gt,e.Primitive=Mn,e.Probe=Gi,e.Quaternion=O,e.Ray=I,e.RaycastHit=D,e.RefObject=Ft,e.RegistExtension=function(e){Object.keys(e).forEach((function(t){if(void 0===xr[t])switch(xr[t]=e[t],t){case Sr:Rr.KHR_materials_unlit=Ai;break;case Er:br=e[t],Rr.KHR_lights=br;break;default:xn.isPrototypeOf(e[t])&&e[t].TECH_NAME&&(Tr[e[t].TECH_NAME]=e[t])}}))},e.RenderColorTexture=jn,e.RenderContext=pt,e.RenderDepthTexture=Vn,e.RenderPass=_t,e.RenderQueue=gt,e.RenderTarget=Hn,e.RenderTechnique=In,e.RenderableComponent=dt,e.ResourceManager=q,e.Scene=Ye,e.SceneFeature=rt,e.SceneVisitor=it,e.SchemaResource=pa,e.ScreenQuadGeometry=mi,e.Script=ut,e.ShaderFactory=kn,e.ShaderMaterial=ai,e.ShapeGeometry=hi,e.Skin=Jt,e.SkinnedMeshRenderer=pn,e.SkyBox=Ti,e.SphereCollider=Mi,e.SphereGeometry=fi,e.Spherical=B,e.SpotLight=Ut,e.SpriteRenderer=Wn,e.SubPrimitive=Pn,e.SystemInfo=et,e.Texture=cn,e.Texture2D=hn,e.TextureCubeMap=Un,e.TextureMaterial=ii,e.Time=Pe,e.TorusGeometry=gi,e.TrailMaterial=Ci,e.TrailRenderer=Ri,e.Transform=qe,e.TransparentMaterial=ri,e.UpdateFlag=Ve,e.Util=H,e.Vector2=z,e.Vector3=w,e.Vector4=U,e.VertexBufferBinding=wn,e.VertexElement=Ln,e.WebCanvas=no,e.WebGLEngine=_o,e.WebGLRenderer=fo,e.bindFogToMaterial=Di,e.dependencies=Ne,e.getFogMacro=Ii,e.hasFogFeature=ki,e.parseSingleKTX=Yr,e.parser=Ya,e.registerResource=function(e,t){Na.hasOwnProperty(e)||(Na[e]=t,Ba.set(t,e))},e.request=bt,e.resourceLoader=X,e.script=function(e){return function(t){xa[e]=t}},e.version=po,Object.defineProperty(e,"__esModule",{value:!0})}));
