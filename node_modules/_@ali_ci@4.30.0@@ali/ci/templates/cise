# 不要修改该文件，会自动生成，详见 https://gitlab.alibaba-inc.com/node/ci

stage:
{%- for item in versions %}
{{item.name}}-{{item.version}}:
  prepare:
    exec:
      - OS=`uname | tr '[:upper:]' '[:lower:]'` && curl -v -L http://enclose.alibaba-inc.com/packages/tnpm/{{tnpmVersion}}/tnpm/${OS}-x64 | gunzip > tnpm
      - chmod +x tnpm && ls -al tnpm && mkdir -p node_modules/.bin && mv tnpm node_modules/.bin
      - node_modules/.bin/tnpm -v
      - node_modules/.bin/tnpm i --install-{{item.name}}={{item.version}} --no-cache --internal-oss-cache
  unit_test:
    exec:
      - "CI_BUILD_REF=$source_version CI_BUILD_REF_NAME=$scm_branch CI_BUILD_REPO=$scm_url \
        CI_BUILD_URL=http://cise.alibaba-inc.com/task/$task_id/build/$build_idx \
        node_modules/.bin/tnpm run {{command}}"
{%- else %}
test:
  prepare:
    exec:
      - OS=`uname | tr '[:upper:]' '[:lower:]'` && curl -v -L http://enclose.alibaba-inc.com/packages/tnpm/{{tnpmVersion}}/tnpm/${OS}-x64 | gunzip > tnpm
      - chmod +x tnpm && ls -al tnpm && mkdir -p node_modules/.bin && mv tnpm node_modules/.bin
      - node_modules/.bin/tnpm -v
      - node_modules/.bin/tnpm i --no-cache --internal-oss-cache
  unit_test:
    exec:
      - "CI_BUILD_REF=$source_version CI_BUILD_REF_NAME=$scm_branch CI_BUILD_REPO=$scm_url \
        CI_BUILD_URL=http://cise.alibaba-inc.com/task/$task_id/build/$build_idx \
        node_modules/.bin/tnpm run {{command}}"
{%- endfor %}
{%- if pipeline %}
pipeline:
  - {{pipeline}}
{%- endif %}
