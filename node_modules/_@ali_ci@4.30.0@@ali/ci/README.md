@ali/ci
---------------

自动生成 gitlab-ci, aone 或者 cise 的配置文件。

## Badges

[![Build status][build-status-image]][aone-ci-url]
[![Line coverage][line-coverage-image]][aone-ci-url]
[![Branch coverage][branch-coverage-image]][aone-ci-url]
![node >=4.0.0](https://duing.alibaba-inc.com/img/label?key=node&value=%3E%3D4.0.0&keyBgColor=505050&valueBgColor=51CA2A&size=12)
[![TNPM version][tnpm-image]][tnpm-url]
[![TNPM downloads][tnpm-downloads-image]][tnpm-url]

[tnpm-image]: https://npm.alibaba-inc.com/badge/v/@ali/ci.svg
[tnpm-url]: https://npm.alibaba-inc.com/package/@ali/ci
[tnpm-downloads-image]: https://npm.alibaba-inc.com/badge/d/@ali/ci.svg
[aone-ci-url]: https://aone-api.alibaba-inc.com/ak/testservice/api/badge/link?repo=git@gitlab.alibaba-inc.com:node/ci.git
[build-status-image]: https://aone-api.alibaba-inc.com/ak/testservice/api/badge/query?repo=git@gitlab.alibaba-inc.com:node/ci.git&type=%E6%9E%84%E5%BB%BA%E7%8A%B6%E6%80%81
[line-coverage-image]: https://aone-api.alibaba-inc.com/ak/testservice/api/badge/query?repo=git@gitlab.alibaba-inc.com:node/ci.git&type=%E5%8D%95%E6%B5%8B%E8%A1%8C%E8%A6%86%E7%9B%96%E7%8E%87
[branch-coverage-image]: https://aone-api.alibaba-inc.com/ak/testservice/api/badge/query?repo=git@gitlab.alibaba-inc.com:node/ci.git&type=%E5%8D%95%E6%B5%8B%E5%88%86%E6%94%AF%E8%A6%86%E7%9B%96%E7%8E%87

--------------------

## Installation

```bash
$ tnpm install @ali/ci --save-dev
```

## Usage

在 `package.json` 中通过配置 `ci` 字段来定制生成的配置：

```js
"ci": {
  "type": "", // 默认是 aoneci 来生成 Aone CI yml 配置，请记得在 gitlab 配置里面开启 CISE。
  // gitlab 代表使用 gitlab-ci 运行，如果没有配置 type 并且 gitlab 是蚂蚁的，会默认设置为 gitlab
  // aone 是老的格式，建议使用 aoneci，根据简单，由 @焦霸 专业支持！
  // aci 蚂蚁最新的 ci 环境，官方推荐，发现代码库在 code.linke.alipay.com 也会自动设置为 aci
  "version": "8", // 测试的 node 版本，默认只测试最新稳定版（现在是 8.x)，可以通过 "8, 10, 12" 指定多个版本
  // 还可以指定使用 alinode 进行测试，如 `alinode=4`, `alinode=5.0.0` https://help.aliyun.com/knowledge_detail/60811.html
  // 是否通过 docker 来运行，只在 gitlab 的 ci 中支持，默认为 true。如果你的 ci runner 是自己搭建的，请设置为 false。
  "docker": true,
  "tags": "" // gitlab-ci 的 tags 配置
  "fntest": false, // 是否执行功能测试，只在启用 docker 的 ci 中支持，默认为 false
  "tengine": true, // 是否安装 tengine， 只在 aci 中支持，默认为 false
  "command": "ci" // 跑 ci 测试时执行哪个 npm script，默认为 `ci`，即会执行 `npm run ci`,
  "cpp": false, // 是否需要 cpp 模块编译环境，默认为 false，目前只适用于 aoneci
  "autoBadges": true, // 是否自动生成 aone ci 和 tnpm badges，默认为 true
  "coverage": true, // 是否支持收集 coverage 信息，设置为 false 之后 aci 模式不会收集 coverage 信息
  "image": "", // 配置镜像，默认为 node-ci
  "resource": {
    "cpu": 4,
    "memory": 12,
    "storage": 30
  } // ACI 执行资源配置，默认 4c12g30g 配置
}
```

## 原理

安装此模块时会通过 `npm postinstall hook` 来更新本地的 yml 文件，如果需要更新文件，请重新安装改模块即可。

## 支持 AoneCI 需要的 TEST_CASE_AMOUNT 输出

- egg-bin 默认会输出 mochawesome-reports ，alicov 会自动读取报告数据生成 aoneci 需要的 TEST_CASE_AMOUNT 输出。
- jest，内置的 json 报告输出符合 alicov 阅读的统计数据。
```bash
"cov": "jest --json > node_modules/.tap.json"
```
- mocha，可以使用 [tab-json](https://github.com/gummesson/tap-json) 报告，输出符合 alicov 阅读的统计数据。
```bash
"cov": "mocha --tap | tap-json > node_modules/.tap.json"
```
- ava，可以使用 [ava-tap-json](https://github.com/yovasx2/ava-tap-json) 报告，输出符合 alicov 阅读的统计数据。
```bash
"cov": "NODE_ENV=test nyc ava --tap | ava-tap-json > node_modules/.tap.json && nyc report --reporter=json --reporter=lcov"
```
- 其他测试框架，生成 tap json 报告到 `node_modules/.tap.json` 目录即可。

![](http://alipay-rmsdeploy-dev-assets.oss-cn-hangzhou-zmf.aliyuncs.com/tfs-upload/ali-43624.local/1594005912243-LDm5zQmWnhknb3PV-pngpaste_1594005911536.png)

## 参考文章

- [Aone 徽章大全](https://www.atatech.org/articles/67130)
- [阿里集团 GitLab 极速接入 Aone CI](https://yuque.antfin-inc.com/suqian.yf/123/gitlab-plus-aoneci)
- [DUING 内网 Badge 服务](https://yuque.antfin-inc.com/lisheng.lisheng/mx9fm5/ta3dan)

## Contributors(16)

Ordered by date of first contribution, by [ali-contributors](https://gitlab.alibaba-inc.com/node/ali-contributors).

- <a target="_blank" href="https://work.alibaba-inc.com/work/u/52624"><img style="vertical-align: middle;" width="20" src="https://work.alibaba-inc.com/photo/52624.40x40.xz.jpg"> @不四</a> <a target="_blank" href="dingtalk://dingtalkclient/action/sendmsg?dingtalk_id=deadhorse"><img style="vertical-align: middle;" width="20" src="https://img.alicdn.com/tfs/TB18HtyiyqAXuNjy1XdXXaYcVXa-24-24.svg"> 不四🐴</a>
- <a target="_blank" href="https://fengmk2.com"><img style="vertical-align: middle;" width="20" src="https://work.alibaba-inc.com/photo/43624.40x40.xz.jpg"> @苏千</a> <a target="_blank" href="dingtalk://dingtalkclient/action/sendmsg?dingtalk_id=fengmk2"><img style="vertical-align: middle;" width="20" src="https://img.alicdn.com/tfs/TB18HtyiyqAXuNjy1XdXXaYcVXa-24-24.svg"> 苏千</a>
- <a target="_blank" href="https://work.alibaba-inc.com/work/u/70032"><img style="vertical-align: middle;" width="20" src="https://work.alibaba-inc.com/photo/70032.40x40.xz.jpg"> @宫煌</a> <a target="_blank" href="dingtalk://dingtalkclient/action/sendmsg?dingtalk_id=gf8f2zh"><img style="vertical-align: middle;" width="20" src="https://img.alicdn.com/tfs/TB18HtyiyqAXuNjy1XdXXaYcVXa-24-24.svg"> 宫煌 Zhang Yuheng</a>
- <a target="_blank" href="http://chuo.me"><img style="vertical-align: middle;" width="20" src="https://work.alibaba-inc.com/photo/28761.40x40.xz.jpg"> @贯高</a> <a target="_blank" href="dingtalk://dingtalkclient/action/sendmsg?dingtalk_id=popomore"><img style="vertical-align: middle;" width="20" src="https://img.alicdn.com/tfs/TB18HtyiyqAXuNjy1XdXXaYcVXa-24-24.svg"> 贯高</a>
- <a target="_blank" href="https://work.alibaba-inc.com/work/u/89488"><img style="vertical-align: middle;" width="20" src="https://work.alibaba-inc.com/photo/89488.40x40.xz.jpg"> @天筑</a> <a target="_blank" href="dingtalk://dingtalkclient/action/sendmsg?dingtalk_id=atian25"><img style="vertical-align: middle;" width="20" src="https://img.alicdn.com/tfs/TB18HtyiyqAXuNjy1XdXXaYcVXa-24-24.svg"> 天猪(天筑)</a>
- <a target="_blank" href="https://work.alibaba-inc.com/work/u/55162"><img style="vertical-align: middle;" width="20" src="https://work.alibaba-inc.com/photo/55162.40x40.xz.jpg"> @偏右</a> <a target="_blank" href="dingtalk://dingtalkclient/action/sendmsg?dingtalk_id=afc163"><img style="vertical-align: middle;" width="20" src="https://img.alicdn.com/tfs/TB18HtyiyqAXuNjy1XdXXaYcVXa-24-24.svg"> 秒</a>
- <a target="_blank" href="https://work.alibaba-inc.com/work/u/87330"><img style="vertical-align: middle;" width="20" src="https://work.alibaba-inc.com/photo/87330.40x40.xz.jpg"> @夜沉</a> <a target="_blank" href="dingtalk://dingtalkclient/action/sendmsg?dingtalk_id=ta6lb4d"><img style="vertical-align: middle;" width="20" src="https://img.alicdn.com/tfs/TB18HtyiyqAXuNjy1XdXXaYcVXa-24-24.svg"> 夜沉</a>
- <a target="_blank" href="https://work.alibaba-inc.com/work/u/33772"><img style="vertical-align: middle;" width="20" src="https://work.alibaba-inc.com/photo/33772.40x40.xz.jpg"> @汤尧</a> <a target="_blank" href="dingtalk://dingtalkclient/action/sendmsg?dingtalk_id=slauxsy"><img style="vertical-align: middle;" width="20" src="https://img.alicdn.com/tfs/TB18HtyiyqAXuNjy1XdXXaYcVXa-24-24.svg"> 汤尧</a>
- <a target="_blank" href="https://work.alibaba-inc.com/work/u/70088"><img style="vertical-align: middle;" width="20" src="https://work.alibaba-inc.com/photo/70088.40x40.xz.jpg"> @啸生</a> <a target="_blank" href="dingtalk://dingtalkclient/action/sendmsg?dingtalk_id=ikobe621"><img style="vertical-align: middle;" width="20" src="https://img.alicdn.com/tfs/TB18HtyiyqAXuNjy1XdXXaYcVXa-24-24.svg"> 啸生</a>
- <a target="_blank" href="https://work.alibaba-inc.com/work/u/123061"><img style="vertical-align: middle;" width="20" src="https://work.alibaba-inc.com/photo/123061.40x40.xz.jpg"> @血辰</a> <a target="_blank" href="dingtalk://dingtalkclient/action/sendmsg?dingtalk_id=hongxingshi"><img style="vertical-align: middle;" width="20" src="https://img.alicdn.com/tfs/TB18HtyiyqAXuNjy1XdXXaYcVXa-24-24.svg"> 血辰</a>
- <a target="_blank" href="https://work.alibaba-inc.com/work/u/157028"><img style="vertical-align: middle;" width="20" src="https://work.alibaba-inc.com/photo/157028.40x40.xz.jpg"> @零弌</a> <a target="_blank" href="dingtalk://dingtalkclient/action/sendmsg?dingtalk_id=mx53epm"><img style="vertical-align: middle;" width="20" src="https://img.alicdn.com/tfs/TB18HtyiyqAXuNjy1XdXXaYcVXa-24-24.svg"> 零弌(yī)</a>
- <a target="_blank" href="https://work.alibaba-inc.com/work/u/79696"><img style="vertical-align: middle;" width="20" src="https://work.alibaba-inc.com/photo/79696.40x40.xz.jpg"> @慕陶</a> <a target="_blank" href="dingtalk://dingtalkclient/action/sendmsg?dingtalk_id=etlx8r9"><img style="vertical-align: middle;" width="20" src="https://img.alicdn.com/tfs/TB18HtyiyqAXuNjy1XdXXaYcVXa-24-24.svg"> 慕陶</a>
- <a target="_blank" href="https://work.alibaba-inc.com/work/u/80222"><img style="vertical-align: middle;" width="20" src="https://work.alibaba-inc.com/photo/80222.40x40.xz.jpg"> @蛋总</a> <a target="_blank" href="dingtalk://dingtalkclient/action/sendmsg?dingtalk_id=hacke2"><img style="vertical-align: middle;" width="20" src="https://img.alicdn.com/tfs/TB18HtyiyqAXuNjy1XdXXaYcVXa-24-24.svg"> 蛋总</a>
- <a target="_blank" href="https://work.alibaba-inc.com/work/u/208698"><img style="vertical-align: middle;" width="20" src="https://work.alibaba-inc.com/photo/208698.40x40.xz.jpg"> @六牙</a> <a target="_blank" href="dingtalk://dingtalkclient/action/sendmsg?dingtalk_id=yaphetszmn"><img style="vertical-align: middle;" width="20" src="https://img.alicdn.com/tfs/TB18HtyiyqAXuNjy1XdXXaYcVXa-24-24.svg"> 六牙</a>
- <a target="_blank" href="https://work.alibaba-inc.com/work/u/72970"><img style="vertical-align: middle;" width="20" src="https://work.alibaba-inc.com/photo/72970.40x40.xz.jpg"> @谷童</a> <a target="_blank" href="dingtalk://dingtalkclient/action/sendmsg?dingtalk_id=valleykid"><img style="vertical-align: middle;" width="20" src="https://img.alicdn.com/tfs/TB18HtyiyqAXuNjy1XdXXaYcVXa-24-24.svg"> vk(谷童)</a>
- <a target="_blank" href="https://work.alibaba-inc.com/work/u/76397"><img style="vertical-align: middle;" width="20" src="https://work.alibaba-inc.com/photo/76397.40x40.xz.jpg"> @祤轩</a> <a target="_blank" href="dingtalk://dingtalkclient/action/sendmsg?dingtalk_id=xiazhenhua"><img style="vertical-align: middle;" width="20" src="https://img.alicdn.com/tfs/TB18HtyiyqAXuNjy1XdXXaYcVXa-24-24.svg"> 祤轩</a>

---
[![CoffeePay 打赏](http://coffee.alibaba-inc.com/projects/585d6ebe5fb92e2c19c00a00/badge)](http://coffee.alibaba-inc.com/donates?id=585d6ebe5fb92e2c19c00a00)
欢迎打赏一杯咖啡~
<br>
<img width="150" src="http://coffee.alibaba-inc.com/projects/585d6ebe5fb92e2c19c00a00/qr">


--------------------
